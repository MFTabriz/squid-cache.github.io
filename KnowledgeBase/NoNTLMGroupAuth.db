<?xml version="1.0" encoding="utf-8"?><!DOCTYPE article  PUBLIC '-//OASIS//DTD DocBook XML V4.4//EN'  'http://www.docbook.org/xml/4.4/docbookx.dtd'><article><articleinfo><title>KnowledgeBase/NoNTLMGroupAuth</title><revhistory><revision><revnumber>4</revnumber><date>2008-05-18 19:39:00</date><authorinitials>localhost</authorinitials><revremark>converted to 1.6 markup</revremark></revision><revision><revnumber>3</revnumber><date>2007-03-10 09:50:29</date><authorinitials>kinkie</authorinitials><revremark>adjusted formatting to fit index-by-title</revremark></revision><revision><revnumber>2</revnumber><date>2007-03-09 02:08:37</date><authorinitials>AdrianChadd</authorinitials></revision><revision><revnumber>1</revnumber><date>2007-03-01 03:45:10</date><authorinitials>AdrianChadd</authorinitials></revision></revhistory></articleinfo><section><title>NTLM Group ACLs fail during upgrade from Squid-2.5 to Squid-2.6</title><para><emphasis role="strong">Synopsis</emphasis> </para><para>An upgrade from Squid-2.5 to Squid-2.6 (and possibly an underlying upgrade of Samba/Winbind in the process) breaks NTLM group authentication. NTLM user authentication still succeeds normally. </para><para><emphasis role="strong">Symptoms</emphasis> </para><itemizedlist><listitem><para>wbinfo returns valid information; eg &quot;wbinfo -t&quot; and &quot;wbinfo -g&quot; return user and group lists respectively; </para></listitem><listitem><para>Squid can authenticate users via NTLM fine; </para></listitem><listitem><para>cache.log logs messages similar to &quot;Could not convert sid S-1-5-21-466765145-1792897056-1845911597-1995 to gid&quot; </para></listitem></itemizedlist><para><emphasis role="strong">Explanation</emphasis> </para><para>Group ACLs for NTLM are implemented by using the helper &quot;wbinfo_group.pl&quot; to map users+groups into true or false. Squid then uses the results of this in the ACL. &quot;wbinfo_group.pl&quot; internally uses the command line program &quot;wbinfo&quot; to perform the lookups. If &quot;wbinfo&quot; can't map the user/group sid to a group id (gid) then all lookups will return failure/false and Squid will deny access. </para><para><emphasis role="strong">Repairing</emphasis> </para><para>At least one report of this issue was solved by deleting a corrupted &quot;winbindd_idmap.tdb&quot; file in /var/db/samba. The steps taken to resolve the issue were: </para><itemizedlist><listitem><para>Verify kerberos is working fine: </para><itemizedlist><listitem><para>kinit &lt;user@DOMAIN&gt; </para></listitem><listitem><para>klist; which should show a valid certificate </para></listitem></itemizedlist></listitem><listitem><para>Verify winbind can authenticate to the Active Directory service fine: </para><itemizedlist><listitem><para>wbinfo -t should display &quot;checking the trust secret via RPC calls succeeded&quot; </para></listitem><listitem><para>wbinfo -u should list all users </para></listitem><listitem><para>wbinfo -g should list all groups </para></listitem></itemizedlist></listitem><listitem><para>Stop Squid, Samba, Winbindd </para></listitem><listitem><para>Delete the winbindd_idmap.tdb file </para></listitem><listitem><para>Ensure time synchronisation to the Active Directory server is setup and running correctly </para></listitem><listitem><para>Rejoin the domain via &quot;net ads join -U &lt;user@DOMAIN&gt;&quot; </para></listitem><listitem><para>Restart Samba/Winbind/Squid </para></listitem></itemizedlist><para>To verify, use: </para><itemizedlist><listitem><para>wbinfo -n &lt;name or group&gt;; which will attempt to map the given user or group name to an SID. </para></listitem></itemizedlist><para><emphasis role="strong">Thanks</emphasis> </para><para>Thanks to David Whitehead <code>&lt;dwhitehead AT seacrestvillage DOT org&gt;</code> for working with the Squid team to resolve and document this issue. </para><!--rule (<hr>) is not applicable to DocBook--><para> <ulink url="https://wiki.squid-cache.org/KnowledgeBase/NoNTLMGroupAuth/CategoryKnowledgeBase#">CategoryKnowledgeBase</ulink> </para></section></article>