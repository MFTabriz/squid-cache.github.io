<?xml version="1.0" encoding="utf-8"?><!DOCTYPE article  PUBLIC '-//OASIS//DTD DocBook XML V4.4//EN'  'http://www.docbook.org/xml/4.4/docbookx.dtd'><article><articleinfo><title>KnowledgeBase/VaryNotCaching</title><revhistory><revision><revnumber>2</revnumber><date>2008-09-01 10:22:54</date><authorinitials>AdrianChadd</authorinitials></revision><revision><revnumber>1</revnumber><date>2008-09-01 00:37:23</date><authorinitials>AdrianChadd</authorinitials></revision></revhistory></articleinfo><section><title>GZIP Encoded Variants Being Replaced by Non-Compressed Objects</title><para><emphasis role="strong">Synopsis</emphasis> </para><para>Squid stores a compressed reply variant fine but a non-compressed reply causes all subsequent replies to be non-compressed. </para><para><emphasis role="strong">Symptoms</emphasis> </para><itemizedlist><listitem><para>Initial request included Accept-Encoding: gzip (or similar); </para></listitem><listitem><para>The reply was a Content-Encoded gzip reply with the correct Vary: header set; </para></listitem><listitem><para>Subsequent requests w/ Accept-Encoding: gzip returns the cached gzip'ed reply; </para></listitem><listitem><para>A request with no Accept-Encoding: gzip header causes the cache to request a non-compressed variant; </para></listitem><listitem><para>Squid replaces the in-cache variant copies of all content for that particular object with the single non-compressed variant; </para></listitem><listitem><para>And subsequent requests, compressed or not, return the uncompressed object. </para></listitem></itemizedlist><para><emphasis role="strong">Explanation</emphasis> </para><para>(TBD: find relevant sections in the RFC.) </para><para>It is valid for a cache to serve a non-compressed reply to an Accept-Encoding: gzip or similar request. Squid has no way of knowing that an object has multiple variant types if any of the possible replies for the object contains no Vary: header. </para><para>In summary, Squid is doing the right thing. Origin servers need to set correct ETag and Vary: headers so variant content is correctly cached and served. </para><para><emphasis role="strong">Workaround</emphasis> </para><itemizedlist><listitem><para>Make sure the origin server sets Vary: Accept-Encoding for both compressed and non-compressed replies, or Squid will replace the Vary objects with the single non-compressed object. </para></listitem><listitem><para>Make sure the origin server sets a different ETag for each variant reply type - ie, a different ETag for compressed and uncompressed - or browsers/caches will believe the replies are equivalent. </para></listitem></itemizedlist><para><emphasis role="strong">See Also</emphasis> </para><itemizedlist><listitem><para><ulink url="http://devel.squid-cache.org/vary/"/> </para></listitem><listitem><para><ulink url="http://devel.squid-cache.org/etag/"/> </para></listitem></itemizedlist><para><emphasis role="strong">Thanks</emphasis> </para><itemizedlist><listitem><para><ulink url="https://wiki.squid-cache.org/KnowledgeBase/VaryNotCaching/HenrikNordstrom#">HenrikNordstrom</ulink> - providing information on the Vary code behaviour </para></listitem></itemizedlist><!--rule (<hr>) is not applicable to DocBook--><para> <ulink url="https://wiki.squid-cache.org/KnowledgeBase/VaryNotCaching/CategoryKnowledgeBase#">CategoryKnowledgeBase</ulink> <ulink url="https://wiki.squid-cache.org/KnowledgeBase/VaryNotCaching/CategoryKnowledgeBase#">CategoryKnowledgeBase</ulink> </para></section></article>