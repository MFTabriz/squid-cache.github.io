<?xml version="1.0" encoding="utf-8"?><!DOCTYPE article  PUBLIC '-//OASIS//DTD DocBook XML V4.4//EN'  'http://www.docbook.org/xml/4.4/docbookx.dtd'><article><articleinfo><title>KnowledgeBase/NTLMAuthGoryDetails</title><revhistory><revision><revnumber>9</revnumber><date>2009-01-18 10:36:17</date><authorinitials>AmosJeffries</authorinitials><revremark>break intro paragragh to three</revremark></revision><revision><revnumber>8</revnumber><date>2009-01-18 10:34:34</date><authorinitials>AmosJeffries</authorinitials><revremark>informative article.</revremark></revision><revision><revnumber>7</revnumber><date>2008-05-18 19:38:57</date><authorinitials>localhost</authorinitials><revremark>converted to 1.6 markup</revremark></revision><revision><revnumber>6</revnumber><date>2006-08-24 14:48:19</date><authorinitials>kinkie</authorinitials><revremark>added external resources.</revremark></revision><revision><revnumber>5</revnumber><date>2005-01-13 21:56:33</date><authorinitials>ppp201-109.lns1.syd3.internode.on.net</authorinitials></revision><revision><revnumber>4</revnumber><date>2005-01-13 20:19:26</date><authorinitials>ppp201-109.lns1.syd3.internode.on.net</authorinitials></revision><revision><revnumber>3</revnumber><date>2005-01-13 20:18:48</date><authorinitials>ppp201-109.lns1.syd3.internode.on.net</authorinitials><revremark>Make the links clearer</revremark></revision><revision><revnumber>2</revnumber><date>2005-01-07 03:12:57</date><authorinitials>ppp207-236.lns1.syd3.internode.on.net</authorinitials></revision><revision><revnumber>1</revnumber><date>2005-01-04 22:25:27</date><authorinitials>kinkie</authorinitials><revremark>Initial revision, adapted from the version on sourceforge</revremark></revision></revhistory></articleinfo><section><title>Client-Squid NTLM authentication protocol description</title><para>This document details the mechanics of the <ulink url="http://davenport.sourceforge.net/ntlm.html">NTLM</ulink> authentication scheme as applied to Web proxies. </para><para>Client-side, it is supported by Microsoft's Internet Explorer and by Mozilla Firefox (now on all platforms). </para><para>Server-side it is supported by Microsoft Proxy / ISA Server (of course), Squid version 2.5 (only NTLMv1 up to Squid 2.5STABLE5), and via an Apache 1.3 module <ulink url="http://download.samba.org/ftp/unpacked/lorikeet/trunk/mod_ntlm_winbind/">mod_ntlm_winbind</ulink> is available from <ulink url="http://download.samba.org/ftp/unpacked/lorikeet/trunk/">Samba's lorkikeet repository</ulink>. </para><section><title>The mechanics of NTLM authentication</title><orderedlist numeration="arabic"><listitem><para> The client connects and issues a request without any authentication info. This happens for ALL new connections, unlike what happens with most Basic authentication implementations which will supply authentication information automatically for all connections after a successful authentication is performed. </para></listitem><listitem><para> The server returns a 407 status code, along with an header: <code> Proxy-Authenticate: NTLM </code> No realm, domain or anything is specified. Of course, additional Proxy-Authenticate headers might be supplied to announce other supported authentication schemes. There is a bug in all version of Microsoft Internet Explorer by which the NTLM authentication scheme MUST be declared first or it won't be selected. This goes against RFC 2616, which recites &quot;A user agent MUST choose to use the strongest auth scheme it understands&quot; and NTLM, while broken in many ways, is still worlds stronger than Basic. </para></listitem><listitem><para> At this point, Squid disconnects the connection, forcing the client to initiate a new connection, regardless of any keep-alive directives from the client. This is a bug-compatibility issue. It may not be required with HTTP/1.1, but there's no way to make sure. </para></listitem><listitem><para>The client re connects and issues a GET-request, this time with an accompanying <code>Proxy-Authorization: NTLM some_more_stuff</code> header, where some_more_stuff is a base64-encoded negotiate packet. The server once again replies with a 407 (&quot;proxy auth required&quot;) status code, along with an header: <code>Proxy-Authenticate: NTLM still_some_more_stuff</code> where some_more_stuff is a base64-encoded challenge packet. Somewhere in this packet is the challenge nonce. From here on it is vital that the TCP connection be kept alive, since all subsequent authentication-related information is tied to the TCP connection. If it's dropped, it's back to square one, authentication-wise. </para></listitem><listitem><para> The client sends a new GET-request, along with an header: <code>Proxy-Authenticate: NTLM cmon_we_are_almost_done</code> where cmon_we_are_almost_done is an authenticate packet. The packet includes informations about the user name and domain, the challenge nonce encoded with the user's password (actually it MIGHT contain it encoded TWICE using different algorithms). </para></listitem><listitem><para> Either the server denies the authentication via a 407/DENIED or 403/DENIED return code, and we're back to square one, or it returns the requested resource. From now on, until the TCP connection is  kept alive, no further credentials will be sent from the client to the proxy. The TCP connection is marked as &quot;OK&quot;, and the client expects that it can pump whatever it wants. </para></listitem></orderedlist></section><section><title>External resources</title><itemizedlist><listitem><para><ulink url="http://www.innovation.ch/personal/ronald/ntlm.html"/> </para></listitem><listitem><para><ulink url="http://davenport.sourceforge.net/ntlm.html"/> </para></listitem></itemizedlist></section></section></article>