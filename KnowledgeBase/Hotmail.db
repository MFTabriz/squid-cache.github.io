<?xml version="1.0" encoding="utf-8"?><!DOCTYPE article  PUBLIC '-//OASIS//DTD DocBook XML V4.4//EN'  'http://www.docbook.org/xml/4.4/docbookx.dtd'><article><articleinfo><title>KnowledgeBase/Hotmail</title><revhistory><revision><revnumber>2</revnumber><date>2011-05-18 00:39:36</date><authorinitials>AmosJeffries</authorinitials><revremark>mention userhash and sourcehash, they were created primarily for this site.</revremark></revision><revision><revnumber>1</revnumber><date>2011-05-12 12:42:16</date><authorinitials>AmosJeffries</authorinitials><revremark>Document the IP-based security artifacts. mostly historic now.</revremark></revision></revhistory></articleinfo><section><title>Troubleshooting: Hotmail.com</title><para><emphasis role="strong">Synopsis</emphasis> </para><para>This website contains several rather broken systems. As of March 2011 these problems have been known for most of a decade and left unfixed by the Webmasters. </para><para><emphasis role="strong">Symptoms</emphasis> </para><itemizedlist><listitem><para>Site complains about: <emphasis role="strong">Intrusion Logged. Access denied.</emphasis> </para></listitem></itemizedlist><para><emphasis role="strong">Explanation</emphasis> </para><para>HTTP is designed as a relay model, with a built-in concept of proxies and defined behaviour. It operates with stateless requests. These details are important when considering the Hotmail website. </para><para>The Hotmail is one of many websites with a security system is designed assuming a model of end-to-end client-to-server connectivity. </para><itemizedlist><listitem><para>It requires all requests to come from the same client IP address. </para></listitem><listitem><para>It requires all requests to go <emphasis role="strong">to</emphasis> the same server IP address. </para></listitem></itemizedlist><para>This latter detail betrays a historic browser behaviour of finding an IP that works for the website and re-using it for many connections. Squid historically did load balancing across all DNS provided IPs. </para><para>Hotmail is not unique in having this problem. There are many smaller websites which also exhibit these bad security decisions. Hotmail is merely the most popular and thus well-known (and longest lasting) problem. </para><para><emphasis role="strong">Workaround</emphasis> </para><para>There are several changes needed to work with Hotmail. Each with their own problems. </para><para>To force all client requests to go to a consistent IP address you must disable destination load balancing in all network Systems when connecting to Hotmail. Turned <emphasis role="strong">off</emphasis> the Squid <ulink url="http://www.squid-cache.org/Doc/config/balance_on_multiple_ip#">balance_on_multiple_ip</ulink> directive. Other load balancing software may or may not have similar controls. </para><para>To force all client requests to go to Hotmail with consistent IPs. You can do one of a few things: </para><itemizedlist><listitem><para>Proxy clusters can use the <emphasis role="strong">usernamehash</emphasis> or <emphasis role="strong">sourcehash</emphasis> <ulink url="http://www.squid-cache.org/Doc/config/cache_peer#">cache_peer</ulink> algorithms to limit the HTTP request flow without hindering load balancing too much. </para></listitem><listitem><para>Recent Squid releases with TPROXYv4 support are able to spoof the client IP on their contacts. This spoofing gets around the website security system by allowing it access to the client IP. Effectively making it believe the proxy is not there. This can be complex to debug if things go wrong and requires modern systems from the kernel up. </para></listitem><listitem><para>Older Squid releases can use <ulink url="http://www.squid-cache.org/Doc/config/tcp_outgoing_address#">tcp_outgoing_address</ulink> directive Forcing all outgoing requests to Hotmail to use a fixed Squid outbound IP. This risks the old well-known problem that Hotmail <emphasis>Single-Sign-On</emphasis> is linked to the IP address as well and all clients visiting through the proxy may get to see each others email boxes. </para></listitem><listitem><para>Alternatively you can use NAT to set the outbound connection IP from a range of IPs so each client has a temporary but distinct IP for their entire Hotmail session. </para></listitem></itemizedlist><!--rule (<hr>) is not applicable to DocBook--><para> <ulink url="https://wiki.squid-cache.org/KnowledgeBase/Hotmail/CategoryKnowledgeBase#">CategoryKnowledgeBase</ulink> <ulink url="https://wiki.squid-cache.org/KnowledgeBase/Hotmail/SquidFaq/TroubleShooting#">SquidFaq/TroubleShooting</ulink> </para></section></article>