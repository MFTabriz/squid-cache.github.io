##master-page:Features/FeatureTemplate
#format wiki
#language en
##
## Change to 'yes' for a listing under Features in the Squid FAQ.
#faqlisted no

= Feature: SSL Peek and Splice =

 * '''Goal''': Make bumping decisions after the origin server name is known, especially when intercepting SSL. Avoid bumping non-SSL traffic.
 * '''Status''': in progress
 * '''Version''': 3.5
 * '''Developer''': AlexRousskov and Christos Tsantilas
 * '''Priority''': 2
 * '''More''': unofficial development [[https://code.launchpad.net/~measurement-factory/squid/peek-and-splice|branch]].


= Motivation =

Many SslBump deployments try to minimize potential damage by ''not'' bumping sites unless the local policy demands it. Without this feature, the decision is made based on very limited information: A typical HTTP CONNECT request does not contain many details and intercepted TCP connections reveal nothing but IP addresses and port numbers. Peek and Splice gives admins a way to make bumping decision later in the SSL handshake process, when the SSL server certificate is available (or when it becomes clear that we are not dealing with an SSL connection at all!).

The feature also paves the way for SSL SNI support. Without it, Squid cannot forward client SNI info to the SSL server (Squid can send its own SNI when bumping CONNECT requests, but even that is not reliable and does not work at all for intercepted SSL connections because they lack server name information).


= Implementation overview =

Peek and Splice peeks at the SSL client Hello message (if any), sends a similar (to the extent possible) Hello message to the SSL server, peeks at the SSL server Hello message, and then decides whether to bump. If the decision is ''not'' to bump, the server Hello message is forwarded to the client and the two TCP connections are spliced at TCP level, with Squid shoveling TCP bytes back and forth without any decryption.


== Mimicked SSL client Hello properties ==

This section documents how SSL client Hello message fields are generated by Squid.

||'''SSL client Hello field'''||'''Forwarded?'''||'''Comments'''||
||SSL Version||yes||SSL v3 and above (i.e. TLS) only.||
||Ciphers list||yes|| ||
||Server name||yes|| ||
||Ciphers list||yes|| ||
||Random bytes||yes|| ||
||Compression||partially||Compression request flag is mimicked. If compression is requested by the client, then the compression algorithm in the mimicked message is set by Squid OpenSSL (instead of being copied from the client message). This may be OK because the only widely used algorithm is deflate. It is possible that OpenSSL does not support other compression algorithms.||
||TLS extensions||no||We will probably need to mimic at least some of these for splicing TLS connections to work.||
||other||no||There are probably other fields. We should probably mimic some of them. However, blindly forwarding everything is probably a bad idea because it is likely to lead to SSL negotiation failures during bumping.||

= Limitations =

TBD.

----
CategoryFeature
