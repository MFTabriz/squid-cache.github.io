<?xml version="1.0" encoding="utf-8"?><!DOCTYPE article  PUBLIC '-//OASIS//DTD DocBook XML V4.4//EN'  'http://www.docbook.org/xml/4.4/docbookx.dtd'><article><articleinfo><title>Features/ICAP</title><revhistory><revision><revnumber>15</revnumber><date>2015-09-21 04:47:50</date><authorinitials>AmosJeffries</authorinitials></revision><revision><revnumber>14</revnumber><date>2015-09-21 04:45:43</date><authorinitials>AmosJeffries</authorinitials></revision><revision><revnumber>13</revnumber><date>2015-09-21 04:45:22</date><authorinitials>AmosJeffries</authorinitials></revision><revision><revnumber>12</revnumber><date>2013-07-26 10:35:04</date><authorinitials>NathanHoad</authorinitials><revremark>Added information about a previously undocumented &quot;limitation&quot; of Squid's 204 ICAP support.</revremark></revision><revision><revnumber>11</revnumber><date>2011-01-05 11:17:13</date><authorinitials>eu.squid-cache.org</authorinitials><revremark>Adding another ICAP implementation (GreasySpoon) to the list</revremark></revision><revision><revnumber>10</revnumber><date>2011-01-05 11:14:23</date><authorinitials>eu.squid-cache.org</authorinitials><revremark>Trivial change, seperate &quot;pros&quot; and &quot;cons&quot; lines for readability</revremark></revision><revision><revnumber>9</revnumber><date>2010-12-08 00:50:22</date><authorinitials>Henrik Nordstr√∂m</authorinitials><revremark>Added icap-server</revremark></revision><revision><revnumber>8</revnumber><date>2010-02-02 10:02:39</date><authorinitials>AmosJeffries</authorinitials><revremark>updates for current 3.1 status. and some squidconf wiki-links</revremark></revision><revision><revnumber>7</revnumber><date>2009-03-06 07:08:17</date><authorinitials>AmosJeffries</authorinitials><revremark>typos in 3.1 example</revremark></revision><revision><revnumber>6</revnumber><date>2009-01-26 01:32:27</date><authorinitials>AmosJeffries</authorinitials><revremark>pull in configuration detaild from release notes. 3.1 config is inferred from changes, not confirmed yet.</revremark></revision><revision><revnumber>5</revnumber><date>2008-11-23 01:17:48</date><authorinitials>AmosJeffries</authorinitials><revremark>update meta data</revremark></revision><revision><revnumber>4</revnumber><date>2008-10-10 00:49:38</date><authorinitials>AmosJeffries</authorinitials><revremark>update for FAQ listing.</revremark></revision><revision><revnumber>3</revnumber><date>2008-09-25 03:30:47</date><authorinitials>AlexRousskov</authorinitials><revremark>Amos fixed the link</revremark></revision><revision><revnumber>2</revnumber><date>2008-09-25 02:37:32</date><authorinitials>AmosJeffries</authorinitials><revremark>reference implementation has new URL</revremark></revision><revision><revnumber>1</revnumber><date>2008-09-14 03:07:43</date><authorinitials>AmosJeffries</authorinitials><revremark>Break out of squid FAQ. It's a feature.</revremark></revision></revhistory></articleinfo><section><title>Feature: ICAP (Internet Content Adaptation Protocol)</title><itemizedlist><listitem><para><emphasis role="strong">Status</emphasis>: completed </para></listitem><listitem><para><emphasis role="strong">Version</emphasis>: 3.0 </para></listitem><listitem><para><emphasis role="strong">Developer</emphasis>: <ulink url="https://wiki.squid-cache.org/Features/ICAP/AlexRousskov#">AlexRousskov</ulink> </para></listitem></itemizedlist><section><title>Background</title><para>Internet Content Adaptation Protocol (RFC <ulink url="http://www.rfc-editor.org/rfc/rfc3507.txt">3507</ulink>, subject to <ulink url="http://www.measurement-factory.com/std/icap/">errata</ulink>) specifies how an HTTP proxy (an ICAP client) can outsource content adaptation to an external ICAP server. Most popular proxies, including Squid, support ICAP. If your adaptation algorithm resides in an ICAP server, it will be able to work in a variety of environments and will not depend on a single proxy project or vendor. No proxy code modifications are necessary for most content adaptations using ICAP. </para><itemizedlist><listitem override="none"><para><emphasis role="strong">Pros</emphasis>: Proxy-independent, adaptation-focused API, no Squid modifications, supports remote adaptation servers, scalable. <emphasis role="strong">Cons</emphasis>: Communication delays, protocol functionality limitations, needs a stand-alone ICAP server process or box. </para></listitem></itemizedlist><para>One proxy may access many ICAP servers, and one ICAP server may be accessed by many proxies. An ICAP server may reside on the same physical machine as Squid or run on a remote host. Depending on configuration and context, some ICAP failures can be bypassed, making them invisible to proxy end-users. </para><section><title>ICAP Servers</title><para>While writing yet another ICAP server from scratch is always a possibility, the following ICAP servers can be modified to support the adaptations you need. Some ICAP servers even accept custom adaptation modules or plugins. </para><itemizedlist><listitem><para><ulink url="http://c-icap.sourceforge.net/">C-ICAP</ulink> (C) </para></listitem><listitem><para><ulink url="http://spicer.measurement-factory.com/">Traffic Spicer</ulink> (C++) </para></listitem><listitem><para><ulink url="http://icap-server.sourceforge.net">ICAP-Server</ulink> (Python) </para></listitem><listitem><para><ulink url="http://www.poesia-filter.org/">POESIA</ulink> (Java) </para></listitem><listitem><para><ulink url="http://greasyspoon.sourceforge.net/">GreasySpoon</ulink> (Java and Javascript) </para></listitem><listitem><para>original <ulink url="http://www.icap-forum.org/documents/other/icap-server10.zip">reference implementation</ulink> by Network Appliance. </para></listitem></itemizedlist><para>The above list is not comprehensive and is not meant as an endorsement. Any ICAP server will have unique set of pros and cons in the context of your adaptation project. </para><para>More information about ICAP is available on the ICAP <ulink url="http://www.icap-forum.org/">Forum</ulink>. While the Forum site has not been actively maintained, its members-only <ulink url="http://www.icap-forum.org/chat/">newsgroup</ulink> is still a good place to discuss ICAP issues. </para></section></section><section><title>Squid Details</title><para><ulink url="https://wiki.squid-cache.org/Features/ICAP/Squid-3.0#">Squid-3.0</ulink> and later come with integrated ICAP support. Pre-cache REQMOD and RESPMOD vectoring points are supported, including request satisfaction. Squid-2 has limited ICAP support via a set of poorly maintained and very buggy patches. It is worth noting that the Squid developers no longer officially support the Squid-2 ICAP work. </para><para>Squid supports receiving 204 (no modification) responses from ICAP servers. This is typically used when the server wants to perform no modifications on a HTTP message. It is useful to save bandwidth by preventing the server from sending the HTTP message back to Squid as it was received. There are two situations however where Squid will not accept a 204 response: </para><itemizedlist><listitem><para>The size of the payload is greater than 64kb. </para></listitem><listitem><para>The size of the payload cannot be (easily) ascertained. </para></listitem></itemizedlist><para>The reason for this is simple: If the server is to respond to Squid with a 204, Squid needs to maintain a copy of the original HTTP message in memory. These two basic requirements are a basic optimisation to limit Squid's memory usage in supporting 204s. </para></section><section><title>Squid Configuration</title><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/idea.png" width="15"/></imageobject><textobject><phrase>(!)</phrase></textobject></inlinemediaobject> ICAP server configuration should be detailed in the server documentation. Squid is expected to work with any of them. <inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> The configuration of Squid-3 underwent a change between <ulink url="https://wiki.squid-cache.org/Features/ICAP/Squid-3.0#">Squid-3.0</ulink> and <ulink url="https://wiki.squid-cache.org/Features/ICAP/Squid-3.1#">Squid-3.1</ulink> </para></listitem></itemizedlist><section><title>Squid 3.1</title><para>The following example instructs <ulink url="https://wiki.squid-cache.org/Features/ICAP/Squid-3.1#">Squid-3.1</ulink> to talk to two ICAP services, one for request and one for response adaptation: </para><screen><![CDATA[icap_enable on
]]><![CDATA[
icap_service service_req reqmod_precache bypass=1 icap://127.0.0.1:1344/request
adaptation_access service_req allow all
]]><![CDATA[
icap_service service_resp respmod_precache bypass=0 icap://127.0.0.1:1344/response
adaptation_access service_resp allow all]]></screen><itemizedlist><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/adaptation_access#">adaptation_access</ulink> </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/adaptation_service_set#">adaptation_service_set</ulink> </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/icap_client_username_encode#">icap_client_username_encode</ulink> </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/icap_client_username_header#">icap_client_username_header</ulink> </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/icap_connect_timeout#">icap_connect_timeout</ulink> </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/icap_default_options_ttl#">icap_default_options_ttl</ulink> </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/icap_enable#">icap_enable</ulink> </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/icap_io_timeout#">icap_io_timeout</ulink> </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/icap_persistent_connections#">icap_persistent_connections</ulink> </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/icap_preview_enable#">icap_preview_enable</ulink> </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/icap_preview_size#">icap_preview_size</ulink> </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/icap_send_client_ip#">icap_send_client_ip</ulink> </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/icap_send_client_username#">icap_send_client_username</ulink> </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/icap_service#">icap_service</ulink> </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/icap_service_failure_limit#">icap_service_failure_limit</ulink> </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/icap_service_revival_delay#">icap_service_revival_delay</ulink> </para></listitem></itemizedlist></section><section><title>Squid 3.0</title><para>The following example instructs <ulink url="https://wiki.squid-cache.org/Features/ICAP/Squid-3.0#">Squid-3.0</ulink> to talk to two ICAP services, one for request and one for response adaptation: </para><screen><![CDATA[icap_enable on
]]><![CDATA[
icap_service service_req reqmod_precache 1 icap://127.0.0.1:1344/request
icap_class class_req service_req
icap_access class_req allow all
]]><![CDATA[
icap_service service_resp respmod_precache 0 icap://127.0.0.1:1344/response
icap_class class_resp service_resp
icap_access class_resp allow all]]></screen><para>There are other options which can control various aspects of ICAP: </para><itemizedlist><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/icap_access#">icap_access</ulink> </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/icap_class#">icap_class</ulink> </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/icap_client_username_encode#">icap_client_username_encode</ulink> </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/icap_client_username_header#">icap_client_username_header</ulink> </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/icap_connect_timeout#">icap_connect_timeout</ulink> </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/icap_default_options_ttl#">icap_default_options_ttl</ulink> </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/icap_enable#">icap_enable</ulink> </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/icap_io_timeout#">icap_io_timeout</ulink> </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/icap_persistent_connections#">icap_persistent_connections</ulink> </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/icap_preview_enable#">icap_preview_enable</ulink> </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/icap_preview_size#">icap_preview_size</ulink> </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/icap_send_client_ip#">icap_send_client_ip</ulink> </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/icap_send_client_username#">icap_send_client_username</ulink> </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/icap_service#">icap_service</ulink> </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/icap_service_failure_limit#">icap_service_failure_limit</ulink> </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/icap_service_revival_delay#">icap_service_revival_delay</ulink> </para></listitem></itemizedlist><!--rule (<hr>) is not applicable to DocBook--><itemizedlist><listitem override="none"><para><ulink url="https://wiki.squid-cache.org/Features/ICAP/CategoryFeature#">CategoryFeature</ulink> </para></listitem></itemizedlist></section></section></section></article>