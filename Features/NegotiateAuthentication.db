<?xml version="1.0" encoding="utf-8"?><!DOCTYPE article  PUBLIC '-//OASIS//DTD DocBook XML V4.4//EN'  'http://www.docbook.org/xml/4.4/docbookx.dtd'><article><articleinfo><title>Features/NegotiateAuthentication</title><revhistory><revision><revnumber>14</revnumber><date>2012-01-12 03:56:40</date><authorinitials>AmosJeffries</authorinitials><revremark>polish up the 'what do I need' texts and a split off Testing and Troubleshooting sections</revremark></revision><revision><revnumber>13</revnumber><date>2011-12-29 10:10:55</date><authorinitials>AmosJeffries</authorinitials><revremark>move generic intro to Features/Authentication and polish a little. TODO a re-write of the last section of this page.</revremark></revision><revision><revnumber>12</revnumber><date>2011-03-17 10:44:11</date><authorinitials>AmosJeffries</authorinitials><revremark>link helper protocol details from addons page.</revremark></revision><revision><revnumber>11</revnumber><date>2011-03-17 03:49:51</date><authorinitials>AmosJeffries</authorinitials><revremark>some polish. The how do I use it o Linux/Unix needs an update still.</revremark></revision><revision><revnumber>10</revnumber><date>2009-01-14 00:11:36</date><authorinitials>AmosJeffries</authorinitials><revremark>there were apparently more authors.</revremark></revision><revision><revnumber>9</revnumber><date>2009-01-12 07:20:02</date><authorinitials>AmosJeffries</authorinitials><revremark>drop pre-2.6 details. import feature template intro.</revremark></revision><revision><revnumber>8</revnumber><date>2009-01-12 07:03:11</date><authorinitials>AmosJeffries</authorinitials><revremark>this is a feature description</revremark></revision><revision><revnumber>7</revnumber><date>2008-05-18 19:38:57</date><authorinitials>localhost</authorinitials><revremark>converted to 1.6 markup</revremark></revision><revision><revnumber>6</revnumber><date>2006-10-03 12:30:09</date><authorinitials>rpivato</authorinitials><revremark>fixed bad WikiName... put InterWiki links</revremark></revision><revision><revnumber>5</revnumber><date>2006-03-25 15:26:30</date><authorinitials>GuidoSerassio</authorinitials></revision><revision><revnumber>4</revnumber><date>2006-03-25 12:45:27</date><authorinitials>GuidoSerassio</authorinitials><revremark>Added reference to the nego-nt-2.5 package</revremark></revision><revision><revnumber>3</revnumber><date>2006-03-25 11:54:16</date><authorinitials>GuidoSerassio</authorinitials><revremark>Added info on nego-nt-2.5</revremark></revision><revision><revnumber>2</revnumber><date>2005-10-22 18:11:01</date><authorinitials>kinkie</authorinitials><revremark>Removed the redundant title</revremark></revision><revision><revnumber>1</revnumber><date>2005-10-22 18:10:18</date><authorinitials>kinkie</authorinitials><revremark>First revision.</revremark></revision></revhistory></articleinfo><section><title>Feature: Negotiate Authentication</title><itemizedlist><listitem><para><emphasis role="strong">Goal</emphasis>: Make Squid support Negotiate authentication protocol. </para></listitem><listitem><para><emphasis role="strong">Status</emphasis>: Complete. </para></listitem><listitem><para><emphasis role="strong">Version</emphasis>: 2.6+ </para></listitem><listitem><para><emphasis role="strong">Developer</emphasis>: <ulink url="https://wiki.squid-cache.org/Features/NegotiateAuthentication/GuidoSerassio#">GuidoSerassio</ulink>, <ulink url="https://wiki.squid-cache.org/Features/NegotiateAuthentication/HenrikNordstrom#">HenrikNordstrom</ulink>, <ulink url="https://wiki.squid-cache.org/Features/NegotiateAuthentication/RobertCollins#">RobertCollins</ulink>, <ulink url="https://wiki.squid-cache.org/Features/NegotiateAuthentication/FrancescoChemolli#">FrancescoChemolli</ulink> </para></listitem><listitem><para><emphasis role="strong">More</emphasis>: <ulink url="http://squid.acmeconsulting.it/"/> </para></listitem></itemizedlist></section><section><title>Details</title><para><emphasis role="strong">Negotiate</emphasis> is a wrapper protocol around GSSAPI, which in turn is a wrapper around either Kerberos or NTLM authentication. Why a wrapper of a wrapper? No one outside Microsoft knows at this time. GSSAPI would have been more than enough. </para><para>The real significance is that supporting it allows support of transparent Kerberos authentication to a MS Windows domain. It is significantly more secure than NTLM and also poses much less burden on the Domain Controller. </para><para>See <ulink url="https://wiki.squid-cache.org/Features/NegotiateAuthentication/Features/Authentication#">Features/Authentication</ulink> for details on other schemes supported by Squid and how authentication in general works. </para><section><title>How does it work in Squid?</title><para>Negotiate is at the one time both very simple and somewhat complex. Squids part has been kept intentionally minor and simple to improve the overall system security. </para><para>The authentication helper is left to perform all of the risky security encryption and validation processes. Squid may contact it initially for a challenge token and blindly relay this to the client. Any credentials or tokens presented by the client are passed untouched to the helper. </para><para>The protocol lines used to do this are described below. This same protocol is used to contact both NTLM and Negotiate authentication helpers. This allows Squid to support both Negotiate/Kerberos and Negotiate/NTLM flavours through the one protocol configuration. </para><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> This double support does lead to some administrative confusion when the helper does not support the same flavour as the client browser. </para></listitem></itemizedlist><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> These authenticator schemes do not support concurrency due to the statefulness of NTLM. </para></listitem></itemizedlist><para>Input line received from Squid: </para><screen><![CDATA[ request [credentials] [key-extras]]]></screen><glosslist><glossentry><glossterm>request</glossterm><glossdef><itemizedlist><listitem override="none"><para>One of the request codes: </para><informaltable><tgroup cols="2"><colspec colname="col_0"/><colspec colname="col_1"/><tbody><row rowsep="1"><entry colsep="1" rowsep="1"><para> YR </para></entry><entry colsep="1" rowsep="1"><para> A new challenge token is needed. This is always the first communication between the two processes. It may also occur at any time that Squid needs a new challenge, due to the <ulink url="http://www.squid-cache.org/Doc/config/auth_param#">auth_param</ulink> max_challenge_lifetime and max_challenge_uses parameters. The helper should respond with a <emphasis role="strong">TT</emphasis> message. </para></entry></row><row rowsep="1"><entry colsep="1" rowsep="1"><para> KK </para></entry><entry colsep="1" rowsep="1"><para> Authenticate a user's credentials. The helper responds with either <emphasis role="strong">OK</emphasis>, <emphasis role="strong">ERR</emphasis>, <emphasis role="strong">AF</emphasis>, <emphasis role="strong">NA</emphasis>, or <emphasis role="strong">BH</emphasis>. </para></entry></row></tbody></tgroup></informaltable></listitem></itemizedlist></glossdef></glossentry><glossentry><glossterm>credentials</glossterm><glossdef><itemizedlist><listitem override="none"><para>An encoded blob exactly as received in the HTTP headers. This field is only sent on <emphasis role="strong">KK</emphasis> requests. </para></listitem></itemizedlist></glossdef></glossentry><glossentry><glossterm>key-extras</glossterm><glossdef><itemizedlist><listitem override="none"><para>Additional parameters passed to the helper which may be configured with <ulink url="http://www.squid-cache.org/Doc/config/auth_param#">auth_param</ulink> <emphasis>key_extras</emphasis> parameter. Only available in <ulink url="https://wiki.squid-cache.org/Features/NegotiateAuthentication/Squid-3.5#">Squid-3.5</ulink> and later. </para></listitem></itemizedlist></glossdef></glossentry></glosslist><para>Result line sent back to Squid: </para><screen><![CDATA[ result [token label] [kv-pair] [message]]]></screen><glosslist><glossentry><glossterm>result</glossterm><glossdef><itemizedlist><listitem override="none"><para>One of the result codes: </para><informaltable><tgroup cols="2"><colspec colname="col_0"/><colspec colname="col_1"/><tbody><row rowsep="1"><entry colsep="1" rowsep="1"><para> TT </para></entry><entry colsep="1" rowsep="1"><para> Success. A new challenge <emphasis role="strong">token</emphasis> value is presented. </para></entry></row><row rowsep="1"><entry colsep="1" rowsep="1"><para> AF </para></entry><entry colsep="1" rowsep="1"><para> Success. Valid credentials. Deprecated by <emphasis role="strong">OK</emphasis> result from Squid-3.4 onwards. </para></entry></row><row rowsep="1"><entry colsep="1" rowsep="1"><para> NA </para></entry><entry colsep="1" rowsep="1"><para> Success. Invalid credentials. Deprecated by <emphasis role="strong">ERR</emphasis> result from Squid-3.4 onwards. </para></entry></row><row rowsep="1"><entry colsep="1" rowsep="1"><para> OK </para></entry><entry colsep="1" rowsep="1"><para> Success. Valid Credentials. </para></entry></row><row rowsep="1"><entry colsep="1" rowsep="1"><para> ERR </para></entry><entry colsep="1" rowsep="1"><para> Success. Invalid credentials. </para></entry></row><row rowsep="1"><entry colsep="1" rowsep="1"><para> BH </para></entry><entry colsep="1" rowsep="1"><para> Failure. The helper encountered a problem. </para></entry></row></tbody></tgroup></informaltable></listitem><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> the <emphasis role="strong">OK</emphasis> and <emphasis role="strong">ERR</emphasis> result codes are only accepted by <ulink url="https://wiki.squid-cache.org/Features/NegotiateAuthentication/Squid-3.4#">Squid-3.4</ulink> and newer. </para></listitem></itemizedlist></glossdef></glossentry><glossentry><glossterm>token</glossterm><glossdef><itemizedlist><listitem override="none"><para>A new challenge <emphasis role="strong">token</emphasis> value is presented. The token is base64-encoded, as defined by RFC <ulink url="https://tools.ietf.org/rfc/rfc2045#">2045</ulink>.</para><para> <inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> NOTE: NTLM authenticator interface on Squid-3.3 and older does not support a <emphasis role="strong">token</emphasis> field. Negotiate authenticator interface requires it on <emphasis role="strong">TT</emphasis>, <emphasis role="strong">AF</emphasis> and <emphasis role="strong">NA</emphasis> responses.</para><para> <inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> This field must not be sent on <emphasis role="strong">OK</emphasis>, <emphasis role="strong">ERR</emphasis> and <emphasis role="strong">BH</emphasis> responses. </para></listitem></itemizedlist></glossdef></glossentry><glossentry><glossterm>label</glossterm><glossdef><itemizedlist><listitem override="none"><para>The label given here is what gets used by Squid for this client request <emphasis role="strong">&quot;username&quot;</emphasis>. This field is only accepted on <emphasis role="strong">AF</emphasis> responses. It must not be sent on any other result code response. </para></listitem></itemizedlist></glossdef></glossentry><glossentry><glossterm>kv-pair</glossterm><glossdef><itemizedlist><listitem override="none"><para>One or more key=value pairs. The key names reserved on this interface: </para><informaltable><tgroup cols="2"><colspec colname="col_0"/><colspec colname="col_1"/><tbody><row rowsep="1"><entry colsep="1" rowsep="1"><para> clt_conn_tag=... </para></entry><entry colsep="1" rowsep="1"><para> Tag the client TCP connection (<ulink url="https://wiki.squid-cache.org/Features/NegotiateAuthentication/Squid-3.5#">Squid-3.5</ulink>) </para></entry></row><row rowsep="1"><entry colsep="1" rowsep="1"><para> group=... </para></entry><entry colsep="1" rowsep="1"><para> reserved </para></entry></row><row rowsep="1"><entry colsep="1" rowsep="1"><para> message=... </para></entry><entry colsep="1" rowsep="1"><para> A message string that Squid can display on an error page. </para></entry></row><row rowsep="1"><entry colsep="1" rowsep="1"><para> tag=... </para></entry><entry colsep="1" rowsep="1"><para> reserved </para></entry></row><row rowsep="1"><entry colsep="1" rowsep="1"><para> token=... </para></entry><entry colsep="1" rowsep="1"><para> The base64-encoded, as defined by RFC <ulink url="https://tools.ietf.org/rfc/rfc2045#">2045</ulink>, token to be used. This field is only used on <emphasis role="strong">OK</emphasis> responses. </para></entry></row><row rowsep="1"><entry colsep="1" rowsep="1"><para> ttl=... </para></entry><entry colsep="1" rowsep="1"><para> reserved </para></entry></row><row rowsep="1"><entry colsep="1" rowsep="1"><para> user=... </para></entry><entry colsep="1" rowsep="1"><para> The label to be used by Squid for this client request as <emphasis role="strong">&quot;username&quot;</emphasis>. With Negotiate and NTLM protocols it typically has the format NAME@DOMAIN or NAME\\DOMAIN respectively. </para></entry></row><row rowsep="1"><entry colsep="1" rowsep="1"><para> *_=... </para></entry><entry colsep="1" rowsep="1"><para> Key names ending in (_) are reserved for local administrators use. </para></entry></row></tbody></tgroup></informaltable></listitem><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> the kv-pair field is only accepted by <ulink url="https://wiki.squid-cache.org/Features/NegotiateAuthentication/Squid-3.4#">Squid-3.4</ulink> and newer. </para></listitem><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> the kv-pair returned by this helper can be logged by the <emphasis role="strong">%note</emphasis> <ulink url="http://www.squid-cache.org/Doc/config/logformat#">logformat</ulink> code. </para></listitem><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/alert.png" width="15"/></imageobject><textobject><phrase>/!\</phrase></textobject></inlinemediaobject> This field is only accepted on <emphasis role="strong">OK</emphasis>, <emphasis role="strong">ERR</emphasis> and <emphasis role="strong">BH</emphasis> responses and must not be sent on other responses. </para></listitem></itemizedlist></glossdef></glossentry><glossentry><glossterm>message</glossterm><glossdef><itemizedlist><listitem override="none"><para>A message string that Squid can display on an error page. This field is only accepted on <emphasis role="strong">NA</emphasis> and <emphasis role="strong">BH</emphasis> responses. From <ulink url="https://wiki.squid-cache.org/Features/NegotiateAuthentication/Squid-3.4#">Squid-3.4</ulink> this field is deprecated by the <emphasis role="strong">message=</emphasis> kv-pair on <emphasis role="strong">BH</emphasis> responses. </para></listitem></itemizedlist></glossdef></glossentry></glosslist></section><section><title>Squid native Windows build with NEGOTIATE support</title><para>A native Windows build of Squid with Negotiate support. Binary package and source archive are available on <ulink url="http://squid.acmeconsulting.it/"/>. </para></section><section><title>What do I need to do to support NEGOTIATE on Squid?</title><para>Just like any other security protocol, support for Negotiate in Squid is made up by two parts: </para><orderedlist numeration="arabic"><listitem><para>code within Squid to talk to the client. </para><itemizedlist><listitem><para><ulink url="https://wiki.squid-cache.org/Features/NegotiateAuthentication/Squid-2.6#">Squid-2.6</ulink> or later built with <code>--enable-auth=&quot;negotiate&quot;</code>  </para></listitem><listitem><para><ulink url="https://wiki.squid-cache.org/Features/NegotiateAuthentication/Squid-3.2#">Squid-3.2</ulink> or later built with <code>--enable-auth-negotiate</code> </para></listitem></itemizedlist></listitem><listitem><para>one or more authentication helpers which perform the grunt work. </para><itemizedlist><listitem><para>ntlm_auth from Samba 4 with the <code>--helper-protocol=gss-spnego</code> parameter </para></listitem><listitem><para>negotiate_wrapper or squid_kerb_auth by Markus Moeller </para></listitem><listitem><para>win32_negotiate_auth.exe on windows </para></listitem></itemizedlist></listitem></orderedlist><para>Of course the protocol needs to be enabled in the configuration file for everything to work. </para><screen><![CDATA[auth_param negotiate program /usr/sbin/squid_kerb_auth]]></screen><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> All other negotiate parameters are optional. see <ulink url="http://www.squid-cache.org/Doc/config/auth_param#">auth_param</ulink> NEGOTIATE section for more details. </para></listitem></itemizedlist></section><section><title>Testing</title><section><title>Testing Squid</title><para>Send any URL with a GET or any other request via Squid. </para><screen><![CDATA[squidclient http://example.com/]]></screen><para>Squid when setup correctly replies with <emphasis>Proxy-Authenticate: Negotiate</emphasis> like shown: </para><screen><![CDATA[HTTP/1.1 407 Proxy Authentication Required
Server: squid/3.2.0.14
Mime-Version: 1.0
Date: Thu, 12 Jan 2012 03:41:33 GMT
Proxy-Authenticate: Negotiate
...]]></screen></section><section><title>Testing the win32 helper from Unix</title><para>If you want to test the UNIX side of things out, there actually is a way to access the win32 helper from a Unix box, and that is by performing an &quot;authorized man-in-the-middle attack&quot;, as follows: </para><itemizedlist><listitem><para>You need to have an sshd running on the windows box (not a small feat by itself, but it's outside the scope of this document - see <ulink url="http://www.cygwin.com/"/> for details). Notice that it <emphasis role="strong">has</emphasis> to be running as the SYSTEM account. </para></listitem><listitem><para>Create an ssh keypair for the squid user on the Unix box - it's better if the public key is not password-protected. </para></listitem><listitem><para>If it doesn't already exist, create an entry in /etc/passwd for the user 'system', specifying an homedir for him (let's call it /home/system from now on). </para></listitem><listitem><para>Create a /home/system/.ssh directory on the windows box, and copy within its authorized_keys file the public key of the squid user on the unix box. Try connecting from the unix box (you can run bash over ssh), save the server key and check that everything works. </para></listitem><listitem><para>You need to have the <emphasis>setspn</emphasis> tool from the MS Windows Resource Kit. You need to add the service name of the squid box to the windows box machine account, using the command </para><itemizedlist><listitem override="none"><screen><![CDATA[   setspn -A HTTP/netbiosname
   setspn -A HTTP/netbiosname.domain]]></screen></listitem></itemizedlist></listitem><listitem><para>configure as helper in squid.conf ssh calling into the helper (make sure that the helper is within %PATH%, i.e. </para><itemizedlist><listitem override="none"><screen><![CDATA[   auth_param negotiate ssh system@netbiosname.domain "win32_negotiate_auth.exe"]]></screen></listitem></itemizedlist></listitem></itemizedlist></section></section><section><title>Troubleshooting</title><section><title>Token type errors</title><para>The token first presented by the client is used by helpers to identify which flavour is being used: </para><itemizedlist><listitem><para><emphasis role="strong">type 1 token</emphasis> - NTLM </para></listitem><listitem><para><emphasis role="strong">type 2 token</emphasis> - Kerberos </para></listitem></itemizedlist><para>You may see warnings or errors mentioning either of these token types with Negotiate authentication. Particularly common are problems with type 1 when configured with Kerberos helpers. </para><para>The issue is a mismatch between the client and helper capabilities. The <emphasis>negotiate_wrapper</emphasis> helper is currently the only helper known which can handle both types at once. </para><!--rule (<hr>) is not applicable to DocBook--><para> <ulink url="https://wiki.squid-cache.org/Features/NegotiateAuthentication/CategoryFeature#">CategoryFeature</ulink> </para></section></section></section></article>