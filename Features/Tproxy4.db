<?xml version="1.0" encoding="utf-8"?><!DOCTYPE article  PUBLIC '-//OASIS//DTD DocBook XML V4.4//EN'  'http://www.docbook.org/xml/4.4/docbookx.dtd'><article><articleinfo><title>Features/Tproxy4</title><revhistory><revision><revnumber>74</revnumber><date>2019-10-22 10:52:24</date><authorinitials>AmosJeffries</authorinitials></revision><revision><revnumber>73</revnumber><date>2017-08-21 20:21:55</date><authorinitials>Eliezer Croitoru</authorinitials><revremark>Added &quot;spoof_client_ip config directive&quot; section</revremark></revision><revision><revnumber>72</revnumber><date>2015-09-21 03:40:53</date><authorinitials>AmosJeffries</authorinitials></revision><revision><revnumber>71</revnumber><date>2015-04-23 06:05:33</date><authorinitials>AmosJeffries</authorinitials><revremark>mention BSD support</revremark></revision><revision><revnumber>70</revnumber><date>2013-10-24 05:59:12</date><authorinitials>AmosJeffries</authorinitials><revremark>restore ip6tables mention</revremark></revision><revision><revnumber>69</revnumber><date>2013-10-24 05:42:46</date><authorinitials>AmosJeffries</authorinitials><revremark>export bridge details to a dedicated ConfigExamples page so we can include it in examples unrelated to TPROXY</revremark></revision><revision><revnumber>68</revnumber><date>2012-09-24 10:39:50</date><authorinitials>AmosJeffries</authorinitials><revremark>sysctl.conf settings confirmed broken. here are the accurate ones.</revremark></revision><revision><revnumber>67</revnumber><date>2012-06-27 00:39:37</date><authorinitials>AmosJeffries</authorinitials><revremark>ebtables requires --ip6-* options not --ip-* - Thanks to Pawl Mojski for testing.</revremark></revision><revision><revnumber>66</revnumber><date>2012-03-25 05:20:19</date><authorinitials>AmosJeffries</authorinitials><revremark>fwmark rules need separate IPv4 and IPv6 entries. Otherwise IPv6 will not redirect</revremark></revision><revision><revnumber>65</revnumber><date>2012-03-25 03:27:56</date><authorinitials>AmosJeffries</authorinitials><revremark>typo</revremark></revision><revision><revnumber>64</revnumber><date>2012-03-25 03:17:52</date><authorinitials>AmosJeffries</authorinitials><revremark>polish route rules and mention ip6tables for IPv6.</revremark></revision><revision><revnumber>63</revnumber><date>2011-09-24 05:27:35</date><authorinitials>AmosJeffries</authorinitials><revremark>rp_filter ctrl value meanings was changed in the kernel. this seems to be why nothing works recently</revremark></revision><revision><revnumber>62</revnumber><date>2011-09-02 02:56:13</date><authorinitials>AmosJeffries</authorinitials><revremark>mention rp_filter confusion, add IPv6 bridge rules, add details on where to add bypasses</revremark></revision><revision><revnumber>61</revnumber><date>2011-07-20 02:57:01</date><authorinitials>AmosJeffries</authorinitials><revremark>: ( typo</revremark></revision><revision><revnumber>60</revnumber><date>2011-07-20 02:56:00</date><authorinitials>AmosJeffries</authorinitials><revremark>tweak routing configuration explanaton of table 100 pitfalls.</revremark></revision><revision><revnumber>59</revnumber><date>2011-05-26 12:54:01</date><authorinitials>AmosJeffries</authorinitials><revremark>spelling</revremark></revision><revision><revnumber>58</revnumber><date>2011-05-26 12:52:55</date><authorinitials>AmosJeffries</authorinitials><revremark>tweak the minimum requirements a bit.</revremark></revision><revision><revnumber>57</revnumber><date>2011-03-21 05:45:04</date><authorinitials>AmosJeffries</authorinitials><revremark>thanks to Jim Binder we now know that default route matters a lot.</revremark></revision><revision><revnumber>56</revnumber><date>2011-03-04 05:06:02</date><authorinitials>AmosJeffries</authorinitials><revremark>update routing rules. eth0 is proving to be required on many ore systems than expected.</revremark></revision><revision><revnumber>55</revnumber><date>2010-10-27 05:51:39</date><authorinitials>AmosJeffries</authorinitials><revremark>update with IPv6 requirements.</revremark></revision><revision><revnumber>54</revnumber><date>2010-10-22 02:09:12</date><authorinitials>AmosJeffries</authorinitials><revremark>IPv6 support got accepted into *-next kernel (2.6.37-rc1)</revremark></revision><revision><revnumber>53</revnumber><date>2010-07-14 07:21:56</date><authorinitials>Henrik Nordström</authorinitials><revremark>Add selinux policy info in configuration section.</revremark></revision><revision><revnumber>52</revnumber><date>2010-07-11 08:16:31</date><authorinitials>AmosJeffries</authorinitials><revremark>mention ip route limit seen.</revremark></revision><revision><revnumber>51</revnumber><date>2010-06-17 02:11:59</date><authorinitials>AmosJeffries</authorinitials><revremark>link to shorewall info.</revremark></revision><revision><revnumber>50</revnumber><date>2010-05-28 09:20:12</date><authorinitials>AmosJeffries</authorinitials><revremark>shuffle  routing config so things are layered by setup order and update bridging info.</revremark></revision><revision><revnumber>49</revnumber><date>2010-03-18 10:22:53</date><authorinitials>Henrik Nordström</authorinitials><revremark>Documented selinux policy settings needed on Fedora 12.</revremark></revision><revision><revnumber>48</revnumber><date>2010-03-05 00:57:29</date><authorinitials>AmosJeffries</authorinitials><revremark>sync service numbers to the rest of the config.</revremark></revision><revision><revnumber>47</revnumber><date>2010-03-05 00:47:01</date><authorinitials>AmosJeffries</authorinitials><revremark>various updates of stuff I've since learned or confirmed.</revremark></revision><revision><revnumber>46</revnumber><date>2010-02-10 01:47:04</date><authorinitials>AmosJeffries</authorinitials><revremark>kernel 2.6.32 has issues.</revremark></revision><revision><revnumber>45</revnumber><date>2009-10-27 22:33:41</date><authorinitials>AmosJeffries</authorinitials><revremark>oops, it was DROP. but some additional proc settings as well.</revremark></revision><revision><revnumber>44</revnumber><date>2009-10-27 21:51:53</date><authorinitials>AmosJeffries</authorinitials><revremark>update ebtables section on consensus from a few more testers.</revremark></revision><revision><revnumber>43</revnumber><date>2009-10-06 22:58:26</date><authorinitials>AmosJeffries</authorinitials><revremark>Import some missing bits: WCCP, ebtables, kernel config</revremark></revision><revision><revnumber>42</revnumber><date>2009-09-12 05:23:17</date><authorinitials>AmosJeffries</authorinitials><revremark>some updates.</revremark></revision><revision><revnumber>41</revnumber><date>2009-09-05 01:48:17</date><authorinitials>AmosJeffries</authorinitials><revremark>IPv6 is marginaly available in kernel now.</revremark></revision><revision><revnumber>40</revnumber><date>2009-06-28 23:43:20</date><authorinitials>AmosJeffries</authorinitials><revremark>Some more help for hanging traffic.</revremark></revision><revision><revnumber>39</revnumber><date>2009-06-21 10:13:53</date><authorinitials>AmosJeffries</authorinitials><revremark>mention balabit docs mistake.</revremark></revision><revision><revnumber>38</revnumber><date>2009-05-18 10:47:56</date><authorinitials>AmosJeffries</authorinitials><revremark>fu, its libcap-dev not libpcap</revremark></revision><revision><revnumber>37</revnumber><date>2009-05-18 10:08:13</date><authorinitials>AmosJeffries</authorinitials><revremark>typo</revremark></revision><revision><revnumber>36</revnumber><date>2009-05-18 10:07:29</date><authorinitials>AmosJeffries</authorinitials><revremark>mention libpcap a lot more. It is one of the dependencies for this feature.</revremark></revision><revision><revnumber>35</revnumber><date>2009-05-17 08:40:40</date><authorinitials>AmosJeffries</authorinitials><revremark>two-way spoof has been seen on some machines, not on others. its a bit weird still.</revremark></revision><revision><revnumber>34</revnumber><date>2009-05-17 08:38:17</date><authorinitials>AmosJeffries</authorinitials><revremark>some more troubles and their solutions.</revremark></revision><revision><revnumber>33</revnumber><date>2009-04-25 03:12:50</date><authorinitials>AmosJeffries</authorinitials><revremark>turns out there is another kernel option NF_CONNTRACK involved somehow.</revremark></revision><revision><revnumber>32</revnumber><date>2009-03-23 22:38:12</date><authorinitials>AmosJeffries</authorinitials><revremark>make our official link to the overview versiosn page.</revremark></revision><revision><revnumber>31</revnumber><date>2009-03-23 22:37:18</date><authorinitials>AmosJeffries</authorinitials><revremark>link to official releases page for each required package newer versions.</revremark></revision><revision><revnumber>30</revnumber><date>2009-03-23 22:33:58</date><authorinitials>AmosJeffries</authorinitials><revremark>iptables is officially available now.</revremark></revision><revision><revnumber>29</revnumber><date>2009-03-11 01:23:56</date><authorinitials>AmosJeffries</authorinitials><revremark>link to balabit README, not the legacy files download section.</revremark></revision><revision><revnumber>28</revnumber><date>2009-03-11 01:23:23</date><authorinitials>AmosJeffries</authorinitials><revremark>add more troubleshooting help. clarify some details I got wrong.</revremark></revision><revision><revnumber>27</revnumber><date>2009-03-11 01:03:42</date><authorinitials>AmosJeffries</authorinitials><revremark>bump recommeded software details.  add section about routing. It is a MUST apparently.</revremark></revision><revision><revnumber>26</revnumber><date>2009-02-06 10:48:59</date><authorinitials>AmosJeffries</authorinitials><revremark>link to software bundles as required.</revremark></revision><revision><revnumber>25</revnumber><date>2009-02-06 10:13:30</date><authorinitials>AmosJeffries</authorinitials><revremark>add toubleshooting section</revremark></revision><revision><revnumber>24</revnumber><date>2009-02-06 09:37:33</date><authorinitials>AmosJeffries</authorinitials><revremark>first of the two confusing rules is invalid. drop it.</revremark></revision><revision><revnumber>23</revnumber><date>2009-02-05 11:35:03</date><authorinitials>AmosJeffries</authorinitials><revremark>I think this is enough detail for a general config..</revremark></revision><revision><revnumber>22</revnumber><date>2009-02-05 07:45:53</date><authorinitials>AmosJeffries</authorinitials><revremark>add sections for kernel and iptables</revremark></revision><revision><revnumber>21</revnumber><date>2009-01-10 02:37:21</date><authorinitials>AmosJeffries</authorinitials><revremark>3.1 is out.</revremark></revision><revision><revnumber>20</revnumber><date>2008-10-10 01:01:32</date><authorinitials>AmosJeffries</authorinitials><revremark>update for FAQ listing.</revremark></revision><revision><revnumber>19</revnumber><date>2008-10-02 22:52:11</date><authorinitials>AmosJeffries</authorinitials></revision><revision><revnumber>18</revnumber><date>2008-09-24 02:35:33</date><authorinitials>AmosJeffries</authorinitials><revremark>typo</revremark></revision><revision><revnumber>17</revnumber><date>2008-09-24 01:42:54</date><authorinitials>AmosJeffries</authorinitials><revremark>extra patch no longer required</revremark></revision><revision><revnumber>16</revnumber><date>2008-09-23 11:49:53</date><authorinitials>AmosJeffries</authorinitials><revremark>all known bugs tracked down and fully working now.</revremark></revision><revision><revnumber>15</revnumber><date>2008-09-15 06:09:35</date><authorinitials>AmosJeffries</authorinitials><revremark>add two new bug fixes found</revremark></revision><revision><revnumber>14</revnumber><date>2008-09-13 01:54:40</date><authorinitials>AmosJeffries</authorinitials><revremark>Squid-3 does attempt to spoof.</revremark></revision><revision><revnumber>13</revnumber><date>2008-09-03 02:48:39</date><authorinitials>AmosJeffries</authorinitials><revremark>update for FAQ inclusion</revremark></revision><revision><revnumber>12</revnumber><date>2008-09-03 02:41:59</date><authorinitials>AmosJeffries</authorinitials><revremark>better name for this page</revremark></revision><revision><revnumber>11</revnumber><date>2008-08-15 13:36:47</date><authorinitials>AmosJeffries</authorinitials><revremark>reference the first how-to</revremark></revision><revision><revnumber>10</revnumber><date>2008-07-18 10:39:48</date><authorinitials>AmosJeffries</authorinitials><revremark>Note current state and usage</revremark></revision><revision><revnumber>9</revnumber><date>2008-05-30 04:05:54</date><authorinitials>AmosJeffries</authorinitials><revremark>mention where Squid-3 code is now.</revremark></revision><revision><revnumber>8</revnumber><date>2008-05-18 19:38:57</date><authorinitials>localhost</authorinitials><revremark>converted to 1.6 markup</revremark></revision><revision><revnumber>7</revnumber><date>2008-04-26 13:50:33</date><authorinitials>AmosJeffries</authorinitials><revremark>alter the details text to meet the specific RoadMap regex patterns</revremark></revision><revision><revnumber>6</revnumber><date>2008-04-25 14:11:10</date><authorinitials>AlexRousskov</authorinitials><revremark>typo</revremark></revision><revision><revnumber>5</revnumber><date>2008-04-25 07:55:09</date><authorinitials>AmosJeffries</authorinitials><revremark>TPROXYv4 is done in 3.x</revremark></revision><revision><revnumber>4</revnumber><date>2008-04-17 14:11:28</date><authorinitials>AmosJeffries</authorinitials><revremark>3.1 patch committed.</revremark></revision><revision><revnumber>3</revnumber><date>2008-04-09 10:36:26</date><authorinitials>AmosJeffries</authorinitials><revremark>Also myself and Adrian</revremark></revision><revision><revnumber>2</revnumber><date>2008-03-06 02:56:09</date><authorinitials>AmosJeffries</authorinitials><revremark>commit to a date.</revremark></revision><revision><revnumber>1</revnumber><date>2008-03-05 10:36:11</date><authorinitials>AmosJeffries</authorinitials></revision></revhistory></articleinfo><section><title>Feature: TPROXY version 4.1+ Support</title><itemizedlist><listitem><para><emphasis role="strong">Version</emphasis>: 3.1 </para></listitem><listitem><para><emphasis role="strong">Developer</emphasis>: Laszlo Attilla Toth (Balabit), Krisztian Kovacs, <ulink url="https://wiki.squid-cache.org/Features/Tproxy4/AmosJeffries#">AmosJeffries</ulink> </para></listitem><listitem><para><emphasis role="strong">More</emphasis>: <ulink url="http://www.balabit.com/downloads/files/tproxy/README.txt"/> </para></listitem></itemizedlist><section><title>Details</title><para>Support TPROXY v4.1 with full IPv4 and IPv6 transparent interception of HTTP. </para></section><section><title>Sponsor</title><para>This feature was Sponsored by Balabit and developed by Laszlo Attilla Toth and <ulink url="https://wiki.squid-cache.org/Features/Tproxy4/AmosJeffries#">AmosJeffries</ulink>. Production tested and debugged with the help of Krisztian Kovacs and Nicholas Ritter. </para><para>WCCPv2 configuration is derived from testing by Steven Wilton and Adrian Chadd. It has not changed significantly since older TPROXY. </para></section><section><title>Minimum Requirements (IPv6 and IPv4)</title><itemizedlist><listitem override="none"><informaltable><tgroup cols="2"><colspec colname="col_0"/><colspec colname="col_1"/><tbody><row rowsep="1"><entry colsep="1" rowsep="1"><para>Linux Kernel 2.6.37 </para></entry><entry colsep="1" rowsep="1"><para> <ulink url="http://www.kernel.org/">Official releases page</ulink> </para></entry></row><row rowsep="1"><entry colsep="1" rowsep="1"><para>iptables 1.4.10 </para></entry><entry colsep="1" rowsep="1"><para> <ulink url="http://www.netfilter.org/projects/iptables/downloads.html">Official releases page</ulink> </para></entry></row><row rowsep="1"><entry colsep="1" rowsep="1"><para>Squid 3.1 </para></entry><entry colsep="1" rowsep="1"><para><ulink url="http://www.squid-cache.org/Versions/">Official releases page</ulink> </para></entry></row><row rowsep="1"><entry colsep="1" rowsep="1"><para>libcap-dev or libcap2-dev </para></entry><entry colsep="1" rowsep="1"><para>any </para></entry></row><row rowsep="1"><entry colsep="1" rowsep="1"><para>libcap 2.09 or later </para></entry><entry colsep="1" rowsep="1"><para>any </para></entry></row></tbody></tgroup></informaltable></listitem><listitem><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> <emphasis role="strong">libcap2</emphasis> is needed at run time. To build you need the developer versions (*-dev) to compile with Squid. </para></listitem><listitem><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> NP: the versions above are a minimum from the expected working versions for the below config. </para></listitem><listitem><para>TPROXYv4 support reached a usable form in 2.6.28. However several Kernels have various known bugs: </para><itemizedlist><listitem><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-error.png" width="16"/></imageobject><textobject><phrase>{X}</phrase></textobject></inlinemediaobject> older than 2.6.28 are known to supply IPs wrongly to Squid and other client programs. Avoid! </para></listitem><listitem><para>2.6.28 to 2.6.32 have different rp_filter configuration. The rp_filter settings (0 or 1) for these kernels will silently block TPROXY if used on newer kernels. </para></listitem><listitem><para>2.6.28 to 2.6.36 are known to have ICMP and TIME_WAIT issues. </para></listitem><listitem><para>2.6.32 to 2.6.34 have bridging issues on some systems. </para></listitem></itemizedlist></listitem><listitem><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> <ulink url="https://wiki.squid-cache.org/Features/Tproxy4/Squid-3.4#">Squid-3.4</ulink> also supports TPROXY on BSD systems with PF firewall using <emphasis role="strong">divert-to</emphasis> rules in place of the Linux iptables rules. </para></listitem></itemizedlist></section><section><title>Squid Configuration</title><para>Configure build options </para><screen><![CDATA[./configure --enable-linux-netfilter]]></screen><para>squid.conf settings </para><screen><![CDATA[http_port 3128
http_port 3129 tproxy]]></screen><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> NP: A dedicated squid port for tproxy is REQUIRED.  The way TPROXYv4 works makes it incompatible with NAT interception, reverse-proxy acceleration, and standard proxy traffic. The <emphasis role="strong">intercept</emphasis>, <emphasis role="strong">accel</emphasis> and related flags cannot be set on the same <ulink url="http://www.squid-cache.org/Doc/config/http_port#">http_port</ulink> with <emphasis role="strong">tproxy</emphasis> flag. </para></listitem><listitem><para><emphasis role="strong">Obsolete</emphasis> --enable-tproxy option. Remains only for legacy v2.2 ctt proxy support. </para></listitem><listitem><para>NP: The Balabit document still refers to using options <emphasis>tproxy transparent</emphasis>. <emphasis role="strong">Do not do this</emphasis>. It was only needed short-term for a bug which is now fixed. </para></listitem></itemizedlist></section><section><title>Linux Kernel Configuration</title><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/alert.png" width="15"/></imageobject><textobject><phrase>/!\</phrase></textobject></inlinemediaobject> Requires kernel built with the configuration options: </para></listitem></itemizedlist><screen><![CDATA[NF_CONNTRACK=m
NETFILTER_TPROXY=m
NETFILTER_XT_MATCH_SOCKET=m
NETFILTER_XT_TARGET_TPROXY=m]]></screen><para>So far we have this: </para><itemizedlist><listitem override="none"><para><ulink url="https://lists.balabit.hu/pipermail/tproxy/2008-June/000853.html"/> </para></listitem></itemizedlist></section><section><title>Routing configuration</title><para>The routing features in your kernel also need to be configured to enable correct handling of the intercepted packets. Both arriving and leaving your system. </para><screen><![CDATA[# IPv4-only
ip -f inet rule add fwmark 1 lookup 100
ip -f inet route add local default dev eth0 table 100
]]><![CDATA[
# IPv6-only
ip -f inet6 rule add fwmark 1 lookup 100
ip -f inet6 route add local default dev eth0 table 100]]></screen><para>Every OS has different security and limitations around what you can do here. </para><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/alert.png" width="15"/></imageobject><textobject><phrase>/!\</phrase></textobject></inlinemediaobject> some systems require that <emphasis role="strong">lo</emphasis> is the interface TPROXY uses. </para></listitem><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/alert.png" width="15"/></imageobject><textobject><phrase>/!\</phrase></textobject></inlinemediaobject> some systems require that an <emphasis role="strong">ethN</emphasis> is the interface TPROXY uses. </para></listitem><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/alert.png" width="15"/></imageobject><textobject><phrase>/!\</phrase></textobject></inlinemediaobject> some systems require that each receiving interface have its own unique table. </para></listitem><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/alert.png" width="15"/></imageobject><textobject><phrase>/!\</phrase></textobject></inlinemediaobject> Some OS block multiple interfaces being linked to the table. You will see a rejected route when a second <code>ip -f inet route</code> is added to the table. To erase the custom route entry repeat the rule with <emphasis role="strong">del</emphasis> instead of <emphasis role="strong">add</emphasis>. </para></listitem></itemizedlist><para>On each boot startup set: </para><screen><![CDATA[echo 1 > /proc/sys/net/ipv4/ip_forward
echo 0 > /proc/sys/net/ipv4/conf/default/rp_filter
echo 0 > /proc/sys/net/ipv4/conf/all/rp_filter
echo 0 > /proc/sys/net/ipv4/conf/eth0/rp_filter]]></screen><para>Or configure <emphasis role="strong">/etc/sysctl.conf</emphasis>: </para><screen><![CDATA[net.ipv4.ip_forward = 1
net.ipv4.conf.default.rp_filter = 0
net.ipv4.conf.all.rp_filter = 0
net.ipv4.conf.eth0.rp_filter = 0]]></screen><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/alert.png" width="15"/></imageobject><textobject><phrase>/!\</phrase></textobject></inlinemediaobject> your OS also may require the keyword <emphasis role="strong">set</emphasis> before each of those sysctl.conf lines. </para></listitem><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/alert.png" width="15"/></imageobject><textobject><phrase>/!\</phrase></textobject></inlinemediaobject> since we are removing the RP filter on 'default' and 'all' sysctl you may want to set it to 1 or 2 individually on all devices <emphasis role="strong">not</emphasis> using TPROXY. </para></listitem></itemizedlist><section><title>Some routing problems to be aware of</title><itemizedlist><listitem><para><inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/alert.png" width="15"/></imageobject><textobject><phrase>/!\</phrase></textobject></inlinemediaobject> Systems with strict localhost interface security boundaries require each interface to have a separate &quot;table&quot; entry for looking up packets via that device. </para><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-error.png" width="16"/></imageobject><textobject><phrase>{X}</phrase></textobject></inlinemediaobject> in this situation the tables often cannot use the same number. When experimenting finding out how to erase the route table is useful. </para></listitem><listitem override="none"><para><emphasis role="strong">eth0</emphasis> is shown above, change to match your TPROXY interface(s). </para></listitem></itemizedlist></listitem><listitem><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-error.png" width="16"/></imageobject><textobject><phrase>{X}</phrase></textobject></inlinemediaobject> the particular device needed differs between OS. eth0 seems to be the least troublesome. Although <emphasis role="strong">dev lo</emphasis> may be the only one that works. </para></listitem><listitem><para><inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/alert.png" width="15"/></imageobject><textobject><phrase>/!\</phrase></textobject></inlinemediaobject> your OS may require the keyword <emphasis role="strong">set</emphasis> before each sysctl.conf line. </para></listitem></itemizedlist></section></section><section><title>iptables Configuration</title><section><title>iptables on a Router device</title><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> For IPv6 the rules are identical. But the <emphasis>ip6tables</emphasis> tool needs to be used in place of <emphasis>iptables</emphasis> </para></listitem></itemizedlist><para>Setup a chain <emphasis>DIVERT</emphasis> to mark packets </para><screen><![CDATA[iptables -t mangle -N DIVERT
iptables -t mangle -A DIVERT -j MARK --set-mark 1
iptables -t mangle -A DIVERT -j ACCEPT]]></screen><para>Use <emphasis>DIVERT</emphasis> to prevent existing connections going through TPROXY twice: </para><screen><![CDATA[iptables  -t mangle -A PREROUTING -p tcp -m socket -j DIVERT]]></screen><para>Mark all other (new) packets and use <emphasis>TPROXY</emphasis> to pass into Squid: </para><screen><![CDATA[iptables  -t mangle -A PREROUTING -p tcp --dport 80 -j TPROXY --tproxy-mark 0x1/0x1 --on-port 3129]]></screen></section><section><title>ebtables on a Bridging device</title><para>Bridging configuration in Linux is done with the <emphasis>ebtables</emphasis> utility. </para><para>You also need to follow all the steps for setting up the Squid box as a router device. These bridging rules are additional steps to move packets from bridging mode to routing mode: </para><screen><![CDATA[## interface facing clients
CLIENT_IFACE=eth0
]]><![CDATA[
## interface facing Internet
INET_IFACE=eth1
]]><![CDATA[
]]><![CDATA[
ebtables -t broute -A BROUTING \
        -i $CLIENT_IFACE -p ipv6 --ip6-proto tcp --ip6-dport 80 \
        -j redirect --redirect-target DROP
]]><![CDATA[
ebtables -t broute -A BROUTING \
        -i $CLIENT_IFACE -p ipv4 --ip-proto tcp --ip-dport 80 \
        -j redirect --redirect-target DROP
]]><![CDATA[
ebtables -t broute -A BROUTING \
        -i $INET_IFACE -p ipv6 --ip6-proto tcp --ip6-sport 80 \
        -j redirect --redirect-target DROP
]]><![CDATA[
ebtables -t broute -A BROUTING \
        -i $INET_IFACE -p ipv4 --ip-proto tcp --ip-sport 80 \
        -j redirect --redirect-target DROP
]]><![CDATA[
]]><![CDATA[
if test -d /proc/sys/net/bridge/ ; then
  for i in /proc/sys/net/bridge/*
  do
    echo 0 > $i
  done
  unset i
fi]]></screen><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/alert.png" width="15"/></imageobject><textobject><phrase>/!\</phrase></textobject></inlinemediaobject> The bridge interfaces also need to be configured with public IP addresses for Squid to use in its normal operating traffic (DNS, ICMP, TPROXY failed requests, peer requests, etc) </para></listitem></itemizedlist></section><section><title>Bypassing TPROXY intercept</title><para>As always, bypassing the firewall rules is always an option. They need to go first, naturally. </para><itemizedlist><listitem><para>Bridges need to place the bypass in ebtables BROUTE before the DROP rules. </para></listitem><listitem><para>Routers need to place the bypass in iptables PREROUTING before the DIVERT chain. </para></listitem></itemizedlist><para>If you do not understand how to do that or what to write in the bypass rules, please locate any beginners guide on iptables or ebtables and read up on how to operate them. </para></section></section><section><title>SELINUX Policy tuning</title><para>On Linux versions with selinux enabled you also need to tune the selinux policy to allow Squid to use TPROXY. By default the SELINUX policy for Squid denies some of the operations needed for TPROXY. You can tune the policy to allow this by setting a couple selinux booleans: </para><screen><![CDATA[setsebool squid_connect_any=yes
setsebool squid_use_tproxy=yes]]></screen><para>If your version of the selinux policy is missing any of these then see the troubleshooting section for alternative approaches. </para></section><section><title>WCCP Configuration (only if you use WCCP)</title><itemizedlist><listitem override="none"><para><emphasis>by Steve Wilton</emphasis> <inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> $ROUTERIP needs to be replaced with the IP Squid uses to contact the WCCP router. </para></listitem></itemizedlist><section><title>squid.conf</title><para>It is highly recommended that these definitions be used for the two wccp services, otherwise things will break if you have more than one cache (specifically, you will have problems when the a web server's name resolves to multiple ip addresses). </para><screen><![CDATA[wccp2_router $ROUTERIP
wccp2_forwarding_method gre
wccp2_return_method gre
wccp2_service dynamic 80
wccp2_service_info 80 protocol=tcp flags=src_ip_hash priority=240 ports=80
wccp2_service dynamic 90
wccp2_service_info 90 protocol=tcp flags=dst_ip_hash,ports_source priority=240 ports=80]]></screen></section><section><title>Router config</title><para>On the router, you need to make sure that all traffic going to/from the customer will be processed by <emphasis role="strong">_both_</emphasis> WCCP rules. The way we implement this is to apply: </para><itemizedlist><listitem><para>WCCP <emphasis>service 80</emphasis> applied to all traffic coming <emphasis role="strong">in from</emphasis> a customer-facing interface </para></listitem><listitem><para>WCCP <emphasis>service 90</emphasis> applied to all traffic going <emphasis role="strong">out to</emphasis> a customer-facing interface. </para></listitem><listitem><para>WCCP <emphasis>exclude in</emphasis> rule to all traffic coming <emphasis role="strong">in from</emphasis> the proxy-facing interface. </para></listitem></itemizedlist><para>For Example: </para><screen><![CDATA[interface GigabitEthernet0/3.100
 description ADSL customers
 encapsulation dot1Q 502
 ip address x.x.x.x y.y.y.y
 ip wccp 80 redirect in
 ip wccp 90 redirect out
]]><![CDATA[
interface GigabitEthernet0/3.101
 description Dialup customers
 encapsulation dot1Q 502
 ip address x.x.x.x y.y.y.y
 ip wccp 80 redirect in
 ip wccp 90 redirect out
]]><![CDATA[
interface GigabitEthernet0/3.102
 description proxy servers
 encapsulation dot1Q 506
 ip address x.x.x.x y.y.y.y
 ip wccp redirect exclude in]]></screen></section><section><title>Single Squid behind WCCP interceptor</title></section><section><title>Cluster of Sibling Squid behind WCCP interceptor</title><para>When two sibling peers are both behind a WCCP interception gateway and using TPROXY to spoof the client IP, the WCCP gateway will get confused by two identical sources and redirect packets at the wrong sibling. </para><para>This is now resolved by adding the <emphasis role="strong">no-tproxy</emphasis> flag to the cluster sibling <ulink url="http://www.squid-cache.org/Doc/config/cache_peer#">cache_peer</ulink> lines. This disables TPROXY spoofing on requests which are received through another peer in the cluster. </para><screen><![CDATA[cache_peer ip.of.peer sibling 3128 0 no-tproxy ...]]></screen></section></section></section><section><title>Troubleshooting</title><section><title>Squid not spoofing the client IP</title><para>Could be a few things. Check cache.log for messages like those listed here in Troubleshooting. </para><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/alert.png" width="15"/></imageobject><textobject><phrase>/!\</phrase></textobject></inlinemediaobject> The warning about missing libcap appears to be issued before cache.log is started.  So does not always show up when Squid starts.  Start testing this problem by making sure of that dependency manually. </para></listitem></itemizedlist></section><section><title>Stopping full transparency: Error enabling needed capabilities.</title><para>Something went wrong while setting advanced privileges. What exactly, we don't know at this point. Unfortunately its not logged anywhere either. Perhaps your syslog or /var/log/messages log will have details recorded by the OS. </para></section><section><title>Stopping full transparency: Missing needed capability support.</title><para><emphasis role="strong">libcap</emphasis> support appears to be missing.  The library needs to be built into Squid so a rebuild is required after installed the related packages for your system. </para></section><section><title>commBind: cannot bind socket FD X to X.X.X.X: (99) cannot assign requested address</title><para>This error has many reasons for occurring. </para><para>It might be seen repeatedly when Squid is running with TPROXY configured: </para><itemizedlist><listitem><para>If the squid port receives traffic by other means than TPROXY interception. </para><para> Ports using the <emphasis role="strong">tproxy</emphasis> flag <inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/alert.png" width="15"/></imageobject><textobject><phrase>/!\</phrase></textobject></inlinemediaobject> MUST NOT <inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/alert.png" width="15"/></imageobject><textobject><phrase>/!\</phrase></textobject></inlinemediaobject> receive traffic for any other mode Squid can run in. </para></listitem><listitem><para>If Squid is receiving TPROXY traffic on a port without the <emphasis role="strong">tproxy</emphasis> flag. </para></listitem><listitem><para>If the kernel is missing the capability to bind to any random IP. </para></listitem></itemizedlist><para>It may also be seen only at startup due to unrelated issues: </para><itemizedlist><listitem><para><ulink url="https://wiki.squid-cache.org/Features/Tproxy4/SquidFaq/TroubleShooting#head-97c3ff164d9706d3782ea3b242b6e409ce8395f6">Another program already using the port</ulink> </para></listitem><listitem><para><ulink url="https://wiki.squid-cache.org/Features/Tproxy4/SquidFaq/TroubleShooting#head-19aa8aba19772e32d6e3f783a20b0d2be0edc6a2">Address not assigned to any interface</ulink> </para></listitem></itemizedlist></section><section><title>Traffic going through Squid but then timing out</title><para>This is usually seen when the network design prevents packets coming back to Squid. </para><itemizedlist><listitem><para>Check that the Routing portion of the config above is set correctly. </para></listitem><listitem><para>Check that the <emphasis>DIVERT</emphasis> is done before <emphasis>TPROXY</emphasis> rules in iptables <emphasis role="strong">PREROUTING</emphasis> chain. </para></listitem></itemizedlist><section><title>Timeouts with Squid not running in the router directly</title><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> <inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/alert.png" width="15"/></imageobject><textobject><phrase>/!\</phrase></textobject></inlinemediaobject> The above configuration assumes that squid is running on the router OR has a direct connection to the Internet without having to go through the capture router again. For both outbound and return traffic. </para></listitem></itemizedlist><para>If your network topology uses a squid box sitting the <emphasis role="strong">inside</emphasis> the router which passes packets to Squid. Then you will need to explicitly add some additional configuration. </para><para>The WCCPv2 example is provided for people using Cisco boxes.  For others we can't point to exact routing configuration since it will depend on your router. But you will need to figure out some rule(s) which identify the Squid outbound traffic. Dedicated router interface, service groups, TOS set by Squid <ulink url="http://www.squid-cache.org/Doc/config/tcp_outgoing_tos#">tcp_outgoing_tos</ulink>, and MAC source have all been found to be useful under specific situations. <emphasis role="strong">IP address rules are the one thing guaranteed to fail.</emphasis> </para><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> We should not really need to say it; but these exception rules <emphasis role="strong">MUST</emphasis> be placed before any of the capture TPROXY/DIVERT rules. </para></listitem></itemizedlist></section><section><title>Timeouts with Squid running as a bridge or multiple-NIC</title><para>When using the bridge configuration or when multi-homing the system care needs to be taken that the <emphasis role="strong">default</emphasis> route is correct and will route packets to the Internet. Ideally there is only one default route, but for a bridge with routing enabled or for multi-homed systems there may be multiple. </para><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/alert.png" width="15"/></imageobject><textobject><phrase>/!\</phrase></textobject></inlinemediaobject> There has been one confirmed case of the default route being set <emphasis>automatically</emphasis> by the OS to the dead-end route/NIC used only for administering the bridge. </para></listitem></itemizedlist></section><section><title>Wccp2 dst_ip_hash packet loops</title><itemizedlist><listitem override="none"><para><emphasis>by Michael Bowe</emphasis> </para></listitem></itemizedlist><para>Referring to the <ulink url="http://www.squid-cache.org/Doc/config/wccps_service_info#">wccps_service_info</ulink> settings detailed above. </para><para>First method: </para><itemizedlist><listitem><para>dst_ip_hash on 80 </para></listitem><listitem><para>src_ip_hash on 90 </para></listitem></itemizedlist><para>Ties a particular web server to a particular cache </para><para>Second method: </para><itemizedlist><listitem><para>src_ip_hash on 80 </para></listitem><listitem><para>dst_ip_hash on 90 </para></listitem></itemizedlist><para>Ties a particular client to a particular cache </para><para>When using TPROXY the second method must be used. The problem with the first method is this sequence of events which starts to occur: </para><para>Say a client wants to access <ulink url="http://some-large-site"/>, their PC resolves the address and gets x.x.x.1 </para><orderedlist numeration="arabic"><listitem><para>GET request goes off to the network, Cisco sees it and hashes the dst_ip. </para></listitem><listitem><para>Hash for this IP points to cache-A </para></listitem><listitem><para>Router sends the request to cache-A. </para></listitem></orderedlist><para>This cache takes the GET and does another DNS lookup of that host. This time it resolves to x.x.x.2 </para><orderedlist numeration="arabic"><listitem><para>Cache sends request off to the !Internet </para></listitem><listitem><para>Reply comes back from x.x.x.2, and arrives at the Cisco. </para></listitem><listitem><para>Cisco does hash on src_ip and this happens to map to cache-B </para></listitem><listitem><para>Reply arrives at cache-B and it doesn’t know anything about it. Trouble! <inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-error.png" width="16"/></imageobject><textobject><phrase>{X}</phrase></textobject></inlinemediaobject> </para></listitem></orderedlist></section></section><section><title>selinux policy denials</title><para>When configuring TPROXY support on Fedora 12 using the Squid shipped with Fedora selinux initially blocked Squid from usng the TPROXY feature. </para><para>The quick fix is disabling selinux entirely, but this is not generally desired. </para><para>A more permanent fix until the squid part of the selinux policy is updated is to make a custom selinux policy module allowing Squid access to the net operations is needs for TPROXY. </para><screen><![CDATA[# Temporarily set eslinux in permissive mode and test..
setenforce 0
service squid start
# Make a request via Squid and verity that it works.
service squid stop
setenforce 1
# build & install selinux module based on the denials seen
grep AVC.*squid /var/log/audit/autdit.log | audit2allow -M squidtproxy
semodule -i squidtproxy.pp]]></screen><para>Alternatively you can download and install a precomposed policy module from <ulink url="http://www.henriknordstrom.net/code/squidtproxy.te"/> </para><screen><![CDATA[wget http://www.henriknordstrom.net/code/squidtproxy.te
checkmodule -M -m -o squidtproxy.mod squidtproxy.te
semodule_package -o squidtproxy.pp squidtproxy.mod
semodule -i squidtproxy.pp
setsebool -P squid_connect_any true]]></screen></section></section><section><title>References</title><itemizedlist><listitem><para>Older config how-to from before the kernel and iptables bundles were available... <ulink url="http://wiki.squid-cache.org/ConfigExamples/TPROXYPatchingCentOS"/> </para></listitem><listitem><para>Shorewall Firewall Configuration <ulink url="http://www1.shorewall.net/Shorewall_Squid_Usage.html#TPROXY"/> </para></listitem></itemizedlist><section><title>spoof_client_ip config directive (exists only from Squid-3.4)</title><itemizedlist><listitem><para>Squid-Cache allows tproxy spoof control configuration directive: <ulink url="http://www.squid-cache.org/Doc/config/spoof_client_ip/"/> This allows to intercept traffic using tproxy but use the same concept of intercept\transparent proxy for outgoing traffic and to decide whether to spoof or not specific clients src addresses or to use the proxy as the source ip. </para></listitem></itemizedlist><!--rule (<hr>) is not applicable to DocBook--><para> <ulink url="https://wiki.squid-cache.org/Features/Tproxy4/CategoryFeature#">CategoryFeature</ulink> </para></section></section></article>