<?xml version="1.0" encoding="utf-8"?><!DOCTYPE article  PUBLIC '-//OASIS//DTD DocBook XML V4.4//EN'  'http://www.docbook.org/xml/4.4/docbookx.dtd'><article><articleinfo><title>Features/CacheManager</title><revhistory><revision><revnumber>22</revnumber><date>2018-04-19 13:02:23</date><authorinitials>AmosJeffries</authorinitials><revremark>update troubleshooting to include hostname issues</revremark></revision><revision><revnumber>21</revnumber><date>2016-07-25 14:06:08</date><authorinitials>AmosJeffries</authorinitials></revision><revision><revnumber>20</revnumber><date>2015-12-03 12:48:30</date><authorinitials>AmosJeffries</authorinitials><revremark>remove built-in ACL details, it has been long enough now that 3.1 and older are getting less common.</revremark></revision><revision><revnumber>19</revnumber><date>2013-10-30 07:53:50</date><authorinitials>AmosJeffries</authorinitials><revremark>add reference to index report page.</revremark></revision><revision><revnumber>18</revnumber><date>2013-01-10 17:13:48</date><authorinitials>AlexRousskov</authorinitials><revremark>Documented that/why secure cache manager requests are not currently supported. Documented a workaround.</revremark></revision><revision><revnumber>17</revnumber><date>2012-09-22 16:21:59</date><authorinitials>AlexRousskov</authorinitials><revremark>Started documenting SMP support status for various mgr objects.</revremark></revision><revision><revnumber>16</revnumber><date>2012-02-01 01:23:45</date><authorinitials>AmosJeffries</authorinitials><revremark>polish and split off particular reports and tools into own documentation pages.</revremark></revision><revision><revnumber>15</revnumber><date>2011-07-04 02:24:53</date><authorinitials>AmosJeffries</authorinitials><revremark>updates for 3.2 changes.</revremark></revision><revision><revnumber>14</revnumber><date>2011-03-24 16:12:28</date><authorinitials>AlexRousskov</authorinitials><revremark>fixed bold formatting leak</revremark></revision><revision><revnumber>13</revnumber><date>2011-03-24 12:25:40</date><authorinitials>AmosJeffries</authorinitials><revremark>add feature page intro meta bits</revremark></revision><revision><revnumber>12</revnumber><date>2011-03-24 12:22:50</date><authorinitials>AmosJeffries</authorinitials><revremark>this is a major feature</revremark></revision><revision><revnumber>11</revnumber><date>2011-03-24 12:22:16</date><authorinitials>AmosJeffries</authorinitials><revremark>bring some structure to the sectios. remove some obsolete texts. add wiki links</revremark></revision><revision><revnumber>10</revnumber><date>2008-05-18 19:38:58</date><authorinitials>localhost</authorinitials><revremark>converted to 1.6 markup</revremark></revision><revision><revnumber>9</revnumber><date>2008-02-26 12:58:53</date><authorinitials>kinkie</authorinitials><revremark>Fixed broken CamelCase</revremark></revision><revision><revnumber>8</revnumber><date>2007-07-04 00:07:50</date><authorinitials>AmosJeffries</authorinitials></revision><revision><revnumber>7</revnumber><date>2007-02-02 09:52:28</date><authorinitials>ecasbas</authorinitials></revision><revision><revnumber>6</revnumber><date>2007-02-02 09:34:17</date><authorinitials>ecasbas</authorinitials></revision><revision><revnumber>5</revnumber><date>2007-01-30 15:49:31</date><authorinitials>ecasbas</authorinitials></revision><revision><revnumber>4</revnumber><date>2006-08-29 10:16:13</date><authorinitials>kinkie</authorinitials><revremark>syntax fixes</revremark></revision><revision><revnumber>3</revnumber><date>2006-03-03 09:23:54</date><authorinitials>kinkie</authorinitials></revision><revision><revnumber>2</revnumber><date>2006-02-08 13:04:28</date><authorinitials>kinkie</authorinitials><revremark>Markup fixes, added link to index</revremark></revision><revision><revnumber>1</revnumber><date>2006-01-25 15:47:13</date><authorinitials>kinkie</authorinitials></revision></revhistory></articleinfo><section><title>Feature: Squid Cache Manager</title><para>Chapter contributed by <emphasis>Jonathan Larmour</emphasis> </para><section><title>What is the cache manager?</title><para>The cache manager is a component of Squid which provides management controls and reports displaying statistics about the <emphasis>squid</emphasis> process as it runs. </para><para>Reports are generated at the time of request, so data included is presented live. Although due to processing delays some of the larger reports cannot exactly be considered real-time information. For example the all cache objects report may omit some objects which entered the cache during processing of the report. </para></section><section><title>Ways to access the manager reports</title><para>Squid packages come with two tools for accessing the cache manager: </para><itemizedlist><listitem><para><ulink url="https://wiki.squid-cache.org/Features/CacheManager/ManagerCgiTool#">cachemgr.cgi</ulink> is a CGI utility for online browsing of the manager reports. It can be configured to interface with multiple proxies so provides a convenient way to manage proxies and view statistics without logging into each server. </para></listitem><listitem><para><ulink url="https://wiki.squid-cache.org/Features/CacheManager/SquidClientTool#">squidclient</ulink> is a command line utility for performing web requests. It also has a special ability to send cache manager requests to Squid proxies. </para></listitem></itemizedlist><para>The cache manager is accessed with standard HTTP requests using a special cache_object:// URL scheme. Which allows other tools and scripts to easily be written for any special use you may have. </para><para>The cache manager has been extended in <ulink url="https://wiki.squid-cache.org/Features/CacheManager/Squid-3.2#">Squid-3.2</ulink> to allow access from the <ulink url="http://"/> and <ulink url="https://"/> URL schemes. This opens the cache manager reports directly to the web browser if permitted by <ulink url="http://www.squid-cache.org/Doc/config/http_access#">http_access</ulink> security controls. </para><itemizedlist><listitem><para><ulink url="https://wiki.squid-cache.org/Features/CacheManager/Features/CacheManager/Index#">Manager INDEX report</ulink> allows for provision of a customisable HTML template for accessing cache manager reports via a scripted user interface. </para></listitem></itemizedlist></section><section><title>Cache manager Access Control in squid.conf</title><section><title>default</title><para>The default cache manager access configuration in <emphasis>squid.conf</emphasis> is: </para><screen><![CDATA[http_access allow localhost manager
http_access deny manager]]></screen><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> This default has been updated to accommodate changes in <ulink url="https://wiki.squid-cache.org/Features/CacheManager/Squid-3.2#">Squid-3.2</ulink>. For older squid the squid.conf entries may appear different. </para></listitem></itemizedlist><para>The first ACL is the most important as the cache manager program interrogates squid using a special <emphasis role="strong">cache_object://</emphasis> protocol. Try it yourself by doing: </para><screen><![CDATA[telnet mycache.example.com 3128
GET cache_object://mycache.example.com/info HTTP/1.0]]></screen><para>or for <ulink url="https://wiki.squid-cache.org/Features/CacheManager/Squid-3.2#">Squid-3.2</ulink> typing this into your browser address bar: </para><screen><![CDATA[http://mycache.example.com:3128/squid-internal-mgr/info]]></screen><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/alert.png" width="15"/></imageobject><textobject><phrase>/!\</phrase></textobject></inlinemediaobject> NOTE: the above tests assume you have correctly configured your proxy machine with a working FQDN <emphasis>mycache.example.com</emphasis> for its publicly <ulink url="http://www.squid-cache.org/Doc/config/visible_hostname#">visible_hostname</ulink>. </para></listitem></itemizedlist><para>The default ACLs say that if the request is for a cache_object://, and it isn't the local host, then deny access; otherwise allow access. </para><para>In fact, only allowing localhost access means that on the initial <emphasis>cachemgr.cgi</emphasis> form you can only specify the cache host as localhost. </para></section><section><title>Remote Administration</title><para>The default ACLs assume that your web server is on the same machine as squid. Remember that the connection from the cache manager CGI program to squid originates at the <emphasis>web server</emphasis>, not the browser. So if your web server lives somewhere else, you should make sure that IP address of the web server that has cachemgr.cgi installed on it has access. </para><para>To allow a remote administrator (ie cachemgr.cgi) adjust the access controls to include the remote IPs: </para><screen><![CDATA[acl managerAdmin src 192.0.2.1
]]><![CDATA[
http_access allow localhost manager
http_access allow managerAdmin manager
http_access deny manager]]></screen><para>Where 192.0.2.1 is the IP address of your web server with cachemgr.cgi or the administrators workstation. </para></section><section><title>Troubleshooting Access Denied Issues</title><itemizedlist><listitem><para>If you're using <ulink url="http://www.squid-cache.org/Doc/config/miss_access#">miss_access</ulink>, then don't forget to also add a <ulink url="http://www.squid-cache.org/Doc/config/miss_access#">miss_access</ulink> rule for the cache manager: </para></listitem></itemizedlist><screen><![CDATA[miss_access allow manager]]></screen><itemizedlist><listitem><para>Check the ordering and placement. The default rules are placed first. This is to prevent any more complex or wider permissions you have for general access from blocking manager access with <emphasis>Access Denied</emphasis> error page or allowing general users to access the manager. </para></listitem><listitem><para>Always be sure to run <emphasis>squid -k reconfigure</emphasis> any time you change the <emphasis>squid.conf</emphasis> file. </para><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> Once cache manager is configured with a password you can also run the <emphasis role="strong">reconfigure</emphasis> action request remotely. </para></listitem></itemizedlist></listitem><listitem><para>Check that the URLs used to fetch manager reports is the publicly visible hostname Squid knows for itself. The Squid host name is fetched from a reverse-DNS lookup of the first <ulink url="http://www.squid-cache.org/Doc/config/http_port#">http_port</ulink> or <ulink url="http://www.squid-cache.org/Doc/config/https_port#">https_port</ulink> IP address, or the operating system gethostname() API, or <ulink url="http://www.squid-cache.org/Doc/config/unique_hostname#">unique_hostname</ulink>, or <ulink url="http://www.squid-cache.org/Doc/config/visible_hostname#">visible_hostname</ulink>. </para><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/alert.png" width="15"/></imageobject><textobject><phrase>/!\</phrase></textobject></inlinemediaobject> The Squid hostname is required to be a fully-qualified domain name in order to be resolved by any clients with DNS. The <ulink url="http://www.squid-cache.org/Doc/config/unique_hostname#">unique_hostname</ulink> and <ulink url="http://www.squid-cache.org/Doc/config/visible_hostname#">visible_hostname</ulink> directives do not enforce this (yet) which may lead to trouble if a non-resolvable name is configured. </para></listitem></itemizedlist></listitem></itemizedlist></section></section><section><title>Why does it say I need a password and a URL?</title><para>A password is required to perform administrative actions such as shutdown or reconfigure the cache. For security there is no default password set, which means that these command actions are not available until you set one for them. </para><para>You can set the <ulink url="http://www.squid-cache.org/Doc/config/cachemgr_passwd#">cachemgr_passwd</ulink> directive with a specific password for one or more of the manager actions and/or access to the reports. This directive allows you to set different password for each report or group them so that multiple administrators can get different access. </para><para>Squid will use Basic Authentication for retrieving the password to access reports. If <ulink url="http://www.squid-cache.org/Doc/config/auth_param#">auth_param</ulink> is configured that helper will be used to verify the username and password are correct. Otherwise username will be ignored and the password compared against <ulink url="http://www.squid-cache.org/Doc/config/cachemgr_passwd#">cachemgr_passwd</ulink> for the report being accessed. </para><para>The URL is required to refresh an object (i.e., retrieve it from its original source again). </para><para>These details are by default optional to access most reports in the cache manager. </para></section><section><title>How do I make the cache host default to my cache?</title><para>When you run <emphasis>configure</emphasis> use the <emphasis>--enable-cachemgr-hostname</emphasis> option: </para><screen><![CDATA[% ./configure --enable-cachemgr-hostname=`hostname` ...]]></screen><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/alert.png" width="15"/></imageobject><textobject><phrase>/!\</phrase></textobject></inlinemediaobject> Note, if you do this after you already installed Squid before, you need to make sure <emphasis>cachemgr.cgi</emphasis> gets recompiled. </para></listitem></itemizedlist><para>For example: </para><screen><![CDATA[% cd tools
% rm cachemgr.o cachemgr.cgi
% make cachemgr.cgi]]></screen><para>Then copy <emphasis>cachemgr.cgi</emphasis> to your HTTP server's <emphasis>cgi-bin</emphasis> directory. </para></section><section><title>Available Reports</title><para>This is a (incomplete) list of reports available from the Squid manager. Depending on which components are built in (or not) to a particular Squid the avaialble reports will vary. See the <emphasis role="strong">menu</emphasis> report for the authoritative list of reports available from your proxy. </para><para><orderedlist><listitem><ulink url="https://wiki.squid-cache.org/Features/CacheManager/Features/CacheManager/FqdnCache"><emphasis role="strong">Features/CacheManager/</emphasis>FqdnCache</ulink></listitem><listitem><ulink url="https://wiki.squid-cache.org/Features/CacheManager/Features/CacheManager/Index"><emphasis role="strong">Features/CacheManager/</emphasis>Index</ulink></listitem><listitem><ulink url="https://wiki.squid-cache.org/Features/CacheManager/Features/CacheManager/Info"><emphasis role="strong">Features/CacheManager/</emphasis>Info</ulink></listitem><listitem><ulink url="https://wiki.squid-cache.org/Features/CacheManager/Features/CacheManager/IpCache"><emphasis role="strong">Features/CacheManager/</emphasis>IpCache</ulink></listitem><listitem><ulink url="https://wiki.squid-cache.org/Features/CacheManager/Features/CacheManager/Menu"><emphasis role="strong">Features/CacheManager/</emphasis>Menu</ulink></listitem><listitem><ulink url="https://wiki.squid-cache.org/Features/CacheManager/Features/CacheManager/Objects"><emphasis role="strong">Features/CacheManager/</emphasis>Objects</ulink></listitem><listitem><ulink url="https://wiki.squid-cache.org/Features/CacheManager/Features/CacheManager/Utilization"><emphasis role="strong">Features/CacheManager/</emphasis>Utilization</ulink></listitem><listitem><ulink url="https://wiki.squid-cache.org/Features/CacheManager/Features/CacheManager/VmObjects"><emphasis role="strong">Features/CacheManager/</emphasis>VmObjects</ulink></listitem></orderedlist><!--The macro FullSearch caused an error and should be blacklisted. It returned the data '

' which caused the docbook-formatter to choke. Please file a bug.--> </para></section><section><title>SMP considerations</title><para>When Squid is running in SMP mode, Cache Manager should provide a &quot;whole Squid&quot; view (subject to optional SMP worker and process scope restrictions not discussed here). In most important cases, it does, but there are exceptions. This section details the level of SMP support on a per-report basis. </para><para>To understand how to interpret SMP Cache Manager responses, it is useful to understand how they are computed. A Cache Manager query is received by an OS-selected worker, just like any other HTTP request. The receiving worker forwards the query to the Coordinator process (via IPC). Coordinator sends the same query to each kid process (including the original query recipient and Coordinator itself), via IPC, one by one, and aggregates kids responses. Kid K receiving Coordinator request can: </para><itemizedlist><listitem><para>send stats to Coordinator (to be aggregated and displayed by Coordinator); </para></listitem><listitem><para>send some info to the requesting HTTP client directly, inside a <code>&quot;by kidK { ... }&quot;</code> blob; </para></listitem><listitem><para>both: first send a <code>&quot;by KidK&quot;</code> blob to the client and then send the aggregatable part of the information to Coordinator. </para></listitem></itemizedlist><para>The following table details SMP support for each Cache Manager object or report. Unless noted otherwise, an aggregated statistics is either a sum, arithmetic mean, minimum, or maximum across all kids, as appropriate to represent the &quot;whole Squid&quot; view. If the &quot;appropriate&quot; choice is not clear for any of the documented objects, please either update the table to clarify or file a documentation bug report. </para><informaltable><tgroup cols="4"><colspec colname="col_0"/><colspec colname="col_1"/><colspec colname="col_2"/><colspec colname="col_3"/><tbody><row rowsep="1"><entry colsep="1" rowsep="1"><para><emphasis role="strong">Name</emphasis></para></entry><entry colsep="1" rowsep="1"><para><emphasis role="strong">Component</emphasis></para></entry><entry colsep="1" rowsep="1"><para><emphasis role="strong">Aggregated?</emphasis></para></entry><entry colsep="1" rowsep="1"><para><emphasis role="strong">Comments</emphasis></para></entry></row><row rowsep="1"><entry align="left" colsep="1" rowsep="1"><para>menu</para></entry><entry colsep="1" rowsep="1"><para>all</para></entry><entry colsep="1" rowsep="1"><para>yes</para></entry><entry colsep="1" rowsep="1"><para>The mgr:menu request <emphasis>is</emphasis> sent to Coordinator, &quot;broadcasted&quot; to kids, etc. This is suboptimal, of course.</para></entry></row><row rowsep="1"><entry align="left" colsep="1" morerows="2" nameend="col_0" namest="col_0" rowsep="1"><para>info</para></entry><entry colsep="1" rowsep="1"><para>Number of clients accessing cache</para></entry><entry colsep="1" rowsep="1"><para>yes, but poorly</para></entry><entry colsep="1" rowsep="1"><para>Coordinator sums up the number of clients reported by each kid, which is usually wrong because most active clients will use more than one worker, leading to exaggerated values. Note that even without SMP, this statistics is exaggerated because the count goes down when Squid cleans up the internal client table and not when the last client connection closes. SMP amplifies that effect.</para></entry></row><row rowsep="1"><entry colsep="1" rowsep="1"><para>UP Time</para></entry><entry colsep="1" rowsep="1"><para>yes</para></entry><entry colsep="1" rowsep="1"><para>The maximum uptime across all kids is reported.</para></entry></row><row rowsep="1"><entry colsep="1" rowsep="1"><para>other</para></entry><entry colsep="1" rowsep="1"><para>yes</para></entry><entry colsep="1" rowsep="1"/></row><row rowsep="1"><entry align="left" colsep="1" rowsep="1"><para>server_list</para></entry><entry colsep="1" rowsep="1"><para>all</para></entry><entry colsep="1" rowsep="1"><para>no, but can be</para></entry><entry colsep="1" rowsep="1"><para>If you work on aggregating these stats, please keep in mind that kids may have a different set of peers. The to-Coordinator responses should include, for each peer, a peer name and not just its &quot;index&quot;.</para></entry></row><row rowsep="1"><entry align="left" colsep="1" rowsep="1"><para>mem</para></entry><entry colsep="1" rowsep="1"><para>all</para></entry><entry colsep="1" rowsep="1"><para>no, but can be</para></entry><entry colsep="1" rowsep="1"><para>If you work on aggregating these stats, please keep in mind that kids may have a different set of memory pools. The to-Coordinator responses should include, for each pool, a pool name and not just its &quot;index&quot;. Full stats may exceed typical UDS message size limits (16KB). If overflows are likely, it may be a good idea to create response messages so that overflowing items are not included (in the current sort order). Another alternative is to split mgr:mem into mgr:mem (with various aggregated totals) and mgr:pools (with non-aggregated per-pool details).</para></entry></row><row rowsep="1"><entry align="left" colsep="1" morerows="1" nameend="col_0" namest="col_0" rowsep="1"><para>counters</para></entry><entry colsep="1" rowsep="1"><para>sample_time</para></entry><entry colsep="1" rowsep="1"><para>yes</para></entry><entry colsep="1" rowsep="1"><para>The latest (maximum) sample time across all kids is reported.</para></entry></row><row rowsep="1"><entry colsep="1" rowsep="1"><para>other</para></entry><entry colsep="1" rowsep="1"><para>yes</para></entry><entry colsep="1" rowsep="1"/></row><row rowsep="1"><entry align="left" colsep="1" rowsep="1"><para>refresh</para></entry><entry colsep="1" rowsep="1"><para>all</para></entry><entry colsep="1" rowsep="1"><para>no, but can be</para></entry><entry colsep="1" rowsep="1"/></row><row rowsep="1"><entry align="left" colsep="1" morerows="1" nameend="col_0" namest="col_0" rowsep="1"><para>idns</para></entry><entry colsep="1" rowsep="1"><para>queue</para></entry><entry colsep="1" rowsep="1"><para>no and should not be</para></entry><entry colsep="1" rowsep="1"><para>The kids should probably report their own queues, especially since DNS query IDs are kid-specific.</para></entry></row><row rowsep="1"><entry colsep="1" rowsep="1"><para>other</para></entry><entry colsep="1" rowsep="1"><para>no, but can be</para></entry><entry colsep="1" rowsep="1"><para>If you work on aggregating these stats, please keep in mind that kids may have a different set of name servers. The to-Coordinator responses should include, for each name server, a server address and not just its &quot;index&quot;.</para></entry></row><row rowsep="1"><entry align="left" colsep="1" rowsep="1"><para>histograms</para></entry><entry colsep="1" rowsep="1"><para>all</para></entry><entry colsep="1" rowsep="1"><para>no, but can be</para></entry><entry colsep="1" rowsep="1"><para>If you work on aggregating these stats, please keep typical UDS message size limits (16KB) in mind.</para></entry></row><row rowsep="1"><entry align="left" colsep="1" morerows="3" nameend="col_0" namest="col_0" rowsep="1"><para>5min</para></entry><entry colsep="1" rowsep="1"><para>sample_start_time</para></entry><entry colsep="1" rowsep="1"><para>yes</para></entry><entry colsep="1" rowsep="1"><para>The earliest (minimum) sample time across all kids is reported.</para></entry></row><row rowsep="1"><entry colsep="1" rowsep="1"><para>sample_end_time</para></entry><entry colsep="1" rowsep="1"><para>yes</para></entry><entry colsep="1" rowsep="1"><para>The latest (maximum) sample time across all kids is reported.</para></entry></row><row rowsep="1"><entry colsep="1" rowsep="1"><para>*median*</para></entry><entry colsep="1" rowsep="1"><para>yes, approximately</para></entry><entry colsep="1" rowsep="1"><para>The arithmetic mean over kids medians is reported. This is not a true median. True median reporting is possible but would require adding code to exchange and aggregate raw histograms.</para></entry></row><row rowsep="1"><entry colsep="1" rowsep="1"><para>other</para></entry><entry colsep="1" rowsep="1"><para>yes</para></entry><entry colsep="1" rowsep="1"/></row><row rowsep="1"><entry align="left" colsep="1" rowsep="1"><para>60min</para></entry><entry colsep="1" rowsep="1"><para>all</para></entry><entry colsep="1" rowsep="1"><para>yes</para></entry><entry colsep="1" rowsep="1"><para>See 5min rows for component details.</para></entry></row><row rowsep="1"><entry align="left" colsep="1" rowsep="1"><para>utilization</para></entry><entry colsep="1" rowsep="1"><para>all</para></entry><entry colsep="1" rowsep="1"><para>no, but can be</para></entry><entry colsep="1" rowsep="1"><para>If you work on aggregating these stats, please reuse or mimic mgr:5min/60min aggregation code.</para></entry></row><row rowsep="1"><entry align="left" colsep="1" rowsep="1"><para>other</para></entry><entry colsep="1" rowsep="1"><para>all</para></entry><entry colsep="1" rowsep="1"><para>varies</para></entry><entry colsep="1" rowsep="1"><para>TBD. In general, statistics inside <code>&quot;by kidK {...}&quot;</code> blobs are <emphasis>not</emphasis> aggregated while all others are.</para></entry></row></tbody></tgroup></informaltable><para>While all of the above information was verified at some point, the sheer number of Cache Manager objects (and their components) as well as ongoing Squid changes virtually guarantee some bugs and discrepancies. You should test statistics you rely on (e.g., in a controlled lab environment) and file bugs reports as appropriate. </para><section><title>Secure SMP reports</title><para>When Squid is running in SMP mode, only _insecure_ Cache Manager requests (i.e., those received on http_port) are currently supported. </para><para>What would happen if you try to send a Cache Manager query to a secure https_port? The Squid worker receiving the management request on an secure connection does not send the response back. Instead, Coordinator and/or other processes send Cache Manager responses directly to the secure client using raw TCP socket descriptor they receive from the secure worker. Since those Squid processes do not know that the connection is supposed to be encrypted and do not have access to the encryption state, they send plain data, confusing the client which expects an encrypted stream. </para><para>To support secure Cache Manager requests (i.e., those received on https_port), we may have to restrict writing the Cache Manager response to the secure worker, but that is difficult because we still want to support large (non-aggregatable) Cache Manager responses where each worker should produce its own response stream. The secure worker would probably have to receive and forward those streams to the client somehow. </para><para>As a workaround, one could create a secure tunnel (using secure TCP tunneling programs such as ssh or stunnel) to a Squid http_port assigned to a loopback address and send all Cache Manager requests securely through that tunnel. Squid will not have to deal with encryption then and SMP cache manager queries will work. This workaround is secure only where unencrypted loopback traffic is considered secure, of course. </para></section></section><section><title>Understanding the manager reports</title><section><title>What's the difference between Squid TCP connections and Squid UDP connections?</title><para>Browsers and caches use TCP connections to retrieve web objects from web servers or caches.  UDP connections are used when another cache using you as a sibling or parent wants to find out if you have an object in your cache that it's looking for.  The UDP connections are ICP or HTCP queries. </para></section><section><title>It says the storage expiration will happen in 1970!</title><para>Don't worry. The default (and sensible) behavior of <emphasis>squid</emphasis> is to expire an object when it happens to overwrite it.  It doesn't explicitly garbage collect (unless you tell it to in other ways). </para></section><section><title>What do the Meta Data entries mean?</title><glosslist><glossentry><glossterm>StoreEntry</glossterm><glossdef><para>Entry describing an object in the cache. </para></glossdef></glossentry><glossentry><glossterm>IPCacheEntry</glossterm><glossdef><para>An entry in the DNS cache. </para></glossdef></glossentry><glossentry><glossterm>Hash link</glossterm><glossdef><para>Link in the cache hash table structure. </para></glossdef></glossentry><glossentry><glossterm>URL strings</glossterm><glossdef><para>The strings of the URLs themselves that map to an object number in the cache, allowing access to the Store<emphasis role="strong"/>Entry. </para></glossdef></glossentry></glosslist><para>Basically just like the log file in your cache directory: </para><itemizedlist><listitem><para>Pool<emphasis role="strong"/>Mem<emphasis role="strong"/>Object structures </para></listitem><listitem><para>Info about objects currently in memory, (eg, in the process of being transferred). </para></listitem><listitem><para>Pool for Request structures </para></listitem><listitem><para>Information about each request as it happens. </para></listitem><listitem><para>Pool for in-memory object </para></listitem><listitem><para>Space for object data as it is retrieved. </para></listitem></itemizedlist><para>If <emphasis>squid</emphasis> is much smaller than this field, run for cover! Something is very wrong, and you should probably restart <emphasis>squid</emphasis>. </para></section><section><title>What does AVG RTT mean?</title><para><emphasis role="strong">Average Round Trip Time</emphasis>. This is how long on average after an ICP ping is sent that a reply is received. </para></section><section><title>What does &quot;Page faults with physical i/o: 4897&quot; mean?</title><para>This question was asked on the <ulink url="http://www.squid-cache.org/Support/mailing-lists.html#squid-users">''squid-users'' mailing list</ulink>, to which there were three excellent replies. </para><para>by <emphasis>Jonathan Larmour</emphasis> </para><para>You get a &quot;page fault&quot; when your OS tries to access something in memory which is actually swapped to disk. The term &quot;page fault&quot; while correct at the kernel and CPU level, is a bit deceptive to a user, as there's no actual error - this is a normal feature of operation. </para><para>Also, this doesn't necessarily mean your squid is swapping by that much. Most operating systems also implement paging for executables, so that only sections of the executable which are actually used are read from disk into memory. Also, whenever squid needs more memory, the fact that the memory was allocated will show up in the page faults. </para><para>However, if the number of faults is unusually high, and getting bigger, this could mean that squid is swapping. Another way to verify this is using a program called &quot;vmstat&quot; which is found on most UNIX platforms. If you run this as &quot;vmstat 5&quot; this will update a display every 5 seconds. This can tell you if the system as a whole is swapping a lot (see your local man page for vmstat for more information). </para><para>It is very bad for squid to swap, as every single request will be blocked until the requested data is swapped in. It is better to tweak the <ulink url="http://www.squid-cache.org/Doc/config/cache_mem#">cache_mem</ulink> and/or <ulink url="http://www.squid-cache.org/Doc/config/memory_pools#">memory_pools</ulink> directive in squid.conf than allow this to happen. </para><para>by <emphasis>Peter Wemm</emphasis> </para><para>There's two different operations at work, Paging and swapping.  Paging is when individual pages are shuffled (either discarded or swapped to/from disk), while &quot;swapping&quot; <emphasis>generally</emphasis> means the entire process got sent to/from disk. </para><para>Needless to say, swapping a process is a pretty drastic event, and usually only reserved for when there's a memory crunch and paging out cannot free enough memory quickly enough.  Also, there's some variation on how swapping is implemented in OS's.  Some don't do it at all or do a hybrid of paging and swapping instead. </para><para>As you say, paging out doesn't necessarily involve disk IO, eg: text (code) pages are read-only and can simply be discarded if they are not used (and reloaded if/when needed).  Data pages are also discarded if unmodified, and paged out if there's been any changes.  Allocated memory (malloc) is always saved to disk since there's no executable file to recover the data from. mmap() memory is variable..  If it's backed from a file, it uses the same rules as the data segment of a file - ie: either discarded if unmodified or paged out. </para><para>There's also &quot;demand zeroing&quot; of pages as well that cause faults..  If you malloc memory and it calls brk()/sbrk() to allocate new pages, the chances are that you are allocated demand zero pages.  Ie: the pages are not &quot;really&quot; attached to your process yet, but when you access them for the first time, the page fault causes the page to be connected to the process address space and zeroed - this saves unnecessary zeroing of pages that are allocated but never used. </para><para>The &quot;page faults with physical IO&quot; comes from the OS via getrusage(). It's highly OS dependent on what it means.  Generally, it means that the process accessed a page that was not present in memory (for whatever reason) and there was disk access to fetch it.  Many OS's load executables by demand paging as well, so the act of starting squid implicitly causes page faults with disk IO - however, many (but not all) OS's use &quot;read ahead&quot; and &quot;prefault&quot; heuristics to streamline the loading.  Some OS's maintain &quot;intent queues&quot; so that pages can be selected as pageout candidates ahead of time.  When (say) squid touches a freshly allocated demand zero page and one is needed, the OS can page out one of the candidates on the spot, causing a 'fault with physical IO' with demand zeroing of allocated memory which doesn't happen on many other OS's.  (The other OS's generally put the process to sleep while the pageout daemon finds a page for it). </para><para>The meaning of &quot;swapping&quot; varies.  On FreeBSD for example, swapping out is implemented as unlocking upages, kernel stack, PTD etc for aggressive pageout with the process.  The only thing left of the process in memory is the 'struct proc'.  The FreeBSD paging system is highly adaptive and can resort to paging in a way that is equivalent to the traditional swapping style operation (ie: entire process).  FreeBSD also tries stealing pages from active processes in order to make space for disk cache.  I suspect this is why setting 'memory_pools off' on the non-NOVM squids on FreeBSD is reported to work better - the VM/buffer system could be competing with squid to cache the same pages.  It's a pity that squid cannot use mmap() to do file IO on the 4K chunks in it's memory pool (I can see that this is not a simple thing to do though, but that won't stop me wishing. :-). </para><para>by <emphasis>John Line</emphasis> </para><para>The comments so far have been about what paging/swapping figures mean in a &quot;traditional&quot; context, but it's worth bearing in mind that on some systems (Sun's Solaris 2, at least), the virtual memory and filesystem handling are unified and what a user process sees as reading or writing a file, the system simply sees as paging something in from disk or a page being updated so it needs to be paged out. (I suppose you could view it as similar to the operating system memory-mapping the files behind-the-scenes.) </para><para>The effect of this is that on Solaris 2, paging figures will also include file I/O. Or rather, the figures from vmstat certainly appear to include file I/O, and I presume (but can't quickly test) that figures such as those quoted by Squid will also include file I/O. </para><para>To confirm the above (which represents an impression from what I've read and observed, rather than 100% certain facts...), using an otherwise idle Sun Ultra 1 system system I just tried using cat (small, shouldn't need to page) to copy (a) one file to another, (b) a file to /dev/null, (c) /dev/zero to a file, and (d) /dev/zero to /dev/null (interrupting the last two with control-C after a while!), while watching with vmstat. 300-600 page-ins or page-outs per second when reading or writing a file (rather than a device), essentially zero in other cases (and when not cat-ing). </para><para>So ... beware assuming that all systems are similar and that paging figures represent *only* program code and data being shuffled to/from disk - they may also include the work in reading/writing all those files you were accessing... </para><para><emphasis role="strong">Ok, so what <emphasis role="underline">is</emphasis> unusually high?</emphasis> </para><para>You'll probably want to compare the number of page faults to the number of HTTP requests.  If this ratio is close to, or exceeding 1, then Squid is paging too much. </para></section><section><title>What does the IGNORED field mean in the 'cache server list'?</title><para>This refers to ICP replies which Squid ignored, for one of these reasons: </para><itemizedlist><listitem><para>The URL in the reply could not be found in the cache at all. </para></listitem><listitem><para>The URL in the reply was already being fetched.  Probably this ICP reply arrived too late. </para></listitem><listitem><para>The URL in the reply did not have a Mem<emphasis role="strong"/>Object associated with it.  Either the request is already finished, or the user aborted before the ICP arrived. </para></listitem><listitem><para>The reply came from a multicast-responder, but the <ulink url="http://www.squid-cache.org/Doc/config/cache_peer_access#">cache_peer_access</ulink> configuration does not allow us to forward this request to that neighbor. </para></listitem><listitem><para>Source-Echo replies from known neighbors are ignored. </para></listitem><listitem><para>ICP_OP_DENIED replies are ignored after the first 100. </para></listitem></itemizedlist><!--rule (<hr>) is not applicable to DocBook--><para>Back to the <ulink url="https://wiki.squid-cache.org/Features/CacheManager/SquidFaq#">SquidFaq</ulink> </para></section></section></section></article>