<?xml version="1.0" encoding="utf-8"?><!DOCTYPE article  PUBLIC '-//OASIS//DTD DocBook XML V4.4//EN'  'http://www.docbook.org/xml/4.4/docbookx.dtd'><article><articleinfo><title>ProgrammingGuide/HttpHeaders</title><revhistory><revision><revnumber>2</revnumber><date>2008-05-18 19:38:56</date><authorinitials>localhost</authorinitials><revremark>converted to 1.6 markup</revremark></revision><revision><revnumber>1</revnumber><date>2006-08-21 09:01:39</date><authorinitials>kinkie</authorinitials></revision></revhistory></articleinfo><section><title>HTTP Headers</title><para><emphasis>Files:</emphasis> </para><itemizedlist><listitem override="none"><para><code>HttpHeader.c</code>, <code>HttpHeaderTools.c</code>, <code>HttpHdrCc.c</code>, <code>HttpHdrContRange.c</code>, <code>HttpHdrExtField.c</code>, <code>HttpHdrRange.c</code> </para></listitem></itemizedlist><para><code>HttpHeader</code> class encapsulates methods and data for HTTP header manipulation.  <code>HttpHeader</code> can be viewed as a collection of HTTP header-fields with such common operations as add, delete, and find. Compared to an ascii &quot;string&quot; representation, <code>HttpHeader</code> performs those operations without rebuilding the underlying structures from scratch or searching through the entire &quot;string&quot;. </para><section><title>General remarks</title><para><code>HttpHeader</code> is a collection (or array) of HTTP header-fields. A header field is represented by an <code>HttpHeaderEntry</code> object. <code>HttpHeaderEntry</code> is an (id, name, value) triplet.  Meaningful &quot;Id&quot;s are defined for &quot;well-known&quot; header-fields like &quot;Connection&quot; or &quot;Content-Length&quot;. When Squid fails to recognize a field, it uses special &quot;id&quot;, <emphasis>HDR_OTHER</emphasis>.  Ids are formed by capitalizing the corresponding HTTP header-field name and replacing dashes ('-') with underscores ('_'). </para><para>Most operations on <code>HttpHeader</code> require a &quot;known&quot; id as a parameter. The rationale behind the later restriction is that Squid programmer should operate on &quot;known&quot; fields only. If a new field is being added to header processing, it must be given an id. </para></section><section><title>Life cycle</title><para><code>HttpHeader</code> follows a common pattern for object initialization and cleaning: </para><screen><![CDATA[    /* declare */
    HttpHeader hdr;
]]><![CDATA[
    /* initialize (as an HTTP Request header) */
    httpHeaderInit(&amp;hdr, hoRequest);
]]><![CDATA[
    /* do something */
    ...
]]><![CDATA[
    /* cleanup */
    httpHeaderClean(&amp;hdr);]]></screen><para>Prior to use, an <code>HttpHeader</code> must be initialized. A programmer must specify if a header belongs to a request or reply message. The &quot;ownership&quot; information is used mostly for statistical purposes. </para><para>Once initialized, the <code>HttpHeader</code> object <emphasis role="strong">must</emphasis> be, eventually, cleaned.  Failure to do so will result in a memory leak. </para><para>Note that there are no methods for &quot;creating&quot; or &quot;destroying&quot; a &quot;dynamic&quot; <code>HttpHeader</code> object. Looks like headers are always stored as a part of another object or as a temporary variable. Thus, dynamic allocation of headers is not needed. </para></section><section><title>Header Manipulation</title><para>The mostly common operations on HTTP headers are testing for a particular header-field (<code>httpHeaderHas()</code>), extracting field-values (<code>httpHeaderGet*()</code>), and adding new fields (<code>httpHeaderPut*()</code>). </para><para><code>httpHeaderHas(hdr, id)</code> returns true if at least one header-field specified by &quot;id&quot; is present in the header. Note that using <emphasis>HDR_OTHER</emphasis> as an id is prohibited. There is usually no reason to know if there are &quot;other&quot; header-fields in a header. </para><para><code>httpHeaderGet&lt;Type&gt;(hdr, id)</code> returns the value of the specified header-field.  The &quot;Type&quot; must match header-field type. If a header is not present a &quot;null&quot; value is returned. &quot;Null&quot; values depend on field-type, of course. </para><para>Special care must be taken when several header-fields with the same id are preset in the header. If HTTP protocol allows only one copy of the specified field per header (e.g. &quot;Content-Length&quot;), <code>httpHeaderGet&lt;Type&gt;()</code> will return one of the field-values (chosen semi-randomly). If HTTP protocol allows for several values (e.g. &quot;Accept&quot;), a &quot;String List&quot; will be returned. </para><para>It is prohibited to ask for a List of values when only one value is permitted, and visa-versa. This restriction prevents a programmer from processing one value of an header-field while ignoring other valid values. </para><para><code>httpHeaderPut&lt;Type&gt;(hdr, id, value)</code> will add an header-field with a specified field-name (based on &quot;id&quot;) and field_value. The location of the newly added field in the header array is undefined, but it is guaranteed to be after all fields with the same &quot;id&quot; if any. Note that old header-fields with the same id (if any) are not altered in any way. </para><para>The value being put using one of the <code>httpHeaderPut()</code> methods is converted to and stored as a String object. </para><para>Example: </para><screen><![CDATA[    /* add our own Age field if none was added before */
    int age = ...
    if (!httpHeaderHas(hdr, HDR_AGE))
        httpHeaderPutInt(hdr, HDR_AGE, age);]]></screen><para>There are two ways to delete a field from a header. To delete a &quot;known&quot; field (a field with &quot;id&quot; other than <emphasis>HDR_OTHER</emphasis>), use <code>httpHeaderDelById()</code> function. Sometimes, it is convenient to delete all fields with a given name (&quot;known&quot; or not) using <code>httpHeaderDelByName()</code> method. Both methods will delete <emphasis>all</emphasis> fields specified. </para><para>The <emphasis>httpHeaderGetEntry(hdr, pos)</emphasis> function can be used for iterating through all fields in a given header. Iteration is controlled by the <emphasis>pos</emphasis> parameter. Thus, several concurrent iterations over one <emphasis>hdr</emphasis> are possible. It is also safe to delete/add fields from/to <emphasis>hdr</emphasis> while iteration is in progress. </para><screen><![CDATA[/* delete all fields with a given name */
HttpHeaderPos pos = HttpHeaderInitPos;
HttpHeaderEntry *e;
while ((e = httpHeaderGetEntry(hdr, &amp;pos))) {
        if (!strCaseCmp(e->name, name))
                ... /* delete entry */
}]]></screen><para>Note that <emphasis>httpHeaderGetEntry()</emphasis> is a low level function and must not be used if high level alternatives are available. For example, to delete an entry with a given name, use the <emphasis>httpHeaderDelByName()</emphasis> function rather than the loop above. </para></section><section><title>I/O and Headers</title><para>To store a header in a file or socket, pack it using <code>httpHeaderPackInto()</code> method and a corresponding &quot;Packer&quot;. Note that <code>httpHeaderPackInto</code> will pack only header-fields; request-lines and status-lines are not prepended, and CRLF is not appended. Remember that neither of them is a part of HTTP message header as defined by the HTTP protocol. </para></section><section><title>Adding new header-field ids</title><para>Adding new ids is simple. First add new HDR_ entry to the http_hdr_type enumeration in enums.h. Then describe a new header-field attributes in the HeadersAttrs array located in <code>HttpHeader.c</code>. The last attribute specifies field type. Five types are supported: integer (<emphasis>ftInt</emphasis>), string (<emphasis>ftStr</emphasis>), date in RFC 1123 format (<emphasis>ftDate_1123</emphasis>), cache control field (<emphasis>ftPCc</emphasis>), range field (<emphasis>ftPRange</emphasis>), and content range field (<emphasis>ftPContRange</emphasis>).  Squid uses type information to convert internal binary representation of fields to their string representation (<code>httpHeaderPut</code> functions) and visa-versa (<code>httpHeaderGet</code> functions). </para><para>Finally, add new id to one of the following arrays: <emphasis>GeneralHeadersArr</emphasis>, <emphasis>EntityHeadersArr</emphasis>, <emphasis>ReplyHeadersArr</emphasis>, <emphasis>RequestHeadersArr</emphasis>.  Use HTTP specs to determine the applicable array.  If your header-field is an &quot;extension-header&quot;, its place is in <emphasis>ReplyHeadersArr</emphasis> and/or in <emphasis>RequestHeadersArr</emphasis>. You can also use <emphasis>EntityHeadersArr</emphasis> for &quot;extension-header&quot;s that can be used both in replies and requests.  Header fields other than &quot;extension-header&quot;s must go to one and only one of the arrays mentioned above. </para><para>Also, if the new field is a &quot;list&quot; header, add it to the <emphasis>ListHeadersArr</emphasis> array.  A &quot;list&quot; field-header is the one that is defined (or can be defined) using &quot;&amp;num;<!--RAW HTML: &num;-->&quot; BNF construct described in the HTTP specs. Essentially, a field that may have more than one valid field-value in a single header is a &quot;list&quot; field. </para><para>In most cases, if you forget to include a new field id in one of the required arrays, you will get a run-time assertion. For rarely used fields, however, it may take a long time for an assertion to be triggered. </para><para>There is virtually no limit on the number of fields supported by Squid. If current mask sizes cannot fit all the ids (you will get an assertion if that happens), simply enlarge HttpHeaderMask type in <code>typedefs.h</code>. </para></section><section><title>A Word on Efficiency</title><para><code>httpHeaderHas()</code> is a very cheap (fast) operation implemented using a bit mask lookup. </para><para>Adding new fields is somewhat expensive if they require complex conversions to a string. </para><para>Deleting existing fields requires scan of all the entries and comparing their &quot;id&quot;s (faster) or &quot;names&quot; (slower) with the one specified for deletion. </para><para>Most of the operations are faster than their &quot;ascii string&quot; equivalents. </para></section></section></article>