<?xml version="1.0" encoding="utf-8"?><!DOCTYPE article  PUBLIC '-//OASIS//DTD DocBook XML V4.4//EN'  'http://www.docbook.org/xml/4.4/docbookx.dtd'><article><articleinfo><title>SquidFaq/SquidAcl</title><revhistory><revision><revnumber>40</revnumber><date>2021-08-14 16:51:08</date><authorinitials>AlexRousskov</authorinitials><revremark>Tried to explain what 255.0.0.128 is based on readers feedback.</revremark></revision><revision><revnumber>39</revnumber><date>2020-08-25 14:00:52</date><authorinitials>AlexRousskov</authorinitials><revremark>Removed unnecessary/stale note about the lack of all-of/any-of ACLs. The AND/ORing rules are still arguably unusable. TODO: Move away from the increasingly unfortunate access-,list-based terminology!</revremark></revision><revision><revnumber>38</revnumber><date>2020-08-25 13:40:53</date><authorinitials>AlexRousskov</authorinitials><revremark>Documented what happens when no http_access rules are configured. Explained the danger of relying on defaults. Polished grammar, phrasing. Needs more work.</revremark></revision><revision><revnumber>37</revnumber><date>2017-02-20 18:26:15</date><authorinitials>AlexRousskov</authorinitials><revremark>Fixed dstdomain documentation to avoid the wrong implication that it is a fast ACL or that slow ACLs always match upon initiating an async lookup.</revremark></revision><revision><revnumber>36</revnumber><date>2015-12-11 13:19:35</date><authorinitials>AmosJeffries</authorinitials></revision><revision><revnumber>35</revnumber><date>2015-10-27 22:04:23</date><authorinitials>AmosJeffries</authorinitials><revremark>bug 4315 - update ARP ACL documentation</revremark></revision><revision><revnumber>34</revnumber><date>2015-01-11 21:17:58</date><authorinitials>YuriVoinov</authorinitials><revremark>Why skipped Shalla blacklist?</revremark></revision><revision><revnumber>33</revnumber><date>2013-06-03 03:45:56</date><authorinitials>AmosJeffries</authorinitials><revremark>add a basic overview of acl vs *_access directives</revremark></revision><revision><revnumber>32</revnumber><date>2013-05-07 14:59:39</date><authorinitials>AmosJeffries</authorinitials><revremark>add http://www.squidblacklist.org/</revremark></revision><revision><revnumber>31</revnumber><date>2012-06-02 14:53:25</date><authorinitials>Marcus Kool</authorinitials></revision><revision><revnumber>30</revnumber><date>2012-02-10 02:29:16</date><authorinitials>AmosJeffries</authorinitials><revremark>polishing some texts and link to squidclient tool page</revremark></revision><revision><revnumber>29</revnumber><date>2010-06-23 01:54:20</date><authorinitials>AmosJeffries</authorinitials><revremark>mention adapted_http_access</revremark></revision><revision><revnumber>28</revnumber><date>2010-06-05 20:02:38</date><authorinitials>Henrik Nordström</authorinitials></revision><revision><revnumber>27</revnumber><date>2010-02-23 00:17:19</date><authorinitials>AmosJeffries</authorinitials><revremark>typos. user contributed fix</revremark></revision><revision><revnumber>26</revnumber><date>2010-02-22 03:34:33</date><authorinitials>AmosJeffries</authorinitials><revremark>some access lists were omitted from the summary. and a typo</revremark></revision><revision><revnumber>25</revnumber><date>2010-02-19 11:36:03</date><authorinitials>AmosJeffries</authorinitials><revremark>typos in ACL types. Thanks to Алексей Баранов</revremark></revision><revision><revnumber>24</revnumber><date>2009-09-29 08:14:16</date><authorinitials>AmosJeffries</authorinitials><revremark>add SquidConf inter-wiki links everywhere I can find on this page :)</revremark></revision><revision><revnumber>23</revnumber><date>2009-09-10 21:27:56</date><authorinitials>Henrik Nordström</authorinitials><revremark>Linked http_access etc to the config manual.</revremark></revision><revision><revnumber>22</revnumber><date>2009-08-07 12:43:22</date><authorinitials>AmosJeffries</authorinitials><revremark>dstdomain is a FAST group ACL (we really need to get a better public name for this grouping)</revremark></revision><revision><revnumber>21</revnumber><date>2009-07-07 11:00:08</date><authorinitials>FrancescoChemolli</authorinitials><revremark>added some access check points</revremark></revision><revision><revnumber>20</revnumber><date>2009-04-11 03:43:08</date><authorinitials>AmosJeffries</authorinitials><revremark>some polish, and extra info on ACL all</revremark></revision><revision><revnumber>19</revnumber><date>2009-04-10 16:08:01</date><authorinitials>FrancescoChemolli</authorinitials></revision><revision><revnumber>18</revnumber><date>2009-02-11 11:23:18</date><authorinitials>AmosJeffries</authorinitials><revremark>typos, and new links</revremark></revision><revision><revnumber>17</revnumber><date>2008-10-30 13:09:54</date><authorinitials>AmosJeffries</authorinitials><revremark>update available ACL to match 3.1, link to config manual</revremark></revision><revision><revnumber>16</revnumber><date>2008-06-10 11:45:56</date><authorinitials>AmosJeffries</authorinitials><revremark>make use of 'all' ACL consistent across the FAQ entry.</revremark></revision><revision><revnumber>15</revnumber><date>2008-05-18 19:39:00</date><authorinitials>localhost</authorinitials><revremark>converted to 1.6 markup</revremark></revision><revision><revnumber>14</revnumber><date>2008-05-16 20:58:58</date><authorinitials>eu.squid-cache.org</authorinitials></revision><revision><revnumber>13</revnumber><date>2008-05-15 16:22:27</date><authorinitials>eu.squid-cache.org</authorinitials></revision><revision><revnumber>12</revnumber><date>2008-05-15 16:21:09</date><authorinitials>eu.squid-cache.org</authorinitials></revision><revision><revnumber>11</revnumber><date>2007-10-24 00:02:21</date><authorinitials>AmosJeffries</authorinitials></revision><revision><revnumber>10</revnumber><date>2007-05-31 10:47:33</date><authorinitials>Henrik Nordström</authorinitials></revision><revision><revnumber>9</revnumber><date>2007-03-02 18:24:15</date><authorinitials>kinkie</authorinitials><revremark>Fixed Mistyped link</revremark></revision><revision><revnumber>8</revnumber><date>2006-08-29 10:20:48</date><authorinitials>kinkie</authorinitials><revremark>syntax changes</revremark></revision><revision><revnumber>7</revnumber><date>2006-07-31 11:51:40</date><authorinitials>Henrik Nordström</authorinitials></revision><revision><revnumber>6</revnumber><date>2006-06-05 18:24:33</date><authorinitials>tmcb-u110-3N10E-CE1.byu.edu</authorinitials><revremark>These sites mentioned are not valid anymore</revremark></revision><revision><revnumber>5</revnumber><date>2006-03-04 21:06:17</date><authorinitials>kinkie</authorinitials><revremark>Added chapter on max acl name length</revremark></revision><revision><revnumber>4</revnumber><date>2006-03-03 09:26:12</date><authorinitials>kinkie</authorinitials></revision><revision><revnumber>3</revnumber><date>2006-02-08 13:51:15</date><authorinitials>kinkie</authorinitials><revremark>added sample parent auth helper</revremark></revision><revision><revnumber>2</revnumber><date>2006-02-08 13:36:48</date><authorinitials>kinkie</authorinitials><revremark>Markup Fixes. Added to &quot;Proxy-authentication and neighbor caches&quot;. Link to Index</revremark></revision><revision><revnumber>1</revnumber><date>2006-01-25 04:48:02</date><authorinitials>kinkie</authorinitials></revision></revhistory></articleinfo><section><title>Access Controls in Squid</title><section><title>The Basics: How the parts fit together</title><para>Squid's access control scheme is relatively comprehensive and difficult for some people to understand.  There are two different components: <emphasis>ACL elements</emphasis>, and <emphasis>access lists</emphasis>.  An access list consists of an <emphasis>allow</emphasis> or <emphasis>deny</emphasis> action followed by a number of ACL elements. </para><para>When loading the configuration file Squid processes all the <ulink url="http://www.squid-cache.org/Doc/config/acl#">acl</ulink> lines (directives) into memory as tests which can be performed against any request transaction. Types of tests are outlined in the next section <emphasis>ACL Elements</emphasis>. By themselves these tests do nothing. For example; the word &quot;Sunday&quot; matches a day of the week, but does not indicate which day of the week you are reading this. </para><para>To process a transaction another type of line is used. As each processing action needs to take place a check in run to test what action or limitations are to occur for the transaction. The types of checks are outlined in the next section <emphasis>Access Lists</emphasis> followed by details of how the checks operate. </para></section><section><title>ACL elements</title><informaltable><tgroup cols="2"><colspec colname="col_0"/><colspec colname="col_1"/><tbody><row rowsep="1"><entry colsep="1" rowsep="1"><para> <inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> </para></entry><entry colsep="1" rowsep="1"><para>The information here is current for version 3.1 see <ulink url="http://www.squid-cache.org/Doc/config/acl#">acl</ulink> for the latest configuration guide list of available types. </para></entry></row></tbody></tgroup></informaltable><para>Squid knows about the following types of ACL elements: </para><para>***** ACL TYPES AVAILABLE ***** </para><itemizedlist><listitem><para><emphasis role="strong">src</emphasis>: source (client) IP addresses </para></listitem><listitem><para><emphasis role="strong">dst</emphasis>: destination (server) IP addresses </para></listitem><listitem><para><emphasis role="strong">myip</emphasis>: the local IP address of a client's connection </para></listitem><listitem><para><emphasis role="strong">arp</emphasis>: Ethernet (MAC) address matching </para></listitem><listitem><para><emphasis role="strong">srcdomain</emphasis>: source (client) domain name </para></listitem><listitem><para><emphasis role="strong">dstdomain</emphasis>: destination (server) domain name </para></listitem><listitem><para><emphasis role="strong">srcdom_regex</emphasis>: source (client) regular expression pattern matching </para></listitem><listitem><para><emphasis role="strong">dstdom_regex</emphasis>: destination (server) regular expression pattern matching </para></listitem><listitem><para><emphasis role="strong">src_as</emphasis>: source (client) Autonomous System number </para></listitem><listitem><para><emphasis role="strong">dst_as</emphasis>: destination (server) Autonomous System number </para></listitem><listitem><para><emphasis role="strong">peername</emphasis>: name tag assigned to the cache_peer where request is expected to be sent. </para></listitem><listitem><para><emphasis role="strong">time</emphasis>: time of day, and day of week </para></listitem><listitem><para><emphasis role="strong">url_regex</emphasis>: URL regular expression pattern matching </para></listitem><listitem><para><emphasis role="strong">urlpath_regex</emphasis>: URL-path regular expression pattern matching, leaves out the protocol and hostname </para></listitem><listitem><para><emphasis role="strong">port</emphasis>: destination (server) port number </para></listitem><listitem><para><emphasis role="strong">myport</emphasis>: local port number that client connected to </para></listitem><listitem><para><emphasis role="strong">myportname</emphasis>: name tag assigned to the squid listening port that client connected to </para></listitem><listitem><para><emphasis role="strong">proto</emphasis>: transfer protocol (http, ftp, etc) </para></listitem><listitem><para><emphasis role="strong">method</emphasis>: HTTP request method (get, post, etc) </para></listitem><listitem><para><emphasis role="strong">http_status</emphasis>: HTTP response status (200 302 404 etc.) </para></listitem><listitem><para><emphasis role="strong">browser</emphasis>: regular expression pattern matching on the request user-agent header </para></listitem><listitem><para><emphasis role="strong">referer_regex</emphasis>: regular expression pattern matching on the request http-referer header </para></listitem><listitem><para><emphasis role="strong">ident</emphasis>: string matching on the user's name </para></listitem><listitem><para><emphasis role="strong">ident_regex</emphasis>: regular expression pattern matching on the user's name </para></listitem><listitem><para><emphasis role="strong">proxy_auth</emphasis>: user authentication via external processes </para></listitem><listitem><para><emphasis role="strong">proxy_auth_regex</emphasis>: regular expression pattern matching on user authentication via external processes </para></listitem><listitem><para><emphasis role="strong">snmp_community</emphasis>: SNMP community string matching </para></listitem><listitem><para><emphasis role="strong">maxconn</emphasis>: a limit on the maximum number of connections from a single client IP address </para></listitem><listitem><para><emphasis role="strong">max_user_ip</emphasis>: a limit on the maximum number of IP addresses one user can login from </para></listitem><listitem><para><emphasis role="strong">req_mime_type</emphasis>: regular expression pattern matching on the request content-type header </para></listitem><listitem><para><emphasis role="strong">req_header</emphasis>: regular expression pattern matching on a request header content </para></listitem><listitem><para><emphasis role="strong">rep_mime_type</emphasis>: regular expression pattern matching on the reply (downloaded content) content-type header. This is only usable in the http_reply_access directive, not http_access. </para></listitem><listitem><para><emphasis role="strong">rep_header</emphasis>: regular expression pattern matching on a reply header content. This is only usable in the http_reply_access directive, not http_access. </para></listitem><listitem><para><emphasis role="strong">external</emphasis>: lookup via external acl helper defined by external_acl_type </para></listitem><listitem><para><emphasis role="strong">user_cert</emphasis>: match against attributes in a user SSL certificate </para></listitem><listitem><para><emphasis role="strong">ca_cert</emphasis>: match against attributes a users issuing CA SSL certificate </para></listitem><listitem><para><emphasis role="strong">ext_user</emphasis>: match on user= field returned by external acl helper defined by external_acl_type </para></listitem><listitem><para><emphasis role="strong">ext_user_regex</emphasis>: regular expression pattern matching on user= field returned by external acl helper defined by external_acl_type </para></listitem></itemizedlist><para><emphasis role="strong">Notes</emphasis>: </para><para>Not all of the ACL elements can be used with all types of access lists (described below).  For example, <emphasis>snmp_community</emphasis> is only meaningful when used with <ulink url="http://www.squid-cache.org/Doc/config/snmp_access#">snmp_access</ulink>.  The <emphasis>src_as</emphasis> and <emphasis>dst_as</emphasis> types are only used in <ulink url="http://www.squid-cache.org/Doc/config/cache_peer_access#">cache_peer_access</ulink> lines. </para><para>The <emphasis>arp</emphasis> ACL requires the special configure option --enable-arp-acl in Squid-3.1 and older, for newer Squid versions EUI-48 (aka MAC address) support is enabled by default.  Furthermore, the ARP / EUI-48 code is not portable to all operating systems.  It works on Linux, Solaris, and some *BSD variants. </para><para>The SNMP ACL element and access list require the --enable-snmp configure option. </para><para>Some ACL elements can cause processing delays.  For example, use of <emphasis>srcdomain</emphasis> and <emphasis>srcdom_regex</emphasis> require a reverse DNS lookup on the client's IP address.  This lookup adds some delay to the request. </para><para>Each ACL element is assigned a unique <emphasis>name</emphasis>.  A named ACL element consists of a <emphasis>list of values</emphasis>. When checking for a match, the multiple values use OR logic.  In other words, an ACL element is <emphasis>matched</emphasis> when any one of its values is a match. </para><para>You can't give the same name to two different types of ACL elements.  It will generate a syntax error. </para><para>You can put different values for the same ACL name on different lines.  Squid combines them into one list. </para></section><section><title>Access Lists</title><para>There are a number of different access lists: </para><itemizedlist><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/http_access#">http_access</ulink>: Allows HTTP clients (browsers) to access the HTTP port.  This is the primary access control list. </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/http_reply_access#">http_reply_access</ulink>: Allows HTTP clients (browsers) to receive the reply to their request. This further restricts permissions given by <ulink url="http://www.squid-cache.org/Doc/config/http_access#">http_access</ulink>, and is primarily intended to be used together with rep_mime_type <ulink url="http://www.squid-cache.org/Doc/config/acl#">acl</ulink> for blocking different content types. </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/icp_access#">icp_access</ulink>: Allows neighbor caches to query your cache with ICP. </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/miss_access#">miss_access</ulink>: Allows certain clients to forward cache misses through your cache. This further restricts permissions given by <ulink url="http://www.squid-cache.org/Doc/config/http_access#">http_access</ulink>, and is primarily intended to be used for enforcing sibling relations by denying siblings from forwarding cache misses through your cache. </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/cache#">cache</ulink>: Defines responses that should not be cached. </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/url_rewrite_access#">url_rewrite_access</ulink>: Controls which requests are sent through the redirector pool. </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/ident_lookup_access#">ident_lookup_access</ulink>: Controls which requests need an Ident lookup. </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/always_direct#">always_direct</ulink>: Controls which requests should always be forwarded directly to origin servers. </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/never_direct#">never_direct</ulink>: Controls which requests should never be forwarded directly to origin servers. </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/snmp_access#">snmp_access</ulink>: Controls SNMP client access to the cache. </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/broken_posts#">broken_posts</ulink>: Defines requests for which squid appends an extra CRLF after POST message bodies as required by some broken origin servers. </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/cache_peer_access#">cache_peer_access</ulink>: Controls which requests can be forwarded to a given neighbor (<ulink url="http://www.squid-cache.org/Doc/config/cache_peer#">cache_peer</ulink>). </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/htcp_access#">htcp_access</ulink>: Controls which remote machines are able to make HTCP requests. </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/htcp_clr_access#">htcp_clr_access</ulink>: Controls which remote machines are able to make HTCP CLR requests. </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/request_header_access#">request_header_access</ulink>: Controls which request headers are removed when violating HTTP protocol. </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/reply_header_access#">reply_header_access</ulink>: Controls which reply headers are removed from delivery to the client when violating HTTP protocol. </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/delay_access#">delay_access</ulink>: Controls which requests are handled by what <ulink url="https://wiki.squid-cache.org/SquidFaq/SquidAcl/Features/DelayPools#">delay pool</ulink> </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/icap_access#">icap_access</ulink>: (replaced by <ulink url="http://www.squid-cache.org/Doc/config/adaptation_access#">adaptation_access</ulink> in <ulink url="https://wiki.squid-cache.org/SquidFaq/SquidAcl/Squid-3.1#">Squid-3.1</ulink>) What requests may be sent to a particular ICAP server. </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/adaptation_access#">adaptation_access</ulink>: What requests may be sent to a particular ICAP or eCAP filter service. </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/log_access#">log_access</ulink>: Controls which requests are logged. This is global and overrides specific file access lists appended to <ulink url="http://www.squid-cache.org/Doc/config/access_log#">access_log</ulink> directives. </para></listitem></itemizedlist><para><emphasis role="strong">Notes</emphasis>: </para><para>An access list <emphasis>rule</emphasis> consists of an <emphasis>allow</emphasis> or <emphasis>deny</emphasis> keyword, followed by a list of ACL element names. </para><para>An access list consists of one or more access list rules. </para><para>Access list rules are checked in the order they are written.  List searching terminates as soon as one of the rules is a match. </para><para>If a rule has multiple ACL elements, it uses AND logic.  In other words, <emphasis>all</emphasis> ACL elements of the rule must be a match in order for the rule to be a match.  This means that it is possible to write a rule that can never be matched.  For example, a port number can never be equal to both 80 AND 8000 at the same time. </para><para>To summarize the ACL logics can be described as: (note: AND/OR below is just for illustartion, not part of the syntax) </para><screen><![CDATA[http_access allow|deny acl AND acl AND ...
        OR
http_access allow|deny acl AND acl AND ...
        OR
...]]></screen><para>If none of the configured rules match, then Squid <emphasis>reverses</emphasis> the action of the last configured rule. For example, if the last configured http_access action was &quot;allow&quot;, then Squid denies access. </para><para>Consult directive-specific documentation for that directive <emphasis>default</emphasis> behavior. For example, if no http_access rules are configured at all, Squid denies access. </para><para>Relying on these implicit defaults is dangerous because Squid action may &quot;unexpectedly&quot; change when you add or remove the last configured rule. It is best to end your rules with an explicit rule that will match any transaction. For example: </para><screen><![CDATA[http_access deny all]]></screen></section><section><title>How do I allow my clients to use the cache?</title><para>Define an ACL that corresponds to your client's IP addresses. For example: </para><screen><![CDATA[acl myclients src 172.16.5.0/24]]></screen><para>Next, allow those clients in the <emphasis><ulink url="http://www.squid-cache.org/Doc/config/http_access#">http_access</ulink></emphasis> list: </para><screen><![CDATA[http_access allow myclients]]></screen></section><section><title>how do I configure Squid not to cache a specific server?</title><screen><![CDATA[acl someserver dstdomain .someserver.com
cache deny someserver]]></screen></section><section><title>How do I implement an ACL ban list?</title><para>As an example, we will assume that you would like to prevent users from accessing cooking recipes. </para><para>One way to implement this would be to deny access to any URLs that contain the words &quot;cooking&quot; or &quot;recipe.&quot; You would use these configuration lines: </para><screen><![CDATA[acl Cooking1 url_regex cooking
acl Recipe1 url_regex recipe
acl myclients src 172.16.5.0/24
http_access deny Cooking1
http_access deny Recipe1
http_access allow myclients
http_access deny all]]></screen><para>The <emphasis>url_regex</emphasis> means to search the entire URL for the regular expression you specify.  Note that these regular expressions are case-sensitive, so a url containing &quot;Cooking&quot; would not be denied. </para><para>Another way is to deny access to specific servers which are known to hold recipes.  For example: </para><screen><![CDATA[acl Cooking2 dstdomain www.gourmet-chef.com
http_access deny Cooking2
http_access allow all]]></screen><para>The <emphasis>dstdomain</emphasis> means to search the hostname in the URL for the string &quot;www.gourmet-chef.com.&quot; Note that when IP addresses are used in URLs (instead of domain names), Squid may have to do a DNS lookup to determine whether the ACL matches: If a domain name for the IP address is already in the Squid's &quot;FQDN cache&quot;, then Squid can immediately compare the destination domain against the access controls. Otherwise, Squid does an asynchronous reverse DNS lookup and evaluates the ACL after that lookup is over. Subsequent ACL evaluations may be able to use the cached lookup result (if any). </para><para>Asynchronous lookups are done for http_access and other directives that support so called &quot;slow&quot; ACLs. If a directive does not support a required asynchronous DNS lookup, then modern Squids use &quot;none&quot; instead of the actual domain name to determine whether a dstdomain ACL matches, but you should <emphasis>not</emphasis> rely on that behavior. To disable DNS lookups, use the &quot;-n&quot; ACL option (where supported). </para></section><section><title>How do I block specific users or groups from accessing my cache?</title><section><title>Using Ident</title><para>You can use <ulink url="ftp://ftp.isi.edu/in-notes/rfc931.txt">ident lookups</ulink> to allow specific users access to your cache.  This requires that an <ulink url="ftp://ftp.lysator.liu.se/pub/ident/servers">ident server</ulink> process runs on the user's machine(s). In your <emphasis>squid.conf</emphasis> configuration file you would write something like this: </para><screen><![CDATA[ident_lookup_access allow all
acl friends ident kim lisa frank joe
http_access allow friends
http_access deny all]]></screen><para>Note that <ulink url="http://www.squid-cache.org/Doc/config/ident_lookup_access#">ident_lookup_access</ulink> only permits/denies whether a machine is tested for its Ident. This does not directly alter access to the users request. </para></section></section><section><title>Is there a way to do ident lookups only for a certain host and compare the result with a userlist in squid.conf?</title><para>You can use the <emphasis><ulink url="http://www.squid-cache.org/Doc/config/ident_lookup_access#">ident_lookup_access</ulink></emphasis> directive to control for which hosts Squid will issue <ulink url="ftp://ftp.isi.edu/in-notes/rfc931.txt">ident lookup</ulink> requests. </para><para>Additionally, if you use a <emphasis>ident</emphasis> ACL in squid.conf, then Squid will make sure an ident lookup is performed while evaluating the acl even if <emphasis><ulink url="http://www.squid-cache.org/Doc/config/ident_lookup_access#">ident_lookup_access</ulink></emphasis> does not indicate ident lookups should be performed earlier. </para><para>However, Squid does not wait for the lookup to complete unless the ACL rules require it.  Consider this configuration: </para><screen><![CDATA[acl host1 src 10.0.0.1
acl host2 src 10.0.0.2
acl pals  ident kim lisa frank joe
http_access allow host1
http_access allow host2 pals]]></screen><para>Requests coming from 10.0.0.1 will be allowed immediately because there are no user requirements for that host.  However, requests from 10.0.0.2 will be allowed only after the ident lookup completes, and if the username is in the set kim, lisa, frank, or joe. </para><section><title>Using Proxy Authentication</title><para>Another option is to use proxy-authentication.    In this scheme, you assign usernames and passwords to individuals.  When they first use the proxy they are asked to authenticate themselves by entering their username and password. </para><para>In Squid this authentication is handled via external processes.  For information on how to configure this, please see <ulink url="https://wiki.squid-cache.org/SquidFaq/SquidAcl/SquidFaq/ProxyAuthentication#">SquidFaq/ProxyAuthentication</ulink>. </para></section></section><section><title>Do you have a CGI program which lets users change their own proxy passwords?</title><para><ulink url="mailto:orso@brturbo.com">Pedro L Orso</ulink> has adapted the Apache's <emphasis>htpasswd</emphasis> into a CGI program called  <ulink url="http://www.squid-cache.org/htpasswd/">chpasswd.cgi</ulink>. </para></section><section><title>Common Mistakes</title><section><title>And/Or logic</title><para>Interpretation of ACL-driven directives is based, in part, on the following rules: </para><itemizedlist><listitem><para><emphasis role="strong">All elements of an <emphasis><ulink url="http://www.squid-cache.org/Doc/config/acl#">acl</ulink></emphasis> entry are OR'ed together</emphasis>. </para></listitem><listitem><para><emphasis role="strong">All elements of an <emphasis>access</emphasis> entry are AND'ed together</emphasis> (e.g. <emphasis><ulink url="http://www.squid-cache.org/Doc/config/http_access#">http_access</ulink></emphasis> and <emphasis><ulink url="http://www.squid-cache.org/Doc/config/icp_access#">icp_access</ulink></emphasis>) </para></listitem></itemizedlist><para>For example, the following access control configuration will never work: </para><screen><![CDATA[acl ME src 10.0.0.1
acl YOU src 10.0.0.2
http_access allow ME YOU]]></screen><para>In order for the request to be allowed, it must match the &quot;ME&quot; <ulink url="http://www.squid-cache.org/Doc/config/acl#">acl</ulink> <emphasis role="strong">AND</emphasis> the &quot;YOU&quot; <ulink url="http://www.squid-cache.org/Doc/config/acl#">acl</ulink>. This is impossible because any IP address could only match one or the other.  This should instead be rewritten as: </para><screen><![CDATA[acl ME src 10.0.0.1
acl YOU src 10.0.0.2
http_access allow ME
http_access allow YOU]]></screen><para>Or, alternatively, this would also work: </para><screen><![CDATA[acl US src 10.0.0.1 10.0.0.2
http_access allow US]]></screen></section><section><title>allow/deny mixups</title><para><emphasis>I have read through my squid.conf numerous times, spoken to my neighbors, read the FAQ and Squid Docs and cannot for the life of me work out why the following will not work.</emphasis> </para><para><emphasis>I can successfully access <emphasis role="strong">cachemgr.cgi</emphasis> from our web server machine here, but I would like to use MRTG to monitor various aspects of our proxy. When I try to use <ulink url="https://wiki.squid-cache.org/SquidFaq/SquidAcl/SquidClientTool#">squidclient</ulink> or GET cache_object from the machine the proxy is running on, I always get access denied.</emphasis> </para><screen><![CDATA[acl manager proto cache_object
acl localhost src 127.0.0.1
acl server    src 1.2.3.4
acl ourhosts  src 1.2.0.0/24
http_access deny manager !localhost !server
http_access allow ourhosts
http_access deny all]]></screen><para>The intent here is to allow cache manager requests from the <emphasis>localhost</emphasis> and <emphasis>server</emphasis> addresses, and deny all others.  This policy has been expressed here: </para><screen><![CDATA[http_access deny manager !localhost !server]]></screen><para>The problem here is that for allowable requests, this access rule is not matched.  For example, </para><itemizedlist><listitem><para>if the source IP address is <emphasis>localhost</emphasis>, then &quot;!localhost&quot; is <emphasis>false</emphasis> and the access rule is not matched, so Squid continues checking the other rules. </para></listitem><listitem><para>if the source IP address is <emphasis>server</emphasis>, then &quot;!server is <emphasis>false</emphasis> and the access rule is not matched, so Squid continues checking the other rules. </para></listitem></itemizedlist><para>Cache manager requests from the <emphasis>server</emphasis> address work because <emphasis>server</emphasis> is a subset of <emphasis role="strong">ourhosts</emphasis> and the second access rule will match and allow the request. </para><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/alert.png" width="15"/></imageobject><textobject><phrase>/!\</phrase></textobject></inlinemediaobject> Also note that this means any cache manager request from <emphasis>ourhosts</emphasis> would be allowed. </para></listitem></itemizedlist><para>To implement the desired policy correctly, the access rules should be rewritten as </para><screen><![CDATA[http_access allow manager localhost
http_access allow manager server
http_access deny manager
http_access allow ourhosts
http_access deny all]]></screen><para>If you're using <emphasis><ulink url="http://www.squid-cache.org/Doc/config/miss_access#">miss_access</ulink></emphasis>, then don't forget to also add a <emphasis><ulink url="http://www.squid-cache.org/Doc/config/miss_access#">miss_access</ulink></emphasis> rule for the cache manager: </para><screen><![CDATA[miss_access allow manager]]></screen><para>You may be concerned that the having five access rules instead of three may have an impact on the cache performance.  In our experience this is not the case.  Squid is able to handle a moderate amount of access control checking without degrading overall performance.  You may like to verify that for yourself, however. </para></section><section><title>Differences between ''src'' and ''srcdomain'' ACL types</title><para>For the <emphasis>srcdomain</emphasis> ACL type, Squid does a reverse lookup of the client's IP address and checks the result with the domains given on the <emphasis><ulink url="http://www.squid-cache.org/Doc/config/acl#">acl</ulink></emphasis> line.  With the <emphasis>src</emphasis> ACL type, Squid converts hostnames to IP addresses at startup and then only compares the client's IP address.  The <emphasis>src</emphasis> ACL is preferred over <emphasis>srcdomain</emphasis> because it does not require address-to-name lookups for each request. </para></section></section><section><title>I set up my access controls, but they don't work!  why?</title><para>If ACLs are giving you problems and you don't know why they aren't working, you can use this tip to debug them. </para><para>In <emphasis>squid.conf</emphasis> enable debugging for section 33 at level 2. For example: </para><screen><![CDATA[debug_options ALL,1 33,2]]></screen><para>Then restart or reconfigure squid. </para><para>From now on, your <emphasis>cache.log</emphasis> should contain a line for every request that explains if it was allowed, or denied, and which ACL was the last one that it matched. </para><para>If this does not give you sufficient information to nail down the problem you can also enable detailed debug information on ACL processing </para><screen><![CDATA[debug_options ALL,1 33,2 28,9]]></screen><para>Then restart or reconfigure squid as above. </para><para>From now on, your <emphasis>cache.log</emphasis> should contain detailed traces of all access list processing. Be warned that this can be quite some lines per request. </para><para>See also <ulink url="https://wiki.squid-cache.org/SquidFaq/SquidAcl/SquidFaq/TroubleShooting#">SquidFaq/TroubleShooting</ulink>. </para></section><section><title>Proxy-authentication and neighbor caches</title><para><emphasis role="strong"> The problem </emphasis> </para><screen><![CDATA[               [ Parents ]
               /         \
              /           \
       [ Proxy A ] --- [ Proxy B ]
           |
           |
          USER]]></screen><para><emphasis>Proxy A sends and ICP query to Proxy B about an object, Proxy B replies with an ICP_HIT.  Proxy A forwards the HTTP request to Proxy B, but does not pass on the authentication details, therefore the HTTP GET from Proxy A fails.</emphasis> </para><para>Only ONE proxy cache in a chain is allowed to &quot;use&quot; the Proxy-Authentication request header.  Once the header is used, it must not be passed on to other proxies. </para><para>Therefore, you must allow the neighbor caches to request from each other without proxy authentication.  This is simply accomplished by listing the neighbor ACL's first in the list of <emphasis><ulink url="http://www.squid-cache.org/Doc/config/http_access#">http_access</ulink></emphasis> lines.  For example: </para><screen><![CDATA[acl proxy-A src 10.0.0.1
acl proxy-B src 10.0.0.2
acl user_passwords proxy_auth /tmp/user_passwds
http_access allow proxy-A
http_access allow proxy-B
http_access allow user_passwords
http_access deny all]]></screen><para>Squid-2.5 allows two exceptions to this rule, by defining the appropriate <ulink url="http://www.squid-cache.org/Doc/config/cache_peer#">cache_peer</ulink> options: </para><screen><![CDATA[cache_peer parent.foo.com parent login=PASS]]></screen><para>This will forward the user's credentials <emphasis role="strong">as-is</emphasis> to the parent proxy which will be thus able to authenticate again. </para><informaltable><tgroup cols="2"><colspec colname="col_0"/><colspec colname="col_1"/><tbody><row rowsep="1"><entry colsep="1" rowsep="1"><para> <inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/attention.png" width="15"/></imageobject><textobject><phrase>&lt;!&gt;</phrase></textobject></inlinemediaobject> </para></entry><entry colsep="1" rowsep="1"><para>This will <emphasis role="strong">only</emphasis> work with the <emphasis>Basic</emphasis> authentication scheme. If any other scheme is enabled, it will fail </para></entry></row></tbody></tgroup></informaltable><screen><![CDATA[cache_peer parent.foo.com parent login=*:somepassword]]></screen><para>This will perform <emphasis>Basic</emphasis> authentication against the parent, sending the <emphasis role="strong">username</emphasis> of the current client connection and as password <emphasis role="strong">always</emphasis> <emphasis>somepassword</emphasis>. The parent will need to authorization against the child cache's IP address, as if there was no authentication forwarding, and it will need to perform client authentication for all usernames against <emphasis>somepassword</emphasis> via a specially-designed authentication helper. The purpose is to log the client cache's usernames into the parent's <emphasis>access.log</emphasis>. You can find an example semi-tested helper of that kind as <ulink url="https://wiki.squid-cache.org/SquidFaq/SquidAcl/SquidFaq/SquidAcl?action=AttachFile&amp;do=get&amp;target=parent_auth.pl">parent_auth.pl</ulink> . </para></section><section><title>Is there an easy way of banning all Destination addresses except one?</title><screen><![CDATA[acl GOOD dst 10.0.0.1
http_access allow GOOD
http_access deny all]]></screen></section><section><title>How can I block access to porn sites?</title><para>Often, the hardest part about using Squid to deny pornography is coming up with the list of sites that should be blocked.  You may want to maintain such a list yourself, or get one from somewhere else (see below).  Note that once you start blocking web content, users will try to use web proxies to circumvent the porn filter, hence you will also need to block all web proxies (visit <ulink url="http://www.proxy.org"/> if you do not know what a web proxy is). </para><para>The ACL syntax for using such a list depends on its contents. If the list contains regular expressions, use this: </para><screen><![CDATA[acl PornSites url_regex "/usr/local/squid/etc/pornlist"
http_access deny PornSites]]></screen><para>On the other hand, if the list contains origin server hostnames, simply change <emphasis>url_regex</emphasis> to <emphasis>dstdomain</emphasis> in this example. </para></section><section><title>Does anyone have a ban list of porn sites and such?</title><itemizedlist><listitem><para>The <ulink url="http://www.squidblacklist.org/"/> site contains a number of free blacklists designed specifically for use in Squid. </para></listitem><listitem><para>The <ulink url="http://www.squidguard.org/blacklists.html">SquidGuard</ulink> redirector folks have links to some lists. </para></listitem><listitem><para>The maintainer of the free <ulink url="http://www.urlfilterdb.com/">ufdbGuard</ulink> redirector has a commercial URL database. </para></listitem><listitem><para>Bill Stearns maintains the <ulink url="http://www.stearns.org/sa-blacklist/">sa-blacklist</ulink> of known spammers. By blocking the spammer web sites in squid, users can no longer use up bandwidth downloading spam images and html. Even more importantly, they can no longer send out requests for things like scripts and gifs that have a unique identifer attached, showing that they opened the email and making their addresses more valuable to the spammer. </para></listitem><listitem><para>The <ulink url="http://freshmeat.net/projects/sleezeball/">SleezeBall site</ulink> has a list of patterns that you can download. </para></listitem><listitem><para>The <ulink url="http://www.shallalist.de/Downloads/shallalist.tar.gz">Shalla Secure Services</ulink> provide a nice downloadable blacklist on free basis with many categories. </para></listitem></itemizedlist><para>Note that once you start blocking web content, users will try to use web proxies to circumvent the filtering, hence you will also need to block all web proxies. </para></section><section><title>Squid doesn't match my subdomains</title><para>If you are using Squid-2.4 or later then keep in mind that dstdomain acls uses different syntax for exact host matches and entire domain matches. <emphasis>www.example.com</emphasis> matches the <emphasis role="strong">exact host</emphasis> <emphasis>www.example.com</emphasis>, while <emphasis>.example.com</emphasis> matches the <emphasis role="strong">entire domain</emphasis> example.com (including example.com alone) </para><para>There is also subtle issues if your dstdomain ACLs contains matches for both an exact host in a domain and the whole domain where both are in the same domain (i.e. both <emphasis>www.example.com</emphasis> and <emphasis>.example.com</emphasis>). Depending on how your data is ordered this may cause only the most specific of these (e.g. <emphasis>www.example.com</emphasis>) to be used. </para><informaltable><tgroup cols="2"><colspec colname="col_0"/><colspec colname="col_1"/><tbody><row rowsep="1"><entry colsep="1" rowsep="1"><para> <inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> </para></entry><entry colsep="1" rowsep="1"><para>Squid-2.4 and later will warn you when this kind of configuration is used. If your Squid does not warn you while reading the configuration file you do not have the problem described below. Also the configuration here uses the dstdomain syntax of Squid-2.1 or earlier.. (Squid-2.2 and later needs to have domains prefixed by a dot) </para></entry></row></tbody></tgroup></informaltable><para>There is a subtle problem with domain-name based access controls when a single ACL element has an entry that is a subdomain of another entry.  For example, consider this list: </para><screen><![CDATA[acl FOO dstdomain boulder.co.us vail.co.us .co.us]]></screen><para>In the first place, the above list is simply wrong because the first two (<emphasis>boulder.co.us</emphasis> and <emphasis>vail.co.us</emphasis>) are unnecessary.  Any domain name that matches one of the first two will also match the last one (<emphasis>co.us</emphasis>).  Ok, but why does this happen? </para><para>The problem stems from the data structure used to index domain names in an access control list.  Squid uses <emphasis>Splay trees</emphasis> for lists of domain names.  As other tree-based data structures, the searching algorithm requires a comparison function that returns -1, 0, or +1 for any pair of keys (domain names).  This is similar to the way that <emphasis>strcmp()</emphasis> works. </para><para>The problem is that it is wrong to say that <emphasis>co.us</emphasis> is greater-than, equal-to, or less-than <emphasis>boulder.co.us</emphasis>. </para><para>For example, if you said that <emphasis>co.us</emphasis> is LESS than <emphasis>fff.co.us</emphasis>, then the Splay tree searching algorithm might never discover <emphasis>co.us</emphasis> as a match for <emphasis>kkk.co.us</emphasis>. </para><para>similarly, if you said that <emphasis>co.us</emphasis> is GREATER than <emphasis>fff.co.us</emphasis>, then the Splay tree searching algorithm might never discover <emphasis>co.us</emphasis> as a match for <emphasis>bbb.co.us</emphasis>. </para><para>The bottom line is that you can't have one entry that is a subdomain of another.  Squid will warn you if it detects this condition. </para></section><section><title>Why does Squid deny some port numbers?</title><para>It is dangerous to allow Squid to connect to certain port numbers. For example, it has been demonstrated that someone can use Squid as an SMTP (email) relay.  As I'm sure you know, SMTP relays are one of the ways that spammers are able to flood our mailboxes. To prevent mail relaying, Squid denies requests when the URL port number is 25.  Other ports should be blocked as well, as a precaution against other less common attacks. </para><para>There are two ways to filter by port number: either allow specific ports, or deny specific ports.  By default, Squid does the first.  This is the ACL entry that comes in the default <emphasis>squid.conf</emphasis>: </para><screen><![CDATA[acl Safe_ports port 80 21 443 563 70 210 1025-65535
http_access deny !Safe_ports]]></screen><para>The above configuration denies requests when the URL port number is not in the list.  The list allows connections to the standard ports for HTTP, FTP, Gopher, SSL, WAIS, and all non-privileged ports. </para><para>Another approach is to deny dangerous ports.  The dangerous port list should look something like: </para><screen><![CDATA[acl Dangerous_ports port 7 9 19 22 23 25 53 109 110 119
http_access deny Dangerous_ports]]></screen><para>...and probably many others. </para><para>Please consult the <emphasis>/etc/services</emphasis> file on your system for a list of known ports and protocols. </para></section><section><title>Does Squid support the use of a database such as mySQL for storing the ACL list?</title><para>Yes, Squid supports acl interaction with external data sources via the <ulink url="http://www.squid-cache.org/Doc/config/external_acl_type#">external_acl_type</ulink> directive. Helpers for LDAP and NT Domain group membership is included in the distribution and it's very easy to write additional helpers to fit your environment. </para></section><section><title>How can I allow a single address to access a specific URL?</title><para>This example allows only the <emphasis>special_client</emphasis> to access the <emphasis>special_url</emphasis>.  Any other client that tries to access the <emphasis>special_url</emphasis> is denied. </para><screen><![CDATA[acl special_client src 10.1.2.3
acl special_url url_regex ^http://www.squid-cache.org/Doc/FAQ/$
http_access allow special_client special_url
http_access deny special_url]]></screen></section><section><title>How can I allow some clients to use the cache at specific times?</title><para>Let's say you have two workstations that should only be allowed access to the Internet during working hours (8:30 - 17:30).  You can use something like this: </para><screen><![CDATA[acl FOO src 10.1.2.3 10.1.2.4
acl WORKING time MTWHF 08:30-17:30
http_access allow FOO WORKING
http_access deny FOO]]></screen></section><section><title>How can I allow some users to use the cache at specific times?</title><screen><![CDATA[acl USER1 proxy_auth Dick
acl USER2 proxy_auth Jane
acl DAY time 06:00-18:00
http_access allow USER1 DAY
http_access deny USER1
http_access allow USER2 !DAY
http_access deny USER2]]></screen></section><section><title>Problems with IP ACL's that have complicated netmasks</title><para>The following ACL entry gives inconsistent or unexpected results: </para><screen><![CDATA[acl restricted  src 10.0.0.128/255.0.0.128 10.85.0.0/16]]></screen><para>The reason is that IP access lists are stored in &quot;splay&quot; tree data structures. These trees require the keys (i.e. address/mask pairs) to follow a strong sorting order. Complicated or non-standard netmasks (like the 255.0.0.128 netmask that uses a non-CIDR netmask notation) break the key comparison function. </para><para>The best way to fix this problem is to use separate ACL names for each ACL value.  For example, change the above to: </para><screen><![CDATA[acl restricted1 src 10.0.0.128/255.0.0.128
acl restricted2 src 10.85.0.0/16]]></screen><para>Then, of course, you'll have to rewrite your <emphasis><ulink url="http://www.squid-cache.org/Doc/config/http_access#">http_access</ulink></emphasis> lines as well. </para></section><section><title>Can I set up ACL's based on MAC address rather than IP?</title><para>Yes, for some operating systes. The ACL type is named <emphasis>arp</emphasis> after the ARP protocol used in IPv4 to fetch the EUI-48 / MAC address. This ACL is supported on Linux, Solaris, and probably BSD variants. </para><informaltable><tgroup cols="2"><colspec colname="col_0"/><colspec colname="col_1"/><tbody><row rowsep="1"><entry colsep="1" rowsep="1"><para> <inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/alert.png" width="15"/></imageobject><textobject><phrase>/!\</phrase></textobject></inlinemediaobject> </para></entry><entry colsep="1" rowsep="1"><para>MAC address is only available for clients that are on the same subnet.  If the client is on a different subnet, then Squid can not find out its MAC address as the MAC is replaced by the router MAC when a packet is router. </para></entry></row></tbody></tgroup></informaltable><para>For <ulink url="https://wiki.squid-cache.org/SquidFaq/SquidAcl/Squid-3.1#">Squid-3.1</ulink> and older to use ARP (MAC) access controls, you first need to compile in the optional code. </para><para>Do this with the <emphasis>--enable-arp-acl</emphasis> configure option: </para><screen><![CDATA[% ./configure --enable-arp-acl ...
% make clean
% make]]></screen><para>If <emphasis>src/acl.c</emphasis> doesn't compile, then ARP ACLs are probably not supported on your system. </para><para>For <ulink url="https://wiki.squid-cache.org/SquidFaq/SquidAcl/Squid-3.2#">Squid-3.2</ulink> and newer the EUI support is enabled by default whenever it can be used. </para><para>Add some <emphasis>arp</emphasis> ACL lines to your squid.conf: </para><screen><![CDATA[acl M1 arp 01:02:03:04:05:06
acl M2 arp 11:12:13:14:15:16
http_access allow M1
http_access allow M2
http_access deny all]]></screen><para>Run <emphasis role="strong">squid -k parse</emphasis> to confirm that the ARP / EUI supprot is available and the ACLs are going to work. </para></section><section><title>Can I limit the number of connections from a client?</title><para>Yes, use the <emphasis>maxconn</emphasis> ACL type in conjunction with <emphasis><ulink url="http://www.squid-cache.org/Doc/config/http_access#">http_access</ulink> deny</emphasis>. For example: </para><screen><![CDATA[acl losers src 1.2.3.0/24
acl 5CONN maxconn 5
http_access deny 5CONN losers]]></screen><para>Given the above configuration, when a client whose source IP address is in the 1.2.3.0/24 subnet tries to establish 6 or more connections at once, Squid returns an error page.  Unless you use the <emphasis><ulink url="http://www.squid-cache.org/Doc/config/deny_info#">deny_info</ulink></emphasis> feature, the error message will just say &quot;access denied.&quot; </para><para>The <emphasis>maxconn</emphasis> ACL requires the <ulink url="http://www.squid-cache.org/Doc/config/client_db#">client_db</ulink> feature.  If you've disabled <ulink url="http://www.squid-cache.org/Doc/config/client_db#">client_db</ulink> (for example with <emphasis><ulink url="http://www.squid-cache.org/Doc/config/client_db#">client_db</ulink> off</emphasis>) then <emphasis>maxconn</emphasis> ALCs will not work. </para><para>Note, the <emphasis>maxconn</emphasis> ACL type is kind of tricky because it uses less-than comparison.  The ACL is a match when the number of established connections is <emphasis>greater</emphasis> than the value you specify.  Because of that, you don't want to use the <emphasis>maxconn</emphasis> ACL with <emphasis><ulink url="http://www.squid-cache.org/Doc/config/http_access#">http_access</ulink> allow</emphasis>. </para><para>Also note that you could use <emphasis>maxconn</emphasis> in conjunction with a user type (ident, proxy_auth), rather than an IP address type. </para></section><section><title>I'm trying to deny ''foo.com'', but it's not working.</title><para>In Squid-2.3 we changed the way that Squid matches subdomains. There is a difference between <emphasis>.foo.com</emphasis> and <emphasis>foo.com</emphasis>.  The first matches any domain in <emphasis>foo.com</emphasis>, while the latter matches only &quot;foo.com&quot; exactly.  So if you want to deny <emphasis>bar.foo.com</emphasis>, you should write </para><screen><![CDATA[acl yuck dstdomain .foo.com
http_access deny yuck]]></screen></section><section><title>I want to customize, or make my own error messages.</title><para>You can customize the existing error messages as described in <emphasis>Customizable Error Messages</emphasis> in <ulink url="https://wiki.squid-cache.org/SquidFaq/SquidAcl/SquidFaq/MiscFeatures#">SquidFaq/MiscFeatures</ulink>. You can also create new error messages and use these in conjunction with the <emphasis><ulink url="http://www.squid-cache.org/Doc/config/deny_info#">deny_info</ulink></emphasis> option. </para><para>For example, lets say you want your users to see a special message when they request something that matches your pornography list. First, create a file named ERR_NO_PORNO in the <emphasis>/usr/local/squid/etc/errors</emphasis> directory.  That file might contain something like this: </para><screen><![CDATA[Our company policy is to deny requests to known porno sites.  If you
feel you've received this message in error, please contact
the support staff (support@this.company.com, 555-1234).]]></screen><para>Next, set up your access controls as follows: </para><screen><![CDATA[acl porn url_regex "/usr/local/squid/etc/porno.txt"
deny_info ERR_NO_PORNO porn
http_access deny porn
(additional http_access lines ...)]]></screen></section><section><title>I want to use local time zone in error messages.</title><para>Squid, by default, uses GMT as timestamp in all generated error messages. This to allow the cache to participate in a hierarchy of caches in different timezones without risking confusion about what the time is. </para><para>To change the timestamp in Squid generated error messages you must change the Squid signature. See <emphasis>Customizable Error Messages</emphasis> in <ulink url="https://wiki.squid-cache.org/SquidFaq/SquidAcl/SquidFaq/MiscFeatures#">MiscFeatures</ulink>. The signature by defaults uses %T as timestamp, but if you like then you can use %t instead for a timestamp using local time zone. </para></section><section><title>I want to put ACL parameters in an external file.</title><para>by Adam Aube </para><para>Squid can read ACL parameters from an external file. To do this, first place the acl parameters, one per line, in a file. Then, on the ACL line in <emphasis>squid.conf</emphasis>, put the full path to the file in double quotes. </para><para>For example, instead of: </para><screen><![CDATA[acl trusted_users proxy_auth john jane jim]]></screen><para>you would have: </para><screen><![CDATA[acl trusted_users proxy_auth "/usr/local/squid/etc/trusted_users.txt"]]></screen><para>Inside trusted_users.txt, there is: </para><screen><![CDATA[john
jane
jim]]></screen></section><section><title>I want to authorize users depending on their MS Windows group memberships</title><para>There is an excellent resource over at <ulink url="http://workaround.org/squid-ldap"/> on how to use LDAP-based group membership checking. </para><para>Also the <ulink url="https://wiki.squid-cache.org/SquidFaq/SquidAcl/ConfigExamples/Authenticate/Ldap#">LDAP</ulink> or <ulink url="https://wiki.squid-cache.org/SquidFaq/SquidAcl/ConfigExamples/Authenticate/WindowsActiveDirectory#">Active Directory</ulink> config example here in the squid wiki might prove useful. </para></section><section><title>Maximum length of an acl name</title><para>By default the maximum length of an ACL name is 32-1 = 31 characters, but it can be changed by editing the source: in <emphasis>defines.h</emphasis> </para><screen><![CDATA[#define ACL_NAME_SZ 32]]></screen></section><section><title>Fast and Slow ACLs</title><para><anchor id="acl_types"/> </para><para>Some ACL types require information which may not be already available to Squid. Checking them requires suspending work on the current request, querying some external source, and resuming work when the needed information becomes available. This is for example the case for DNS, authenticators or external authorization scripts. ACLs can thus be divided in <emphasis role="strong">FAST</emphasis> ACLs, which do not require going to external sources to be fulfilled, and <emphasis role="strong">SLOW</emphasis> ACLs, which do. </para><para>Fast ACLs include (as of squid 3.1.0.7): </para><itemizedlist><listitem><para>all (built-in) </para></listitem><listitem><para>src </para></listitem><listitem><para>dstdomain </para></listitem><listitem><para>dstdom_regex </para></listitem><listitem><para>myip </para></listitem><listitem><para>arp </para></listitem><listitem><para>src_as </para></listitem><listitem><para>peername </para></listitem><listitem><para>time </para></listitem><listitem><para>url_regex </para></listitem><listitem><para>urlpath_regex </para></listitem><listitem><para>port </para></listitem><listitem><para>myport </para></listitem><listitem><para>myportname </para></listitem><listitem><para>proto </para></listitem><listitem><para>method </para></listitem><listitem><para>http_status {R} </para></listitem><listitem><para>browser </para></listitem><listitem><para>referer_regex </para></listitem><listitem><para>snmp_community </para></listitem><listitem><para>maxconn </para></listitem><listitem><para>max_user_ip </para></listitem><listitem><para>req_mime_type </para></listitem><listitem><para>req_header </para></listitem><listitem><para>rep_mime_type {R} </para></listitem><listitem><para>user_cert </para></listitem><listitem><para>ca_cert </para></listitem></itemizedlist><para>Slow ACLs include: </para><itemizedlist><listitem><para>dst </para></listitem><listitem><para>dst_as </para></listitem><listitem><para>srcdomain </para></listitem><listitem><para>srcdom_regex </para></listitem><listitem><para>ident </para></listitem><listitem><para>ident_regex </para></listitem><listitem><para>proxy_auth </para></listitem><listitem><para>proxy_auth_regex </para></listitem><listitem><para>external </para></listitem><listitem><para>ext_user </para></listitem><listitem><para>ext_user_regex </para></listitem></itemizedlist><para>This list may be incomplete or out-of-date. See your <code>squid.conf.documented</code> file for details. ACL types marked with {R} are <emphasis>reply</emphasis> ACLs, see the dedicated FAQ chapter. </para><para>Squid caches the results of ACL lookups whenever possible, thus slow ACLs will not always need to go to the external data-source. </para><para>Knowing the behaviour of an ACL type is relevant because not all ACL matching directives support all kinds of ACLs. Some check-points will <emphasis role="strong">not</emphasis> suspend the request: they allow (or deny) immediately. If a SLOW acl has to be checked, and the results of the check are not cached, the corresponding ACL result will be as if it didn't match. In other words, such ACL types are in general not reliable in all access check clauses. </para><para>The following are <emphasis role="strong">SLOW</emphasis> access clauses: </para><itemizedlist><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/http_access#">http_access</ulink> </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/adapted_http_access#">adapted_http_access</ulink> (2.x call this <ulink url="http://www.squid-cache.org/Doc/config/http_access2#">http_access2</ulink>) </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/http_reply_access#">http_reply_access</ulink> </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/url_rewrite_access#">url_rewrite_access</ulink> </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/storeurl_access#">storeurl_access</ulink> </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/location_rewrite_access#">location_rewrite_access</ulink> </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/always_direct#">always_direct</ulink> </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/never_direct#">never_direct</ulink> </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/cache#">cache</ulink> </para></listitem></itemizedlist><para>These are instead <emphasis role="strong">FAST</emphasis> access clauses: </para><itemizedlist><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/icp_access#">icp_access</ulink> </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/htcp_access#">htcp_access</ulink> </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/htcp_clr_access#">htcp_clr_access</ulink> </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/miss_access#">miss_access</ulink> </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/ident_lookup_access#">ident_lookup_access</ulink> </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/reply_body_max_size#">reply_body_max_size</ulink> {R} </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/authenticate_ip_shortcircuit_access#">authenticate_ip_shortcircuit_access</ulink> </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/log_access#">log_access</ulink> </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/header_access#">header_access</ulink> </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/delay_access#">delay_access</ulink> </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/snmp_access#">snmp_access</ulink> </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/cache_peer_access#">cache_peer_access</ulink> </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/ssl_bump#">ssl_bump</ulink> </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/sslproxy_cert_error#">sslproxy_cert_error</ulink> </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/follow_x_forwarded_for#">follow_x_forwarded_for</ulink> </para></listitem></itemizedlist><para>Thus the safest course of action is to only use fast ACLs in fast access clauses, and any kind of ACL in slow access clauses. </para><para>A possible workaround which can mitigate the effect of this characteristic consists in exploiting caching, by setting some &quot;useless&quot; ACL checks in slow clauses, so that subsequent fast clauses may have a cached result to evaluate against. </para><!--rule (<hr>) is not applicable to DocBook--><para> Back to the <ulink url="https://wiki.squid-cache.org/SquidFaq/SquidAcl/SquidFaq#">SquidFaq</ulink> </para></section></section></article>