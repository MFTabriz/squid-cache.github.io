<?xml version="1.0" encoding="utf-8"?><!DOCTYPE article  PUBLIC '-//OASIS//DTD DocBook XML V4.4//EN'  'http://www.docbook.org/xml/4.4/docbookx.dtd'><article><articleinfo><title>SquidFaq/ReverseProxy</title><revhistory><revision><revnumber>17</revnumber><date>2010-08-26 11:56:16</date><authorinitials>AmosJeffries</authorinitials><revremark>wikilinks. and mention ignore-cc for accelerators.</revremark></revision><revision><revnumber>16</revnumber><date>2009-02-01 07:26:19</date><authorinitials>AmosJeffries</authorinitials><revremark>split several config examples into ConfigExamples section.</revremark></revision><revision><revnumber>15</revnumber><date>2008-08-25 10:50:24</date><authorinitials>AmosJeffries</authorinitials><revremark>fancy bits</revremark></revision><revision><revnumber>14</revnumber><date>2008-08-25 07:05:18</date><authorinitials>AmosJeffries</authorinitials><revremark>note on login=PASS</revremark></revision><revision><revnumber>13</revnumber><date>2008-05-18 19:39:00</date><authorinitials>localhost</authorinitials><revremark>converted to 1.6 markup</revremark></revision><revision><revnumber>12</revnumber><date>2008-05-12 04:34:05</date><authorinitials>AmosJeffries</authorinitials><revremark>update simple config to prevent non-accelerated requests going to webserver peer</revremark></revision><revision><revnumber>11</revnumber><date>2007-07-31 11:18:51</date><authorinitials>Henrik Nordström</authorinitials><revremark>Merged the two request mapping entries into one, and expanded it slightly.</revremark></revision><revision><revnumber>10</revnumber><date>2007-07-14 11:20:17</date><authorinitials>Henrik Nordström</authorinitials></revision><revision><revnumber>9</revnumber><date>2007-03-06 01:30:56</date><authorinitials>Henrik Nordström</authorinitials></revision><revision><revnumber>8</revnumber><date>2007-02-23 07:16:39</date><authorinitials>Henrik Nordström</authorinitials><revremark>one more parent missing, and added the accel option to http_port for clarity.</revremark></revision><revision><revnumber>7</revnumber><date>2007-02-23 07:09:31</date><authorinitials>Henrik Nordström</authorinitials><revremark>Add parent to cache_peer lines.</revremark></revision><revision><revnumber>6</revnumber><date>2007-01-09 17:33:41</date><authorinitials>Henrik Nordström</authorinitials></revision><revision><revnumber>5</revnumber><date>2007-01-09 17:31:16</date><authorinitials>Henrik Nordström</authorinitials><revremark>Added login=PASS section.</revremark></revision><revision><revnumber>4</revnumber><date>2006-12-31 12:54:15</date><authorinitials>Henrik Nordström</authorinitials></revision><revision><revnumber>3</revnumber><date>2006-12-31 12:47:09</date><authorinitials>Henrik Nordström</authorinitials></revision><revision><revnumber>2</revnumber><date>2006-03-03 09:26:54</date><authorinitials>kinkie</authorinitials></revision><revision><revnumber>1</revnumber><date>2006-01-26 10:03:33</date><authorinitials>kinkie</authorinitials></revision></revhistory></articleinfo><section><title>Reverse Proxy Mode</title><section><title>What is the Reverse Proxy (httpd-accelerator) mode?</title><para>Occasionally people have trouble understanding accelerators and proxy caches, usually resulting from mixed up interpretations of &quot;incoming&quot; and &quot;outgoing&quot; data.  I think in terms of requests (i.e., an outgoing request is from the local site out to the big bad Internet).  The data received in reply is incoming, of course. Others think in the opposite sense of &quot;a request for incoming data&quot;. </para><para>An accelerator caches incoming requests for outgoing data (i.e., that which you publish to the world).  It takes load away from your HTTP server and internal network.  You move the server away from port 80 (or whatever your published port is), and substitute the accelerator, which then pulls the HTTP data from the &quot;real&quot; HTTP server (only the accelerator needs to know where the real server is).  The outside world sees no difference (apart from an increase in speed, with luck). </para><para>Quite apart from taking the load of a site's normal web server, accelerators can also sit outside firewalls or other network bottlenecks and talk to HTTP servers inside, reducing traffic across the bottleneck and simplifying the configuration.  Two or more accelerators communicating via ICP can increase the speed and resilience of a web service to any single failure. </para><para>The Squid redirector can make one accelerator act as a single front-end for multiple servers.  If you need to move parts of your filesystem from one server to another, or if separately administered HTTP servers should logically appear under a single URL hierarchy, the accelerator makes the right thing happen. </para><para>If you wish only to cache the &quot;rest of the world&quot; to improve local users browsing performance, then accelerator mode is irrelevant.  Sites which own and publish a URL hierarchy use an accelerator to improve access to it from the Internet.  Sites wishing to improve their local users' access to other sites' URLs use proxy caches.  Many sites, like us, do both and hence run both. </para><para>Measurement of the Squid cache and its Harvest counterpart suggest an order of magnitude performance improvement over CERN or other widely available caching software.  This order of magnitude performance improvement on hits suggests that the cache can serve as an httpd accelerator, a cache configured to act as a site's primary httpd server (on port 80), forwarding references that miss to the site's real httpd (on port 81). </para><para>In such a configuration, the web administrator renames all non-cachable URLs to the httpd's port (81).  The cache serves references to cachable objects, such as HTML pages and GIFs, and the true httpd (on port 81) serves references to non-cachable objects, such as queries and cgi-bin programs.  If a site's usage characteristics tend toward cachable objects, this configuration can dramatically reduce the site's web workload. </para></section><section><title>How do I set it up?</title><para>Several configurations are possible. The <ulink url="https://wiki.squid-cache.org/SquidFaq/ReverseProxy/ConfigExamples#">ConfigExamples</ulink> section details several variations of Reverse Proxy. </para><para><orderedlist><listitem><ulink url="https://wiki.squid-cache.org/SquidFaq/ReverseProxy/ConfigExamples/Reverse/BasicAccelerator"><emphasis role="strong">ConfigExamples/Reverse/BasicAccelerator</emphasis></ulink></listitem><listitem><ulink url="https://wiki.squid-cache.org/SquidFaq/ReverseProxy/ConfigExamples/Reverse/ExchangeRpc"><emphasis role="strong">ConfigExamples/Reverse/ExchangeRpc</emphasis></ulink></listitem><listitem><ulink url="https://wiki.squid-cache.org/SquidFaq/ReverseProxy/ConfigExamples/Reverse/HttpsVirtualHosting"><emphasis role="strong">ConfigExamples/Reverse/HttpsVirtualHosting</emphasis></ulink></listitem><listitem><ulink url="https://wiki.squid-cache.org/SquidFaq/ReverseProxy/ConfigExamples/Reverse/MultipleWebservers"><emphasis role="strong">ConfigExamples/Reverse/MultipleWebservers</emphasis></ulink></listitem><listitem><ulink url="https://wiki.squid-cache.org/SquidFaq/ReverseProxy/ConfigExamples/Reverse/OutlookWebAccess"><emphasis role="strong">ConfigExamples/Reverse/OutlookWebAccess</emphasis></ulink></listitem><listitem><ulink url="https://wiki.squid-cache.org/SquidFaq/ReverseProxy/ConfigExamples/Reverse/SslWithWildcardCertifiate"><emphasis role="strong">ConfigExamples/Reverse/SslWithWildcardCertifiate</emphasis></ulink></listitem><listitem><ulink url="https://wiki.squid-cache.org/SquidFaq/ReverseProxy/ConfigExamples/Reverse/VirtualHosting"><emphasis role="strong">ConfigExamples/Reverse/VirtualHosting</emphasis></ulink></listitem></orderedlist><!--The macro FullSearchCached caused an error and should be blacklisted. It returned the data '

' which caused the docbook-formatter to choke. Please file a bug.--> </para></section><section><title>Running the web server on the same server</title><para>While not generally recommended it is possible to run both the accelerator and the backend web server on the same host. To do this you need to make them listen on different IP addresses. Usually the loopback address (127.0.0.1 or ::1) is used for the web server. </para><para>In Squid this is done by specifying the public IP address in <ulink url="http://www.squid-cache.org/Doc/config/http_port#">http_port</ulink>, and using loopback address for the web server </para><screen><![CDATA[http_port the.public.ip.address:80 accel defaultsite=your.main.website
cache_peer 127.0.0.1 parent 80 0 no-query originserver]]></screen><para>And<ulink url="http://www.apache.org/">Apache</ulink> may be configured like in <emphasis>httpd.conf </emphasis>to listen on the loopback address: </para><screen><![CDATA[Port 80
BindAddress 127.0.0.1]]></screen><para>Other web servers uses similar directives specifying the address where it should listen for requests. See the manual to your web server for details. </para></section><section><title>Load balancing of backend servers</title><para>To load balance requests among a set of backend servers allow requests to be forwarded to more than one <ulink url="http://www.squid-cache.org/Doc/config/cache_peer#">cache_peer</ulink>, and use one of the load balancing options in the <ulink url="http://www.squid-cache.org/Doc/config/cache_peer#">cache_peer</ulink> lines. I.e. the round-robin option. </para><screen><![CDATA[cache_peer ip.of.server1 parent 80 0 no-query originserver round-robin
cache_peer ip.of.server2 parent 80 0 no-query originserver round-robin]]></screen><para>Other load balancing methods is also available. See squid.conf.default for the full the description of the <ulink url="http://www.squid-cache.org/Doc/config/cache_peer#">cache_peer</ulink> directive options. </para></section><section><title>Common Problems</title><section><title>When using an httpd-accelerator, the port number or host name for redirects or CGI-generated content is wrong</title><para>This happens if the port or domain name of the accelerated content is different from what the client requested.  When your httpd issues a redirect message (e.g. 302 Moved Temporarily) or generates absolute URLs, it only knows the port it's configured on and uses this to build the URL.  Then, when the client requests the redirected URL, it bypasses the accelerator. </para><para>To fix this make sure that defaultsite is the site name requested by clients, and that the port number of <ulink url="http://www.squid-cache.org/Doc/config/http_port#">http_port</ulink> and the backent web server is the same. You may also need to configure the official site name on the web server. </para><para>Alternatively you can also use the location_rewrite helper interface to Squid to fixup redirects on the way out to the client, but this only works for the Location header, not URLs dynamically embedded in the returned content. </para></section><section><title>Access to password protected content fails via the reverse proxy</title><para>If the content on the web servers is password protected then you need to tell the proxy to trust your web server with authentication credentials. This is done via the login= option to <ulink url="http://www.squid-cache.org/Doc/config/cache_peer#">cache_peer</ulink>. Normally you would use login=PASS to have the login information forwarded. The other alternatives is meant to be used when it's the reverse proxy which processes the authentication as such but you like to have information about the authenticated account forwarded to the backend web server. </para><screen><![CDATA[cache_peer ip.of.server parent 80 0 no-query originserver login=PASS]]></screen><informaltable><tgroup cols="2"><colspec colname="col_0"/><colspec colname="col_1"/><tbody><row rowsep="1"><entry colsep="1" rowsep="1"><para> <inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> </para></entry><entry colsep="1" rowsep="1"><para> To pass details back as given <emphasis role="strong">login=PASS</emphasis> is an exact string. </para></entry></row></tbody></tgroup></informaltable></section><section><title>Visitor requests can force fetching new objects from the back-end server</title><para>Client requests can contain <emphasis>Cache-Control:</emphasis> settings specifying no-cache, must-revalidate, or low max-age which cause Squid to revalidate or fetch new content from the backend web server rather earlier than needed. This raises load on the delivery system which can lead to bandwidth problems and rising costs. </para><para>In <ulink url="https://wiki.squid-cache.org/SquidFaq/ReverseProxy/Squid-3.1#">Squid-3.1</ulink> and later the <ulink url="http://www.squid-cache.org/Doc/config/http_port#">http_port</ulink> <emphasis role="strong">ignore-cc</emphasis> options is available on accel ports. This option informs Squid to ignore the visitors control headers and depend solely on the headers provided by backend servers. </para><screen><![CDATA[http_port 80 accel ignore-cc]]></screen><!--rule (<hr>) is not applicable to DocBook--><itemizedlist><listitem override="none"><para>Back to the <ulink url="https://wiki.squid-cache.org/SquidFaq/ReverseProxy/SquidFaq#">SquidFaq</ulink> </para></listitem></itemizedlist></section></section></section></article>