<?xml version="1.0" encoding="utf-8"?><!DOCTYPE article  PUBLIC '-//OASIS//DTD DocBook XML V4.4//EN'  'http://www.docbook.org/xml/4.4/docbookx.dtd'><article><articleinfo><title>SquidFaq/ToomanyMisses</title><revhistory><revision><revnumber>2</revnumber><date>2008-05-18 19:38:58</date><authorinitials>localhost</authorinitials><revremark>converted to 1.6 markup</revremark></revision><revision><revnumber>1</revnumber><date>2006-07-22 03:23:49</date><authorinitials>pool-68-163-173-209.bos.east.verizon.net</authorinitials></revision></revhistory></articleinfo><section><title>Way Too Many Cache Misses</title><para>In normal operation Squid gives very few (typically well less than 1%) code TCP_SWAPFAIL_MISS indicating an object was thought to be in the cache but couldn't be found. Once in a while though this occurs very very frequently. When lots of errors occur, the problem is the Squid cache <emphasis role="strong">index</emphasis> (probably in a file named something like <emphasis>swap.state</emphasis> at the top level of the Squid cache directory structure) is out of sync with the actual cache contents.  </para><para>Here's a script I use to make <emphasis role="strong">sure</emphasis> this doesn't happen. It's way too paranoid, doing a lot of unnecessary things including throwing away what's in the cache every time. But it always works.  </para><section><title>sample script</title><screen><![CDATA[# restart Squid
# (probably after making arbitrary config changes)
]]><![CDATA[
echo temporarily stopping Dans Guardian [Squid user]
dansguardian -q
while [[ `ps aux | grep dansguardian | wc -l` -gt 1 ]]; do
        sleep 1
done
sleep 2
echo stopping Squid so can make arbitrary changes
squid -k shutdown
while [[ `ps aux | grep squid | wc -l` -gt 1 ]]; do
        sleep 1
done
sleep 2
echo flushing-by-deleting old Squid cache including index
rm -rf /var/spool/squid/*
sleep 2
echo creating new Squid disk cache directories and index
squid -z
sleep 2
echo starting Squid again with new configuration
squid
sleep 2
echo starting Dans Guardian [Squid user] again
dansguardian]]></screen></section></section></article>