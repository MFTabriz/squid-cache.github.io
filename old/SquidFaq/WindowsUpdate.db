<?xml version="1.0" encoding="utf-8"?><!DOCTYPE article  PUBLIC '-//OASIS//DTD DocBook XML V4.4//EN'  'http://www.docbook.org/xml/4.4/docbookx.dtd'><article><articleinfo><title>SquidFaq/WindowsUpdate</title><revhistory><revision><revnumber>32</revnumber><date>2017-10-29 18:28:28</date><authorinitials>Eliezer Croitoru</authorinitials></revision><revision><revnumber>31</revnumber><date>2016-06-08 07:09:00</date><authorinitials>AmosJeffries</authorinitials><revremark>polish the slayout a litte, and update the outdated XP info</revremark></revision><revision><revnumber>30</revnumber><date>2016-06-08 06:58:37</date><authorinitials>AmosJeffries</authorinitials></revision><revision><revnumber>29</revnumber><date>2016-05-02 01:53:19</date><authorinitials>Eliezer Croitoru</authorinitials></revision><revision><revnumber>28</revnumber><date>2016-04-23 16:09:44</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>27</revnumber><date>2016-04-23 16:06:42</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>26</revnumber><date>2015-11-05 18:48:06</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>25</revnumber><date>2015-11-05 18:39:28</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>24</revnumber><date>2015-11-05 18:38:11</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>23</revnumber><date>2015-10-27 21:10:38</date><authorinitials>AmosJeffries</authorinitials><revremark>grammar and interwiki links</revremark></revision><revision><revnumber>22</revnumber><date>2015-10-27 17:04:03</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>21</revnumber><date>2015-10-27 17:02:24</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>20</revnumber><date>2014-04-11 04:17:21</date><authorinitials>AmosJeffries</authorinitials></revision><revision><revnumber>19</revnumber><date>2014-04-11 04:11:59</date><authorinitials>AmosJeffries</authorinitials></revision><revision><revnumber>18</revnumber><date>2014-04-11 04:08:54</date><authorinitials>AmosJeffries</authorinitials><revremark>add details regarding Windows 8.1 massive update and PSF files - thanks Nick Hill in mailng lists for the details.</revremark></revision><revision><revnumber>17</revnumber><date>2013-11-10 20:44:22</date><authorinitials>AmosJeffries</authorinitials><revremark>update after range_offset_limit changes in 3.2</revremark></revision><revision><revnumber>16</revnumber><date>2012-01-18 22:18:51</date><authorinitials>AmosJeffries</authorinitials><revremark>polish the description order. remove false statement about intercept vis caching and duplicate details about auth.</revremark></revision><revision><revnumber>15</revnumber><date>2011-10-30 23:41:04</date><authorinitials>AmosJeffries</authorinitials><revremark>Formatting fixes. And remove Linux formats from the pattern. MS do not supply Linux updates for Windows.</revremark></revision><revision><revnumber>14</revnumber><date>2011-10-30 23:22:40</date><authorinitials>freak1</authorinitials></revision><revision><revnumber>13</revnumber><date>2011-10-30 23:16:32</date><authorinitials>freak1</authorinitials></revision><revision><revnumber>12</revnumber><date>2009-11-17 08:09:05</date><authorinitials>AmosJeffries</authorinitials><revremark>typo</revremark></revision><revision><revnumber>11</revnumber><date>2009-11-17 08:02:46</date><authorinitials>AmosJeffries</authorinitials><revremark>add explicit answer to the &quot;how do I cache WU&quot; FAQ.</revremark></revision><revision><revnumber>10</revnumber><date>2009-10-21 10:18:37</date><authorinitials>AmosJeffries</authorinitials><revremark>inter-wiki the config and make some corrections to the tag names</revremark></revision><revision><revnumber>9</revnumber><date>2009-09-22 04:44:09</date><authorinitials>AmosJeffries</authorinitials></revision><revision><revnumber>8</revnumber><date>2009-08-24 23:45:55</date><authorinitials>AmosJeffries</authorinitials><revremark>Mention service pack issues seen on WU with forced-caching.</revremark></revision><revision><revnumber>7</revnumber><date>2009-05-03 06:19:49</date><authorinitials>AmosJeffries</authorinitials><revremark>some more domains from squid-users posting.</revremark></revision><revision><revnumber>6</revnumber><date>2008-08-01 02:23:06</date><authorinitials>AmosJeffries</authorinitials><revremark>Add comment about mixing services. Thanks to Elvar in squid-users.</revremark></revision><revision><revnumber>5</revnumber><date>2008-05-18 19:38:57</date><authorinitials>localhost</authorinitials><revremark>converted to 1.6 markup</revremark></revision><revision><revnumber>4</revnumber><date>2007-12-17 23:40:03</date><authorinitials>AmosJeffries</authorinitials></revision><revision><revnumber>3</revnumber><date>2007-12-17 23:39:24</date><authorinitials>AmosJeffries</authorinitials></revision></revhistory></articleinfo><section><title>How do I make Windows Updates cache?</title><para>Windows Update generally (but not always) uses HTTP Range-Offsets' (AKA file partial ranges) to grab pieces of the Microsoft Update archive in parallel or using a random-access algorithm trying to reduce the web traffic. Some versions of Squid do not handle or store Ranges very well yet. </para><para>A mix of configuration options are required to force caching of range requests. Particularly when large objects are involved. </para><itemizedlist><listitem><para><emphasis role="strong"><ulink url="http://www.squid-cache.org/Doc/config/maximum_object_size#">maximum_object_size</ulink></emphasis>. Default value is a bit small. It needs to be somewhere 100MB or higher to cope with the IE updates. </para><itemizedlist><listitem override="none"><para><emphasis role="strong">UPDATE:</emphasis> Windows 8.1 upgrade pack requires up to 5GB objects to be cached. It will however, cache nicely provided the size limit is set high enough. </para></listitem></itemizedlist></listitem><listitem><para><emphasis role="strong"><ulink url="http://www.squid-cache.org/Doc/config/range_offset_limit#">range_offset_limit</ulink></emphasis>. Does the main work of converting range requests into cacheable requests. Use the same size limit as <ulink url="http://www.squid-cache.org/Doc/config/maximum_object_size#">maximum_object_size</ulink> to prevent conversion of requests for objects which will not cache anyway. With <ulink url="https://wiki.squid-cache.org/SquidFaq/WindowsUpdate/Squid-3.2#">Squid-3.2</ulink> or later use the <emphasis role="strong">windowsupdate</emphasis> ACL list defined below to apply this offset limit only to windows updates. </para></listitem><listitem><para><emphasis role="strong"><ulink url="http://www.squid-cache.org/Doc/config/quick_abort_min#">quick_abort_min</ulink></emphasis>. May need to be altered to allow the full object to download when the client software disconnects. Some Squid releases let <ulink url="http://www.squid-cache.org/Doc/config/range_offset_limit#">range_offset_limit</ulink> override properly, some have weird behavior when combined. </para></listitem></itemizedlist><screen><![CDATA[range_offset_limit 200 MB windowsupdate
maximum_object_size 200 MB
quick_abort_min -1]]></screen><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> Due to the slow-down problem below we recommend service packs be handled specially: </para><itemizedlist><listitem override="none"><para>Extend the maximum cached object size to the required size, then run a full download on a single machine, then run on a second machine to verify the cache is being used. Only after this verification succeeds open updating to all other machines through the proxy. </para></listitem></itemizedlist></listitem></itemizedlist></section><section><title>Preventing Early or Frequent Replacement</title><para>Once you have done the above to cache updates you encounter the problem that some software often forces a full object reload instead of revalidation. Which pushes the cached content out and fetches new objects very frequently. </para><para>An idea that was floating around suggested that you use a <ulink url="http://www.squid-cache.org/Doc/config/refresh_pattern#">refresh_pattern</ulink> regexp config to do your WU caching. I decided to test this idea out in my squid proxy, along with one or 2 other ideas (the other ideas failed hopelessly but the WU caching worked like a charm.) </para><para>The idea basically suggested this: </para><screen><![CDATA[refresh_pattern microsoft.com/.*\.(cab|exe|ms[i|u|f]|asf|wm[v|a]|dat|zip) 4320 80% 43200]]></screen><para>The original idea seemed to work in theory, yet in practicality it was pretty useless - the updates expired after 30 minutes, there were download inconsistencies, and a whole array of issues. So looking at the HTTP responses and documentation for <ulink url="http://www.squid-cache.org/Doc/config/refresh_pattern#">refresh_pattern</ulink>, there was an extra clause that could be added. This is how it changed: </para><screen><![CDATA[refresh_pattern -i microsoft.com/.*\.(cab|exe|ms[i|u|f]|[ap]sf|wm[v|a]|dat|zip) 4320 80% 43200 reload-into-ims
refresh_pattern -i windowsupdate.com/.*\.(cab|exe|ms[i|u|f]|[ap]sf|wm[v|a]|dat|zip) 4320 80% 43200 reload-into-ims]]></screen><para>Now all that this line tells us to do is cache all .cab, .exe, .msu, .msu, .msf, .asf, .psf, .wma,..... to .zip from microsoft.com, and the lifetime of the object in the cache is 4320 minutes (aka 3 days) to 43200 minutes (aka 30 days). Each of the downloaded objects are added to the cache, and then whenever a request arrives indicating the cache copy must not be used it gets converted to an if-modified-since check instead of a new copy reload request. </para><para>So adding it to the original Squid settings to do with <ulink url="http://www.squid-cache.org/Doc/config/refresh_pattern#">refresh_pattern</ulink>, we get: </para><screen><![CDATA[# Add one of these lines for each of the websites you want to cache.
]]><![CDATA[
refresh_pattern -i microsoft.com/.*\.(cab|exe|ms[i|u|f]|[ap]sf|wm[v|a]|dat|zip) 4320 80% 43200 reload-into-ims
]]><![CDATA[
refresh_pattern -i windowsupdate.com/.*\.(cab|exe|ms[i|u|f]|[ap]sf|wm[v|a]|dat|zip) 4320 80% 43200 reload-into-ims
]]><![CDATA[
refresh_pattern -i windows.com/.*\.(cab|exe|ms[i|u|f]|[ap]sf|wm[v|a]|dat|zip) 4320 80% 43200 reload-into-ims
]]><![CDATA[
]]><![CDATA[
# DONT MODIFY THESE LINES
refresh_pattern \^ftp:           1440    20%     10080
refresh_pattern \^gopher:        1440    0%      1440
refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
refresh_pattern .               0       20%     4320]]></screen><para>This should limit the system from downloading windows updates a trillion times a minute. It'll hand out the Windows updates, and will keep them stored in the squid cache. </para><para>I also recommend a 30 to 60GB <ulink url="http://www.squid-cache.org/Doc/config/cache_dir#">cache_dir</ulink> size allocation, which will let you download tonnes of windows updates and other stuff and then you won't really have any major issues with cache storage or cache allocation or any other issues to do with the cache. .  . </para></section><section><title>Why does it go so slowly through Squid?</title><para>The work-around used by many cache maintainers has been to set the above config and force Squid to fetch the whole object when a range request goes through. </para><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> Compounding the problem and ironically causing some slowdowns is the fact that some of the Microsoft servers may be telling your Squid not to store the archive file. This means that Squid will pull the entire archive every time it needs any small piece. </para></listitem></itemizedlist><para>You will need to test your squid config with smaller values for the <ulink url="http://www.squid-cache.org/Doc/config/range_offset_limit#">range_offset_limit</ulink> bypass and see which provides the best results for you. </para><para>Another symptoms which occasionally appear when attempting to force caching of windows updates is service packs. </para><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> If the <ulink url="http://www.squid-cache.org/Doc/config/quick_abort_min#">quick_abort_min</ulink>, <ulink url="http://www.squid-cache.org/Doc/config/quick_abort_max#">quick_abort_max</ulink>, <ulink url="http://www.squid-cache.org/Doc/config/quick_abort_pct#">quick_abort_pct</ulink> settings are set to abort a download incomplete and a client closes with almost but not quite enough of the service pack downloaded. That clients following requests will often timeout waiting for Squid to re-download the whole object from the start. Which naturally causes the problem to repeat on following restart attempts. </para></listitem></itemizedlist></section><section><title>How do I stop Squid popping up the Authentication box for Windows Update?</title><para>Add the following to your squid.conf, assuming you have defined <emphasis role="strong">localnet</emphasis> to mean your local clients. It <emphasis role="strong">'MUST</emphasis>' be added near the top before any ACL that require authentication. </para><screen><![CDATA[acl windowsupdate dstdomain windowsupdate.microsoft.com
acl windowsupdate dstdomain .update.microsoft.com
acl windowsupdate dstdomain download.windowsupdate.com
acl windowsupdate dstdomain redir.metaservices.microsoft.com
acl windowsupdate dstdomain images.metaservices.microsoft.com
acl windowsupdate dstdomain c.microsoft.com
acl windowsupdate dstdomain www.download.windowsupdate.com
acl windowsupdate dstdomain wustat.windows.com
acl windowsupdate dstdomain crl.microsoft.com
acl windowsupdate dstdomain sls.microsoft.com
acl windowsupdate dstdomain productactivation.one.microsoft.com
acl windowsupdate dstdomain ntservicepack.microsoft.com
]]><![CDATA[
acl CONNECT method CONNECT
acl wuCONNECT dstdomain www.update.microsoft.com
acl wuCONNECT dstdomain sls.microsoft.com
]]><![CDATA[
http_access allow CONNECT wuCONNECT localnet
http_access allow windowsupdate localnet]]></screen><para>The above config is also useful for other automatic update sites such as Anti-Virus vendors, just add their domains to the <ulink url="http://www.squid-cache.org/Doc/config/acl#">acl</ulink>. </para><informaltable><tgroup cols="2"><colspec colname="col_0"/><colspec colname="col_1"/><tbody><row rowsep="1"><entry colsep="1" rowsep="1"><para> <inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> </para></entry><entry colsep="1" rowsep="1"><para>If you have squid listening on a localhost port with other software in front (ie dansGuardian). You will probably need to add permission for <emphasis role="strong">localhost</emphasis> address so the front-end service can relay the requests. </para></entry></row></tbody></tgroup></informaltable><screen><![CDATA[...
http_access allow CONNECT wuCONNECT localnet
http_access allow CONNECT wuCONNECT localhost
http_access allow windowsupdate localnet
http_access allow windowsupdate localhost]]></screen></section><section><title>Squid problems with Windows Update v5</title><section><title>AKA, Why does Internet Explorer work but the background automatic updates fail?</title><itemizedlist><listitem override="none"><para><emphasis>by Janno de Wit</emphasis> </para></listitem></itemizedlist><para>There seems to be some problems with Microsoft Windows to access the Windows Update website. This is especially a problem when you block all traffic by a firewall and force your users to go through a proxy. </para><para>Symptom: Windows Update gives error codes like 0x80072EFD and cannot update, automatic updates aren't working too. </para><para>Cause: In earlier Windows-versions Windows Update takes the proxy-settings from Internet Explorer. Since XP SP2 this is not sure. At my machine I ran Windows XP SP1 without Windows Update problems. When I upgraded to SP2 Windows Update started to give errors when searching updates etc. </para><para>The problem was that WU did not go through the proxy and tries to establish direct HTTP connections to Update-servers. Even when I set the proxy in IE again, it didn't help . It isn't Squid's problem that Windows Update doesn't work, but it is in Windows itself. The solution is to use the 'proxycfg' or 'netsh' tool shipped with Windows. With this tool you can set the proxy for WinHTTP. </para><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> Similar issues are found with other Microsoft products in the same Windows versions. The commands below often fix all Microsoft proxy issues at once. </para></listitem></itemizedlist></section><section><title>Proxy configuration with proxycfg</title><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> In Windows Vista, Server 2008 and later proxycfg is obsolete. Use netsh instead. </para></listitem></itemizedlist><para>Commands: </para><screen><![CDATA[C:\> proxycfg
# gives information about the current connection type. Note: 'Direct Connection' does not force WU to bypass proxy
]]><![CDATA[
C:\> proxycfg -d
# Set Direct Connection
]]><![CDATA[
C:\> proxycfg -p wu-proxy.lan:8080
# Set Proxy to use with Windows Update to wu-proxy.lan, port 8080
]]><![CDATA[
C:\> proxycfg -u
# Set proxy to Internet Explorer settings.]]></screen></section><section><title>Proxy configuration with netsh</title><itemizedlist><listitem override="none"><para><emphasis>by Yuri Voinov</emphasis> </para></listitem></itemizedlist><para>Syntax: </para><screen><![CDATA[netsh winhttp set proxy ProxyName:80 "<local>"]]></screen><screen><![CDATA[C:\> netsh winhttp set proxy 192.168.1.100:3128 "localhost;192.168.1.100"]]></screen><para>To reset proxy settings for WinHTTP use: </para><screen><![CDATA[C:\> netsh winhttp reset proxy]]></screen></section></section><section><title>Squid with SSL-Bump and Windows Updates</title><itemizedlist><listitem override="none"><para><emphasis>by Yuri Voinov</emphasis> </para></listitem></itemizedlist><para>In modern setups with Squid, Windows Update cannot be check updates with error &quot;<ulink url="https://wiki.squid-cache.org/SquidFaq/WindowsUpdate/WindowsUpdate#">WindowsUpdate</ulink>_80072F8F&quot; or similar. </para><para>WU now uses its own pinned SSL certificate and must be spliced to work. When you use sniffer, you can see many IP's with relatively big subnetworks. This leads to problems with a <ulink url="https://wiki.squid-cache.org/SquidFaq/WindowsUpdate/Squid-3.4#">Squid-3.4</ulink> and causes serious problems when using <ulink url="https://wiki.squid-cache.org/SquidFaq/WindowsUpdate/Squid-3.5#">Squid-3.5</ulink> or above. </para><para>To use splicing, you need to know the names of the servers, however, a recursive DNS query does not give a result. </para><para>To pass WU check through Squid splice, you only need to splice next MS servers: </para><screen><![CDATA[update.microsoft.com
update.microsoft.com.akadns.net ]]></screen><para>For use in real setups, write file url.nobump: </para><screen><![CDATA[# WU (Squid 3.5.x and above with SSL Bump)
# Only this sites must be spliced.
update\.microsoft\.com
update\.microsoft\.com\.akadns\.net ]]></screen><para>Just add this file as Squid ACL as follows: </para><screen><![CDATA[acl DiscoverSNIHost at_step SslBump1
acl NoSSLIntercept ssl::server_name_regex -i "/usr/local/squid/etc/url.nobump"
ssl_bump splice NoSSLIntercept
ssl_bump peek DiscoverSNIHost
ssl_bump bump all]]></screen><para>and you do not need to know all the IP authorization server for updates. </para><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> <emphasis role="strong">NOTE:</emphasis> In some countries WU can product SQUID_X509_V_ERR_DOMAIN_MISMATCH error via Akamai. To do WU, you can require to add this into your Squid's config: </para></listitem></itemizedlist><screen><![CDATA[acl BrokenButTrustedServers dstdomain "/usr/local/squid/etc/dstdom.broken"
acl DomainMismatch ssl_error SQUID_X509_V_ERR_DOMAIN_MISMATCH
sslproxy_cert_error allow BrokenButTrustedServers DomainMismatch
sslproxy_cert_error deny all]]></screen><para>and add this to <emphasis role="strong">dstdom.broken</emphasis>: </para><screen><![CDATA[download.microsoft.com
update.microsoft.com
update.microsoft.com.akadns.net
update.microsoft.com.nsatc.net]]></screen><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> <emphasis role="strong">NOTE:</emphasis> Depending your Squid's configuration, you may need to change your Squid's cipher configuration to this one: </para></listitem></itemizedlist><screen><![CDATA[sslproxy_cipher HIGH:MEDIUM:RC4:3DES:!aNULL:!eNULL:!LOW:!MD5:!EXP:!PSK:!SRP:!DSS]]></screen><para>and add this one to your bumped port's configuration: </para><screen><![CDATA[cipher=HIGH:MEDIUM:RC4:3DES:!aNULL:!eNULL:!LOW:!MD5:!EXP:!PSK:!SRP:!DSS]]></screen><para>3DES and RC4 required to connect to WU and - <emphasis role="strong">attention!</emphasis> -  Skype assets site. </para><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/alert.png" width="15"/></imageobject><textobject><phrase>/!\</phrase></textobject></inlinemediaobject> <emphasis role="strong">WARNING:</emphasis> Some updates cannot be cached due to splice above. Beware! </para></listitem><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/alert.png" width="15"/></imageobject><textobject><phrase>/!\</phrase></textobject></inlinemediaobject> <emphasis role="strong">WARNING:</emphasis> Adding 3DES and, especially, RC4, produces potentially weak ciphers via client and WU/Skype and some other sites. Be careful! </para></listitem></itemizedlist></section><section><title>Microsoft technical articles related to proxy issues and windows updates</title><para><ulink url="https://support.microsoft.com/en-us/kb/3084568"/> </para></section><section><title>An example of refresh_pattern that is being used at OpnSense</title><para><ulink url="https://github.com/opnsense/core/issues/1691#issuecomment-340276788"/> </para><!--rule (<hr>) is not applicable to DocBook--><para> Back to the <ulink url="https://wiki.squid-cache.org/SquidFaq/WindowsUpdate/SquidFaq#">SquidFaq</ulink> </para></section></article>