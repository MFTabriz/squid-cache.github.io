<?xml version="1.0" encoding="utf-8"?><!DOCTYPE article  PUBLIC '-//OASIS//DTD DocBook XML V4.4//EN'  'http://www.docbook.org/xml/4.4/docbookx.dtd'><article><articleinfo><title>SquidFaq/OperatingSquid</title><revhistory><revision><revnumber>11</revnumber><date>2013-09-05 06:04:17</date><authorinitials>AmosJeffries</authorinitials><revremark>update FAQ about how Squid and root privileges interact. Thanks to Antony Stone in squid-users for an excellent write-up.</revremark></revision><revision><revnumber>10</revnumber><date>2010-02-22 12:14:54</date><authorinitials>FrancescoChemolli</authorinitials><revremark>Fixed dangling wiki-links</revremark></revision><revision><revnumber>9</revnumber><date>2009-04-02 00:36:36</date><authorinitials>AmosJeffries</authorinitials><revremark>re-order and update cache management info. shuffle ReadlAudio stuff to config examples.</revremark></revision><revision><revnumber>8</revnumber><date>2008-05-18 19:39:00</date><authorinitials>localhost</authorinitials><revremark>converted to 1.6 markup</revremark></revision><revision><revnumber>7</revnumber><date>2007-10-24 00:00:41</date><authorinitials>AmosJeffries</authorinitials></revision><revision><revnumber>6</revnumber><date>2006-12-13 17:07:33</date><authorinitials>kinkie</authorinitials><revremark>Added chapter on purging multiple objects.</revremark></revision><revision><revnumber>5</revnumber><date>2006-08-29 09:43:23</date><authorinitials>kinkie</authorinitials><revremark>Added start and end markers</revremark></revision><revision><revnumber>4</revnumber><date>2006-03-03 09:23:00</date><authorinitials>kinkie</authorinitials></revision><revision><revnumber>3</revnumber><date>2006-02-10 13:26:10</date><authorinitials>kinkie</authorinitials><revremark>Markup fixes</revremark></revision><revision><revnumber>2</revnumber><date>2006-02-07 22:43:57</date><authorinitials>kinkie</authorinitials><revremark>Added link to FAQ index</revremark></revision><revision><revnumber>1</revnumber><date>2006-01-24 21:20:24</date><authorinitials>kinkie</authorinitials></revision></revhistory></articleinfo><section><title>How do I see system level Squid statistics?</title><para>The Squid distribution includes a CGI utility called <emphasis>cachemgr.cgi</emphasis> which can be used to view squid statistics with a web browser. See <ulink url="https://wiki.squid-cache.org/SquidFaq/OperatingSquid/SquidFaq/CacheManager#">../CacheManager</ulink> for more information on its usage and installation. </para></section><section><title>Managing the Cache Storage</title><section><title>How can I make Squid NOT cache some servers or URLs?</title><para>From Squid-2.6, you use the <emphasis role="strong">cache</emphasis> option to specify uncachable requests and any exceptions to your cachable rules. </para><para>For example, this makes all responses from origin servers in the 10.0.1.0/24 network uncachable: </para><screen><![CDATA[acl localnet dst 10.0.1.0/24
cache deny localnet]]></screen><para>This example makes all URL's with '.html' uncachable: </para><screen><![CDATA[acl HTML url_regex .html$
cache deny HTML]]></screen><para>This example makes a specific URL uncachable: </para><screen><![CDATA[acl XYZZY url_regex ^http://www.i.suck.com/foo.html$
cache deny XYZZY]]></screen><para>This example caches nothing between the hours of 8AM to 11AM: </para><screen><![CDATA[acl Morning time 08:00-11:00
cache deny Morning]]></screen></section><section><title>How can I purge an object from my cache?</title><para>Squid does not allow you to purge objects unless it is configured with access controls in <emphasis>squid.conf</emphasis>.  First you must add something like </para><screen><![CDATA[acl PURGE method PURGE
acl localhost src 127.0.0.1
http_access allow PURGE localhost
http_access deny PURGE]]></screen><para>The above only allows purge requests which come from the local host and denies all other purge requests. </para><para>To purge an object, you can use the <emphasis>squidclient</emphasis> program: </para><screen><![CDATA[squidclient -m PURGE http://www.miscreant.com/]]></screen><para>If the purge was successful, you will see a &quot;200 OK&quot; response: </para><screen><![CDATA[HTTP/1.0 200 OK
Date: Thu, 17 Jul 1997 16:03:32 GMT
...]]></screen><para>Sometimes if the object was not found in the cache, you will see a &quot;404 Not Found&quot; response: </para><screen><![CDATA[HTTP/1.0 404 Not Found
Date: Thu, 17 Jul 1997 16:03:22 GMT
...]]></screen><para>Such 404 are not failures. It simply means the object has already been purged by other means or never existed. So the final result you wanted (object no longer exists in cache) has happened. </para></section><section><title>How can I purge multiple objects from my cache?</title><para>It's not possible; you have to purge the objects one by one by URL. This is because squid doesn't keep in memory the URL of every object it stores, but only a compact representation of it (a hash). Finding the hash given the URL is easy, the other way around is not possible. </para><para>Purging by wildcard, by domain, by time period, etc. are unfortunately not possible at this time. </para></section><section><title>How can I find the biggest objects in my cache?</title><screen><![CDATA[sort -r -n +4 -5 access.log | awk '{print $5, $7}' | head -25]]></screen><para>If your cache processes several hundred hits per second, good luck. </para></section><section><title>How can I add a cache directory?</title><orderedlist numeration="arabic"><listitem><para>Edit <emphasis role="strong">squid.conf</emphasis> and add a new <emphasis role="strong">cache_dir</emphasis> line. </para></listitem><listitem><para>Shutdown Squid  <code> squid -k shutdown </code> </para></listitem><listitem><para>Initialize the new directory by running </para><screen><![CDATA[ squid -z ]]></screen></listitem><listitem><para>Start Squid again </para></listitem></orderedlist></section><section><title>How can I delete a cache directory?</title><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> If you don't have any <emphasis>cache_dir</emphasis> lines in your squid.conf, then Squid was using the default. From Squid-3.1 the default has been changed to memory-only cache and does not involve cache_dir. </para><para>For Squid older than 3.1 using the default you'll need to add a new <emphasis role="strong">cache_dir</emphasis> line because Squid will continue to use the default otherwise. You can add a small, temporary directory, for example: </para><screen><![CDATA[/usr/local/squid/cachetmp ....]]></screen><para>see above about creating a new cache directory. </para><para><inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/alert.png" width="15"/></imageobject><textobject><phrase>/!\</phrase></textobject></inlinemediaobject> do not use /tmp !! That will cause Squid to periodically encounter fatal errors. </para></listitem></itemizedlist><para><emphasis role="strong">The removal:</emphasis> </para><orderedlist numeration="arabic"><listitem><para>Edit your <emphasis role="strong">squid.conf</emphasis> file and comment out, or delete the <emphasis role="strong">cache_dir</emphasis> line for the cache directory that you want to remove. </para></listitem><listitem><para>You can not delete a cache directory from a running Squid process; you can not simply reconfigure squid. </para></listitem><listitem><para>You must shutdown Squid: </para><screen><![CDATA[squid -k shutdown]]></screen></listitem><listitem><para>Once Squid exits, you may immediately start it up again. </para></listitem></orderedlist><para>Since you deleted the old <emphasis role="strong">cache_dir</emphasis> from squid.conf, Squid won't try to access that directory.  If you use the RunCache script, Squid should start up again automatically. </para><para>Now Squid is no longer using the cache directory that you removed from the config file.  You can verify this by checking &quot;Store Directory&quot; information with the cache manager.  From the command line, type: </para><screen><![CDATA[squidclient mgr:storedir]]></screen></section><section><title>I want to restart Squid with a clean cache</title><para>Squid-2.6 and later contain mechanisms which will automatically detect <emphasis>dirty</emphasis> information in both the cache directories and swap.state file. When squid starts up it runs these validation and security checks. The objects which fail for any reason are automatically purged from the cache. </para><para>The above mechanisms can be triggered manually to force squid into a full cache_dir scan and re-load all objects from disk by simply shuttign down Squid and deleting the <emphasis role="strong">swap.state</emphasis> journal from each cache_dir before restarting. </para><itemizedlist><listitem override="none"><para><emphasis>NP:</emphasis> Deleting the swap.state before shutting down will cause Squid to generate new ones and fail to do the re-scan you wanted. </para></listitem></itemizedlist></section><section><title>I want to restart Squid with an empty cache</title><para>To erase the entire contents of the cache and make Squid start fresh the following commands provide the fastest recovery time: </para><screen><![CDATA[ squid -k shutdown
 mv /dir/cache /dir/cache.old]]></screen><para>repeat for each cache_dir location you wish to empty. </para><screen><![CDATA[ squid -z
 squid
 rm -rf /dir/cache.old]]></screen><para>The <emphasis role="strong">rm</emphasis> command may take some time, but since Squid is already back up and running the service downtime is reduced. </para></section></section><section><title>Using ICMP to Measure the Network</title><para>As of version 1.1.9, Squid is able to utilize ICMP Round-Trip-Time (RTT) measurements to select the optimal location to forward a cache miss. Previously, cache misses would be forwarded to the parent cache which returned the first ICP reply message.  These were logged with FIRST_PARENT_MISS in the access.log file.  Now we can select the parent which is closest (RTT-wise) to the origin server. </para><section><title>Supporting ICMP in your Squid cache</title><para>It is more important that your parent caches enable the ICMP features.  If you are acting as a parent, then you may want to enable ICMP on your cache.  Also, if your cache makes RTT measurements, it will fetch objects directly if your cache is closer than any of the parents. </para><para>If you want your Squid cache to measure RTT's to origin servers, Squid must be compiled with the USE_ICMP option.  This is easily accomplished by uncommenting &quot;-DUSE_ICMP=1&quot; in <emphasis>src/Makefile</emphasis> and/or <emphasis>src/Makefile.in</emphasis>. </para><para>An external program called <emphasis>pinger</emphasis> is responsible for sending and receiving ICMP packets.  It must run with root privileges.  After Squid has been compiled, the pinger program must be installed separately.  A special Makefile target will install <emphasis>pinger</emphasis> with appropriate permissions. </para><screen><![CDATA[% make install
% su
# make install-pinger]]></screen><para>There are three configuration file options for tuning the measurement database on your cache.  <emphasis>netdb_low</emphasis> and <emphasis>netdb_high</emphasis> specify high and low water marks for keeping the database to a certain size  (e.g. just like with the IP cache).  The <emphasis>netdb_ttl</emphasis> option specifies the minimum rate for pinging a site.  If <emphasis>netdb_ttl</emphasis> is set to 300 seconds (5 minutes) then an ICMP packet will not be sent to the same site more than once every five minutes.  Note that a site is only pinged when an HTTP request for the site is received. </para><para>Another option, <emphasis>minimum_direct_hops</emphasis> can be used to try finding servers which are close to your cache.  If the measured hop count to the origin server is less than or equal to <emphasis>minimum_direct_hops</emphasis>, the request will be forwarded directly to the origin server. </para></section><section><title>Utilizing your parents database</title><para>Your parent caches can be asked to include the RTT measurements in their ICP replies.  To do this, you must enable <emphasis>query_icmp</emphasis> in your config file: </para><screen><![CDATA[query_icmp on]]></screen><para>This causes a flag to be set in your outgoing ICP queries. </para><para>If your parent caches return ICMP RTT measurements then the eighth column of your access.log will have lines similar to: </para><screen><![CDATA[CLOSEST_PARENT_MISS/it.cache.nlanr.net]]></screen><para>In this case, it means that <emphasis>it.cache.nlanr.net</emphasis> returned the lowest RTT to the origin server.  If your cache measured a lower RTT than any of the parents, the request will be logged with </para><screen><![CDATA[CLOSEST_DIRECT/www.sample.com]]></screen></section><section><title>Inspecting the database</title><para>The measurement database can be viewed from the cachemgr by selecting &quot;Network Probe Database.&quot;  Hostnames are aggregated into /24 networks.  All measurements made are averaged over time.  Measurements are made to specific hosts, taken from the URLs of HTTP requests.  The recv and sent fields are the number of ICMP packets sent and received.  At this time they are only informational. </para><para>A typical database entry looks something like this: </para><screen><![CDATA[    Network          recv/sent     RTT  Hops Hostnames
    192.41.10.0        20/  21    82.3   6.0 www.jisedu.org www.dozo.com
bo.cache.nlanr.net        42.0   7.0
uc.cache.nlanr.net        48.0  10.0
pb.cache.nlanr.net        55.0  10.0
it.cache.nlanr.net       185.0  13.0]]></screen><para>This means we have sent 21 pings to both www.jisedu.org and www.dozo.com.  The average RTT is 82.3 milliseconds.  The next four lines show the measured values from our parent caches.  Since <emphasis>bo.cache.nlanr.net</emphasis> has the lowest RTT, it would be selected as the location to forward a request for a www.jisedu.org or www.dozo.com URL. </para></section></section><section><title>Why are so few requests logged as TCP_IMS_MISS?</title><para>When Squid receives an <emphasis>If-Modified-Since</emphasis> request, it will not forward the request unless the object needs to be refreshed according to the <emphasis>refresh_pattern</emphasis> rules.  If the request does need to be refreshed, then it will be logged as TCP_REFRESH_HIT or TCP_REFRESH_MISS. </para><para>If the request is not forwarded, Squid replies to the IMS request according to the object in its cache.  If the modification times are the same, then Squid returns TCP_IMS_HIT.  If the modification times are different, then Squid returns TCP_IMS_MISS.  In most cases, the cached object will not have changed, so the result is TCP_IMS_HIT.  Squid will only return TCP_IMS_MISS if some other client causes a newer version of the object to be pulled into the cache. </para></section><section><title>Why do I need to run Squid as root? why can't I just use cache_effective_user root?</title><itemizedlist><listitem override="none"><para><emphasis>by Antony Stone and Dave J Woolley</emphasis> </para></listitem></itemizedlist><informaltable><tgroup cols="1"><colspec colname="col_0"/><tbody><row rowsep="1"><entry colsep="1" rowsep="1"><para> Why run the parent squid process as root and the child as user proxy? Is that normal? Is it best practice? Should I chmod or chown cache and other directories? </para></entry></row></tbody></tgroup></informaltable><para>It is completely normal for a great many applications providing network  services, and yes, it is best practice.  In fact some will not <emphasis role="strong">allow</emphasis> you to  run them as root, without an unprivileged user to run the main process as. This applies to all programs that don't absolutely need root status, not just squid. </para><para>The reasoning is simple: </para><orderedlist numeration="arabic"><listitem><para>You need root privileges to do certain things when you start an application  </para></listitem></orderedlist><para>(such as bind to a network socket, open a log file, perhaps read a configuration  file), therefore it starts as root. </para><orderedlist><listitem><para>Any application might contain bugs which lead to security vulnerabilities,  </para></listitem></orderedlist><para>which can be remotely exploited through the network connection, and until the  bugs are fixed, you at least want to minimise the risk presented by them. </para><orderedlist><listitem><para>Therefore as soon as you've done all the things involved in (1) above, you  </para></listitem></orderedlist><para>drop the privilege level of the application, and/or spawn a child process with  reduced privilege, so that it still runs and does everything you need, but if  a vulnerability is exploited, it no longer has root privilege and therefore  cannot cause as much damage as it might have done. </para><para>Squid does this with <ulink url="http://www.squid-cache.org/Doc/config/cache_effective_user#">cache_effective_user</ulink>. The coordinator (daemon manager) process must be run as 'root' in order to setup the administrative details and will downgrade its privileges to the <ulink url="http://www.squid-cache.org/Doc/config/cache_effective_user#">cache_effective_user</ulink> account before running any of the more risky network operations. </para><para>If the <ulink url="http://www.squid-cache.org/Doc/config/cache_effective_group#">cache_effective_group</ulink> is configured Squid will drop additional group privileges and run as only the user:group specified. </para><para>The <emphasis role="strong">-N</emphasis> command line option makes Squid run without spawning low-privileged child processes for safe networking. When this option is used Squid main process will drop its privileges down to the <ulink url="http://www.squid-cache.org/Doc/config/cache_effective_user#">cache_effective_user</ulink> account but will try to retain some means of regaining root privileges for reconfiguration. Some components which rely on the more dangerous root privieges will not be able to be altered with just a reconfigure but will need a full restart. </para></section><section><title>Can you tell me a good way to upgrade Squid with minimal downtime?</title><para>Here is a technique that was described by <emphasis>Radu Greab</emphasis>. </para><para>Start a second Squid server on an unused HTTP port (say 4128).  This instance of Squid probably doesn't need a large disk cache.  When this second server has finished reloading the disk store, swap the <emphasis>http_port</emphasis> values in the two <emphasis>squid.conf</emphasis> files.  Set the original Squid to use port 5128, and the second one to use 3128.  Next, run &quot;squid -k reconfigure&quot; for both Squids.  New requests will go to the second Squid, now on port 3128 and the first Squid will finish handling its current requests.  After a few minutes, it should be safe to fully shut down the first Squid and upgrade it.  Later you can simply repeat this process in reverse. </para></section><section><title>Can Squid listen on more than one HTTP port?</title><para><emphasis>Note: The information here is current for version 2.3.</emphasis> </para><para>Yes, you can specify multiple <emphasis>http_port</emphasis> lines in your <emphasis>squid.conf</emphasis> file.   Squid attempts to bind() to each port that you specify.  Sometimes Squid may not be able to bind to a port, either because of permissions or because the port is already in use.  If Squid can bind to at least one port, then it will continue running.  If it can not bind to any of the ports, then Squid stops. </para><para>With version 2.3 and later you can specify IP addresses and port numbers together (see the squid.conf comments). </para></section><section><title>Can I make origin servers see the client's IP address when going through Squid?</title><para>Normally you cannot.  Most TCP/IP stacks do not allow applications to create sockets with the local endpoint assigned to a foreign IP address. However, some folks have some <ulink url="http://www.balabit.hu/en/downloads/tproxy/">patches to Linux</ulink> that allow exactly that. </para><para>In this situation, you must ensure that all HTTP packets destined for the client IP addresses are routed to the Squid box.  If the packets take another path, the real clients will send TCP resets to the origin servers, thereby breaking the connections. </para><!--rule (<hr>) is not applicable to DocBook--><para> Back to the <ulink url="https://wiki.squid-cache.org/SquidFaq/OperatingSquid/SquidFaq#">SquidFaq</ulink> </para></section></article>