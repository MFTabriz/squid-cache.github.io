<?xml version="1.0" encoding="utf-8"?><!DOCTYPE article  PUBLIC '-//OASIS//DTD DocBook XML V4.4//EN'  'http://www.docbook.org/xml/4.4/docbookx.dtd'><article><articleinfo><title>SquidFaq/SecurityPitfalls</title><revhistory><revision><revnumber>11</revnumber><date>2012-12-27 17:30:47</date><authorinitials>FrancescoChemolli</authorinitials><revremark>corrected typo, thanks to Ed Drouillard for finding it.</revremark></revision><revision><revnumber>10</revnumber><date>2011-07-04 02:39:03</date><authorinitials>AmosJeffries</authorinitials><revremark>update for 3.2 security changes.</revremark></revision><revision><revnumber>9</revnumber><date>2011-06-04 09:00:16</date><authorinitials>AmosJeffries</authorinitials><revremark>tweak the heading layers</revremark></revision><revision><revnumber>8</revnumber><date>2011-06-04 08:58:55</date><authorinitials>AmosJeffries</authorinitials><revremark>add manager ACLs to the security problems people open up by mistake.</revremark></revision><revision><revnumber>7</revnumber><date>2009-05-29 03:33:18</date><authorinitials>AmosJeffries</authorinitials><revremark>browsing is semi-anonymous through Squid by default. not fully.</revremark></revision><revision><revnumber>6</revnumber><date>2008-10-05 08:57:21</date><authorinitials>AmosJeffries</authorinitials><revremark>I'm seeing a lot of unsafe configs due to ACL before Safe_Ports restriction</revremark></revision><revision><revnumber>5</revnumber><date>2008-09-01 03:47:20</date><authorinitials>AmosJeffries</authorinitials><revremark>wording improvement to match behavior + XFF description</revremark></revision><revision><revnumber>4</revnumber><date>2008-05-18 19:38:56</date><authorinitials>localhost</authorinitials><revremark>converted to 1.6 markup</revremark></revision><revision><revnumber>3</revnumber><date>2008-02-05 11:48:38</date><authorinitials>AmosJeffries</authorinitials></revision></revhistory></articleinfo><section><title>Open-access proxies</title><para>Squid's default configuration file denies all external requests.  It is the administrator's responsibility to configure Squid to allow access only to trusted hosts and/or users. </para><para>If your proxy allows access from untrusted hosts or users, you can be sure that people will find and abuse your service.  Some people will use your proxy to make their browsing semi-anonymous.  Others will intentionally use your proxy for transactions that may be illegal (such as credit card fraud).  A number of web sites exist simply to provide the world with a list of open-access HTTP proxies.  You don't want to end up on this list. </para><para>Be sure to carefully design your access control scheme.  You should also check it from time to time to make sure that it works as you expect. </para></section><section><title>Mail relaying</title><para>SMTP and HTTP are rather similar in design.  This, unfortunately, may allow someone to relay an email message through your HTTP proxy.  To prevent this, you must make sure that your proxy denies HTTP requests to port 25, the SMTP port. </para><para>Squid is configured this way by default.  The default <emphasis>squid.conf</emphasis> file lists a small number of trusted ports.  See the <emphasis>Safe_ports</emphasis> ACL in <emphasis>squid.conf</emphasis>.  Your configuration file should always deny unsafe ports early in the <emphasis>http_access</emphasis> lists: </para><screen><![CDATA[http_access deny !Safe_ports
(additional http_access lines ...)]]></screen><para>Do NOT add port 25 to <emphasis>Safe_ports</emphasis> (unless your goal is to end up in the <ulink url="http://mail-abuse.org/rbl/">RBL</ulink>).  You may want to make a cron job that regularly verifies that your proxy blocks access to port 25. </para></section><section><title>Hijackable proxies</title><para>Squid's default configuration file denies all external requests.  It is the administrator's responsibility to configure Squid to allow access only to trusted hosts and/or users. </para><para>If your proxy allows unrestricted access to any ports.  Some people may use your proxy to make their website anonymous.  A number of websites commonly seen in Spam and Phishing emails are using this method of hiding and software is available in some circles supporting the automatic detection of these partially-open proxies. </para><screen><![CDATA[acl mycoolapp port 1234
...
http_access allow mycoolapp]]></screen><para>Be careful that configuration lines like these are kept behind any lines that block public access to your squid. </para><screen><![CDATA[acl mycoolapp port 1234
...
http_access deny !localnet
...
http_access allow mycoolapp]]></screen><para>OR even better: </para><screen><![CDATA[acl mycoolapp port 1234
...
http_access allow localnet mycoolapp]]></screen></section><section><title>X-Forwarded-For fiddling</title><para>The <emphasis role="strong">X-Forwarded-For</emphasis> header is inserted by Squid to identify the internal client making a request.  Some people mistake it for a data-breach and crop it from their traffic streams. </para><para>Please understand that it is there for your protection.  Many security systems use it to identify the true source of any breach, to protect against and for reporting those sources accurately. This is particularly important now that the Internet has degraded into a vast network of NAT systems and transparent middleware. </para><para>If it is not present in web requests the middleware proxy is identified as the trouble source and administrators can find their entire network under boycott for the actions of a single user. It may seem useful to simply find and block borged proxies, but tracking the origin source is far more so, and the borged proxy can be clearly identified as a traffic hop anyway. </para><para>The configuration controls provided by Squid are intended for Accelerator setups. </para></section><section><title>The Safe_Ports and SSL_Ports ACL</title><para>These ACL controls are listed in a very specific way in the default squid.conf to protect Squid against Security issues such as those outlines for SMTP above. </para><glosslist><glossentry><glossterm>Safe_Ports</glossterm><glossdef><para>Prevents people from making requests to any of the registered protocol ports. For which Squid is unable to proxy and filter the protocol. </para></glossdef></glossentry><glossentry><glossterm>SSL_Ports</glossterm><glossdef><para>Along with the CONNECT ACL prevents anyone from making an unfiltered tunnel to any of the otherwise safe ports which don't need it. </para></glossdef></glossentry></glosslist><para><emphasis role="strong">Notes:</emphasis> </para><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/idea.png" width="15"/></imageobject><textobject><phrase>(!)</phrase></textobject></inlinemediaobject> They should be left as the <emphasis role="strong">top</emphasis> access control lines in any standard forward-proxy configuration. </para><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> Only Reverse-Proxy configurations need to go above them. </para></listitem></itemizedlist><para>Default usage: </para><screen><![CDATA[http_access deny !Safe_ports
http_access deny CONNECT !SSL_Ports
...
# Place your own access controls here. Between them.
...
http_access deny all]]></screen></section><section><title>The manager ACLs</title><para>These ACLs control access to the Squid cache manager. The manager can do a lot of powerful things. Including shutting down your Squid, or displaying the configuration file, or displaying the current logged in users, or displaying your network layout. </para><para>As you can imagine, allowing random internet visitors to see these details is not a good thing. For this reason the <emphasis role="strong">very top</emphasis> access control in Squid limits manager access on only be available to the special localhost IP. </para><screen><![CDATA[acl manger url_regex -i ^cache_object:// /squid-internal-mgr/
http_access allow localhost manager
http_access deny manager]]></screen><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/alert.png" width="15"/></imageobject><textobject><phrase>/!\</phrase></textobject></inlinemediaobject> placing any kind of major <emphasis role="strong">allow</emphasis> privilege before this ACL breaks it. {!} only reverse-proxy configuration may go above it. </para></listitem></itemizedlist><para>Feel free to change the <emphasis role="strong">localhost</emphasis> part to something even more secure or specific to allow only you network management access. But beware that changes keep regular visitors out. </para><!--rule (<hr>) is not applicable to DocBook--><para> Back to the <ulink url="https://wiki.squid-cache.org/SquidFaq/SecurityPitfalls/SquidFaq#">SquidFaq</ulink> </para></section></article>