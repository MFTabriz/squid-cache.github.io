<?xml version="1.0" encoding="utf-8"?><!DOCTYPE article  PUBLIC '-//OASIS//DTD DocBook XML V4.4//EN'  'http://www.docbook.org/xml/4.4/docbookx.dtd'><article><articleinfo><title>SquidFaq/ConfiguringSquid</title><revhistory><revision><revnumber>38</revnumber><date>2016-07-04 13:11:55</date><authorinitials>AmosJeffries</authorinitials></revision><revision><revnumber>37</revnumber><date>2014-02-13 21:59:14</date><authorinitials>AmosJeffries</authorinitials></revision><revision><revnumber>36</revnumber><date>2014-02-13 21:49:18</date><authorinitials>AmosJeffries</authorinitials></revision><revision><revnumber>35</revnumber><date>2014-02-13 21:47:41</date><authorinitials>AmosJeffries</authorinitials><revremark>shuffle default config examples into the per-release pages</revremark></revision><revision><revnumber>34</revnumber><date>2012-02-06 02:52:34</date><authorinitials>AmosJeffries</authorinitials><revremark>add 3.2 default config and guide link</revremark></revision><revision><revnumber>33</revnumber><date>2010-12-05 12:28:16</date><authorinitials>AmosJeffries</authorinitials><revremark>add 0.0.0.0/32 range to example config</revremark></revision><revision><revnumber>32</revnumber><date>2010-12-05 12:27:35</date><authorinitials>AmosJeffries</authorinitials><revremark>add IPv6 defaults to the example 3.1 config.</revremark></revision><revision><revnumber>31</revnumber><date>2010-07-02 03:20:59</date><authorinitials>AmosJeffries</authorinitials><revremark>HEAD to 3.HEAD updates</revremark></revision><revision><revnumber>30</revnumber><date>2010-02-19 10:27:29</date><authorinitials>FrancescoChemolli</authorinitials><revremark>fixed external links format</revremark></revision><revision><revnumber>29</revnumber><date>2009-08-17 07:55:33</date><authorinitials>AmosJeffries</authorinitials><revremark>shuffle the hierarchy info into its own feature description.</revremark></revision><revision><revnumber>28</revnumber><date>2009-07-22 05:07:43</date><authorinitials>AmosJeffries</authorinitials><revremark>3.1 update for localhost default allow</revremark></revision><revision><revnumber>27</revnumber><date>2009-04-07 07:20:28</date><authorinitials>AmosJeffries</authorinitials><revremark>best and most helpful advice I've seen about configuring Squid.</revremark></revision><revision><revnumber>26</revnumber><date>2008-11-27 21:24:28</date><authorinitials>AmosJeffries</authorinitials><revremark>IPv6 is linked form the master features list now.</revremark></revision><revision><revnumber>25</revnumber><date>2008-11-27 21:23:42</date><authorinitials>AmosJeffries</authorinitials><revremark>export more dnsserver info to dnsserver feature page.</revremark></revision><revision><revnumber>24</revnumber><date>2008-11-27 21:17:58</date><authorinitials>AmosJeffries</authorinitials><revremark>answer FAQ about where to find detailed config info.</revremark></revision><revision><revnumber>23</revnumber><date>2008-10-10 02:51:48</date><authorinitials>AmosJeffries</authorinitials><revremark>link typos</revremark></revision><revision><revnumber>22</revnumber><date>2008-10-10 02:47:07</date><authorinitials>AmosJeffries</authorinitials><revremark>cut some squid &lt;2.5 specifics away. add 3.1 updates</revremark></revision><revision><revnumber>21</revnumber><date>2008-08-25 12:38:06</date><authorinitials>AmosJeffries</authorinitials><revremark>shuffle IPv6 config details into Feature/IPv6</revremark></revision><revision><revnumber>20</revnumber><date>2008-05-18 19:38:59</date><authorinitials>localhost</authorinitials><revremark>converted to 1.6 markup</revremark></revision><revision><revnumber>19</revnumber><date>2008-02-19 02:12:26</date><authorinitials>AmosJeffries</authorinitials></revision><revision><revnumber>18</revnumber><date>2008-02-01 02:07:15</date><authorinitials>AmosJeffries</authorinitials></revision><revision><revnumber>17</revnumber><date>2007-12-17 03:46:51</date><authorinitials>AmosJeffries</authorinitials></revision><revision><revnumber>16</revnumber><date>2007-12-17 03:29:06</date><authorinitials>AmosJeffries</authorinitials></revision><revision><revnumber>15</revnumber><date>2007-12-17 03:18:49</date><authorinitials>AmosJeffries</authorinitials></revision><revision><revnumber>14</revnumber><date>2007-12-17 03:11:45</date><authorinitials>AmosJeffries</authorinitials></revision></revhistory></articleinfo><section><title>Configuring Squid</title></section><section><title>Before you start configuring</title><itemizedlist><listitem override="none"><para>The best all around advice I can give on Squid is to start simple!  Once everything works the way you expect, then start tweaking your way into complexity with a means to track the (in)effectiveness of each change you make (and a known good configuration that you can always go back to when you inevitably fubar the thing!). </para><para><emphasis>by Gregori Parker</emphasis> Seconded by all the Squid developers and Squid helpers. </para></listitem></itemizedlist><section><title>How do I configure Squid without re-compiling it?</title><para>The <emphasis role="strong">squid.conf</emphasis> file. By default, this file is located at <emphasis>/etc/squid/squid.conf</emphasis> or maybe <emphasis>/usr/local/squid/etc/squid.conf</emphasis>. </para><para>Also, a QUICKSTART guide has been included with the source distribution. Please see the directory where you unpacked the source archive. </para></section><section><title>What does the squid.conf file do?</title><para>The <emphasis>squid.conf</emphasis> file defines the configuration for <emphasis>squid</emphasis>.  The configuration includes (but not limited to) HTTP port number, the ICP request port number, incoming and outgoing requests, information about firewall access, and various timeout information. </para></section><section><title>Where can I find examples and configuration for a Feature?</title><para>There is still a fair bit of config knowledge buried in the old <ulink url="https://wiki.squid-cache.org/SquidFaq/ConfiguringSquid/SquidFaq#">SquidFaq</ulink> and Guide pages of this wiki. We are endeavoring to pull them into a layout easier to use. </para><para>What we have so far is: </para><itemizedlist><listitem><para>The general background configuration info here on this page </para></listitem><listitem><para>Specific feature descriptions pros/cons and some config are linked from the main <ulink url="https://wiki.squid-cache.org/SquidFaq/ConfiguringSquid/SquidFaq#">SquidFaq</ulink> in a features section. </para></listitem><listitem><para>Any complex tuning stuff mixing features and specific demos in <ulink url="https://wiki.squid-cache.org/SquidFaq/ConfiguringSquid/ConfigExamples#">ConfigExamples</ulink> and usually linked from the related features or FAQ pages as well. </para></listitem></itemizedlist></section><section><title>Do you have a squid.conf example?</title><para>Yes. </para><para>For Squid 2.x and 3.0 after you <emphasis>make install</emphasis>, a sample <emphasis>squid.conf.default</emphasis> file will exist in the <emphasis>etc</emphasis> directory under the Squid installation directory. </para><para>From 2.6 the Squid developers also provide a set of Configuration Guides online. They list all the options each version of Squid can accept in its squid.conf file </para><itemizedlist><listitem><para><ulink url="http://www.squid-cache.org/Versions/v2/2.7/cfgman/">Squid 2.7</ulink> Configuration Guide </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Versions/v3/3.0/cfgman/">Squid 3.0</ulink> Configuration Guide </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Versions/v3/3.1/cfgman/">Squid 3.1</ulink> Configuration Guide </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Versions/v3/3.2/cfgman/">Squid 3.2</ulink> Configuration Guide </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Versions/v3/3.3/cfgman/">Squid 3.3</ulink> Configuration Guide </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Versions/v3/3.4/cfgman/">Squid 3.4</ulink> Configuration Guide </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Versions/v3/3.5/cfgman/">Squid 3.5</ulink> Configuration Guide </para></listitem></itemizedlist><para>including guides for the current development test releases </para><itemizedlist><listitem><para><ulink url="http://www.squid-cache.org/Versions/v4/cfgman/">Squid 4</ulink> Configuration Guide </para></listitem></itemizedlist><section><title><ulink url="https://wiki.squid-cache.org/SquidFaq/ConfiguringSquid/Squid-3.1">Squid-3.1 default config</ulink></title><para>From 3.1 a lot of configuration cleanups have been done to make things easier. </para><itemizedlist><listitem override="none"><informaltable><tgroup cols="2"><colspec colname="col_0"/><colspec colname="col_1"/><tbody><row rowsep="1"><entry colsep="1" rowsep="1"><para> <inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/alert.png" width="15"/></imageobject><textobject><phrase>/!\</phrase></textobject></inlinemediaobject> </para></entry><entry colsep="1" rowsep="1"><para> This minimal configuration does not work with versions earlier than 3.1 which are missing special cleanup done to the code. </para></entry></row></tbody></tgroup></informaltable></listitem></itemizedlist><screen><![CDATA[http_port 3128
]]><![CDATA[
refresh_pattern ^ftp:           1440    20%     10080
refresh_pattern ^gopher:        1440    0%      1440
refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
refresh_pattern .               0       20%     4320
]]><![CDATA[
acl manager url_regex -i ^cache_object:// +i ^https?://[^/]+/squid-internal-mgr/
]]><![CDATA[
acl localhost src 127.0.0.1/32 ::1
acl to_localhost dst 127.0.0.0/8 0.0.0.0/32 ::1
]]><![CDATA[
acl localnet src 10.0.0.0/8     # RFC 1918 possible internal network
acl localnet src 172.16.0.0/12  # RFC 1918 possible internal network
acl localnet src 192.168.0.0/16 # RFC 1918 possible internal network
acl localnet src fc00::/7       # RFC 4193 local private network range
acl localnet src fe80::/10      # RFC 4291 link-local (directly plugged) machines
]]><![CDATA[
acl SSL_ports port 443
acl Safe_ports port 80          # http
acl Safe_ports port 21          # ftp
acl Safe_ports port 443         # https
acl Safe_ports port 70          # gopher
acl Safe_ports port 210         # wais
acl Safe_ports port 1025-65535  # unregistered ports
acl Safe_ports port 280         # http-mgmt
acl Safe_ports port 488         # gss-http
acl Safe_ports port 591         # filemaker
acl Safe_ports port 777         # multiling http
acl CONNECT method CONNECT
]]><![CDATA[
http_access allow manager localhost
http_access deny manager
http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports
http_access allow localhost
http_access allow localnet
http_access deny all]]></screen></section><section><title><ulink url="https://wiki.squid-cache.org/SquidFaq/ConfiguringSquid/Squid-3.2">Squid-3.2 default config</ulink></title><para>From 3.2 further configuration cleanups have been done to make things easier and safer. The manager, localhost, and to_localhost ACL definitions are now built-in. </para><itemizedlist><listitem override="none"><informaltable><tgroup cols="2"><colspec colname="col_0"/><colspec colname="col_1"/><tbody><row rowsep="1"><entry colsep="1" rowsep="1"><para> <inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/alert.png" width="15"/></imageobject><textobject><phrase>/!\</phrase></textobject></inlinemediaobject> </para></entry><entry colsep="1" rowsep="1"><para> This minimal configuration does not work with versions earlier than 3.2 which are missing special cleanup done to the code. </para></entry></row></tbody></tgroup></informaltable></listitem></itemizedlist><screen><![CDATA[http_port 3128
]]><![CDATA[
refresh_pattern ^ftp:           1440    20%     10080
refresh_pattern ^gopher:        1440    0%      1440
refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
refresh_pattern .               0       20%     4320
]]><![CDATA[
acl localnet src 10.0.0.0/8     # RFC 1918 possible internal network
acl localnet src 172.16.0.0/12  # RFC 1918 possible internal network
acl localnet src 192.168.0.0/16 # RFC 1918 possible internal network
acl localnet src fc00::/7       # RFC 4193 local private network range
acl localnet src fe80::/10      # RFC 4291 link-local (directly plugged) machines
]]><![CDATA[
acl SSL_ports port 443
]]><![CDATA[
acl Safe_ports port 80          # http
acl Safe_ports port 21          # ftp
acl Safe_ports port 443         # https
acl Safe_ports port 70          # gopher
acl Safe_ports port 210         # wais
acl Safe_ports port 1025-65535  # unregistered ports
acl Safe_ports port 280         # http-mgmt
acl Safe_ports port 488         # gss-http
acl Safe_ports port 591         # filemaker
acl Safe_ports port 777         # multiling http
acl CONNECT method CONNECT
]]><![CDATA[
http_access allow manager localhost
http_access deny manager
http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports
http_access allow localhost
http_access allow localnet
http_access deny all]]></screen></section><section><title><ulink url="https://wiki.squid-cache.org/SquidFaq/ConfiguringSquid/Squid-3.3">Squid-3.3 default config</ulink></title><para>From 3.3 a few performance improvements have been done. The manager regex ACLs have been moved after the DoS and protocol smuggling attack protections. </para><itemizedlist><listitem override="none"><informaltable><tgroup cols="2"><colspec colname="col_0"/><colspec colname="col_1"/><tbody><row rowsep="1"><entry colsep="1" rowsep="1"><para> <inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/alert.png" width="15"/></imageobject><textobject><phrase>/!\</phrase></textobject></inlinemediaobject> </para></entry><entry colsep="1" rowsep="1"><para> This minimal configuration does not work with versions earlier than 3.2 which are missing special cleanup done to the code. </para></entry></row></tbody></tgroup></informaltable></listitem></itemizedlist><screen><![CDATA[http_port 3128
]]><![CDATA[
refresh_pattern ^ftp:           1440    20%     10080
refresh_pattern ^gopher:        1440    0%      1440
refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
refresh_pattern .               0       20%     4320
]]><![CDATA[
acl localnet src 10.0.0.0/8     # RFC 1918 possible internal network
acl localnet src 172.16.0.0/12  # RFC 1918 possible internal network
acl localnet src 192.168.0.0/16 # RFC 1918 possible internal network
acl localnet src fc00::/7       # RFC 4193 local private network range
acl localnet src fe80::/10      # RFC 4291 link-local (directly plugged) machines
]]><![CDATA[
acl SSL_ports port 443          # https
]]><![CDATA[
acl Safe_ports port 80          # http
acl Safe_ports port 21          # ftp
acl Safe_ports port 443         # https
acl Safe_ports port 70          # gopher
acl Safe_ports port 210         # wais
acl Safe_ports port 1025-65535  # unregistered ports
acl Safe_ports port 280         # http-mgmt
acl Safe_ports port 488         # gss-http
acl Safe_ports port 591         # filemaker
acl Safe_ports port 777         # multiling http
]]><![CDATA[
acl CONNECT method CONNECT
]]><![CDATA[
http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports
http_access allow localhost manager
http_access deny manager
http_access allow localnet
http_access allow localhost
http_access deny all]]></screen></section><section><title><ulink url="https://wiki.squid-cache.org/SquidFaq/ConfiguringSquid/Squid-3.3">Squid-3.3 default config</ulink></title><para>From 3.3 a few performance improvements have been done. The manager regex ACLs have been moved after the DoS and protocol smuggling attack protections. </para><itemizedlist><listitem override="none"><informaltable><tgroup cols="2"><colspec colname="col_0"/><colspec colname="col_1"/><tbody><row rowsep="1"><entry colsep="1" rowsep="1"><para> <inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/alert.png" width="15"/></imageobject><textobject><phrase>/!\</phrase></textobject></inlinemediaobject> </para></entry><entry colsep="1" rowsep="1"><para> This minimal configuration does not work with versions earlier than 3.2 which are missing special cleanup done to the code. </para></entry></row></tbody></tgroup></informaltable></listitem></itemizedlist><screen><![CDATA[http_port 3128
]]><![CDATA[
refresh_pattern ^ftp:           1440    20%     10080
refresh_pattern ^gopher:        1440    0%      1440
refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
refresh_pattern .               0       20%     4320
]]><![CDATA[
acl localnet src 10.0.0.0/8     # RFC 1918 possible internal network
acl localnet src 172.16.0.0/12  # RFC 1918 possible internal network
acl localnet src 192.168.0.0/16 # RFC 1918 possible internal network
acl localnet src fc00::/7       # RFC 4193 local private network range
acl localnet src fe80::/10      # RFC 4291 link-local (directly plugged) machines
]]><![CDATA[
acl SSL_ports port 443          # https
]]><![CDATA[
acl Safe_ports port 80          # http
acl Safe_ports port 21          # ftp
acl Safe_ports port 443         # https
acl Safe_ports port 70          # gopher
acl Safe_ports port 210         # wais
acl Safe_ports port 1025-65535  # unregistered ports
acl Safe_ports port 280         # http-mgmt
acl Safe_ports port 488         # gss-http
acl Safe_ports port 591         # filemaker
acl Safe_ports port 777         # multiling http
]]><![CDATA[
acl CONNECT method CONNECT
]]><![CDATA[
http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports
http_access allow localhost manager
http_access deny manager
http_access allow localnet
http_access allow localhost
http_access deny all]]></screen></section><section><title><ulink url="https://wiki.squid-cache.org/SquidFaq/ConfiguringSquid/Squid-3.5">Squid-3.5 default config</ulink></title><para>From 3.5 a few performance improvements have been done. The manager regex ACLs have been moved after the DoS and protocol smuggling attack protections. </para><itemizedlist><listitem override="none"><informaltable><tgroup cols="2"><colspec colname="col_0"/><colspec colname="col_1"/><tbody><row rowsep="1"><entry colsep="1" rowsep="1"><para> <inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/alert.png" width="15"/></imageobject><textobject><phrase>/!\</phrase></textobject></inlinemediaobject> </para></entry><entry colsep="1" rowsep="1"><para> This minimal configuration does not work with versions earlier than 3.2 which are missing special cleanup done to the code. </para></entry></row></tbody></tgroup></informaltable></listitem></itemizedlist><screen><![CDATA[http_port 3128
]]><![CDATA[
acl localnet src 10.0.0.0/8     # RFC1918 possible internal network
acl localnet src 172.16.0.0/12  # RFC1918 possible internal network
acl localnet src 192.168.0.0/16 # RFC1918 possible internal network
acl localnet src fc00::/7       # RFC 4193 local private network range
acl localnet src fe80::/10      # RFC 4291 link-local (directly plugged) machines
]]><![CDATA[
acl SSL_ports port 443
]]><![CDATA[
acl Safe_ports port 80          # http
acl Safe_ports port 21          # ftp
acl Safe_ports port 443         # https
acl Safe_ports port 70          # gopher
acl Safe_ports port 210         # wais
acl Safe_ports port 280         # http-mgmt
acl Safe_ports port 488         # gss-http
acl Safe_ports port 591         # filemaker
acl Safe_ports port 777         # multiling http
acl Safe_ports port 1025-65535  # unregistered ports
]]><![CDATA[
acl CONNECT method CONNECT
]]><![CDATA[
http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports
http_access allow localhost manager
http_access deny manager
]]><![CDATA[
#
# INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS
#
]]><![CDATA[
http_access allow localnet
http_access allow localhost
http_access deny all
]]><![CDATA[
coredump_dir /squid/var/cache/squid
]]><![CDATA[
refresh_pattern ^ftp:           1440    20%     10080
refresh_pattern ^gopher:        1440    0%      1440
refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
refresh_pattern .               0       20%     4320]]></screen></section></section><section><title>How do I configure Squid to work behind a firewall?</title><para>If you are behind a firewall which can't make direct connections to the outside world, you <emphasis role="strong">must</emphasis> use a parent cache. Normally Squid tries to be smart and only uses cache peers when it makes sense from a perspective of global hit ratio, and thus you need to tell Squid when it can not go direct and must use a parent proxy even if it knows the request will be a cache miss. </para><para>You can use the <emphasis>never_direct</emphasis> access list in <emphasis>squid.conf</emphasis> to specify which requests must be forwarded to your parent cache outside the firewall, and the <emphasis>always_direct</emphasis> access list to specify which requests must not be forwarded.  For example, if Squid must connect directly to all servers that end with <emphasis>mydomain.com</emphasis>, but must use the parent for all others, you would write: </para><screen><![CDATA[acl INSIDE dstdomain .mydomain.com
always_direct allow INSIDE
never_direct allow all]]></screen><para>You could also specify internal servers by IP address </para><screen><![CDATA[acl INSIDE_IP dst 1.2.3.0/24
always_direct allow INSIDE_IP
never_direct allow all]]></screen><para>Note, however that when you use IP addresses, Squid must perform a DNS lookup to convert URL hostnames to an address.  Your internal DNS servers may not be able to lookup external domains. </para><para>If you use <emphasis>never_direct</emphasis> and you have multiple parent caches, then you probably will want to mark one of them as a default choice in case Squid can't decide which one to use.  That is done with the <emphasis>default</emphasis> keyword on a <emphasis>cache_peer</emphasis> line.  For example: </para><screen><![CDATA[cache_peer xyz.mydomain.com parent 3128 0 no-query default]]></screen></section><section><title>How do I configure Squid forward all requests to another proxy?</title><para>see <ulink url="https://wiki.squid-cache.org/SquidFaq/ConfiguringSquid/Features/CacheHierarchy#">Features/CacheHierarchy</ulink> </para></section><section><title>What ''cache_dir'' size should I use?</title><para>This chapter assumes that you are dedicating an entire disk partition to a squid cache_dir, as is often the case. </para><para>Generally speaking, setting the cache_dir to be the same size as the disk partition is not a wise choice, for two reasons. The first is that squid is not very tolerant to running out of disk space. On top of the cache_dir size, squid will use some extra space for <emphasis>swap.state</emphasis> and then some more temporary storage as work-areas, for instance when rebuilding <emphasis>swap.state</emphasis>. So in any case make sure to leave some extra room for this, or your cache will enter an endless crash-restart cycle. </para><para>The second reason is fragmentation (note, this won't apply to the COSS object storage engine - when it will be ready): filesystems can only do so much to avoid fragmentation, and in order to be effective they need to have the space to try and optimize file placement. If the disk is full, optimization is very hard, and when the disk is 100% full optimizing is plain impossible. Get your disk fragmented, and it will most likely be your worst bottleneck, by far offsetting the modest gain you got by having more storage. </para><para>Let's see an example: you have a 9Gb disk (these times they're even hard to find..). First thing, manifacturers often lie about disk capacity (the whole Megabyte vs Mebibyte issue), and then the OS needs some space for its accounting structures, so you'll reasonably end up with 8Gib of useable space. You then have to account for another 10% in overhead for Squid, and then the space needed for keeping fragmentation at bay. So in the end the recommended cache_dir setting is 6000 to 7000 Mebibyte. </para><screen><![CDATA[cache_dir ... 7000 16 256]]></screen><para>Its better to start out with a conservative setting and then, after the cache has been filled, look at the disk usage.  If you think there is plenty of unused space, then increase the cache_dir setting a little. </para><para>If you're getting &quot;disk full&quot; write errors, then you definitely need to decrease your cache size. </para></section><section><title>I'm adding a new cache_dir. Will I lose my cache?</title><para>No. You can add and delete cache_dir lines without affecting any of the others. </para></section><section><title>Squid and http-gw from the TIS toolkit.</title><para>Several people on both the fwtk-users and the squid-users mailing asked about using Squid in combination with http-gw from the <ulink url="http://www.tis.com/">TIS toolkit</ulink>. The most elegant way in my opinion is to run an internal Squid caching proxyserver which handles client requests and let this server forward it's requests to the http-gw running on the firewall. Cache hits won't need to be handled by the firewall. </para><para>In this example Squid runs on the same server as the http-gw, Squid uses 8000 and http-gw uses 8080 (web).  The local domain is home.nl. </para><section><title>Firewall configuration</title><para>Either run http-gw as a daemon from the /etc/rc.d/rc.local<emphasis> (Linux Slackware): </emphasis> </para><screen><![CDATA[exec /usr/local/fwtk/http-gw -daemon 8080]]></screen><para>or run it from inetd like this: </para><screen><![CDATA[web stream      tcp      nowait.100  root /usr/local/fwtk/http-gw http-gw]]></screen><para>I increased the watermark to 100 because a lot of people run into problems with the default value. </para><para>Make sure you have at least the following line in /usr/local/etc/netperm-table<emphasis>: </emphasis> </para><screen><![CDATA[http-gw: hosts 127.0.0.1]]></screen><para>You could add the IP-address of your own workstation to this rule and make sure the http-gw by itself works, like: </para><screen><![CDATA[http-gw:                hosts 127.0.0.1 10.0.0.1]]></screen></section><section><title>Squid configuration</title><para>The following settings are important: </para><screen><![CDATA[http_port       8000
icp_port        0
cache_peer      localhost.home.nl parent 8080 0 default
acl HOME        dstdomain .home.nl
alwayws_direct  allow HOME
never_direct    allow all]]></screen><para>This tells Squid to use the parent for all domains other than home.nl<emphasis>. Below, </emphasis>access.log<emphasis> entries show what happens if you do a reload on the Squid-homepage: </emphasis> </para><screen><![CDATA[872739961.631 1566 10.0.0.21 ERR_CLIENT_ABORT/304 83 GET http://www.squid-cache.org/ - DEFAULT_PARENT/localhost.home.nl -
872739962.976 1266 10.0.0.21 TCP_CLIENT_REFRESH/304 88 GET http://www.nlanr.net/Images/cache_now.gif - DEFAULT_PARENT/localhost.home.nl -
872739963.007 1299 10.0.0.21 ERR_CLIENT_ABORT/304 83 GET http://www.squid-cache.org/Icons/squidnow.gif - DEFAULT_PARENT/localhost.home.nl -
872739963.061 1354 10.0.0.21 TCP_CLIENT_REFRESH/304 83 GET http://www.squid-cache.org/Icons/Squidlogo2.gif - DEFAULT_PARENT/localhost.home.nl]]></screen><para>http-gw entries in syslog: </para><screen><![CDATA[Aug 28 02:46:00 memo http-gw[2052]: permit host=localhost/127.0.0.1 use of gateway (V2.0beta)
Aug 28 02:46:00 memo http-gw[2052]: log host=localhost/127.0.0.1 protocol=HTTP cmd=dir dest=www.squid-cache.org path=/
Aug 28 02:46:01 memo http-gw[2052]: exit host=localhost/127.0.0.1 cmds=1 in=0 out=0 user=unauth duration=1
Aug 28 02:46:01 memo http-gw[2053]: permit host=localhost/127.0.0.1 use of gateway (V2.0beta)
Aug 28 02:46:01 memo http-gw[2053]: log host=localhost/127.0.0.1 protocol=HTTP cmd=get dest=www.squid-cache.org path=/Icons/Squidlogo2.gif
Aug 28 02:46:01 memo http-gw[2054]: permit host=localhost/127.0.0.1 use of gateway (V2.0beta)
Aug 28 02:46:01 memo http-gw[2054]: log host=localhost/127.0.0.1 protocol=HTTP cmd=get dest=www.squid-cache.org path=/Icons/squidnow.gif
Aug 28 02:46:01 memo http-gw[2055]: permit host=localhost/127.0.0.1 use of gateway (V2.0beta)
Aug 28 02:46:01 memo http-gw[2055]: log host=localhost/127.0.0.1 protocol=HTTP cmd=get dest=www.nlanr.net path=/Images/cache_now.gif
Aug 28 02:46:02 memo http-gw[2055]: exit host=localhost/127.0.0.1 cmds=1 in=0 out=0 user=unauth duration=1
Aug 28 02:46:03 memo http-gw[2053]: exit host=localhost/127.0.0.1 cmds=1 in=0 out=0 user=unauth duration=2
Aug 28 02:46:04 memo http-gw[2054]: exit host=localhost/127.0.0.1 cmds=1 in=0 out=0 user=unauth duration=3]]></screen><para>To summarize: </para><para>Advantages: </para><itemizedlist><listitem><para>http-gw allows you to selectively block ActiveX and Java, and it's primary design goal is security. </para></listitem><listitem><para>The firewall doesn't need to run large applications like Squid. </para></listitem><listitem><para>The internal Squid-server still gives you the benefit of caching. </para></listitem></itemizedlist><para>Disadvantages: </para><itemizedlist><listitem><para>The internal Squid proxyserver can't (and shouldn't) work with other parent or neighbor caches. </para></listitem><listitem><para>Initial requests are slower because these go through http-gw, http-gw also does reverse lookups. Run a nameserver on the firewall or use an internal nameserver. </para></listitem></itemizedlist><para>(contributed by <ulink url="mailto:RvdOever@baan.nl">Rodney van den Oever</ulink>) </para></section></section><section><title>What is &quot;HTTP_X_FORWARDED_FOR&quot;?  Why does squid provide it to WWW servers, and how can I stop it?</title><para>see. <ulink url="https://wiki.squid-cache.org/SquidFaq/ConfiguringSquid/SquidFaq/SecurityPitfalls#head-bc80c66abc9dfd9d6463fac3113bf5101d7b741e">Security - X-Forwarded-For</ulink> </para><para>When a proxy-cache is used, a server does not see the connection coming from the originating client.  Many people like to implement access controls based on the client address. To accommodate these people, Squid adds the request header called &quot;X-Forwarded-For&quot; which looks like this: </para><screen><![CDATA[X-Forwarded-For: 128.138.243.150, unknown, 192.52.106.30]]></screen><para>Entries are always IP addresses, or the word unknown if the address could not be determined or if it has been disabled with the forwarded_for configuration option. </para><para>We must note that access controls based on this header are extremely weak and simple to fake.  Anyone may hand-enter a request with any IP address whatsoever.  This is perhaps the reason why client IP addresses have been omitted from the HTTP/1.1 specification. </para><para>Because of the weakness of this header, access controls based on X-Forwarded-For are not used by default. It's needs to be specifically enabled with <emphasis role="strong">follow_x_forwarded_for</emphasis>. </para></section><section><title>Can Squid anonymize HTTP requests?</title><para>Yes it can, however the way of doing it has changed from earlier versions of squid. Please follow the instructions for the version of squid that you are using. As a default, no anonymizing is done. </para><para>If you choose to use the anonymizer you might wish to investigate the forwarded_for option to prevent the client address being disclosed. Failure to turn off the forwarded_for option will reduce the effectiveness of the anonymizer. Finally if you filter the User-Agent header using the fake_user_agent option can prevent some user problems as some sites require the User-Agent header. </para><para>NP: Squid must be built with the <emphasis role="strong">--enable-http-violations</emphasis> configure option before building. </para><para>Current squid releases provide a mix of header control directives and capability; </para><glosslist><glossentry><glossterm>Squid 2.6 - 2.7</glossterm><glossdef><para>Allow erasure or replacement of specific headers through the <emphasis role="strong">http_header_access</emphasis> and <emphasis role="strong">header_replace</emphasis> options. </para></glossdef></glossentry><glossentry><glossterm>Squid 3.0</glossterm><glossdef><para>Allows selective erasure and replacement of specific headers in either request or reply with the <emphasis role="strong">request_header_access</emphasis> and <emphasis role="strong">reply_header_access</emphasis> and <emphasis role="strong">header_replace</emphasis> settings. </para></glossdef></glossentry><glossentry><glossterm>Squid 3.1</glossterm><glossdef><para>Adds to the 3.0 capability with truncation, replacement, or removal of X-Forwarded-For header. </para></glossdef></glossentry></glosslist><para>For details see the documentation in squid.conf.default or squid.conf.documented for your specific version of squid. </para><para><ulink url="http://www.squid-cache.org/Versions/v2/HEAD/cfgman/"/> ,  <ulink url="http://www.squid-cache.org/Versions/v3/3.HEAD/cfgman/"/> , References: <ulink url="http://www.iks-jena.de/mitarb/lutz/anon/web.en.html">Anonymous WWW</ulink> </para></section><section><title>Can I make Squid go direct for some sites?</title><para>Sure, just use the <emphasis role="strong">always_direct</emphasis> access list. </para><para>For example, if you want Squid to connect directly to hotmail.com servers, you can use these lines in your config file: </para><screen><![CDATA[acl hotmail dstdomain .hotmail.com
always_direct allow hotmail]]></screen></section><section><title>Can I make Squid proxy only, without caching anything?</title><para>Sure, there are few things you can do. </para><para>You can use the <emphasis>cache</emphasis> access list to make Squid never cache any response: </para><screen><![CDATA[cache deny all]]></screen><para>With Squid-2.7, Squid-3.1 and later you can also remove all 'cache_dir' options from your squid.conf to avoid having a cache directory. </para><para>With Squid-2.4, 2.5, 2.6, and 3.0 you need to use the &quot;null&quot; storage module: </para><screen><![CDATA[cache_dir null /tmp]]></screen><para>Note: a null cache_dir does not disable caching, but it does save you from creating a cache structure if you have disabled caching with cache. The directory (e.g., <code>/tmp</code>) must exist so that squid can chdir to it, unless you also use the <code>coredump_dir</code> option. </para><para>To configure Squid for the &quot;null&quot; storage module, specify it on the configure<emphasis> command line: </emphasis> </para><screen><![CDATA[--enable-storeio=null,...]]></screen></section><section><title>Can I prevent users from downloading large files?</title><para>You can set the global <code>reply_body_max_size</code> parameter.  This option controls the largest HTTP message body that will be sent to a cache client for one request. </para><para>If the HTTP response coming from the server has a <emphasis>Content-length</emphasis> header, then Squid compares the content-length value to the <code>reply_body_max_size</code> value.  If the content-length is larger,the server connection is closed and the user receives an error message from Squid. </para><para><emphasis>Some responses don't have </emphasis>Content-length<emphasis> headers. In this case, Squid counts how many bytes are written to the client.  Once the limit is reached, the client's connection is simply closed. </emphasis> </para><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/idea.png" width="15"/></imageobject><textobject><phrase>(!)</phrase></textobject></inlinemediaobject> Note that &quot;creative&quot; user-agents will still be able to download really large files through the cache using HTTP/1.1 range requests. </para></listitem></itemizedlist><!--rule (<hr>) is not applicable to DocBook--><itemizedlist><listitem override="none"><para>Back to the <ulink url="https://wiki.squid-cache.org/SquidFaq/ConfiguringSquid/SquidFaq#">SquidFaq</ulink> </para></listitem></itemizedlist></section></section></article>