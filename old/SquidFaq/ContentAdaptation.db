<?xml version="1.0" encoding="utf-8"?><!DOCTYPE article  PUBLIC '-//OASIS//DTD DocBook XML V4.4//EN'  'http://www.docbook.org/xml/4.4/docbookx.dtd'><article><articleinfo><title>SquidFaq/ContentAdaptation</title><revhistory><revision><revnumber>15</revnumber><date>2013-03-17 19:55:25</date><authorinitials>AlexRousskov</authorinitials><revremark>Mentioned request_header_add (although SquidConf link is borken for some reason) and clarified version-dependent limitations.</revremark></revision><revision><revnumber>14</revnumber><date>2008-10-01 03:53:47</date><authorinitials>AlexRousskov</authorinitials><revremark>updated eCAP info</revremark></revision><revision><revnumber>13</revnumber><date>2008-09-14 03:11:30</date><authorinitials>AmosJeffries</authorinitials><revremark>Break most of the ICAP details into a feature page.</revremark></revision><revision><revnumber>12</revnumber><date>2008-05-18 19:38:55</date><authorinitials>localhost</authorinitials><revremark>converted to 1.6 markup</revremark></revision><revision><revnumber>11</revnumber><date>2008-02-13 17:08:13</date><authorinitials>AlexRousskov</authorinitials><revremark>Finished renaming eCAM to eCAP. Added a note about a broken link.</revremark></revision><revision><revnumber>10</revnumber><date>2007-10-10 17:35:35</date><authorinitials>AlexRousskov</authorinitials><revremark>Linked eCAM text with eCAP feature page. Updated the eCAM wording to reflect work-in-progress status.</revremark></revision><revision><revnumber>9</revnumber><date>2007-08-13 17:44:07</date><authorinitials>AlexRousskov</authorinitials><revremark>Added mechanism scope table to the Summary section.</revremark></revision><revision><revnumber>8</revnumber><date>2007-08-13 17:18:01</date><authorinitials>AlexRousskov</authorinitials><revremark>Added squid.conf ACLs mechanism, acting on Henrik's hint.</revremark></revision><revision><revnumber>7</revnumber><date>2007-08-10 14:13:27</date><authorinitials>AlexRousskov</authorinitials><revremark>Added a mechansim summary section; polished</revremark></revision><revision><revnumber>6</revnumber><date>2007-08-10 13:41:32</date><authorinitials>AlexRousskov</authorinitials><revremark>Polished wording</revremark></revision><revision><revnumber>5</revnumber><date>2007-08-10 13:23:09</date><authorinitials>AlexRousskov</authorinitials><revremark>Polished Pros/Cons wording</revremark></revision><revision><revnumber>4</revnumber><date>2007-08-08 18:10:59</date><authorinitials>AlexRousskov</authorinitials><revremark>Polished Pros/Cons rendering</revremark></revision><revision><revnumber>3</revnumber><date>2007-08-08 17:10:53</date><authorinitials>AlexRousskov</authorinitials></revision><revision><revnumber>2</revnumber><date>2007-08-08 17:08:09</date><authorinitials>AlexRousskov</authorinitials><revremark>Added meat. Needs review, especially the ClientStream section.</revremark></revision><revision><revnumber>1</revnumber><date>2007-08-08 05:20:23</date><authorinitials>AlexRousskov</authorinitials><revremark>Initial skeleton</revremark></revision></revhistory></articleinfo><section><title>Content Adaptation</title><para>A proxy may analyze, capture, block, replace, or modify the messages it proxies. Such actions are often called <emphasis>content adaptation</emphasis> even though some of them do not alter anything. </para><para>Squid can be configured or modified to perform some forms of content adaptation. This page highlights content adaptation approaches supported by Squid. </para></section><section><title>Use cases</title><para>The following are typical content adaptation needs. Virtually all of the adaptations listed below have been implemented using one or more mechanisms described in this document. </para><itemizedlist><listitem><para>Add, remove, or modify an HTTP header field (e.g., Cookie) </para></listitem><listitem><para>Block messages based on request URLs </para></listitem><listitem><para>Block messages based on content </para></listitem><listitem><para>Redirect certain requests to a custom page or server </para></listitem><listitem><para>Respond to certain requests with a custom page </para></listitem><listitem><para>Modify a page to insert new content (e.g., warnings or ads) </para></listitem><listitem><para>Modify a page to remove existing content (e.g., images or ads) </para></listitem><listitem><para>Scale an embedded image (e.g., for mobile devices) </para></listitem></itemizedlist></section><section><title>Adaptation Mechanisms</title><para><anchor id="secICAP"/> </para><section><title>ICAP</title><para>Internet Content Adaptation Protocol (RFC <ulink url="http://www.rfc-editor.org/rfc/rfc3507.txt">3507</ulink>, subject to <ulink url="http://www.measurement-factory.com/std/icap/">errata</ulink>) specifies how an HTTP proxy (an ICAP client) can outsource content adaptation to an external ICAP server. Most popular proxies, including Squid, support ICAP. If your adaptation algorithm resides in an ICAP server, it will be able to work in a variety of environments and will not depend on a single proxy project or vendor. No proxy code modifications are necessary for most content adaptations using ICAP. </para><itemizedlist><listitem override="none"><para><emphasis role="strong">Pros</emphasis>: Proxy-independent, adaptation-focused API, no Squid modifications, supports remote adaptation servers, scalable. </para><para><emphasis role="strong">Cons</emphasis>: Communication delays, protocol functionality limitations, needs a stand-alone ICAP server process or box. </para></listitem></itemizedlist><para>One proxy may access many ICAP servers, and one ICAP server may be accessed by many proxies. An ICAP server may reside on the same physical machine as Squid or run on a remote host. Depending on configuration and context, some ICAP failures can be bypassed, making them invisible to proxy end-users. </para><para>see <ulink url="https://wiki.squid-cache.org/SquidFaq/ContentAdaptation/Features/ICAP#">../../Features/ICAP</ulink> </para><para><anchor id="secClientStreams"/> </para></section><section><title>Client Streams</title><para>Squid3 sources include <ulink url="https://wiki.squid-cache.org/SquidFaq/ContentAdaptation/ProgrammingGuide/ClientStreams#">ClientStreams</ulink> classes designed for embedded server-side includes (ESI). A Client Streams node has access to the HTTP response message being received from the origin server or being fetched from the cache. By modifying Squid code, new nodes performing custom content adaptation may be added. Client Streams are limited to response modification. </para><itemizedlist><listitem override="none"><para><emphasis role="strong">Pros</emphasis>: Fast, integrated. </para><para><emphasis role="strong">Cons</emphasis>: Limited API documentation, lack of support, cannot adapt requests, dependent on Squid (installation, code, license). </para></listitem></itemizedlist><para>Unfortunately, Client Streams creators have not been actively participating in Squid development for a while, little API <ulink url="https://wiki.squid-cache.org/SquidFaq/ContentAdaptation/ProgrammingGuide/ClientStreams#">documentation</ulink> is available, and the long-term sustainability of the code is uncertain. Custom Client Streams code integrated with Squid may need to be licensed under GPL. </para><para><anchor id="seceCAP"/> </para></section><section><title>eCAP</title><para><ulink url="http://www.e-cap.org/">eCAP</ulink> services are like ICAP services embedded into Squid. eCAP is an interface that lets Squid and other servers to use embedded adaptation modules that are dynamically or statically loaded into the host application. This approach allows for fast content adaptation without tight dependency on Squid sources. Other proxies and even ICAP servers may chose to support the same API, removing dependency on Squid. </para><itemizedlist><listitem override="none"><para><emphasis role="strong">Pros</emphasis>: Fast, integrated, adaptation-focused API, no Squid modifications. </para><para><emphasis role="strong">Cons</emphasis>: Dependent on Squid installation (at least in the beginning) </para></listitem></itemizedlist><para>Initial support for eCAP is available in <ulink url="https://wiki.squid-cache.org/SquidFaq/ContentAdaptation/RoadMap/Squid3#">Squid 3.1</ulink>. You can find more details <ulink url="https://wiki.squid-cache.org/SquidFaq/ContentAdaptation/Features/eCAP#">elsewhere</ulink>. </para><para><anchor id="secACLs"/> </para></section><section><title>Squid.conf ACLs</title><para>Simple HTTP request header adaptation is possible without writing any code. Squid supports a few configuration options that allow the administrator to add, delete, or replace specified HTTP request headers: <ulink url="http://www.squid-cache.org/Doc/config/request_header_add#">request_header_add</ulink>, <ulink url="http://www.squid-cache.org/Doc/config/request_header_access#">request_header_access</ulink>, and <ulink url="http://www.squid-cache.org/Doc/config/request_header_replace#">request_header_replace</ulink>. Similar directives available for adapting response headers. </para><itemizedlist><listitem override="none"><para><emphasis role="strong">Pros</emphasis>: Fast, integrated, adaptation-focused API, no Squid modifications. </para><para><emphasis role="strong">Cons</emphasis>: Limited to simple header adaptations, dependent on Squid installation. </para></listitem></itemizedlist><para>The extent of header manipulation support depends on Squid version: Some versions do not allow adding new headers and some do not allow replacing old response headers, for example. </para><para><anchor id="secCodeHacks"/> </para></section><section><title>Code hacks</title><para>It is possible to modify Squid sources to perform custom content adaptation without using the Client Streams mechanism described above. Simple and generic adaptations such as header manipulations may be accepted into the official Squid code base, minimizing long-term maintenance overheads. </para><itemizedlist><listitem override="none"><para><emphasis role="strong">Pros</emphasis>: Fast, integrated. </para><para><emphasis role="strong">Cons</emphasis>: Must study Squid sources (no API), limited support, dependent on Squid (installation, code, license). </para></listitem></itemizedlist><para>Unfortunately, most adaptations are relatively complex, not limited to headers, or highly customized and, hence, are unlikely to be accepted. Message body adaptation is especially difficult because Squid does not buffer the entire message body, but instead processes one semi-random piece of content at a time. </para><para>Developers concerned with Squid code quality and bloat may not want to help you with specific coding problems. On the other hand, you may need to modify your code for every Squid release and license your software under GPL. The code will not work with other proxies. </para></section><section><title>Summary</title><para>Some adaptation mechanisms are limited in their scope. The following table summarizes what messages and what message parts  the mechanisms can adapt. </para><informaltable><tgroup cols="5"><colspec colname="col_0"/><colspec colname="col_1"/><colspec colname="col_2"/><colspec colname="col_3"/><colspec colname="col_4"/><tbody><row rowsep="1"><entry align="center" colsep="1" morerows="1" nameend="col_0" namest="col_0" rowsep="1"><para> <emphasis role="strong">Mechanism</emphasis> </para></entry><entry align="center" colsep="1" nameend="col_2" namest="col_1" rowsep="1"><para><emphasis role="strong">Request</emphasis> </para></entry><entry align="center" colsep="1" nameend="col_4" namest="col_3" rowsep="1"><para><emphasis role="strong">Response</emphasis> </para></entry></row><row rowsep="1"><entry align="center" colsep="1" rowsep="1"><para><emphasis role="strong">Header</emphasis> </para></entry><entry align="center" colsep="1" rowsep="1"><para> <emphasis role="strong">Body</emphasis> </para></entry><entry align="center" colsep="1" rowsep="1"><para> <emphasis role="strong">Header</emphasis> </para></entry><entry align="center" colsep="1" rowsep="1"><para> <emphasis role="strong">Body</emphasis> </para></entry></row><row rowsep="1"><entry colsep="1" rowsep="1"><para> <link linkend="secICAP">ICAP</link> </para></entry><entry align="center" colsep="1" rowsep="1"><para>yes </para></entry><entry align="center" colsep="1" rowsep="1"><para>yes </para></entry><entry align="center" colsep="1" rowsep="1"><para>yes </para></entry><entry align="center" colsep="1" rowsep="1"><para>yes </para></entry></row><row rowsep="1"><entry colsep="1" rowsep="1"><para> <link linkend="secClientStreams">Client Streams</link> </para></entry><entry colsep="1" rowsep="1"/><entry colsep="1" rowsep="1"/><entry align="center" colsep="1" rowsep="1"><para>yes </para></entry><entry align="center" colsep="1" rowsep="1"><para>yes </para></entry></row><row rowsep="1"><entry colsep="1" rowsep="1"><para> <link linkend="seceCAP">eCAP</link> </para></entry><entry align="center" colsep="1" rowsep="1"><para>yes </para></entry><entry align="center" colsep="1" rowsep="1"><para>yes </para></entry><entry align="center" colsep="1" rowsep="1"><para>yes </para></entry><entry align="center" colsep="1" rowsep="1"><para>yes </para></entry></row><row rowsep="1"><entry colsep="1" rowsep="1"><para> <link linkend="secACLs">ACLs</link> </para></entry><entry align="center" colsep="1" rowsep="1"><para>yes </para></entry><entry colsep="1" rowsep="1"/><entry align="center" colsep="1" rowsep="1"><para>del </para></entry><entry colsep="1" rowsep="1"/></row><row rowsep="1"><entry colsep="1" rowsep="1"><para> <link linkend="secCodeHacks">code hacks</link> </para></entry><entry align="center" colsep="1" rowsep="1"><para>yes </para></entry><entry align="center" colsep="1" rowsep="1"><para>yes </para></entry><entry align="center" colsep="1" rowsep="1"><para>yes </para></entry><entry align="center" colsep="1" rowsep="1"><para>yes </para></entry></row></tbody></tgroup></informaltable><para>Each adaptation mechanism has its strength and weaknesses. The following table attempts to rank mechanisms using frequently used evaluation criteria. </para><informaltable><tgroup cols="2"><colspec colname="col_0"/><colspec colname="col_1"/><tbody><row rowsep="1"><entry colsep="1" rowsep="1"><para> <emphasis role="strong">Evaluation Criteria</emphasis> </para></entry><entry colsep="1" rowsep="1"><para> <emphasis role="strong">Mechanisms in rough order from &quot;best&quot; to &quot;worst&quot;</emphasis> </para></entry></row><row rowsep="1"><entry colsep="1" rowsep="1"><para> Squid independence </para></entry><entry colsep="1" rowsep="1"><para> <link linkend="secICAP">ICAP</link>, <link linkend="seceCAP">eCAP</link>, <link linkend="secACLs">ACLs</link>, <link linkend="secClientStreams">Client Streams</link>, <link linkend="secCodeHacks">code hacks</link> </para></entry></row><row rowsep="1"><entry colsep="1" rowsep="1"><para> Processing speed </para></entry><entry colsep="1" rowsep="1"><para> <link linkend="seceCAP">eCAP</link> or <link linkend="secClientStreams">Client Streams</link> or <link linkend="secACLs">ACLs</link> or <link linkend="secCodeHacks">code hacks</link>, <link linkend="secICAP">ICAP</link> </para></entry></row><row rowsep="1"><entry colsep="1" rowsep="1"><para> Development effort (header adaptation)</para></entry><entry colsep="1" rowsep="1"><para> <link linkend="secACLs">ACLs</link>, <link linkend="secCodeHacks">code hacks</link>, <link linkend="secClientStreams">Client Streams</link>, <link linkend="seceCAP">eCAP</link>, <link linkend="secICAP">ICAP</link> </para></entry></row><row rowsep="1"><entry colsep="1" rowsep="1"><para> Development effort (content adaptation)</para></entry><entry colsep="1" rowsep="1"><para> <link linkend="seceCAP">eCAP</link>, <link linkend="secICAP">ICAP</link>, <link linkend="secClientStreams">Client Streams</link>, <link linkend="secCodeHacks">code hacks</link> </para></entry></row><row rowsep="1"><entry colsep="1" rowsep="1"><para> Versatility </para></entry><entry colsep="1" rowsep="1"><para> <link linkend="secCodeHacks">code hacks</link>, <link linkend="seceCAP">eCAP</link>, <link linkend="secICAP">ICAP</link>, <link linkend="secClientStreams">Client Streams</link>, <link linkend="secACLs">ACLs</link> </para></entry></row><row rowsep="1"><entry colsep="1" rowsep="1"><para> Maintenance overheads </para></entry><entry colsep="1" rowsep="1"><para> <link linkend="secACLs">ACLs</link>, <link linkend="seceCAP">eCAP</link>, <link linkend="secICAP">ICAP</link>, <link linkend="secClientStreams">Client Streams</link>, <link linkend="secCodeHacks">code hacks</link> </para></entry></row></tbody></tgroup></informaltable></section></section><section><title>Additional resources</title><para>The following mailing list threads cover some content adaptation scenarios and options: <ulink url="http://thread.gmane.org/gmane.comp.web.squid.devel/4048/">4048</ulink>, <ulink url="http://thread.gmane.org/gmane.comp.web.squid.devel/4197/">4197</ulink>. </para></section><section><title>Warning</title><para>Certain forms of content adaptation are considered harmful by <ulink url="http://www.ietf.org/">IETF</ulink> (see, for example, RFC <ulink url="http://www.rfc-editor.org/rfc/rfc3238.txt">3238</ulink>). Many forms of content adaptation will annoy content owners, producers, consumers, or all of the above. Not everything that is technically possible is ethical, desirable, or legal. Think before you adapt others content! </para><!--rule (<hr>) is not applicable to DocBook--><para> <ulink url="https://wiki.squid-cache.org/SquidFaq/ContentAdaptation/CategoryKnowledgeBase#">CategoryKnowledgeBase</ulink> </para></section></article>