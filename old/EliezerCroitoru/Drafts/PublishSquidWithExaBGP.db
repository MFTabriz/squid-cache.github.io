<?xml version="1.0" encoding="utf-8"?><!DOCTYPE article  PUBLIC '-//OASIS//DTD DocBook XML V4.4//EN'  'http://www.docbook.org/xml/4.4/docbookx.dtd'><article><articleinfo><title>EliezerCroitoru/Drafts/PublishSquidWithExaBGP</title><revhistory><revision><revnumber>2</revnumber><date>2019-06-26 17:26:15</date><authorinitials>Eliezer Croitoru</authorinitials><revremark>Added withdraw which is by default in down state</revremark></revision><revision><revnumber>1</revnumber><date>2019-06-26 03:06:11</date><authorinitials>Eliezer Croitoru</authorinitials></revision></revhistory></articleinfo><section><title>Publishing Squid instance with ExaBGP</title><itemizedlist><listitem><para><emphasis role="strong">Goal</emphasis>: Advertise a single Squid proxy instance to a router using ExaBGP with a monitoring script. </para></listitem><listitem><para><emphasis role="strong">Status</emphasis>: 0% </para></listitem><listitem><para><emphasis role="strong">State</emphasis>: DRAFT </para></listitem><listitem><para><emphasis role="strong">Writer</emphasis>: <ulink url="https://wiki.squid-cache.org/EliezerCroitoru/Drafts/PublishSquidWithExaBGP/EliezerCroitoru#">Eliezer Croitoru</ulink> </para></listitem><listitem><para><emphasis role="strong">More</emphasis>:  </para></listitem></itemizedlist><section><title>What's the story?</title><para>Most industrial routers support basic BGP options and functions. These by nature allowing the admin to utilize BGP health and status to decide on routing policy. The network admin can run multiple RIF/FIB and apply specific policy on specific clients such as route redirection or marking. </para></section><section><title>LB</title></section><section><title>AnyCast</title></section><section><title>ExaBGP links</title><itemizedlist><listitem><para><ulink url="https://gist.github.com/elico/db3d2e4c63989f0326db60c15dc92206"/> </para></listitem><listitem><para><ulink url="https://www.aangelis.gr/blog/2016/03/dns-high-availability-using-exabgp"/> </para></listitem><listitem><para><ulink url="https://karld.blog/2015/01/18/anycasting-dns/"/> </para></listitem><listitem><para><ulink url="https://github.com/criteo-cookbooks/chef-exabgp"/> </para></listitem><listitem><para><ulink url="https://engineering.linkedin.com/blog/2016/04/the-joy-of-anycast--in-side-the-datacenter"/> </para></listitem></itemizedlist></section><section><title>Code</title><para>exabgp.conf (v4.1 compatible) </para><screen><![CDATA[process watch-application {
        run ruby /etc/exabgp/check-squid.sh;
        encoder text;
}
]]><![CDATA[
neighbor 10.0.55.254 {
        description "will announce a route to a service";
]]><![CDATA[
        router-id 10.0.55.1;
]]><![CDATA[
        local-address 10.0.55.1;
]]><![CDATA[
        local-as 65511;
        peer-as 65511;
        md5-password test_password;
        hold-time 60;
]]><![CDATA[
        family {
                ipv4 unicast;
        }
    
        api services {
                processes [ watch-application ];
        }
    
        static {
                route 10.1.55.1/32 {
                        next-hop self;
                        watchdog squid;
                        local-preference 100;
                        med 100;
                        withdraw;
                }
                route 10.1.55.2/32 {
                        next-hop self;
                        watchdog squid;
                        local-preference 400;
                        med 400;
                        withdraw;
                }
        }
}]]></screen><programlisting format="linespecific" language="highlight" linenumbering="numbered" startinglinenumber="1"><lineannotation><![CDATA[#!/usr/bin/env bash]]></lineannotation>
<lineannotation></lineannotation>
<methodname><![CDATA[STATE]]></methodname><![CDATA[=]]><phrase><![CDATA["down"]]></phrase>

<token><![CDATA[while]]></token><![CDATA[ true; ]]><token><![CDATA[do]]></token>
<![CDATA[  ls /etc/exabgp/squid-up  >/dev/null 2>&1]]>
<![CDATA[  ]]><methodname><![CDATA[RES]]></methodname><![CDATA[=]]><methodname><![CDATA[$?]]></methodname>
<![CDATA[  ]]><token><![CDATA[if]]></token><![CDATA[ [[ ]]><phrase><![CDATA["]]></phrase><phrase><![CDATA[${]]></phrase><methodname><![CDATA[RES]]></methodname><phrase><![CDATA[}]]></phrase><phrase><![CDATA["]]></phrase><![CDATA[ -eq ]]><phrase><![CDATA["0"]]></phrase><![CDATA[ ]]; ]]><token><![CDATA[then]]></token>
<![CDATA[    ]]><token><![CDATA[if]]></token><![CDATA[ [[ ]]><phrase><![CDATA["]]></phrase><phrase><![CDATA[${]]></phrase><methodname><![CDATA[STATE]]></methodname><phrase><![CDATA[}]]></phrase><phrase><![CDATA["]]></phrase><![CDATA[ != ]]><phrase><![CDATA["up"]]></phrase><![CDATA[ ]]; ]]><token><![CDATA[then]]></token>
<![CDATA[      ]]><token><![CDATA[echo]]></token><![CDATA[ ]]><phrase><![CDATA["announce watchdog squid"]]></phrase>
<![CDATA[      ]]><methodname><![CDATA[STATE]]></methodname><![CDATA[=]]><phrase><![CDATA["up"]]></phrase>
<![CDATA[    ]]><token><![CDATA[fi]]></token>
<![CDATA[  ]]><token><![CDATA[else]]></token>
<![CDATA[    ]]><token><![CDATA[if]]></token><![CDATA[ [[ ]]><phrase><![CDATA["]]></phrase><phrase><![CDATA[${]]></phrase><methodname><![CDATA[STATE]]></methodname><phrase><![CDATA[}]]></phrase><phrase><![CDATA["]]></phrase><![CDATA[ != ]]><phrase><![CDATA["down"]]></phrase><![CDATA[ ]]; ]]><token><![CDATA[then]]></token>
<![CDATA[      ]]><token><![CDATA[echo]]></token><![CDATA[ ]]><phrase><![CDATA["withdraw watchdog squid"]]></phrase>
<![CDATA[      ]]><methodname><![CDATA[STATE]]></methodname><![CDATA[=]]><phrase><![CDATA["down"]]></phrase>
<![CDATA[    ]]><token><![CDATA[fi]]></token>
<![CDATA[  ]]><token><![CDATA[fi]]></token>
<![CDATA[  sleep 2]]>
<token><![CDATA[done]]></token>
</programlisting></section></section></article>