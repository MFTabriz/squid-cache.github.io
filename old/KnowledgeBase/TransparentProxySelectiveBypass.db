<?xml version="1.0" encoding="utf-8"?><!DOCTYPE article  PUBLIC '-//OASIS//DTD DocBook XML V4.4//EN'  'http://www.docbook.org/xml/4.4/docbookx.dtd'><article><articleinfo><title>KnowledgeBase/TransparentProxySelectiveBypass</title><revhistory><revision><revnumber>5</revnumber><date>2011-05-12 13:04:35</date><authorinitials>AmosJeffries</authorinitials><revremark>layout, spelling, wiki links fixes</revremark></revision><revision><revnumber>4</revnumber><date>2011-05-12 12:58:38</date><authorinitials>AmosJeffries</authorinitials><revremark>actual FAQ link :(</revremark></revision><revision><revnumber>3</revnumber><date>2011-05-12 12:57:20</date><authorinitials>AmosJeffries</authorinitials><revremark>wiki link</revremark></revision><revision><revnumber>2</revnumber><date>2011-05-12 12:56:39</date><authorinitials>AmosJeffries</authorinitials><revremark>link to FAQ</revremark></revision><revision><revnumber>1</revnumber><date>2008-11-25 17:32:40</date><authorinitials>FrancescoChemolli</authorinitials></revision></revhistory></articleinfo><section><title>Transparent Proxy Selective Bypass</title><para><emphasis role="strong">Synopsis</emphasis> </para><para>Is it possible to selectively bypass a Transparent Interception Proxy squid? If so, how? </para><para><emphasis role="strong">Explanation</emphasis> </para><para>Yes, it is possible to bypass a Squid running as an interception proxy. Except for the fact that it's not up to squid to do it, but it's a task for the underlying interception technology. </para><para>Once Squid gets engaged to serve a request, it can't declare itself out of the game, but has to either service it or fail it. </para><para>This requirement also determines what kind of filtering is possible; generally speaking this restricts to only using network-level checks: typically destination IP address and TCP port. </para><para><emphasis role="strong">Example</emphasis> </para><para>When running on a Linux host, interception will typically be handled, via an <code>iptables</code> <code>REDIRECT</code> or <code>DNAT</code> rule, as detailed in <ulink url="https://wiki.squid-cache.org/KnowledgeBase/TransparentProxySelectiveBypass/ConfigExamples/Intercept/LinuxRedirect#">ConfigExamples/Intercept/LinuxRedirect</ulink> or <ulink url="https://wiki.squid-cache.org/KnowledgeBase/TransparentProxySelectiveBypass/ConfigExamples/Intercept/LinuxDnat#">ConfigExamples/Intercept/LinuxDnat</ulink>. </para><para>To add an exception allowing direct access to www.example.com, the iptables configuration example in that page should be changed like this: </para><screen><![CDATA[iptables -t nat -N BYPASS
iptables -t nat -A PREROUTING -s SQUIDIP -p tcp --dport 80 -j ACCEPT
iptables -t nat -A PREROUTING -p tcp --dport 80 -j BYPASS
iptables -t nat -A PREROUTING -p tcp --dport 80 -j REDIRECT --to-port 3129
iptables -t nat -A POSTROUTING -j MASQUERADE
]]><![CDATA[
iptables -t nat -A BYPASS -d www.example.com -j ACCEPT]]></screen><para>The <emphasis role="strong">BYPASS</emphasis> chain is the one performing the transparent interception bypass. You can grow it as much as you wish appending one line like the example for every destination host (or network) you wish NOT to intercept. </para><para>For details on setting iptables up and the meaning of the various flags and options, please see the iptables documentation. </para><para><emphasis role="strong">Problems with the solution</emphasis> </para><para>As a side effect, all sites served from the same IP address as www.example.com, will be directly accessible as well. At this time, this is an unavoidable side-effect using general-purpose technologies; workarounds such as the one shown at <ulink url="http://www.linuxquestions.org/questions/linux-networking-3/url-blocking-via-iptables-655678/">LinuxQuestions</ulink> are not reliable and should not be deployed. </para><!--rule (<hr>) is not applicable to DocBook--><itemizedlist><listitem override="none"><para><ulink url="https://wiki.squid-cache.org/KnowledgeBase/TransparentProxySelectiveBypass/CategoryKnowledgeBase#">CategoryKnowledgeBase</ulink> <ulink url="https://wiki.squid-cache.org/KnowledgeBase/TransparentProxySelectiveBypass/SquidFaq/TroubleShooting#">SquidFaq/TroubleShooting</ulink> </para></listitem></itemizedlist></section></article>