<?xml version="1.0" encoding="utf-8"?><!DOCTYPE article  PUBLIC '-//OASIS//DTD DocBook XML V4.4//EN'  'http://www.docbook.org/xml/4.4/docbookx.dtd'><article><articleinfo><title>ConfigExamples/Intercept/SolarisOpenIndianaIPF</title><revhistory><revision><revnumber>9</revnumber><date>2018-02-11 08:04:18</date><authorinitials>AmosJeffries</authorinitials><revremark>add generic NAT disclaimer</revremark></revision><revision><revnumber>8</revnumber><date>2016-04-25 21:42:31</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>7</revnumber><date>2016-02-16 20:48:48</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>6</revnumber><date>2016-02-16 20:46:52</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>5</revnumber><date>2015-01-11 13:46:16</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>4</revnumber><date>2015-01-10 12:54:29</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>3</revnumber><date>2015-01-10 12:53:43</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>2</revnumber><date>2015-01-10 12:52:36</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>1</revnumber><date>2015-01-10 12:34:04</date><authorinitials>YuriVoinov</authorinitials></revision></revhistory></articleinfo><section><title>Intercepting traffic with IPFilter on Solaris/OpenIndiana</title><itemizedlist><listitem override="none"><para><emphasis>by <ulink url="https://wiki.squid-cache.org/ConfigExamples/Intercept/SolarisOpenIndianaIPF/YuriVoinov#">YuriVoinov</ulink></emphasis> </para></listitem></itemizedlist><para><emphasis role="strong">Warning</emphasis>: Any example presented here is provided &quot;as-is&quot; with no support or guarantee of suitability. If you have any further questions about these examples please email the squid-users mailing list. </para><section><title>Outline</title><para><emphasis role="strong">NOTE:</emphasis> NAT configuration will only work when used <emphasis role="strong">on the squid box</emphasis>. This is required to perform intercept accurately and securely. To intercept from a gateway machine and direct traffic at a separate squid box use <ulink url="https://wiki.squid-cache.org/ConfigExamples/Intercept/SolarisOpenIndianaIPF/ConfigExamples/Intercept/IptablesPolicyRoute#">policy routing</ulink>. </para><para>We need to intercept incoming HTTP/HTTPS traffic on Solaris/OpenIndiana box with Squid proxy. In this example server has two aggregated 1 Gbit interfaces, bge0+bge1: </para><screen><![CDATA[# ifconfig bge0 down
# ifconfig bge0 unplumb
]]><![CDATA[
# dladm create-aggr -d bge0 -d bge1 1
# ifconfig aggr1 plumb
# ifconfig aggr1 192.168.200.3/24 up
# mv /etc/hostname.bge0 /etc/hostname.aggr1]]></screen><para><emphasis role="strong">Note:</emphasis> Using LACP for aggregated links required adequate configuration managed switch on other side, if used. </para></section><section><title>Usage</title><para>This configuration useful with transparent interception proxy in DMZ, with zero client configuration. </para><para><emphasis role="strong">Note:</emphasis> We can intercept only IPv4 traffic. </para></section><section><title>Configure Squid</title><para>Squid must be configured with ipf-transparent option: </para><screen><![CDATA[./configure '--enable-ipf-transparent']]></screen><para><emphasis role="strong">Note:</emphasis> You don't need any authentification options, because of no auth in transparent interception mode. Also, be sure your Squid is <emphasis role="strong">really</emphasis> built with Intercept module (see bug <ulink url="https://bugs.squid-cache.org/show_bug.cgi?id=3754#">3754</ulink>).  </para></section><section><title>Configure IPFilter</title><para>You need to edit /etc/ipt/ipnat.conf as follows: </para><screen><![CDATA[rdr aggr1 0.0.0.0/0 port 80 -> 0/32 port 3126
rdr aggr1 0.0.0.0/0 port 443 -> 0/32 port 3127]]></screen><para>In case of proxy placed in DMZ, will be good to configure IPFilter as closed firewall by edit /etc/ipt/ipf.conf as follows: </para><screen><![CDATA[# Transparent proxy host
#
# Host proxyhost with one interface:
# aggr1 - aggregated (bge0+bge1)
#
]]><![CDATA[
# Group 100 - Blocked networks & packets on any interface
# Group 100 setup
block in all head 100
# Group 200 - Opened incoming ports & services on aggr1
# Group 200 setup
pass in on aggr1 head 200
]]><![CDATA[
# ---------------------
# Common blocking rules
# ---------------------
# Block all IP fragments
block in quick all with frag group 100
]]><![CDATA[
# Block all short IP fragments
block in quick proto tcp all with short group 100
]]><![CDATA[
# Block any IP packets with options set in them 
block in quick all with ipopts group 100
]]><![CDATA[
# Make sure the loopback allows packets to traverse it
# ---------------------- lo0 interface --------------------------
pass in quick on lo0 all
pass out quick on lo0 all
# ---------------------- lo0 interface --------------------------
]]><![CDATA[
# Allow ICMP Echo on aggr1 from internal networks
pass in quick on aggr1 proto icmp from 192.168.0.0/16 to proxyhost icmp-type echo group 200
# Permit DNS access to Unbound
pass in quick proto tcp/udp from 192.168.0.0/16 to proxyhost port=53 keep state keep frag group 200
# Allow incoming NTP requests to NTP-server. Restrict access from LAN only
pass in quick on aggr1 proto udp from 192.168.0.0/16 to proxyhost port=ntp keep state group 200
# Permit access to SSH
pass in quick proto tcp from any to proxyhost port=2222 flags S keep state keep frag group 200
# Restrict access to proxy by WCCP from DMZ only
pass in quick on aggr1 proto udp from 192.168.200.0/24 to proxyhost port=2048 keep state keep frags group 200
# Restrict access to proxy only from localnet (interception)
pass in quick proto tcp from 192.168.0.0/16 to proxyhost port=3126 flags S keep state keep frag group 200
# Restrict access to proxy only from localnet (HTTPS interception)
pass in quick proto tcp from 192.168.0.0/16 to proxyhost port=3127 flags S keep state keep frag group 200
# Restrict access to proxy only from localnet (forwarding)
pass in quick proto tcp from 192.168.0.0/16 to proxyhost port=3128 flags S keep state keep frag group 200
# Restrict access to ICP only from localnet
pass in quick proto tcp from 192.168.0.0/16 to proxyhost port=3130 flags S keep state keep frag group 200
# Restrict access to HTCP only from localnet
pass in quick proto tcp from 192.168.0.0/16 to proxyhost port=4827 flags S keep state keep frag group 200
# Restrict access to proxy Web server
pass in quick proto tcp from 192.168.0.0/16 to proxyhost port=8080 flags S keep state keep frag group 200
# Restrict access to proxy Web server
pass in quick proto tcp from 192.168.0.0/16 to proxyhost port=8088 flags S keep state keep frag group 200
# Restrict access to proxy Web server
pass in quick proto tcp from 192.168.0.0/16 to proxyhost port=8888 flags S keep state keep frag group 200
]]><![CDATA[
# Allow packets originating from local machine out
pass out quick proto tcp/udp from any to any keep state keep frags
pass out quick proto icmp from any to any keep state
]]><![CDATA[
# Finally block any unmatched
block in on aggr1 all]]></screen></section><section><title>Squid 3.x Configuration File</title><para>Paste the configuration file like this: </para><screen><![CDATA[http_port 3126 intercept
]]><![CDATA[
https_port 3127 intercept ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/usr/local/squid/etc/rootCA.crt key=/usr/local/squid/etc/rootCA.key capath=/etc/opt/csw/ssl/certs
]]><![CDATA[
http_port 3128]]></screen></section><section><title>Finally you need to enable/restart IPFilter and Squid proxy</title><screen><![CDATA[# svcadm enable ipfilter
# svcadm restart squid]]></screen><para>That's all, folks. <inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/smile4.png" width="15"/></imageobject><textobject><phrase>;)</phrase></textobject></inlinemediaobject> </para><!--rule (<hr>) is not applicable to DocBook--><para> <ulink url="https://wiki.squid-cache.org/ConfigExamples/Intercept/SolarisOpenIndianaIPF/CategoryConfigExample#">CategoryConfigExample</ulink> </para></section></section></article>