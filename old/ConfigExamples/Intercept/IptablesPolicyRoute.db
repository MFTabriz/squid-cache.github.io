<?xml version="1.0" encoding="utf-8"?><!DOCTYPE article  PUBLIC '-//OASIS//DTD DocBook XML V4.4//EN'  'http://www.docbook.org/xml/4.4/docbookx.dtd'><article><articleinfo><title>ConfigExamples/Intercept/IptablesPolicyRoute</title><revhistory><revision><revnumber>17</revnumber><date>2015-05-08 06:22:38</date><authorinitials>AmosJeffries</authorinitials></revision><revision><revnumber>16</revnumber><date>2013-10-31 06:18:30</date><authorinitials>AmosJeffries</authorinitials><revremark>switch terminology from cache to proxy to avoid confusion with non-caching proxies.</revremark></revision><revision><revnumber>15</revnumber><date>2013-10-24 05:56:24</date><authorinitials>AmosJeffries</authorinitials><revremark>update config details to a more cut-n-paste friendly scriptlet</revremark></revision><revision><revnumber>14</revnumber><date>2013-10-24 05:29:08</date><authorinitials>AmosJeffries</authorinitials><revremark>update description</revremark></revision><revision><revnumber>13</revnumber><date>2012-01-20 00:44:10</date><authorinitials>AmosJeffries</authorinitials><revremark>verified now</revremark></revision><revision><revnumber>12</revnumber><date>2009-07-20 11:22:50</date><authorinitials>AmosJeffries</authorinitials><revremark>note differences betwen Internal and DMZ configs. note other bits as well.</revremark></revision><revision><revnumber>11</revnumber><date>2009-06-01 13:42:17</date><authorinitials>AmosJeffries</authorinitials><revremark>loopback gotcha</revremark></revision><revision><revnumber>10</revnumber><date>2009-06-01 13:35:50</date><authorinitials>AmosJeffries</authorinitials><revremark>typo</revremark></revision><revision><revnumber>9</revnumber><date>2009-06-01 13:34:58</date><authorinitials>AmosJeffries</authorinitials><revremark>updates after testing.</revremark></revision><revision><revnumber>8</revnumber><date>2009-05-30 03:29:48</date><authorinitials>AmosJeffries</authorinitials><revremark>better link for additional config info</revremark></revision><revision><revnumber>7</revnumber><date>2009-04-03 07:17:06</date><authorinitials>AmosJeffries</authorinitials><revremark>drop template comment</revremark></revision><revision><revnumber>6</revnumber><date>2008-09-01 03:58:19</date><authorinitials>AmosJeffries</authorinitials><revremark>re-link wiki</revremark></revision><revision><revnumber>5</revnumber><date>2008-09-01 03:56:38</date><authorinitials>AmosJeffries</authorinitials><revremark>building Intercept section</revremark></revision><revision><revnumber>4</revnumber><date>2008-05-18 19:38:58</date><authorinitials>localhost</authorinitials><revremark>converted to 1.6 markup</revremark></revision><revision><revnumber>3</revnumber><date>2008-04-03 11:08:46</date><authorinitials>AmosJeffries</authorinitials><revremark>Link pages for extra config needed to handle the results of this config</revremark></revision><revision><revnumber>2</revnumber><date>2007-09-11 08:40:12</date><authorinitials>AdrianChadd</authorinitials></revision><revision><revnumber>1</revnumber><date>2007-09-11 08:38:08</date><authorinitials>AdrianChadd</authorinitials></revision></revhistory></articleinfo><section><title>Policy Routing Web Traffic On A Linux Router</title><para><emphasis role="strong">Warning</emphasis>: Any example presented here is provided &quot;as-is&quot; with no support or guarantee of suitability. If you have any further questions about these examples please email the squid-users mailing list. </para><section><title>Outline</title><para>This example outlines how to configure a Linux router to policy route traffic (web in this instance) towards a Squid proxy.  </para></section><section><title>Usage</title><para>Various networks are using embedded Linux devices (such as OpenWRT) as gateways and wish to implement transparent caching or proxying. </para><para>There's no obvious policy routing in Linux - you use iptables to mark interesting traffic, iproute2 ip rules to choose an alternate routing table and a default route in the alternate routing table to policy route to the distribution. </para><para>Please realize that this just gets the packets to the proxy; you have to then configure <ulink url="https://wiki.squid-cache.org/ConfigExamples/Intercept/IptablesPolicyRoute/SquidFaq/InterceptionProxy#">interception</ulink> on the proxy itself to redirect traffic to the Squid TCP port! </para><section><title>iptables Setup</title><section><title>When Squid is Internal amongst clients</title><screen><![CDATA[# IPv4 address of proxy
PROXYIP4= 192.168.0.10
]]><![CDATA[
# IPv6 address of proxy
PROXYIP6= fe80:dead:beef::10
]]><![CDATA[
# interface facing clients
CLIENTIFACE= eth0
]]><![CDATA[
# arbitrary mark used to route packets by the firewall. May be anything from 1 to 64.
FWMARK= 2
]]><![CDATA[
]]><![CDATA[
# permit Squid box out to the Internet
iptables -t mangle -A PREROUTING -p tcp --dport 80 -s $PROXYIP4 -j ACCEPT
ip6tables -t mangle -A PREROUTING -p tcp --dport 80 -s $PROXYIP6 -j ACCEPT
]]><![CDATA[
# mark everything else on port 80 to be routed to the Squid box
iptables -t mangle -A PREROUTING -i $CLIENTIFACE -p tcp --dport 80 -j MARK --set-mark $FWMARK
iptables -t mangle -A PREROUTING -m mark --mark $FWMARK -j ACCEPT
ip6tables -t mangle -A PREROUTING -i $CLIENTIFACE -p tcp --dport 80 -j MARK --set-mark $FWMARK
ip6tables -t mangle -A PREROUTING -m mark --mark $FWMARK -j ACCEPT
]]><![CDATA[
# NP: Ensure that traffic from inside the network is allowed to loop back inside again.
iptables -t filter -A FORWARD -i $CLIENTIFACE -o $CLIENTIFACE -p tcp --dport 80 -j ACCEPT
ip6tables -t filter -A FORWARD -i $CLIENTIFACE -o $CLIENTIFACE -p tcp --dport 80 -j ACCEPT]]></screen></section><section><title>When Squid is in a DMZ between the router and Internet</title><para>NOTE: this special configuration is only necessary if the Squid box is not the normal gateway for the router. If you make the Squid box the default gateway and pass all traffic through it out of the router then these rules are not necessary. But Squid and the kernel will then be competing for CPU cycles to process their portions of the traffic which slows both down somewhat. </para><screen><![CDATA[# interface facing clients
CLIENTIFACE= eth0
]]><![CDATA[
# arbitrary mark used to route packets by the firewall. May be anything from 1 to 64.
FWMARK= 2
]]><![CDATA[
]]><![CDATA[
# mark everything on port 80 to be routed to the Squid box
iptables -t mangle -A PREROUTING -i $CLIENTIFACE -p tcp --dport 80 -j MARK --set-mark $FWMARK
iptables -t mangle -A PREROUTING -m mark --mark $FWMARK -j ACCEPT
ip6tables -t mangle -A PREROUTING -i $CLIENTIFACE -p tcp --dport 80 -j MARK --set-mark $FWMARK
ip6tables -t mangle -A PREROUTING -m mark --mark $FWMARK -j ACCEPT]]></screen><itemizedlist><listitem override="none"><para>NP: don't forget to set a route on the Squid box so traffic for the internal clients can get back to them. </para></listitem></itemizedlist></section></section><section><title>Routing Setup</title><para>Needs to be run as root. </para><screen><![CDATA[cat /etc/iproute2/rt_tables]]></screen><para>Pick a number which does <emphasis role="strong">NOT</emphasis> exist there yet. We choose <emphasis>201</emphasis> for this demo. You need to pick your own. </para><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/alert.png" width="15"/></imageobject><textobject><phrase>/!\</phrase></textobject></inlinemediaobject> &quot;201&quot; is just a unique routing table number. Check the file contents first! </para></listitem></itemizedlist><para>Create a routing table for our intercepted proxy traffic </para><screen><![CDATA[echo "201   proxy" >> /etc/iproute2/rt_tables]]></screen><para>Configure what traffic gets handled by that table (stuff marked 2 earlier by iptables), and create a default route for it to the squid box at <emphasis role="strong">$PROXYIP</emphasis>. </para><screen><![CDATA[ip rule add fwmark 2 table proxy
ip route add default via $PROXYIP table proxy]]></screen></section><section><title>Squid configuration</title><para>Squid is a separate box right?  See the <emphasis role="strong">capture into Squid</emphasis> section of <ulink url="https://wiki.squid-cache.org/ConfigExamples/Intercept/IptablesPolicyRoute/ConfigExamples/Intercept#">ConfigExamples/Intercept</ulink> for details on configuring it. </para><!--rule (<hr>) is not applicable to DocBook--><para> <ulink url="https://wiki.squid-cache.org/ConfigExamples/Intercept/IptablesPolicyRoute/CategoryConfigExample#">CategoryConfigExample</ulink> </para></section></section></section></article>