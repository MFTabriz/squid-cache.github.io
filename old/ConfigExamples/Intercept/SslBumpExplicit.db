<?xml version="1.0" encoding="utf-8"?><!DOCTYPE article  PUBLIC '-//OASIS//DTD DocBook XML V4.4//EN'  'http://www.docbook.org/xml/4.4/docbookx.dtd'><article><articleinfo><title>ConfigExamples/Intercept/SslBumpExplicit</title><revhistory><revision><revnumber>55</revnumber><date>2019-05-10 00:44:52</date><authorinitials>AmosJeffries</authorinitials><revremark>fix some typos</revremark></revision><revision><revnumber>54</revnumber><date>2018-06-29 06:04:36</date><authorinitials>AmosJeffries</authorinitials><revremark>fix some broken wiki links</revremark></revision><revision><revnumber>53</revnumber><date>2018-06-29 05:50:00</date><authorinitials>AmosJeffries</authorinitials><revremark>add missing -M parameter mentions for security_file_certgen</revremark></revision><revision><revnumber>52</revnumber><date>2017-01-21 21:16:04</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>51</revnumber><date>2017-01-21 21:12:56</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>50</revnumber><date>2017-01-21 21:11:20</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>49</revnumber><date>2017-01-21 21:08:07</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>48</revnumber><date>2017-01-21 21:07:00</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>47</revnumber><date>2016-12-29 15:09:22</date><authorinitials>AmosJeffries</authorinitials></revision><revision><revnumber>46</revnumber><date>2016-04-25 19:10:22</date><authorinitials>AmosJeffries</authorinitials><revremark>move advanced to Intercept/SslBumpWithIntermediateCA and added reference to Jok Thuau who actually designed it.</revremark></revision><revision><revnumber>45</revnumber><date>2016-04-25 18:26:21</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>44</revnumber><date>2016-04-25 18:25:03</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>43</revnumber><date>2016-04-25 14:07:39</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>42</revnumber><date>2016-04-25 13:07:00</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>41</revnumber><date>2016-04-25 13:05:27</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>40</revnumber><date>2016-04-12 19:39:28</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>39</revnumber><date>2016-04-12 19:36:14</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>38</revnumber><date>2016-03-28 23:59:26</date><authorinitials>AmosJeffries</authorinitials></revision><revision><revnumber>37</revnumber><date>2016-03-25 19:06:24</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>36</revnumber><date>2016-03-25 18:58:39</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>35</revnumber><date>2016-03-25 18:58:22</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>34</revnumber><date>2016-03-25 18:57:36</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>33</revnumber><date>2016-02-16 19:56:15</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>32</revnumber><date>2016-02-16 19:52:01</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>31</revnumber><date>2016-02-16 19:44:32</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>30</revnumber><date>2015-10-27 13:59:52</date><authorinitials>AmosJeffries</authorinitials><revremark>update grammar and add some Squid-4 updates</revremark></revision><revision><revnumber>29</revnumber><date>2015-09-16 07:39:43</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>28</revnumber><date>2015-09-05 13:07:29</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>27</revnumber><date>2015-09-01 11:45:16</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>26</revnumber><date>2015-09-01 11:42:51</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>25</revnumber><date>2015-09-01 11:24:42</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>24</revnumber><date>2015-08-30 18:42:33</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>23</revnumber><date>2015-08-30 18:39:24</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>22</revnumber><date>2015-08-30 18:35:40</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>21</revnumber><date>2015-08-30 18:14:05</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>20</revnumber><date>2015-08-30 18:09:04</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>19</revnumber><date>2015-08-30 18:01:12</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>18</revnumber><date>2015-02-08 12:21:14</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>17</revnumber><date>2015-02-08 12:18:56</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>16</revnumber><date>2015-02-08 02:58:48</date><authorinitials>AmosJeffries</authorinitials><revremark>moved the SHA256 2048-bit changes to the imported reference page. dropping the 10-years permission grant for admin authority rights over client browsers.</revremark></revision><revision><revnumber>15</revnumber><date>2015-02-07 23:26:48</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>14</revnumber><date>2015-02-07 23:26:18</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>13</revnumber><date>2015-02-07 23:22:56</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>12</revnumber><date>2015-02-07 23:22:30</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>11</revnumber><date>2015-02-07 23:19:53</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>10</revnumber><date>2015-02-07 23:11:53</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>9</revnumber><date>2015-02-07 22:56:59</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>8</revnumber><date>2015-02-07 22:48:14</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>7</revnumber><date>2015-02-07 22:47:20</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>6</revnumber><date>2015-02-07 22:45:19</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>5</revnumber><date>2015-02-07 22:44:37</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>4</revnumber><date>2015-02-07 22:37:24</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>3</revnumber><date>2015-02-07 22:35:09</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>2</revnumber><date>2015-02-07 22:33:45</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>1</revnumber><date>2015-01-30 23:53:17</date><authorinitials>AmosJeffries</authorinitials></revision></revhistory></articleinfo><section><title>Intercept HTTPS CONNECT messages with SSL-Bump</title><para><emphasis role="strong">Warning</emphasis>: Any example presented here is provided &quot;as-is&quot; with no support or guarantee of suitability. If you have any further questions about these examples please email the squid-users mailing list. </para><para>HTTPS interception has ethical and legal issues which you need to be aware of. </para><itemizedlist><listitem><para>some countries do not limit what can be done within the home environment, </para></listitem><listitem><para>some countries permit employment or contract law to overrule privacy, </para></listitem><listitem><para>some countries require government registration for all decryption services, </para></listitem><listitem><para>some countries it is an outright capital offence with severe penalties </para></listitem><listitem override="none"><para>DO Seek legal advice before using this configuration, even at home. </para></listitem></itemizedlist><para>On the ethical side; consider some unknown other person reading all your private communications. What would you be happy with them doing? Be considerate of others. </para><section><title>Outline</title><para>This configuration is written for <ulink url="https://wiki.squid-cache.org/ConfigExamples/Intercept/SslBumpExplicit/Squid-3.5#">Squid-3.5</ulink>. It will definitely not work on older Squid releases even though they have a form of the SSL-Bump feature, and may not work on newer versions if there have been any significant improvements to the TLS protocol environment. </para><para>TLS is a security protocol explicitly intended to make secure communication possible and prevent undetected third-party (such as Squid) interception of the traffic. </para><itemizedlist><listitem override="none"><para><emphasis role="strong"> when used properly TLS cannot be &quot;bumped&quot;. </emphasis> </para></listitem></itemizedlist><para>Even incorrectly used TLS usually makes it possible for at least one end of the communication channel to detect the proxies existence. Squid SSL-Bump is intentionally implemented in a way that allows that detection without breaking the TLS. Your clients <emphasis role="strong">will</emphasis> be capable of identifying the proxy exists. If you are looking for a way to do it in complete secrecy, dont use Squid. </para></section><section><title>Usage</title><para>In a home or corporate environment client devices may be <ulink url="https://wiki.squid-cache.org/ConfigExamples/Intercept/SslBumpExplicit/SquidFaq/ConfiguringBrowsers#">configured</ulink> to use a proxy and HTTPS messages are sent over a proxy using CONNECT messages. </para><para>To intercept this HTTPS traffic Squid needs to be provided both public and private keys to a self-signed CA certificate. It uses these to generate server certificates for the HTTPS domains clients visit. </para><para>The client devices also need to be configured to trust the CA certificate when validating the Squid generated certificates. </para><section><title>Create Self-Signed Root CA Certificate</title><para>This certificate will be used by Squid to generate dynamic certificates for proxied sites. For all practical purposes, this certificate becomes a <ulink url="http://en.wikipedia.org/wiki/Root_certificate">Root certificate</ulink> and you become a Root CA. </para><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-error.png" width="16"/></imageobject><textobject><phrase>{X}</phrase></textobject></inlinemediaobject> If your certificate is compromised, any user trusting (knowingly or otherwise) your Root certificate may not be able to detect man-in-the-middle attacks orchestrated by others. </para></listitem></itemizedlist><para>Create directory to store the certificate (the exact location is not important): </para><itemizedlist><listitem override="none"><screen><![CDATA[cd /etc/squid
mkdir ssl_cert
chown squid:squid ssl_cert
chmod 700 ssl_cert
cd ssl_cert]]></screen></listitem></itemizedlist><para>Create self-signed certificate (you will be asked to provide information that will be incorporated into your certificate): </para><itemizedlist><listitem><para>using OpenSSL: </para></listitem><listitem override="none"><screen><![CDATA[openssl req -new -newkey rsa:2048 -sha256 -days 365 -nodes -x509 -extensions v3_ca -keyout myCA.pem  -out myCA.pem]]></screen></listitem><listitem><para>using GnuTLS certtool: </para></listitem><listitem override="none"><screen><![CDATA[certtool --generate-privkey --outfile ca-key.pem
]]><![CDATA[
certtool --generate-self-signed --load-privkey ca-key.pem --outfile myCA.pem]]></screen></listitem></itemizedlist><para>You can also specify some required additional CA's attributes in openssl.cfg to reduce the questions: </para><screen><![CDATA[[ v3_req ]
basicConstraints = CA:FALSE
keyUsage = nonRepudiation, digitalSignature, keyEncipherment
[ v3_ca ]
keyUsage = cRLSign, keyCertSign]]></screen></section><section><title>Create a DER-encoded certificate to import into users' browsers</title><itemizedlist><listitem override="none"><screen><![CDATA[openssl x509 -in myCA.pem -outform DER -out myCA.der]]></screen></listitem></itemizedlist><para>The result file (<emphasis role="strong">myCA.der</emphasis>) should be imported into the 'Authorities' section of users' browsers. </para><para>For example, in FireFox: </para><orderedlist numeration="arabic"><listitem><para>Open 'Preferences' </para></listitem><listitem><para>Go to the 'Advanced' section, 'Encryption' tab </para></listitem><listitem><para>Press the 'View Certificates' button and go to the 'Authorities' tab </para></listitem><listitem><para>Press the 'Import' button, select the .der file that was created previously and pres 'OK' </para></listitem></orderedlist><para>In theory, you must either import your root certificate into browsers or instruct users on how to do that. Unfortunately, it is apparently a <ulink url="https://www.computerworld.com/s/article/9224082/Trustwave_admits_issuing_man_in_the_middle_digital_certificate_Mozilla_debates_punishment">common practice</ulink> among well-known Root CAs to issue <emphasis>subordinate</emphasis> root certificates. If you have obtained such a subordinate root certificate from a Root CA already trusted by your users, you do not need to import your certificate into browsers. However, going down this path may result in <ulink url="https://bugzilla.mozilla.org/show_bug.cgi?id=724929">removal of the well-known Root CA certificate</ulink> from browsers around the world. Such a removal will make your local SslBump-based infrastructure inoperable until you import your certificate, but that may only be the beginning of your troubles. Will the affected Root CA go after <emphasis>you</emphasis> to recoup their world-wide damages? What will your users do when they learn that you have been decrypting their traffic without their consent? </para></section></section><section><title>Squid Configuration File</title><para>Squid must be built with: </para><screen><![CDATA[ ./configure \
    --with-openssl \
    --enable-ssl-crtd]]></screen><para>Paste the configuration file like this: </para><screen><![CDATA[http_port 3128 ssl-bump \
  cert=/etc/squid/ssl_cert/myCA.pem \
  generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
]]><![CDATA[
# For squid 3.5.x
sslcrtd_program /usr/local/squid/libexec/ssl_crtd -s /var/lib/ssl_db -M 4MB
]]><![CDATA[
# For squid 4.x
# sslcrtd_program /usr/local/squid/libexec/security_file_certgen -s /var/lib/ssl_db -M 4MB
]]><![CDATA[
acl step1 at_step SslBump1
]]><![CDATA[
ssl_bump peek step1
ssl_bump bump all]]></screen><section><title>Alternative trust roots</title><para>In some cases you may need to specify custom root CA to be added to the library default &quot;Global Trusted CA&quot; set. This is done by  </para><itemizedlist><listitem override="none"><para><ulink url="https://wiki.squid-cache.org/ConfigExamples/Intercept/SslBumpExplicit/Squid-3.5#">Squid-3.5</ulink> and older: </para></listitem></itemizedlist><screen><![CDATA[sslproxy_cafile /usr/local/openssl/cabundle.file]]></screen><itemizedlist><listitem override="none"><para><ulink url="https://wiki.squid-cache.org/ConfigExamples/Intercept/SslBumpExplicit/Squid-4#">Squid-4</ulink> and newer: </para></listitem></itemizedlist><screen><![CDATA[tls_outgoing_options cafile=/usr/local/openssl/cabundle.file]]></screen><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> Note: OpenSSL CA's bundle is derived from Mozilla's bundle and is <emphasis role="strong">NOT COMPLETE</emphasis>. Specifically most intermediate certificates are not included (see below). Adding extra root CA in this way is your responsibility. Also beware, when you use OpenSSL, you need to make c_rehash utility before Squid can use the added certificates. Beware - you can't grab any CA's you see. Check it before use! </para></listitem></itemizedlist></section><section><title>Missing intermediate certificates</title><para>Some global root servers use an intermediate certificate to sign, and sometimes servers do not deliver all the intermediate certificates in the chain up to their root CA. </para><para><ulink url="https://wiki.squid-cache.org/ConfigExamples/Intercept/SslBumpExplicit/Squid-4#">Squid-4</ulink> is capable of downloading missing intermediate CA certificates, like popular browsers do. </para><para>For <ulink url="https://wiki.squid-cache.org/ConfigExamples/Intercept/SslBumpExplicit/Squid-3.5#">Squid-3.5</ulink> the <ulink url="http://www.squid-cache.org/Doc/config/sslproxy_foreign_intermediate_certs#">sslproxy_foreign_intermediate_certs</ulink> directive can be used to load intermediate CA certificates from a file: </para><screen><![CDATA[sslproxy_foreign_intermediate_certs /etc/squid/extra-intermediate-CA.pem]]></screen><para>Older versions of Squid cannot handle intermediate CA certificates very well. You may be able to find various hacks for certain situations around, but it is highly recommended to upgrade to at least the latest <ulink url="https://wiki.squid-cache.org/ConfigExamples/Intercept/SslBumpExplicit/Squid-3.5#">Squid-3.5</ulink> version when dealing with HTTPS / TLS traffic. </para></section></section><section><title>Create and initialize TLS certificates cache directory</title><para>Finally you need to create and initialize TLS certificates cache directory and set permissions to allow access by Squid. </para><para>The crtd helper will store mimicked certificates in this directory. The squid low-privilege account needs permission to both read and write there. </para><para><ulink url="https://wiki.squid-cache.org/ConfigExamples/Intercept/SslBumpExplicit/Squid-3.5#">Squid-3.5</ulink>: </para><screen><![CDATA[/usr/local/squid/libexec/ssl_crtd -c -s /var/lib/ssl_db -M 4MB
chown squid:squid -R /var/lib/ssl_db]]></screen><para><ulink url="https://wiki.squid-cache.org/ConfigExamples/Intercept/SslBumpExplicit/Squid-4#">Squid-4</ulink> and newer: </para><screen><![CDATA[/usr/local/squid/libexec/security_file_certgen -c -s /var/lib/ssl_db -M 4MB
chown squid:squid -R /var/lib/ssl_db]]></screen><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/alert.png" width="15"/></imageobject><textobject><phrase>/!\</phrase></textobject></inlinemediaobject> The low-privilege account varies by OS and may not be 'squid' in your system. </para></listitem><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/alert.png" width="15"/></imageobject><textobject><phrase>/!\</phrase></textobject></inlinemediaobject> also, be aware that SELinux and <ulink url="https://wiki.squid-cache.org/ConfigExamples/Intercept/SslBumpExplicit/AppArmour#">AppArmour</ulink> permissions may need to be updated to allow the Squid helper to use this directory. </para></listitem><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/alert.png" width="15"/></imageobject><textobject><phrase>/!\</phrase></textobject></inlinemediaobject> certificates cache directory used only if squid configured with --enable-ssl-crtd. Otherwise bump will work, but no certificates will store anywhere. </para></listitem></itemizedlist></section><section><title>Troubleshooting</title><para>For <ulink url="https://wiki.squid-cache.org/ConfigExamples/Intercept/SslBumpExplicit/Squid-3.1#">Squid-3.1</ulink> in some cases you may need to add some options in your Squid configuration: </para><screen><![CDATA[sslproxy_cert_error allow all
sslproxy_flags DONT_VERIFY_PEER]]></screen><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/alert.png" width="15"/></imageobject><textobject><phrase>/!\</phrase></textobject></inlinemediaobject> <emphasis role="strong">BEWARE!</emphasis> It can reduce SSL/TLS errors in cache.log, but <emphasis role="strong">this is NOT SECURE!</emphasis> With these options your cache will ignore all server certificates errors and connect your users with them. Use these options at your own risk. </para></listitem><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> Note that <emphasis role="strong">DONT_VERIFY_PEER</emphasis> is not good even for debugging. Since it will most probably hide the error you are trying to identify and fix. </para></listitem><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> Note: <ulink url="http://www.squid-cache.org/Doc/config/sslproxy_cert_error#">sslproxy_cert_error</ulink> can be used to refine server's cert error and control access to it. Use it with caution. </para></listitem></itemizedlist><para>To increase security the good idea to set these options: </para><screen><![CDATA[# SINGLE_DH_USE is 3.5 before squid-3.5.12-20151222-r13967
# SINGLE_ECDH_USE is AFTER squid-3.5.12-20151222-r13967
]]><![CDATA[
# for Squid-3.5 and older
sslproxy_options NO_SSLv2,NO_SSLv3,SINGLE_DH_USE
]]><![CDATA[
# for Squid-4 and newer
tls_outgoing_options options=NO_SSLv3,SINGLE_DH_USE,SINGLE_ECDH_USE]]></screen><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/alert.png" width="15"/></imageobject><textobject><phrase>/!\</phrase></textobject></inlinemediaobject> SSL options must be comma (,) or colon (:) separated, not spaces! </para></listitem><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> NO_SSLv2 is relevant only for Squid-3.x. SSLv2 support has been completely removed from <ulink url="https://wiki.squid-cache.org/ConfigExamples/Intercept/SslBumpExplicit/Squid-4#">Squid-4</ulink>. </para></listitem></itemizedlist><para>As a result, you can get more errors in your cache.log. So, you must investigate every case separately and correct it as needed. </para></section><section><title>Hardening</title><itemizedlist><listitem override="none"><para><emphasis>by <ulink url="https://wiki.squid-cache.org/ConfigExamples/Intercept/SslBumpExplicit/YuriVoinov#">YuriVoinov</ulink></emphasis> </para></listitem></itemizedlist><para>It is important to increase invisible for you part of bumped connection - from proxy to server. </para><para>By default, you are use default set of ciphers. And never check your ssl connection from outside. </para><para>To achieve this, you can use <ulink url="https://www.ssllabs.com/ssltest/viewMyClient.html">this link</ulink> for example. Just point browser from client behing your proxy to this URL. </para><para>Most often you can see usage of export/weak ciphers. </para><para>To do hardening, you can set Mozilla-provided cipher list (this is one line): </para><screen><![CDATA[sslproxy_cipher EECDH+ECDSA+AESGCM:EECDH+aRSA+AESGCM:EECDH+ECDSA+SHA384:EECDH+ECDSA+SHA256:EECDH+aRSA+SHA384:EECDH+aRSA+SHA256:EECDH+aRSA+RC4:EECDH:EDH+aRSA:!RC4:!aNULL:!eNULL:!LOW:!3DES:!MD5:!EXP:!PSK:!SRP:!DSS]]></screen><para>In combination with <ulink url="http://www.squid-cache.org/Doc/config/sslproxy_options#">sslproxy_options</ulink> or <ulink url="http://www.squid-cache.org/Doc/config/tls_outgoing_options#">tls_outgoing_options</ulink> above you can increase the outgoing TLS connection's security. </para><para>A good result should look like this: </para><para><inlinemediaobject><imageobject><imagedata fileref="https://wiki.squid-cache.org/ConfigExamples/Intercept/SslBumpExplicit?action=AttachFile&amp;do=get&amp;target=ssl_client_online_check.png"/></imageobject><textobject><phrase>Test TLS after change cipher's suite</phrase></textobject></inlinemediaobject> </para><para>This looks like more better for outgoing SSL connections. </para><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> Note: Your browser shows connection security info from proxy to client. But it is important for you to know the security level from proxy to server connection. Don't forget about ciphers. </para></listitem><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> Note: Some HTTPS sites will prevent connections with the above ciphers. So, to make it work you can add HIGH cipher suite to this cipher's list. Remember, this makes your configuration a bit weak, but more compatible. Your cipher's row will look like this: </para></listitem></itemizedlist><screen><![CDATA[sslproxy_cipher EECDH+ECDSA+AESGCM:EECDH+aRSA+AESGCM:EECDH+ECDSA+SHA384:EECDH+ECDSA+SHA256:EECDH+aRSA+SHA384:EECDH+aRSA+SHA256:EECDH+aRSA+RC4:EECDH:EDH+aRSA:HIGH:!RC4:!aNULL:!eNULL:!LOW:!3DES:!MD5:!EXP:!PSK:!SRP:!DSS]]></screen><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> Note: Ciphers are used also depending from your SSL/TLS library. In some cases will be enough to specify: </para></listitem></itemizedlist><screen><![CDATA[sslproxy_cipher HIGH:MEDIUM:!RC4:!aNULL:!eNULL:!LOW:!3DES:!MD5:!EXP:!PSK:!SRP:!DSS]]></screen><para>or </para><screen><![CDATA[tls_outgoing_options cipher=HIGH:MEDIUM:!RC4:!aNULL:!eNULL:!LOW:!3DES:!MD5:!EXP:!PSK:!SRP:!DSS]]></screen><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> Note: Don't forget, that sslproxy_cipher/tls_outgoing_options effective for external (i.e., from Squid to Web) connections. For internal (i.e., from Squid to LAN) connections you also need to specify cipher in http_port/https_port. </para></listitem></itemizedlist><section><title>Modern DH/EDH ciphers usage</title><para>To enable Squid to use modern DH/EDH exchanges/ciphers you must (depending of your openssl build) create DH params file and specify it with http(s)_port. </para><para>To do that first create DH params file: </para><screen><![CDATA[# openssl dhparam -outform PEM -out dhparam.pem 2048]]></screen><para>Then add <emphasis role="strong">dhparams=</emphasis> or <emphasis role="strong">tls-dh=</emphasis> option to your bumped port specification (depending Squid's version): </para><para>Squid 3.x: </para><screen><![CDATA[#          dhparams=    File containing DH parameters for temporary/ephemeral
#                       DH key exchanges. See OpenSSL documentation for details
#                       on how to create this file.
#                       WARNING: EDH ciphers will be silently disabled if this
#                                option is not set.
https_port 3127 intercept ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/usr/local/squid/etc/rootCA.crt key=/usr/local/squid/etc/rootCA.key options=NO_SSLv3 dhparams=/usr/local/squid/etc/dhparam.pem]]></screen><para>Squid 4.x: </para><screen><![CDATA[#          tls-dh=[curve:]file
#                       File containing DH parameters for temporary/ephemeral DH key
#                       exchanges, optionally prefixed by a curve for ephemeral ECDH
#                       key exchanges.
#                       See OpenSSL documentation for details on how to create the
#                       DH parameter file. Supported curves for ECDH can be listed
#                       using the "openssl ecparam -list_curves" command.
#                       WARNING: EDH and EECDH ciphers will be silently disabled if
#                                this option is not set.
https_port 3128 ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/usr/local/squid/etc/rootCA.crt key=/usr/local/squid/etc/rootCA.key options=SINGLE_DH_USE,SINGLE_ECDH_USE tls-dh=/usr/local/squid/etc/dhparam.pem]]></screen><para>and restart squid. </para><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> Note: Careful, these config snippets may not work in your proxy. They are just examples! </para></listitem><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> Note: In some cases you can specify curve in tls-dh option: </para></listitem></itemizedlist><screen><![CDATA[tls-dh=prime256v1:/usr/local/squid/etc/dhparam.pem]]></screen><!--rule (<hr>) is not applicable to DocBook--><para> <ulink url="https://wiki.squid-cache.org/ConfigExamples/Intercept/SslBumpExplicit/CategoryConfigExample#">CategoryConfigExample</ulink> </para></section></section></section></article>