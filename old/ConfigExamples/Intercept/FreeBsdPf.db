<?xml version="1.0" encoding="utf-8"?><!DOCTYPE article  PUBLIC '-//OASIS//DTD DocBook XML V4.4//EN'  'http://www.docbook.org/xml/4.4/docbookx.dtd'><article><articleinfo><title>ConfigExamples/Intercept/FreeBsdPf</title><revhistory><revision><revnumber>4</revnumber><date>2018-02-11 07:34:50</date><authorinitials>AmosJeffries</authorinitials><revremark>add mention of --with-nat-devpf option required for recent FreeBSD PF version, use example.com for example domain</revremark></revision><revision><revnumber>3</revnumber><date>2018-02-11 07:32:02</date><authorinitials>AmosJeffries</authorinitials><revremark>add generic NAT disclaimer</revremark></revision><revision><revnumber>2</revnumber><date>2011-04-06 03:28:06</date><authorinitials>AmosJeffries</authorinitials><revremark>match the rdr port to the rest of the config</revremark></revision><revision><revnumber>1</revnumber><date>2011-04-06 03:01:34</date><authorinitials>AmosJeffries</authorinitials><revremark>copy the old OpenBSD config for FreeBSD. new OpenBSD is getting new commands that do not work on FreeBSD 8/9</revremark></revision></revhistory></articleinfo><section><title>Intercepting traffic with PF on FreeBSD</title><para>Based on OpenBSD example by Chris Benech </para><para><emphasis role="strong">Warning</emphasis>: Any example presented here is provided &quot;as-is&quot; with no support or guarantee of suitability. If you have any further questions about these examples please email the squid-users mailing list. </para><section><title>Outline</title><para>This configuration applies to FreeBSD 8/9, MP kernel and Squid 2.6 or later. </para><para><emphasis role="strong">NOTE:</emphasis> NAT configuration will only work when used <emphasis role="strong">on the squid box</emphasis>. This is required to perform intercept accurately and securely. To intercept from a gateway machine and direct traffic at a separate squid box use <ulink url="https://wiki.squid-cache.org/ConfigExamples/Intercept/FreeBsdPf/ConfigExamples/Intercept/IptablesPolicyRoute#">policy routing</ulink>. </para></section><section><title>Squid Configuration</title><para>First, compile and install Squid. It requires the following options: </para><screen><![CDATA[./configure --with-pthreads --enable-pf-transparent --with-nat-devpf]]></screen><para>You will need to configure squid to know the IP is being intercepted like so: </para><screen><![CDATA[http_port 3129 transparent]]></screen><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/alert.png" width="15"/></imageobject><textobject><phrase>/!\</phrase></textobject></inlinemediaobject> In Squid 3.1+ the <emphasis>transparent</emphasis> option has been split. Use <emphasis role="strong">'intercept</emphasis> to catch PF packets. </para></listitem></itemizedlist><screen><![CDATA[http_port 3129 intercept]]></screen></section><section><title>pf.conf Configuration</title><para>In pf.conf, the following changes need to be made. </para><para>In the top portion where you set skip on your internal interfaces, remove those lines. They tell the pf filter not to do any processing on packets coming in on an internal interface. </para><screen><![CDATA[#set skip on $int_if << These lines commented out 
#set skip on $wi_if
]]><![CDATA[
# redirect only IPv4 web traffic to squid 
rdr pass inet proto tcp from 192.168.231.0/24 to any port 80 -> 192.168.231.1 port 3129
]]><![CDATA[
block in
pass in quick on $int_if
pass in quick on $wi_if
pass out keep state]]></screen><para>Some pointers: </para><itemizedlist><listitem><para>Use <emphasis role="strong">rdr pass</emphasis> instead of <emphasis role="strong">rdr on ...</emphasis>  part of the way that pf evaluates packets, it would drop through and be allowed as is instead of redirected if you don't use <emphasis role="strong">rdr pass</emphasis>. </para></listitem><listitem><para>If it seems to be ignoring your changes and no redirection is happening, make sure you removed the set <emphasis role="strong">skip on</emphasis> lines. </para></listitem><listitem><para>Make sure and add the <emphasis role="strong">pass in quick</emphasis> lines. Myself I have two internal interfaces, one for wired and one for wireless internet. Although there is a bridge configured, strange things happen sometimes when you don't explicitly allow all traffic on both interfaces. If you don't add these lines, you will lose local network connectivity and have to go to the console to figure it out. </para></listitem></itemizedlist></section><section><title>Testing</title><para>To test if it worked, use the <emphasis role="strong">nc</emphasis> utility. Stop squid and from the command line as root type in: </para><screen><![CDATA[nc -l 3129]]></screen><para>Then restart squid and try to navigate to a page. </para><para>You should now see an output like this: </para><screen><![CDATA[<root:openbsd> [/root]
> nc -l 3129
GET / HTTP/1.1
User-Agent: Mozilla/5.0 (compatible; GNotify 1.0.25.0)
Host: example.com
Connection: keep-alive
...]]></screen><para>From there on out, just set your browsers up normally with no proxy server, and you should see the cache fill up and your browsing speed up. </para><!--rule (<hr>) is not applicable to DocBook--><para> <ulink url="https://wiki.squid-cache.org/ConfigExamples/Intercept/FreeBsdPf/CategoryConfigExample#">CategoryConfigExample</ulink> </para></section></section></article>