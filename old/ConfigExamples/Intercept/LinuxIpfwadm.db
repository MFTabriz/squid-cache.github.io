<?xml version="1.0" encoding="utf-8"?><!DOCTYPE article  PUBLIC '-//OASIS//DTD DocBook XML V4.4//EN'  'http://www.docbook.org/xml/4.4/docbookx.dtd'><article><articleinfo><title>ConfigExamples/Intercept/LinuxIpfwadm</title><revhistory><revision><revnumber>3</revnumber><date>2018-02-11 07:39:43</date><authorinitials>AmosJeffries</authorinitials><revremark>remove unnecessary URL string</revremark></revision><revision><revnumber>2</revnumber><date>2018-02-11 07:19:09</date><authorinitials>AmosJeffries</authorinitials><revremark>add disclaimer about NAT being on the same box. bring port inline with other examples, and use example.com for examples</revremark></revision><revision><revnumber>1</revnumber><date>2009-04-03 07:31:42</date><authorinitials>AmosJeffries</authorinitials><revremark>import from FAQ page</revremark></revision></revhistory></articleinfo><section><title>Intercepting traffic with IPFW on Linux</title><itemizedlist><listitem override="none"><para><emphasis>by Brian Feeny</emphasis> </para></listitem></itemizedlist><para><emphasis role="strong">Warning</emphasis>: Any example presented here is provided &quot;as-is&quot; with no support or guarantee of suitability. If you have any further questions about these examples please email the squid-users mailing list. </para><section><title>Outline</title><itemizedlist><listitem override="none"><para><emphasis role="strong">NP:</emphasis> <emphasis>This configuration information is up-to-date as of Linux 2.0.33</emphasis> </para></listitem></itemizedlist><para><emphasis role="strong">NOTE:</emphasis> NAT configuration will only work when used <emphasis role="strong">on the squid box</emphasis>. This is required to perform intercept accurately and securely. To intercept from a gateway machine and direct traffic at a separate squid box use <ulink url="https://wiki.squid-cache.org/ConfigExamples/Intercept/LinuxIpfwadm/ConfigExamples/Intercept/IptablesPolicyRoute#">policy routing</ulink>. </para></section><section><title>ipfwadm Configuration (/etc/rc.d/rc.local)</title><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/alert.png" width="15"/></imageobject><textobject><phrase>/!\</phrase></textobject></inlinemediaobject> Replace SQUIDIP with the public IP squid may use to send traffic. Repeat the ipfwadm line for each such IP Squid uses. </para></listitem></itemizedlist><screen><![CDATA[# Accept all on loopback
ipfwadm -I -a accept -W lo
]]><![CDATA[
# Accept my own IP, to prevent loops (repeat for each interface/alias)
ipfwadm -I -a accept -P tcp -D SQUIDIP 80
]]><![CDATA[
# Send all traffic destined to port 80 to Squid on port 3129
ipfwadm -I -a accept -P tcp -D 0/0 80 -r 3129]]></screen><para>it accepts packets on port 80, and redirects them to 3127 which is the port my squid process is sitting on. </para></section><section><title>Squid Configuration</title><para>First, compile and install Squid. It requires the following options: </para><screen><![CDATA[./configure --enable-ipfw-transparent]]></screen><para>You will need to configure squid to know the IP is being intercepted like so: </para><screen><![CDATA[http_port 3129 transparent]]></screen><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/alert.png" width="15"/></imageobject><textobject><phrase>/!\</phrase></textobject></inlinemediaobject> In Squid 3.1+ the <emphasis>transparent</emphasis> option has been split. Use <emphasis role="strong">'intercept</emphasis> to catch IPFW packets. </para></listitem></itemizedlist><screen><![CDATA[http_port 3129 intercept]]></screen></section><section><title>Testing</title><para>To test if it worked, use the <emphasis role="strong">nc</emphasis> utility. Stop squid and from the command line as root type in: </para><screen><![CDATA[nc -l 3129]]></screen><para>Then restart squid and try to navigate to a page. </para><para>You should now see an output like this: </para><screen><![CDATA[> nc -l 3129
GET / HTTP/1.1
User-Agent: Mozilla/5.0 (compatible; GNotify 1.0.25.0)
Host: example.com
Connection: Keep-alive
...]]></screen><para>From there on out, just set your browsers up normally with no proxy server, and you should see the cache fill up and your browsing speed up. </para><!--rule (<hr>) is not applicable to DocBook--><para> <ulink url="https://wiki.squid-cache.org/ConfigExamples/Intercept/LinuxIpfwadm/CategoryConfigExample#">CategoryConfigExample</ulink> </para></section></section></article>