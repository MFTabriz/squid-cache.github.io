<?xml version="1.0" encoding="utf-8"?><!DOCTYPE article  PUBLIC '-//OASIS//DTD DocBook XML V4.4//EN'  'http://www.docbook.org/xml/4.4/docbookx.dtd'><article><articleinfo><title>ConfigExamples/Intercept/AtSource</title><revhistory><revision><revnumber>5</revnumber><date>2018-02-11 07:28:35</date><authorinitials>AmosJeffries</authorinitials><revremark>use generic NAT disclaimer, and re-phrase the config description to clarify this is ony useful for a single machine.</revremark></revision><revision><revnumber>4</revnumber><date>2014-07-18 04:16:39</date><authorinitials>AmosJeffries</authorinitials><revremark>add rule to bypass Squid traffic by UID</revremark></revision><revision><revnumber>3</revnumber><date>2010-02-19 10:39:24</date><authorinitials>FrancescoChemolli</authorinitials><revremark>Fixed dangling wiki-links</revremark></revision><revision><revnumber>2</revnumber><date>2009-10-15 02:24:43</date><authorinitials>AmosJeffries</authorinitials><revremark>slightly more clarity on the warning.</revremark></revision><revision><revnumber>1</revnumber><date>2008-12-03 07:45:44</date><authorinitials>AmosJeffries</authorinitials><revremark>Add interesting NAT configuration needed by a client.</revremark></revision></revhistory></articleinfo><section><title>Linux traffic Interception at source using DNAT</title><para><emphasis role="strong">Warning</emphasis>: Any example presented here is provided &quot;as-is&quot; with no support or guarantee of suitability. If you have any further questions about these examples please email the squid-users mailing list. </para><section><title>Outline</title><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/alert.png" width="15"/></imageobject><textobject><phrase>/!\</phrase></textobject></inlinemediaobject> WARNING: Using NAT interception is not recommended other than as a final backup to other systems. There are other methods such as <ulink url="https://wiki.squid-cache.org/ConfigExamples/Intercept/AtSource/Technology/WPAD#">Proxy WPAD/PAC</ulink>, linux http_proxy environment variable, and windows policy enforcement of browser config. All of which are just as effective and encounter less problems when multiple clients are involved. </para></listitem></itemizedlist><para>This configuration is to use NAT to Intercept web requests generated by other software running on the same machine as Squid without any kind of client application configuration or proxy support. It is extremely intrusive and not applicable unless full control is had over the client machine (ie rogue application server). </para><para><emphasis role="strong">NOTE:</emphasis> NAT configuration will only work when used <emphasis role="strong">on the squid box</emphasis>. This is required to perform intercept accurately and securely. To intercept from a gateway machine and direct traffic at a separate squid box use <ulink url="https://wiki.squid-cache.org/ConfigExamples/Intercept/AtSource/ConfigExamples/Intercept/IptablesPolicyRoute#">policy routing</ulink>. </para></section><section><title>iptables configuration</title><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/alert.png" width="15"/></imageobject><textobject><phrase>/!\</phrase></textobject></inlinemediaobject> Replace <emphasis role="strong">SQUIDIP</emphasis> with the public IP which squid may use for its listening port and outbound connections. </para><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> You may also need to replace &quot;squid&quot; UID with the <ulink url="http://www.squid-cache.org/Doc/config/cache_effective_user#">cache_effective_user</ulink> account Squid runs as. This may be using a built-in default of &quot;nobody&quot;, &quot;squid&quot;, or &quot;proxy&quot; depending on your operating system. </para></listitem></itemizedlist><screen><![CDATA[iptables -t nat -A OUTPUT --match owner --uid-owner squid -p tcp --dport 80 -j ACCEPT
]]><![CDATA[
iptables -t nat -A OUTPUT -p tcp --dport 80 -j DNAT --to-destination SQUIDIP:3129]]></screen></section><section><title>Squid Configuration File</title><para>You will need to configure squid to know the IP is being intercepted like so: </para><screen><![CDATA[http_port 3129 transparent]]></screen><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/alert.png" width="15"/></imageobject><textobject><phrase>/!\</phrase></textobject></inlinemediaobject> In Squid 3.1+ the <emphasis>transparent</emphasis> option has been split. Use <emphasis role="strong">'intercept</emphasis> to catch DNAT packets. </para></listitem></itemizedlist><screen><![CDATA[http_port 3129 intercept]]></screen><!--rule (<hr>) is not applicable to DocBook--><para> <ulink url="https://wiki.squid-cache.org/ConfigExamples/Intercept/AtSource/CategoryConfigExample#">CategoryConfigExample</ulink> </para></section></section></article>