<?xml version="1.0" encoding="utf-8"?><!DOCTYPE article  PUBLIC '-//OASIS//DTD DocBook XML V4.4//EN'  'http://www.docbook.org/xml/4.4/docbookx.dtd'><article><articleinfo><title>ConfigExamples/Intercept/LinuxRedirect</title><revhistory><revision><revnumber>16</revnumber><date>2018-02-11 07:43:05</date><authorinitials>AmosJeffries</authorinitials><revremark>add generic NAT disclaimer, and remove IPv4-only references now that IPv6 NAT exists</revremark></revision><revision><revnumber>15</revnumber><date>2017-08-31 10:32:01</date><authorinitials>AmosJeffries</authorinitials></revision><revision><revnumber>14</revnumber><date>2012-02-04 08:34:13</date><authorinitials>AmosJeffries</authorinitials><revremark>tweak config to be a bit more of a copy-n-paste script.</revremark></revision><revision><revnumber>13</revnumber><date>2012-01-20 01:43:04</date><authorinitials>AmosJeffries</authorinitials><revremark>display what this device config looks like visually</revremark></revision><revision><revnumber>12</revnumber><date>2011-04-01 00:40:40</date><authorinitials>AmosJeffries</authorinitials><revremark>typo. PREROUTING for teh mangel rule. INPUT is too late.</revremark></revision><revision><revnumber>11</revnumber><date>2011-03-31 11:55:16</date><authorinitials>AmosJeffries</authorinitials><revremark>mention the firewall rule that protects against part of the NAT problems.</revremark></revision><revision><revnumber>10</revnumber><date>2008-09-04 04:42:33</date><authorinitials>AmosJeffries</authorinitials><revremark>forgot the reverse NAT handling in example</revremark></revision><revision><revnumber>9</revnumber><date>2008-09-01 04:03:56</date><authorinitials>AmosJeffries</authorinitials><revremark>mention NAT limit.</revremark></revision><revision><revnumber>8</revnumber><date>2008-09-01 04:03:05</date><authorinitials>AmosJeffries</authorinitials><revremark>typo</revremark></revision><revision><revnumber>7</revnumber><date>2008-09-01 04:02:49</date><authorinitials>AmosJeffries</authorinitials><revremark>3.1+ use intercept option</revremark></revision><revision><revnumber>6</revnumber><date>2008-09-01 03:59:48</date><authorinitials>AmosJeffries</authorinitials><revremark>re-link wiki</revremark></revision><revision><revnumber>5</revnumber><date>2008-09-01 03:55:04</date><authorinitials>AmosJeffries</authorinitials><revremark>building Intercept Section</revremark></revision><revision><revnumber>4</revnumber><date>2008-05-18 19:38:58</date><authorinitials>localhost</authorinitials><revremark>converted to 1.6 markup</revremark></revision><revision><revnumber>3</revnumber><date>2008-04-03 11:17:14</date><authorinitials>AmosJeffries</authorinitials><revremark>add proto to iptables rules properly</revremark></revision><revision><revnumber>2</revnumber><date>2008-04-03 11:04:40</date><authorinitials>AmosJeffries</authorinitials><revremark>Link the routing info for non-gateway configurations</revremark></revision><revision><revnumber>1</revnumber><date>2008-04-03 10:56:58</date><authorinitials>AmosJeffries</authorinitials></revision></revhistory></articleinfo><section><title>Linux traffic Interception using REDIRECT</title><para><emphasis role="strong">Warning</emphasis>: Any example presented here is provided &quot;as-is&quot; with no support or guarantee of suitability. If you have any further questions about these examples please email the squid-users mailing list. </para><section><title>Outline</title><para>To Intercept web requests transparently without any kind of client configuration. When web traffic is reaching the machine squid is run on. </para><para><emphasis role="strong">NOTE:</emphasis> NAT configuration will only work when used <emphasis role="strong">on the squid box</emphasis>. This is required to perform intercept accurately and securely. To intercept from a gateway machine and direct traffic at a separate squid box use <ulink url="https://wiki.squid-cache.org/ConfigExamples/Intercept/LinuxRedirect/ConfigExamples/Intercept/IptablesPolicyRoute#">policy routing</ulink>. </para><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata fileref="https://wiki.squid-cache.org/ConfigExamples/Intercept/LinuxRedirect?action=AttachFile&amp;do=get&amp;target=squid-NAT-device-REDIRECT.png"/></imageobject><textobject><phrase>squid-NAT-device-REDIRECT.png</phrase></textobject></inlinemediaobject> </para></listitem></itemizedlist></section><section><title>iptables configuration</title><para>Replace <emphasis role="strong">SQUIDIP</emphasis> with the public IP which squid may use for its listening port and outbound connections. Replace <emphasis role="strong">SQUIDPORT</emphasis> with the port in squid.conf set with <emphasis role="strong">intercept</emphasis> flag. </para><para>Due to the NAT security vulnerabilities it is also a <emphasis role="strong">very good idea</emphasis> to block external access to the internal receiving port. This has to be done in the <emphasis role="strong">mangle</emphasis> part of iptables before NAT happens so that intercepted traffic does not get dropped. </para><para>Without the first iptables line here being first, your setup may encounter problems with forwarding loops. </para><screen><![CDATA[# your proxy IP
SQUIDIP=192.168.0.2
]]><![CDATA[
# your proxy listening port
SQUIDPORT=3129
]]><![CDATA[
]]><![CDATA[
iptables -t nat -A PREROUTING -s $SQUIDIP -p tcp --dport 80 -j ACCEPT
iptables -t nat -A PREROUTING -p tcp --dport 80 -j REDIRECT --to-port $SQUIDPORT
iptables -t nat -A POSTROUTING -j MASQUERADE
iptables -t mangle -A PREROUTING -p tcp --dport $SQUIDPORT -j DROP]]></screen></section><section><title>Squid Configuration File</title><para>You will need to configure squid to know the IP is being intercepted like so: </para><screen><![CDATA[http_port 3129 transparent]]></screen><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/alert.png" width="15"/></imageobject><textobject><phrase>/!\</phrase></textobject></inlinemediaobject> In Squid 3.1+ the <emphasis>transparent</emphasis> option has been split. Use <emphasis role="strong">'intercept</emphasis> to catch REDIRECT packets. </para></listitem></itemizedlist><screen><![CDATA[http_port 3129 intercept]]></screen><!--rule (<hr>) is not applicable to DocBook--><para> <ulink url="https://wiki.squid-cache.org/ConfigExamples/Intercept/LinuxRedirect/CategoryConfigExample#">CategoryConfigExample</ulink> </para></section></section></article>