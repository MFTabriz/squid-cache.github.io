<?xml version="1.0" encoding="utf-8"?><!DOCTYPE article  PUBLIC '-//OASIS//DTD DocBook XML V4.4//EN'  'http://www.docbook.org/xml/4.4/docbookx.dtd'><article><articleinfo><title>ConfigExamples/Intercept/LinuxDnat</title><revhistory><revision><revnumber>16</revnumber><date>2018-02-11 07:55:40</date><authorinitials>AmosJeffries</authorinitials></revision><revision><revnumber>15</revnumber><date>2018-02-11 07:14:05</date><authorinitials>AmosJeffries</authorinitials><revremark>import generic nat disclaimer instead of rewriting it.</revremark></revision><revision><revnumber>14</revnumber><date>2017-08-31 10:00:51</date><authorinitials>AmosJeffries</authorinitials></revision><revision><revnumber>13</revnumber><date>2012-02-04 08:33:42</date><authorinitials>AmosJeffries</authorinitials><revremark>polish</revremark></revision><revision><revnumber>12</revnumber><date>2012-02-04 08:26:18</date><authorinitials>AmosJeffries</authorinitials><revremark>tweak config to be a bit more of a copy-n-paste script.</revremark></revision><revision><revnumber>11</revnumber><date>2012-01-20 01:34:28</date><authorinitials>AmosJeffries</authorinitials><revremark>diagram what this device looks like visually</revremark></revision><revision><revnumber>10</revnumber><date>2011-06-05 03:59:52</date><authorinitials>AmosJeffries</authorinitials><revremark>script-ify the example for the cut-n-past crowd</revremark></revision><revision><revnumber>9</revnumber><date>2011-04-01 00:34:37</date><authorinitials>AmosJeffries</authorinitials><revremark>typo. PREROUTING for the mangle rule. INPUT is too late.</revremark></revision><revision><revnumber>8</revnumber><date>2011-03-31 11:53:40</date><authorinitials>AmosJeffries</authorinitials><revremark>mention the firewall rule that protects against part of the NAT problems.</revremark></revision><revision><revnumber>7</revnumber><date>2009-04-03 06:41:46</date><authorinitials>AmosJeffries</authorinitials><revremark>add mentions of sysctl forwarding config</revremark></revision><revision><revnumber>6</revnumber><date>2008-10-10 08:29:34</date><authorinitials>AmosJeffries</authorinitials><revremark>gramar and clarity edit.</revremark></revision><revision><revnumber>5</revnumber><date>2008-09-01 04:08:56</date><authorinitials>AmosJeffries</authorinitials><revremark>re-link wiki, update text.</revremark></revision><revision><revnumber>4</revnumber><date>2008-09-01 04:05:03</date><authorinitials>AmosJeffries</authorinitials><revremark>building intercept section</revremark></revision><revision><revnumber>3</revnumber><date>2008-05-18 19:38:55</date><authorinitials>localhost</authorinitials><revremark>converted to 1.6 markup</revremark></revision><revision><revnumber>2</revnumber><date>2008-04-03 11:16:52</date><authorinitials>AmosJeffries</authorinitials><revremark>add proto to iptables rules properly</revremark></revision><revision><revnumber>1</revnumber><date>2008-04-03 11:15:21</date><authorinitials>AmosJeffries</authorinitials></revision></revhistory></articleinfo><section><title>Linux traffic Interception using DNAT</title><para><emphasis role="strong">Warning</emphasis>: Any example presented here is provided &quot;as-is&quot; with no support or guarantee of suitability. If you have any further questions about these examples please email the squid-users mailing list. </para><section><title>Outline</title><para>To Intercept IPv4 web requests transparently without any kind of client configuration. When web traffic is reaching the machine squid is run on. </para><para><emphasis role="strong">NOTE:</emphasis> NAT configuration will only work when used <emphasis role="strong">on the squid box</emphasis>. This is required to perform intercept accurately and securely. To intercept from a gateway machine and direct traffic at a separate squid box use <ulink url="https://wiki.squid-cache.org/ConfigExamples/Intercept/LinuxDnat/ConfigExamples/Intercept/IptablesPolicyRoute#">policy routing</ulink>. </para><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata fileref="https://wiki.squid-cache.org/ConfigExamples/Intercept/LinuxDnat?action=AttachFile&amp;do=get&amp;target=squid-DNAT-device.png"/></imageobject><textobject><phrase>squid-DNAT-device.png</phrase></textobject></inlinemediaobject> </para></listitem></itemizedlist></section><section><title>iptables configuration</title><para>Replace <emphasis role="strong">SQUIDIP</emphasis> with the public IP which squid may use for its listening port and outbound connections. Replace <emphasis role="strong">SQUIDPORT</emphasis> with the port in squid.conf set with <emphasis role="strong">intercept</emphasis> flag. </para><para>Due to the NAT security vulnerabilities it is also a <emphasis role="strong">very good idea</emphasis> to block external access to the internal receiving port. This has to be done in the <emphasis role="strong">mangle</emphasis> part of iptables before DNAT happens so that intercepted traffic does not get dropped. </para><para>Without the first iptables line here being first, your setup may encounter problems with forwarding loops. </para><screen><![CDATA[# your proxy IP
SQUIDIP=192.168.0.2
]]><![CDATA[
# your proxy listening port
SQUIDPORT=3129
]]><![CDATA[
]]><![CDATA[
iptables -t nat -A PREROUTING -s $SQUIDIP -p tcp --dport 80 -j ACCEPT
iptables -t nat -A PREROUTING -p tcp --dport 80 -j DNAT --to-destination $SQUIDIP:$SQUIDPORT
iptables -t nat -A POSTROUTING -j MASQUERADE
iptables -t mangle -A PREROUTING -p tcp --dport $SQUIDPORT -j DROP]]></screen><para><emphasis role="strong">NOTE:</emphasis> DNAT is only available for IPv4 traffic on older kernel versions. For IPv6 interception use <ulink url="https://wiki.squid-cache.org/ConfigExamples/Intercept/LinuxDnat/Features/Tproxy4#">TPROXY version 4</ulink>. </para></section><section><title>/etc/sysctl.conf Configuration</title><screen><![CDATA[# Controls IP packet forwarding
net.ipv4.ip_forward = 1
]]><![CDATA[
# Controls source route verification
net.ipv4.conf.default.rp_filter = 0
]]><![CDATA[
# Do not accept source routing
net.ipv4.conf.default.accept_source_route = 0]]></screen></section><section><title>Squid Configuration File</title><para>You will need to configure squid to know the IP is being intercepted like so: </para><screen><![CDATA[http_port 3129 transparent]]></screen><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/alert.png" width="15"/></imageobject><textobject><phrase>/!\</phrase></textobject></inlinemediaobject> In Squid 3.1+ the <emphasis>transparent</emphasis> option has been split. Use <emphasis role="strong">'intercept</emphasis> to catch DNAT packets. </para></listitem></itemizedlist><screen><![CDATA[http_port 3129 intercept]]></screen><!--rule (<hr>) is not applicable to DocBook--><para> <ulink url="https://wiki.squid-cache.org/ConfigExamples/Intercept/LinuxDnat/CategoryConfigExample#">CategoryConfigExample</ulink> </para></section></section></article>