<?xml version="1.0" encoding="utf-8"?><!DOCTYPE article  PUBLIC '-//OASIS//DTD DocBook XML V4.4//EN'  'http://www.docbook.org/xml/4.4/docbookx.dtd'><article><articleinfo><title>ConfigExamples/Intercept/PfPolicyRoute</title><revhistory><revision><revnumber>6</revnumber><date>2015-08-27 20:49:47</date><authorinitials>Eliezer Croitoru</authorinitials><revremark>OpenBSD issue fixed in current(5.8)</revremark></revision><revision><revnumber>5</revnumber><date>2015-08-27 09:58:41</date><authorinitials>Eliezer Croitoru</authorinitials></revision><revision><revnumber>4</revnumber><date>2015-08-27 09:55:22</date><authorinitials>Eliezer Croitoru</authorinitials></revision><revision><revnumber>3</revnumber><date>2015-08-27 02:43:10</date><authorinitials>Eliezer Croitoru</authorinitials><revremark>Update to the OpenBSD pf rules.</revremark></revision><revision><revnumber>2</revnumber><date>2015-08-27 01:07:50</date><authorinitials>Eliezer Croitoru</authorinitials></revision><revision><revnumber>1</revnumber><date>2015-08-27 00:01:27</date><authorinitials>Eliezer Croitoru</authorinitials></revision></revhistory></articleinfo><section><title>Policy Routing Web Traffic On A FreeBSD Router</title><para><emphasis role="strong">Warning</emphasis>: Any example presented here is provided &quot;as-is&quot; with no support or guarantee of suitability. If you have any further questions about these examples please email the squid-users mailing list. </para><section><title>Outline</title><para>This example outlines how to configure a FreeBSD router to policy route traffic (web in this instance) towards a Squid proxy which is using a tproxy mode. </para></section><section><title>pf example rules</title><para><inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/alert.png" width="15"/></imageobject><textobject><phrase>/!\</phrase></textobject></inlinemediaobject> the &quot;no state&quot; are very important to make the re-routing decision a packet by packet one. </para><screen><![CDATA[ext_if = "em0"
int_if = "em2"
proxy_if = "em1"
lan_net = "192.168.12.0/24"
proxy1 = "192.168.11.1"
proxy_net = "192.168.11.0/24"
upstream_router= "192.168.15.254"
]]><![CDATA[
pass in quick on $ext_if route-to ($proxy_if $proxy1) proto tcp from any port 80 to $lan_net no state
pass in quick on $int_if route-to ($proxy_if $proxy1) proto tcp from $lan_net to any port 80 no state]]></screen></section><section><title>rc.conf example for a router</title><screen><![CDATA[hostname="edge1"
ifconfig_em0="inet 192.168.15.1 netmask 255.255.255.0"
defaultrouter="192.168.15.254"
ifconfig_em1="inet 192.168.11.254 netmask 255.255.255.0"
ifconfig_em2="inet 192.168.12.254 netmask 255.255.255.0"
ifconfig_em3="inet 192.168.13.254 netmask 255.255.255.0"
]]><![CDATA[
gateway_enable="YES"
sshd_enable="YES"
pflog_enable="YES"
pf_enable="YES"
##PF default rules file is: /etc/pf.conf
]]><![CDATA[
dhcpd_enable="YES"
dhcpd_conf="/usr/local/etc/dhcpd.conf"
dhcpd_withumasl="022"
]]><![CDATA[
# Set dumpdev to "AUTO" to enable crash dumps, "NO" to disable
dumpdev="AUTO"]]></screen></section><section><title>FreeBSD Virtio net drivers issue</title><para>From an unknown reason the FreeBSD virtio net drivers creates invalid packets while being routed. To prevent this corruption to happen there is a need to disable two interfaces options: </para><itemizedlist><listitem><para>rxcsum </para></listitem><listitem><para>txcsum </para></listitem></itemizedlist><para>I wrote a small startup script to disable these options for vtnet(virtio) devices. </para><programlisting format="linespecific" language="highlight" linenumbering="numbered" startinglinenumber="1"><lineannotation><![CDATA[#!/bin/sh]]></lineannotation>
<lineannotation></lineannotation>
<![CDATA[. /etc/rc.subr]]>

<methodname><![CDATA[name]]></methodname><![CDATA[=]]><phrase><![CDATA["vtnet"]]></phrase>
<methodname><![CDATA[rcvar]]></methodname><![CDATA[=vtnet_enable]]>
<methodname><![CDATA[start_cmd]]></methodname><![CDATA[=]]><phrase><![CDATA["]]></phrase><phrase><![CDATA[${]]></phrase><methodname><![CDATA[name]]></methodname><phrase><![CDATA[}]]></phrase><phrase><![CDATA[_start]]></phrase><phrase><![CDATA["]]></phrase>
<methodname><![CDATA[stop_cmd]]></methodname><![CDATA[=]]><phrase><![CDATA[":"]]></phrase>

<![CDATA[vtnet_start()]]>
<![CDATA[{]]>
<![CDATA[        ]]><token><![CDATA[echo]]></token><![CDATA[ ]]><phrase><![CDATA["VTNET started."]]></phrase>
<![CDATA[        ifconfig |grep ]]><phrase><![CDATA["^vtnet"]]></phrase><![CDATA[|awk ]]><phrase><![CDATA['{print $1}']]></phrase><![CDATA[|sed s/\://g |xargs -n1 |       ]]><token><![CDATA[while]]></token><![CDATA[ ]]><token><![CDATA[read]]></token><![CDATA[ INTERFACE]]>
<![CDATA[        ]]><token><![CDATA[do]]></token>
<![CDATA[                ifconfig ]]><methodname><![CDATA[$INTERFACE]]></methodname><![CDATA[ -rxcsum]]>
<![CDATA[                ifconfig ]]><methodname><![CDATA[$INTERFACE]]></methodname><![CDATA[ -txcsum]]>
<![CDATA[        ]]><token><![CDATA[done]]></token>

<![CDATA[}]]>

<![CDATA[load_rc_config ]]><methodname><![CDATA[$name]]></methodname>
<![CDATA[run_rc_command ]]><phrase><![CDATA["]]></phrase><methodname><![CDATA[$1]]></methodname><phrase><![CDATA["]]></phrase>
</programlisting></section></section><section><title>A Similar config on OpenBSD</title><section><title>PF rules</title><screen><![CDATA[ext_if = "em0"
int_if = "em2"
proxy_if = "em1"
lan_net = "192.168.12.0/24"
proxy1 = "192.168.11.2"
proxy_net = "192.168.11.0/24"
upstream_router= "192.168.15.254"
]]><![CDATA[
pass in quick on $int_if proto tcp from $lan_net to any port 80 route-to ($proxy_if $proxy1) no state
pass in quick on $ext_if proto tcp from any port 80 to $lan_net route-to ($proxy_if $proxy1) no state]]></screen><para>Additional settings for a router mode: </para><screen><![CDATA[sysctl -w net.inet6.ip6.forwarding=1 # 1=Permit forwarding (routing) of IPv6 packets
sysctl -w net.inet.ip.forwarding=1 # 1=Permit forwarding (routing) of IPv4 packets]]></screen></section><section><title>OpenBSD Virtio net drivers issue</title><para>Similar to FreeBSD there is an issue in OpenBSD with the virtio drivers which causes packets to get corrupted. </para><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/alert.png" width="15"/></imageobject><textobject><phrase>/!\</phrase></textobject></inlinemediaobject> I will try to contact the OpenBSD mailing list to see if something could be done. </para></listitem><listitem><para>I have contacted someone on the IRC channel and after testing latest(27/08/2015) current(5.8) it seems that the issue got resolved and the packets are not malformed anymore. </para></listitem></itemizedlist></section></section></article>