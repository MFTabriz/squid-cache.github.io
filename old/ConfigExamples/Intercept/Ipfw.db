<?xml version="1.0" encoding="utf-8"?><!DOCTYPE article  PUBLIC '-//OASIS//DTD DocBook XML V4.4//EN'  'http://www.docbook.org/xml/4.4/docbookx.dtd'><article><articleinfo><title>ConfigExamples/Intercept/Ipfw</title><revhistory><revision><revnumber>6</revnumber><date>2018-02-11 07:41:43</date><authorinitials>AmosJeffries</authorinitials><revremark>add generic NAT disclaimer and use-case outline, use exampel.com for exampl domains, and remove unnecessary URL strings</revremark></revision><revision><revnumber>5</revnumber><date>2012-01-01 04:26:20</date><authorinitials>AmosJeffries</authorinitials><revremark>not only FreeBSD</revremark></revision><revision><revnumber>4</revnumber><date>2012-01-01 04:25:48</date><authorinitials>AmosJeffries</authorinitials><revremark>add mention of MacOSX 10.6 problem remove FreeBSD from title</revremark></revision><revision><revnumber>3</revnumber><date>2011-02-20 23:13:53</date><authorinitials>AmosJeffries</authorinitials><revremark>update variable substitution in IPF script.</revremark></revision><revision><revnumber>2</revnumber><date>2011-02-20 23:10:18</date><authorinitials>AmosJeffries</authorinitials><revremark>correct port in IPF configuratio example to match the squid.conf example.</revremark></revision><revision><revnumber>1</revnumber><date>2009-02-04 09:44:48</date><authorinitials>AmosJeffries</authorinitials><revremark>import from one of the WCCP examples</revremark></revision></revhistory></articleinfo><section><title>Intercepting traffic with IPFW</title><para><emphasis role="strong">Warning</emphasis>: Any example presented here is provided &quot;as-is&quot; with no support or guarantee of suitability. If you have any further questions about these examples please email the squid-users mailing list. </para><section><title>Outline</title><para>This configuration is for a machine using IPFirewall (IPFW) to NAT intercept traffic into a Squid proxy. </para><para><emphasis role="strong">NOTE:</emphasis> NAT configuration will only work when used <emphasis role="strong">on the squid box</emphasis>. This is required to perform intercept accurately and securely. To intercept from a gateway machine and direct traffic at a separate squid box use <ulink url="https://wiki.squid-cache.org/ConfigExamples/Intercept/Ipfw/ConfigExamples/Intercept/IptablesPolicyRoute#">policy routing</ulink>. </para></section><section><title>Squid Configuration</title><para>First, compile and install Squid. It requires the following options: </para><screen><![CDATA[./configure --enable-ipfw-transparent]]></screen><para>You will need to configure squid to know the IP is being intercepted like so: </para><screen><![CDATA[http_port 3129 transparent]]></screen><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/alert.png" width="15"/></imageobject><textobject><phrase>/!\</phrase></textobject></inlinemediaobject> In Squid 3.1+ the <emphasis>transparent</emphasis> option has been split. Use <emphasis role="strong">'intercept</emphasis> to catch IPFW packets. </para></listitem></itemizedlist><screen><![CDATA[http_port 3129 intercept]]></screen></section><section><title>rc.firewall.local Configuration</title><screen><![CDATA[# Interface where client requests are coming from
IFACE=eth0
]]><![CDATA[
# The IP Squid is listening on for requests. localhost is safest.
SQUIDIP=127.0.0.1
]]><![CDATA[
# Path to ipfw command
IPFW=/sbin/ipfw
]]><![CDATA[
${IPFW} -f flush
${IPFW} add 60000 permit ip from any to any
${IPFW} add 100 fwd ${SQUIDIP},3129 tcp from any to any 80 recv ${IFACE}]]></screen></section><section><title>Testing</title><para>To test if it worked, use the <emphasis role="strong">nc</emphasis> utility. Stop squid and from the command line as root type in: </para><screen><![CDATA[nc -l 3129]]></screen><para>Then restart squid and try to navigate to a page. </para><para>You should now see an output like this: </para><screen><![CDATA[<root:freebsd> [/root]
> nc -l 3129
GET / HTTP/1.1
User-Agent: Mozilla/5.0 (compatible; GNotify 1.0.25.0)
Host: example.com
Connection: keep-alive
...]]></screen><para>From there on out, just set your browsers up normally with no proxy server, and you should see the cache fill up and your browsing speed up. </para></section><section><title>Troubleshooting</title><section><title>On MacOS X 10.6 traffic does not show up in Squid</title><para><emphasis>by Jeffrey j Donovan</emphasis> </para><para>You need to edit: </para><screen><![CDATA[sysctl -w net.inet.ip.scopedroute=0]]></screen><para>Previous MacOS X set this to 0 by default. On MacOS X 10.6 it now defaults to 1. Disable this and Squid gets the traffic. </para><!--rule (<hr>) is not applicable to DocBook--><para> <ulink url="https://wiki.squid-cache.org/ConfigExamples/Intercept/Ipfw/CategoryConfigExample#">CategoryConfigExample</ulink> </para></section></section></section></article>