<?xml version="1.0" encoding="utf-8"?><!DOCTYPE article  PUBLIC '-//OASIS//DTD DocBook XML V4.4//EN'  'http://www.docbook.org/xml/4.4/docbookx.dtd'><article><articleinfo><title>ConfigExamples/Intercept/OpenBsdPf</title><revhistory><revision><revnumber>19</revnumber><date>2018-02-11 07:46:55</date><authorinitials>AmosJeffries</authorinitials><revremark>add generic NAT disclaimer, use example.com for example domain and remove unnecessary URL strings</revremark></revision><revision><revnumber>18</revnumber><date>2014-07-26 07:22:40</date><authorinitials>AmosJeffries</authorinitials><revremark>mention rdr-to is unsupported</revremark></revision><revision><revnumber>17</revnumber><date>2013-06-20 12:39:11</date><authorinitials>StuartHenderson</authorinitials><revremark>Make it more clear which mode is supported by OS packages. Add debug hints.</revremark></revision><revision><revnumber>16</revnumber><date>2013-06-05 20:15:01</date><authorinitials>StuartHenderson</authorinitials><revremark>switch the link to the port readme to cvs head.</revremark></revision><revision><revnumber>15</revnumber><date>2013-04-16 12:37:53</date><authorinitials>AmosJeffries</authorinitials><revremark>update PF config details with IPv4 and IPv6 specific config lines.</revremark></revision><revision><revnumber>14</revnumber><date>2013-04-16 05:14:44</date><authorinitials>AmosJeffries</authorinitials><revremark>--enable-pf-transparent upgrade has been merged for 3.4</revremark></revision><revision><revnumber>13</revnumber><date>2013-04-10 11:13:40</date><authorinitials>StuartHenderson</authorinitials></revision><revision><revnumber>12</revnumber><date>2013-04-10 11:12:53</date><authorinitials>StuartHenderson</authorinitials><revremark>IPFW mode is default in squid 2.7, it was only made an option in 3.x</revremark></revision><revision><revnumber>11</revnumber><date>2013-04-10 11:09:22</date><authorinitials>StuartHenderson</authorinitials><revremark>divert-to was added in OpenBSD 4.4 not 4.7, also mention that (5.0+) packages are built with --enable-ipfw-transparent</revremark></revision><revision><revnumber>10</revnumber><date>2013-04-02 09:24:09</date><authorinitials>AmosJeffries</authorinitials><revremark>correct TPROXY wikilink</revremark></revision><revision><revnumber>9</revnumber><date>2013-04-02 09:19:07</date><authorinitials>AmosJeffries</authorinitials><revremark>update for current state of PF support in squid-3.3</revremark></revision><revision><revnumber>8</revnumber><date>2011-04-09 12:18:32</date><authorinitials>AmosJeffries</authorinitials><revremark>drop IPFW mention. its broke too.</revremark></revision><revision><revnumber>7</revnumber><date>2011-04-09 12:15:52</date><authorinitials>AmosJeffries</authorinitials><revremark>extra details after feedback from some OpenBSD users and one dev.</revremark></revision><revision><revnumber>6</revnumber><date>2011-04-06 03:31:48</date><authorinitials>AmosJeffries</authorinitials><revremark>rdr is IN traffic not out.</revremark></revision><revision><revnumber>5</revnumber><date>2011-04-06 03:28:14</date><authorinitials>AmosJeffries</authorinitials><revremark>OpenBSD 4.7 has new PF command syntax (unverified)</revremark></revision><revision><revnumber>4</revnumber><date>2008-09-01 04:49:59</date><authorinitials>AmosJeffries</authorinitials><revremark>update text</revremark></revision><revision><revnumber>3</revnumber><date>2008-09-01 04:44:21</date><authorinitials>AmosJeffries</authorinitials><revremark>building intercept section</revremark></revision><revision><revnumber>2</revnumber><date>2008-05-18 19:38:58</date><authorinitials>localhost</authorinitials><revremark>converted to 1.6 markup</revremark></revision><revision><revnumber>1</revnumber><date>2008-04-29 02:50:13</date><authorinitials>AmosJeffries</authorinitials><revremark>import from squid-users contribution.</revremark></revision></revhistory></articleinfo><section><title>Intercepting traffic with PF on OpenBSD</title><para>by Chris Benech and Amos Jeffries </para><para><emphasis role="strong">Warning</emphasis>: Any example presented here is provided &quot;as-is&quot; with no support or guarantee of suitability. If you have any further questions about these examples please email the squid-users mailing list. </para><section><title>Outline</title><para>The Packet Filter (PF) firewall in OpenBSD 4.4 and later offers traffic interception using several very simple methods. </para><para>This configuration example details how to integrate the PF firewall with Squid for interception of port 80 traffic using either NAT-like interception and <ulink url="https://wiki.squid-cache.org/ConfigExamples/Intercept/OpenBsdPf/Features/Tproxy4#">TPROXY-like</ulink> interception. </para><para><emphasis role="strong">NOTE:</emphasis> NAT configuration will only work when used <emphasis role="strong">on the squid box</emphasis>. This is required to perform intercept accurately and securely. To intercept from a gateway machine and direct traffic at a separate squid box use <ulink url="https://wiki.squid-cache.org/ConfigExamples/Intercept/OpenBsdPf/ConfigExamples/Intercept/IptablesPolicyRoute#">policy routing</ulink>. </para><para>More on configuring Squid for OpenBSD can be found in the OpenBSD ports README file: </para><itemizedlist><listitem override="none"><para><ulink url="http://www.openbsd.org/cgi-bin/cvsweb/~checkout~/ports/www/squid/pkg/README-main"/> </para></listitem></itemizedlist></section><section><title>Squid Configuration</title><section><title>Fully Transparent Proxy (TPROXY)</title><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/alert.png" width="15"/></imageobject><textobject><phrase>/!\</phrase></textobject></inlinemediaobject> This configuration requires <ulink url="https://wiki.squid-cache.org/ConfigExamples/Intercept/OpenBsdPf/Squid-3.3#">Squid-3.3.4</ulink> or later. </para></listitem></itemizedlist><para>Squid requires the following build option: </para><screen><![CDATA[--enable-pf-transparent]]></screen><para>Use the <emphasis role="strong">tproxy</emphasis> traffic mode flag to instruct Squid that it is receiving intercepted traffic and to spoof the client IP on outgoing connections: </para><screen><![CDATA[http_port 3129 tproxy]]></screen></section><section><title>NAT Interception proxy</title><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> This is available as standard with the OpenBSD 5.0+ squid port/packages. </para></listitem></itemizedlist><para>For <ulink url="https://wiki.squid-cache.org/ConfigExamples/Intercept/OpenBsdPf/Squid-3.4#">Squid-3.4</ulink> or later: </para><screen><![CDATA[--enable-pf-transparent]]></screen><para>For <ulink url="https://wiki.squid-cache.org/ConfigExamples/Intercept/OpenBsdPf/Squid-3.3#">Squid-3.3</ulink> and <ulink url="https://wiki.squid-cache.org/ConfigExamples/Intercept/OpenBsdPf/Squid-3.2#">Squid-3.2</ulink> support for this is not integrated with the --enable-pf-transparent build option. However the IPFW NAT component of Squid is compatible with PF. You can build Squid with these configure options: </para><screen><![CDATA[--disable-pf-transparent --enable-ipfw-transparent]]></screen><para>For <ulink url="https://wiki.squid-cache.org/ConfigExamples/Intercept/OpenBsdPf/Squid-2.7#">Squid-2.7</ulink>, the default build with no particular configuration options uses the IPFW compatible method. </para><para>Use the <emphasis role="strong">intercept</emphasis> traffic mode flag to instruct Squid that it is receiving intercepted traffic and to use its own IP on outgoing connections (emulating NAT): </para><screen><![CDATA[http_port 3129 intercept]]></screen></section></section><section><title>pf.conf Configuration</title><para>In pf.conf, the following changes need to be made. </para><para>If you have &quot;set skip&quot; lines for your internal interfaces, remove them. They tell PF not to do any processing on packets coming in on those interfaces. </para><screen><![CDATA[set skip on $int_if
set skip on $wi_if]]></screen><section><title>OpenBSD 4.4 and later</title><para>On the machine running Squid, add a firewall rule similar to these... </para><para>For IPv6 traffic interception: </para><screen><![CDATA[pass in quick inet6 proto tcp from 2001:DB8::/32 to port www divert-to ::1 port 3129
pass out quick inet6 from 2001:DB8::/32 divert-reply]]></screen><para>For IPv4 traffic interception: </para><screen><![CDATA[pass in quick on inet proto tcp from 192.0.2.0/24 to port www divert-to 127.0.0.1 port 3129
pass out quick inet from 192.0.2.0/24 divert-reply]]></screen><para><emphasis role="strong">IMPORTANT:</emphasis> The divert-reply rules are needed to receive replies for sockets that are bound to addresses not local to the machine. If there is no divert-reply rule, cache.log will show a line similar to: </para><itemizedlist><listitem override="none"><screen><![CDATA[2013/04/16 14:28:37 kid1|  FD 12, 127.0.0.1 [Stopped, reason:Listener socket closed job49]: (53) Software caused connection abort]]></screen></listitem><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-error.png" width="16"/></imageobject><textobject><phrase>{X}</phrase></textobject></inlinemediaobject> PF offers a <emphasis role="strong">rdr-to</emphasis> option. However this not supported with any Squid. Use <emphasis role="strong">divert-to</emphasis> instead. </para></listitem></itemizedlist></section><section><title>OpenBSD 4.1 to 4.3</title><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-error.png" width="16"/></imageobject><textobject><phrase>{X}</phrase></textobject></inlinemediaobject> NOTE: OpenBSD older than 4.4 requires <ulink url="https://wiki.squid-cache.org/ConfigExamples/Intercept/OpenBsdPf/Squid-3.2#">Squid-3.2</ulink> or older built with <emphasis role="strong">--enable-pf-transparent</emphasis> and only supports the NAT interception method. </para></listitem></itemizedlist><screen><![CDATA[# redirect only IPv4 web traffic into squid
rdr pass inet proto tcp from 192.168.231.0/24 to any port 80 -> 192.168.231.1 port 3129
]]><![CDATA[
block in
pass in quick on $int_if
pass in quick on $wi_if
pass out keep state]]></screen><para>A pointer: </para><itemizedlist><listitem><para>Use <emphasis role="strong">rdr pass</emphasis> instead of <emphasis role="strong">rdr on ...</emphasis>  part of the way that PF evaluates packets, it would drop through and be allowed as is instead of redirected if you don't use <emphasis role="strong">rdr pass</emphasis>. </para></listitem></itemizedlist></section></section><section><title>Troubleshooting</title><itemizedlist><listitem><para>Make sure and add the <emphasis role="strong">pass in quick</emphasis> lines. Myself I have two internal interfaces, one for wired and one for wireless internet. Although there is a bridge configured, strange things happen sometimes when you don't explicitly allow all traffic on both interfaces. If you don't add these lines, you will lose local network connectivity and have to go to the console to figure it out. </para></listitem></itemizedlist><section><title>No redirection is happening</title><para>Make sure you have removed any <emphasis role="strong">set skip on</emphasis> lines which would prevent PF from seeing packets. </para><para>Confirm which PF rules are being used to handle the traffic and ensure that your squid-related rules are not masked by other rules. While debugging, it may be useful to add a logging rule like &quot;match log(matches) from &lt;IP&gt;&quot; to the top of pf.conf. If you then reload the ruleset and monitor the pflog interface (e.g. &quot;tcpdump -neipflog0 -s 500&quot;) you will see a line of output for every rule which matches the packet, making it easier to confirm which rules affect the packets. This logs rule numbers; to lookup a rule by number, use &quot;pfctl -sr -R 1&quot;. </para></section><section><title>PfInterception: PF open failed: (13) Permission denied</title><para>This occurs if you are using --enable-pf-transparent and do not have write access to /dev/pf. It is recommended that you change to the <code>getsockname()</code> interface using &quot;divert-to&quot; pf rules with the following configure options: </para><screen><![CDATA[--disable-pf-transparent --enable-ipfw-transparent]]></screen><para>If you must use --enable-pf-transparent, change permissions on /dev/pf to allow write access to the userid running squid. </para></section></section><section><title>Testing</title><para>To test if it worked, use the <emphasis role="strong">nc</emphasis> utility. Stop squid and from the command line as root type in: </para><screen><![CDATA[nc -l 3129]]></screen><para>Then restart squid and try to navigate to a page. </para><para>You should now see an output like this: </para><screen><![CDATA[<root:openbsd> [/root]
> nc -l 3129
GET / HTTP/1.1
User-Agent: Mozilla/5.0 (compatible; GNotify 1.0.25.0)
Host:  example.com
Connection: keep-alive
...]]></screen><para>From there on out, just set your browsers up normally with no proxy server, and you should see the cache fill up and your browsing speed up. </para><!--rule (<hr>) is not applicable to DocBook--><para> <ulink url="https://wiki.squid-cache.org/ConfigExamples/Intercept/OpenBsdPf/CategoryConfigExample#">CategoryConfigExample</ulink> </para></section></section></article>