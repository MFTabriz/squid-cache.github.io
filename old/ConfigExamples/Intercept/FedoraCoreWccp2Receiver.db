<?xml version="1.0" encoding="utf-8"?><!DOCTYPE article  PUBLIC '-//OASIS//DTD DocBook XML V4.4//EN'  'http://www.docbook.org/xml/4.4/docbookx.dtd'><article><articleinfo><title>ConfigExamples/Intercept/FedoraCoreWccp2Receiver</title><revhistory><revision><revnumber>4</revnumber><date>2009-06-21 10:24:02</date><authorinitials>AmosJeffries</authorinitials><revremark>3.1 uses labels for WCCP now.</revremark></revision><revision><revnumber>3</revnumber><date>2009-04-03 06:56:32</date><authorinitials>AmosJeffries</authorinitials><revremark>add original auther attribution</revremark></revision><revision><revnumber>2</revnumber><date>2009-04-03 06:55:59</date><authorinitials>AmosJeffries</authorinitials><revremark>more specific to Fedora</revremark></revision><revision><revnumber>1</revnumber><date>2009-04-03 06:55:33</date><authorinitials>AmosJeffries</authorinitials><revremark>import from FAQ page</revremark></revision></revhistory></articleinfo><section><title>Configuring Transparent Interception with Fedora Core Linux and WCCPv2</title><itemizedlist><listitem override="none"><para><emphasis>by <ulink url="https://wiki.squid-cache.org/ConfigExamples/Intercept/FedoraCoreWccp2Receiver/ReubenFarrelly#">ReubenFarrelly</ulink></emphasis> </para></listitem></itemizedlist><para><emphasis role="strong">Warning</emphasis>: Any example presented here is provided &quot;as-is&quot; with no support or guarantee of suitability. If you have any further questions about these examples please email the squid-users mailing list. </para><section><title>Outline</title><para>This configuration for a Fedora Core Linux 2.6.18 box running Squid and receiving WCCPv2 traffic through ip_gre. It is expected that another device will perform the WCCPv2 routing and forward it to this box for processing. </para></section><section><title>Fedora Core WCCPv2 configuration</title><para>The GRE packets are sourced from one of the IPs on the router - I'm guessing its the &quot;Router Identifier&quot;. This may not be the local ethernet IP (so in this case it isn't 192.168.1.1.) </para><section><title>/etc/sysctl.conf</title><screen><![CDATA[# Controls IP packet forwarding
net.ipv4.ip_forward = 1
# Controls source route verification
net.ipv4.conf.default.rp_filter = 0
# Do not accept source routing
net.ipv4.conf.default.accept_source_route = 0]]></screen></section><section><title>/etc/sysconfig/network-scripts/ifcfg-gre0</title><screen><![CDATA[DEVICE=gre0
BOOTPROTO=static
IPADDR=172.16.1.6
NETMASK=255.255.255.252
ONBOOT=yes
IPV6INIT=no]]></screen><para>By configuring the interface like this, it automatically comes up at boot, and the module is loaded automatically.  I can additionally ifup or ifdown the interface at will.  This is the standard Fedora way of configuring a GRE interface. </para><itemizedlist><listitem><para>I build customised kernels for my hardware, so I have this set in my kernel .config: </para></listitem></itemizedlist><screen><![CDATA[CONFIG_NET_IPGRE=m]]></screen><para>However you can optionally build the GRE tunnel into your kernel by selecting 'y' instead. </para></section></section><section><title>Fedora Core Intercept configuration</title><para>Then you need to redirect the packets coming in the gre0 interface to the Squid application. </para><section><title>/etc/sysconfig/iptables</title><screen><![CDATA[-A PREROUTING -s 192.168.0.0/255.255.255.0 -d ! 192.168.0.0/255.255.255.0 -i gre0 -p tcp -m tcp --dport 80 -j DNAT --to-destination $SQUIDIP:3127]]></screen></section></section><section><title>Squid Configuration File</title><screen><![CDATA[http_port 3127 transparent
wccp2_router $ROUTERIP
# GRE forwarding
wccp2_forwarding_method 1
# GRE return method
wccp2_return_method 1
wccp2_service standard 0]]></screen><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> From <ulink url="https://wiki.squid-cache.org/ConfigExamples/Intercept/FedoraCoreWccp2Receiver/Squid-3.1#">Squid-3.1</ulink> the magic numbers are now mostly gone. This should work and be clearer: </para></listitem></itemizedlist><screen><![CDATA[wccp2_forwarding_method gre
wccp2_return_method gre]]></screen></section><section><title>What does it all look like?</title><itemizedlist><listitem><para>my operating system runs a GRE tunnel which looks like this: </para></listitem></itemizedlist><screen><![CDATA[[root@tornado squid]# ifconfig gre0
gre0      Link encap:UNSPEC  HWaddr 00-00-00-00-00-00-00-00-00-00-00-00-00-00-00-00
          inet addr:172.16.1.6  Mask:255.255.255.252
          UP RUNNING NOARP  MTU:1476  Metric:1
          RX packets:449 errors:0 dropped:0 overruns:0 frame:0
          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:0
          RX bytes:20917 (20.4 KiB)  TX bytes:0 (0.0 b)]]></screen><itemizedlist><listitem><para>my router sees the cache engine, and tells me how much traffic it has switched through to the cache: </para></listitem></itemizedlist><screen><![CDATA[router#show ip wccp web-cache
Global WCCP information:
    Router information:
        Router Identifier:                   172.16.1.5
        Protocol Version:                    2.0
    Service Identifier: web-cache
        Number of Service Group Clients:     1
        Number of Service Group Routers:     1
        Total Packets s/w Redirected:        1809
          Process:                           203
          Fast:                              1606
          CEF:                               0
        Redirect access-list:                -none-
        Total Packets Denied Redirect:       0
        Total Packets Unassigned:            0
        Group access-list:                   -none-
        Total Messages Denied to Group:      0
        Total Authentication failures:       0
        Total Bypassed Packets Received:     0
router#
router#show ip wccp web-cache detail
WCCP Client information:
        WCCP Client ID:          192.168.0.5
        Protocol Version:        2.0
        State:                   Usable
        Initial Hash Info:       00000000000000000000000000000000
                                 00000000000000000000000000000000
        Assigned Hash Info:      FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
                                 FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
        Hash Allotment:          256 (100.00%)
        Packets s/w Redirected:  449
        Connect Time:            13:51:42
        Bypassed Packets
          Process:               0
          Fast:                  0
          CEF:                   0
router#]]></screen><!--rule (<hr>) is not applicable to DocBook--><para> <ulink url="https://wiki.squid-cache.org/ConfigExamples/Intercept/FedoraCoreWccp2Receiver/CategoryConfigExample#">CategoryConfigExample</ulink> </para></section></section></article>