<?xml version="1.0" encoding="utf-8"?><!DOCTYPE article  PUBLIC '-//OASIS//DTD DocBook XML V4.4//EN'  'http://www.docbook.org/xml/4.4/docbookx.dtd'><article><articleinfo><title>ConfigExamples/MultiplePortsWithWccp2</title><revhistory><revision><revnumber>8</revnumber><date>2009-10-13 23:56:32</date><authorinitials>AmosJeffries</authorinitials><revremark>use inter-wiki links for config options</revremark></revision><revision><revnumber>7</revnumber><date>2009-10-13 23:54:22</date><authorinitials>AmosJeffries</authorinitials><revremark>use documentation IPs 192.0.2.*</revremark></revision><revision><revnumber>6</revnumber><date>2008-05-18 19:38:56</date><authorinitials>localhost</authorinitials><revremark>converted to 1.6 markup</revremark></revision><revision><revnumber>5</revnumber><date>2006-09-24 01:43:12</date><authorinitials>rpivato</authorinitials><revremark>conforming to new category/template scheme</revremark></revision><revision><revnumber>4</revnumber><date>2006-09-13 16:13:29</date><authorinitials>kinkie</authorinitials><revremark>CamelCase fixups</revremark></revision><revision><revnumber>3</revnumber><date>2006-09-13 13:52:58</date><authorinitials>AdrianChadd</authorinitials></revision><revision><revnumber>2</revnumber><date>2006-09-13 13:45:59</date><authorinitials>AdrianChadd</authorinitials></revision><revision><revnumber>1</revnumber><date>2006-09-13 13:45:07</date><authorinitials>AdrianChadd</authorinitials></revision></revhistory></articleinfo><section><title>Configuring multiple interception ports using WCCPv2</title><para>By <ulink url="https://wiki.squid-cache.org/ConfigExamples/MultiplePortsWithWccp2/AdrianChadd#">AdrianChadd</ulink> </para><para><emphasis role="strong">Warning</emphasis>: Any example presented here is provided &quot;as-is&quot; with no support or guarantee of suitability. If you have any further questions about these examples please email the squid-users mailing list. </para><section><title>Outline</title><para>The Squid WCCPv2 implementation can intercept more than TCP port 80. The currrent implementation can create multiple arbitrary TCP and UDP ports. </para><para>There are a few caveats: </para><itemizedlist><listitem><para>Squid will have to be configured to listen on each port - the <ulink url="http://www.squid-cache.org/Doc/config/wccp2_service#">wccp2_service</ulink> configuration only tells WCCPv2 what to do, not Squid; </para></listitem><listitem><para>WCCPv2 (as far as I know) can't be told to redirect random dynamic TCP sessions, only &quot;fixed&quot; service ports - so it can't intercept and cache the FTP data streams; </para></listitem><listitem><para>You could use Squid to advertise services which are handled by &quot;other&quot; software running on the server (for example, if you had a RealServer proxy which functioned you could use Squid to cache the web traffic and announce the RealMedia port interception and RealMedia to proxy.) </para></listitem></itemizedlist></section><section><title>Example</title><para>Here is an example of redirecting port 80 and port 8080 traffic to a Squid proxy server. </para><section><title>Cisco configuration</title><para>This configures a dynamic service group - group 80 - which is handed a bunch of details by the neighbour caches. I chose 80 because its &quot;web and some other stuff&quot;, but it doesn't have to be 80 and it doesn't have to involve http (tcp port 80.) It could be 90, or 100, or 123. </para><screen><![CDATA[!                                                                                                                                        
ip wccp 80                                                                                                                               
!                                                                                                                                        
interface FastEthernet0/1                                                                                                                
 ip address 192.0.2.1 255.255.255.0                                                                                                    
 ip wccp 80 redirect in                                                                                                                  
 ip nat inside                                                                                                                           
 ip virtual-reassembly                                                                                                                   
 duplex auto                                                                                                                             
 speed auto                                                                                                                              
!                                                                                                                                        ]]></screen></section><section><title>Squid configuration</title><para>This configuration covers the interception part - this Squid sits behind a NATted interface that is WCCPv2 intercepted. The Squid server sits on two network interfaces: an external interface with real a IP address that squid binds to with <ulink url="http://www.squid-cache.org/Doc/config/tcp_outgoing_address#">tcp_outgoing_address</ulink>, and the internal 192.0.2.0/24 WCCPv2 intercept + NAT'ted address. </para><screen><![CDATA[wccp2_service dynamic 80                                                                                                                 
wccp2_service_info 80 protocol=tcp priority=240 ports=80,8000,2080                                                                       
                                                                                                                                         
wccp2_router 192.0.2.1:2048                                                                                                            
                                                                                                                                         
http_port 192.0.2.10:3128 transparent vport=80                                                                                         
http_port 192.0.2.10:8000 transparent vport=8000                                                                                       
http_port 192.0.2.10:2080 transparent vport=2080                                                                                       ]]></screen></section><section><title>Linux interception configuration</title><para>eth0 is the external (public) IP address; eth1 is the internal IP address which is being WCCPv2 intercepted. </para><screen><![CDATA[ip tunnel add gre0 mode gre remote 192.0.2.1 local 192.0.2.10 dev eth1
ifconfig gre0 inet 192.0.2.4 netmask 255.255.255.0 up
echo 1 > /proc/sys/net/ipv4/ip_forward
echo 0 > /proc/sys/net/ipv4/conf/default/rp_filter
echo 0 > /proc/sys/net/ipv4/conf/all/rp_filter
echo 0 > /proc/sys/net/ipv4/conf/eth0/rp_filter
echo 0 > /proc/sys/net/ipv4/conf/eth1/rp_filter
echo 0 > /proc/sys/net/ipv4/conf/lo/rp_filter
echo 0 > /proc/sys/net/ipv4/conf/gre0/rp_filter
]]><![CDATA[
iptables -F -t nat
iptables -t nat -A PREROUTING -i gre0 -p tcp -m tcp --dport 80 -j DNAT --to-destination 192.0.2.10:3128
iptables -t nat -A PREROUTING -i gre0 -p tcp -m tcp --dport 8000 -j DNAT --to-destination 192.0.2.10:8000
iptables -t nat -A PREROUTING -i gre0 -p tcp -m tcp --dport 2080 -j DNAT --to-destination 192.0.2.10:2080]]></screen><!--rule (<hr>) is not applicable to DocBook--><para> <ulink url="https://wiki.squid-cache.org/ConfigExamples/MultiplePortsWithWccp2/CategoryConfigExample#">CategoryConfigExample</ulink> </para></section></section></section></article>