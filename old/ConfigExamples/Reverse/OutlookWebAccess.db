<?xml version="1.0" encoding="utf-8"?><!DOCTYPE article  PUBLIC '-//OASIS//DTD DocBook XML V4.4//EN'  'http://www.docbook.org/xml/4.4/docbookx.dtd'><article><articleinfo><title>ConfigExamples/Reverse/OutlookWebAccess</title><revhistory><revision><revnumber>12</revnumber><date>2012-01-04 07:19:15</date><authorinitials>AmosJeffries</authorinitials><revremark>add accel since we recommend that now.</revremark></revision><revision><revnumber>11</revnumber><date>2011-05-05 15:09:17</date><authorinitials>AmosJeffries</authorinitials><revremark>ActiveSync phone issues tracked down to 100-continue breakage.</revremark></revision><revision><revnumber>10</revnumber><date>2011-01-27 03:37:57</date><authorinitials>AmosJeffries</authorinitials><revremark>emphasise the cache_peer uses client cert. wiki links.</revremark></revision><revision><revnumber>9</revnumber><date>2009-02-14 23:43:47</date><authorinitials>AmosJeffries</authorinitials><revremark>include location warning</revremark></revision><revision><revnumber>8</revnumber><date>2009-02-04 06:54:58</date><authorinitials>AmosJeffries</authorinitials><revremark>revers proxy config</revremark></revision><revision><revnumber>7</revnumber><date>2009-01-18 00:58:37</date><authorinitials>AmosJeffries</authorinitials><revremark>3.1 connection auth fails with this config.</revremark></revision><revision><revnumber>6</revnumber><date>2008-06-16 03:07:41</date><authorinitials>AmosJeffries</authorinitials><revremark>... missed one part</revremark></revision><revision><revnumber>5</revnumber><date>2008-06-16 03:05:53</date><authorinitials>AmosJeffries</authorinitials><revremark>domain and peer name-id do not have to be identical</revremark></revision><revision><revnumber>4</revnumber><date>2008-05-18 19:38:58</date><authorinitials>localhost</authorinitials><revremark>converted to 1.6 markup</revremark></revision><revision><revnumber>3</revnumber><date>2008-01-28 03:40:06</date><authorinitials>AmosJeffries</authorinitials><revremark>Private OWA IP should never be requested with peering config. (ony with old redirect config)</revremark></revision></revhistory></articleinfo><section><title>Configuring Squid as an accelerator/SSL offload for Outlook Web Access</title><para><emphasis role="strong">Warning</emphasis>: Any example presented here is provided &quot;as-is&quot; with no support or guarantee of suitability. If you have any further questions about these examples please email the squid-users mailing list. </para><section><title>Outline</title><para>Squid can be easily used to provide SSL acceleration services for Outlook Web Access. It can also speak SSL to the backend Exchange server. Later versions of Squid-2.6 support all the methods used by WebDAV by default. Please consider upgrading to at least the latest Squid-2.6 STABLE release before attempting this. </para></section><section><title>Setup</title><para>The example situation involves a single Outlook Web Access server and a single Squid server. The following information is required: </para><itemizedlist><listitem><para>The IP of the Squid server (ip_of_squid) </para></listitem><listitem><para>The 'public' domain used for Outlook Web Access (owa_domain_name) </para></listitem><listitem><para>The IP of the Outlook Web Access server (ip_of_owa_server) </para></listitem></itemizedlist></section><section><title>Configuration</title><informaltable><tgroup cols="2"><colspec colname="col_0"/><colspec colname="col_1"/><tbody><row rowsep="1"><entry colsep="1" rowsep="1"><para> <inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/alert.png" width="15"/></imageobject><textobject><phrase>/!\</phrase></textobject></inlinemediaobject> </para></entry><entry colsep="1" rowsep="1"><para> This configuration <emphasis role="strong">MUST</emphasis> appear at the top of squid.conf above any other forward-proxy configuration (http_access etc). Otherwise the standard proxy access rules block some people viewing the accelerated site. </para></entry></row></tbody></tgroup></informaltable><para>Please note that the <ulink url="http://www.squid-cache.org/Doc/config/https_port#">https_port</ulink> and <ulink url="http://www.squid-cache.org/Doc/config/cache_peer#">cache_peer</ulink> lines may wrap in your browser! </para><screen><![CDATA[https_port ip_of_squid:443 accel cert=/path/to/certificate/ defaultsite=owa_domain_name
]]><![CDATA[
cache_peer ip_of_owa_server parent 80 0 no-query originserver login=PASS front-end-https=on name=owaServer
]]><![CDATA[
acl OWA dstdomain owa_domain_name
cache_peer_access owaServer allow OWA
never_direct allow OWA
]]><![CDATA[
# lock down access to only query the OWA server!
http_access allow OWA
http_access deny all
miss_access allow OWA
miss_access deny all]]></screen><para>If the connection to the OWA server requires SSL then the <ulink url="http://www.squid-cache.org/Doc/config/cache_peer#">cache_peer</ulink> line should be changed appropriately: </para><screen><![CDATA[cache_peer ip_of_owa_server parent 443 0 no-query originserver login=PASS ssl sslcert=/path/to/client-certificate name=owaServer]]></screen><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/idea.png" width="15"/></imageobject><textobject><phrase>(!)</phrase></textobject></inlinemediaobject> an apparent bug in Squid-3.1 means that <ulink url="http://www.squid-cache.org/Doc/config/https_port#">https_port</ulink> may also need to use the <emphasis role="strong">connection-auth=off</emphasis> option for now. </para></listitem></itemizedlist></section><section><title>Troubleshooting</title><section><title>OWA works but ActiveSync fails</title><para>Windows Phone says <emphasis role="strong">&quot;Connection error. Try again later.&quot;</emphasis> and current status shows <code>&quot;Unable to connect. Retrying.&quot;</code> </para><para>PROBLEM:  </para><itemizedlist><listitem override="none"><para>The device sending <emphasis role="strong">Expect: 100-continue</emphasis> HTTP/1.1 headers, but being unable to retry correctly when presented with the <emphasis role="strong">417</emphasis> response. </para></listitem></itemizedlist><para>SOLUTION: </para><itemizedlist><listitem override="none"><para><ulink url="https://wiki.squid-cache.org/ConfigExamples/Reverse/OutlookWebAccess/Squid-2.7#">Squid-2.7</ulink> and <ulink url="https://wiki.squid-cache.org/ConfigExamples/Reverse/OutlookWebAccess/Squid-3.1#">Squid-3.1</ulink> offer the <ulink url="http://www.squid-cache.org/Doc/config/ignore_expect_100#">ignore_expect_100</ulink> directive to skip the 417 and wait for the client to resume. There are potential DoS side effects to its use, please avoid unless you must. </para><para><ulink url="https://wiki.squid-cache.org/ConfigExamples/Reverse/OutlookWebAccess/Squid-3.2#">Squid-3.2</ulink> supports the HTTP/1.1 feature these clients depend on. This problem will not occur there. </para></listitem></itemizedlist></section></section><section><title>See also</title><itemizedlist><listitem><para><ulink url="http://support.microsoft.com/?scid=kb%3Ben-us%3B327800&amp;x=17&amp;y=16"/> - &quot;How to configure SSL Offloading for Outlook Web Access in Exchange 2000 Server and in Exchange Server 2003&quot; </para></listitem></itemizedlist></section><section><title>Thanks</title><para>Thanks to Tuukka Laurikainen &lt;<ulink url="mailto:t.laurikainen@ibermatica.com">t.laurikainen@ibermatica.com</ulink>&gt; for providing the background information for this article. </para><!--rule (<hr>) is not applicable to DocBook--><para> <ulink url="https://wiki.squid-cache.org/ConfigExamples/Reverse/OutlookWebAccess/CategoryConfigExample#">CategoryConfigExample</ulink> </para></section></section></article>