<?xml version="1.0" encoding="utf-8"?><!DOCTYPE article  PUBLIC '-//OASIS//DTD DocBook XML V4.4//EN'  'http://www.docbook.org/xml/4.4/docbookx.dtd'><article><articleinfo><title>ConfigExamples/Reverse/VirtualHosting</title><revhistory><revision><revnumber>5</revnumber><date>2012-05-07 23:20:58</date><authorinitials>AmosJeffries</authorinitials><revremark>sync http_port option definitions with BasicAccelerator</revremark></revision><revision><revnumber>4</revnumber><date>2012-05-07 23:12:33</date><authorinitials>AmosJeffries</authorinitials><revremark>mention default-on vhost support in squid-3.2 and later.</revremark></revision><revision><revnumber>3</revnumber><date>2009-02-15 00:01:38</date><authorinitials>AmosJeffries</authorinitials><revremark>include location warning.</revremark></revision><revision><revnumber>2</revnumber><date>2009-02-15 00:00:04</date><authorinitials>AmosJeffries</authorinitials><revremark>include chunk of config from basic setup.</revremark></revision><revision><revnumber>1</revnumber><date>2009-02-01 06:57:51</date><authorinitials>AmosJeffries</authorinitials><revremark>import from FAQ</revremark></revision></revhistory></articleinfo><section><title>Reverse Proxy with HTTP/1.1 Domain Based Virtual Host Support</title><para><emphasis role="strong">Warning</emphasis>: Any example presented here is provided &quot;as-is&quot; with no support or guarantee of suitability. If you have any further questions about these examples please email the squid-users mailing list. </para><itemizedlist><listitem override="none"><informaltable><tgroup cols="2"><colspec colname="col_0"/><colspec colname="col_1"/><tbody><row rowsep="1"><entry colsep="1" rowsep="1"><para> <inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> NOTE: </para></entry><entry colsep="1" rowsep="1"><para> This configuration is for <ulink url="https://wiki.squid-cache.org/ConfigExamples/Reverse/VirtualHosting/Squid-3.1#">Squid-3.1</ulink> and older which are HTTP/1.0 proxies. </para><para> <ulink url="https://wiki.squid-cache.org/ConfigExamples/Reverse/VirtualHosting/Squid-3.2#">Squid-3.2</ulink> has virtual hosting support enabled by default as part of HTTP/1.1. </para></entry></row></tbody></tgroup></informaltable></listitem></itemizedlist><section><title>Squid Configuration</title><informaltable><tgroup cols="2"><colspec colname="col_0"/><colspec colname="col_1"/><tbody><row rowsep="1"><entry colsep="1" rowsep="1"><para> <inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/alert.png" width="15"/></imageobject><textobject><phrase>/!\</phrase></textobject></inlinemediaobject> </para></entry><entry colsep="1" rowsep="1"><para> This configuration <emphasis role="strong">MUST</emphasis> appear at the top of squid.conf above any other forward-proxy configuration (http_access etc). Otherwise the standard proxy access rules block some people viewing the accelerated site. </para></entry></row></tbody></tgroup></informaltable><para>If you are using <ulink url="https://wiki.squid-cache.org/ConfigExamples/Reverse/VirtualHosting/Squid-3.1#">Squid-3.1</ulink> or older has an accelerator for a domain based virtual host system then you need to additionally specify the <emphasis role="strong">vhost</emphasis> option to <ulink url="http://www.squid-cache.org/Doc/config/http_port#">http_port</ulink> </para><screen><![CDATA[http_port 80 accel defaultsite=your.main.website.name vhost]]></screen><itemizedlist><listitem><para><emphasis role="strong">accel</emphasis> tells Squid to handle requests coming in this port as if it was a Web Server </para></listitem><listitem><para><emphasis role="strong">defaultsite=X</emphasis> tells Squid to assume the domain <emphasis>X</emphasis> is wanted. </para></listitem><listitem><para><emphasis role="strong">vhost</emphasis> for <ulink url="https://wiki.squid-cache.org/ConfigExamples/Reverse/VirtualHosting/Squid-3.1#">Squid-3.1</ulink> or older enables HTTP/1.1 domain based virtual hosting support. Omit this option for <ulink url="https://wiki.squid-cache.org/ConfigExamples/Reverse/VirtualHosting/Squid-3.2#">Squid-3.2</ulink> or later versions. </para></listitem></itemizedlist><para>When both defaultsite and vhost is specified, defaultsite specifies the domain name old HTTP/1.0 clients not sending a Host header should be sent to. Squid will run fine if you only use vhost, but there is still some software out there not sending Host headers so it's recommended to specify defaultsite as well. If defaultsite is not specified those clients will get an &quot;Invalid request&quot; error. </para><para>Next, you need to tell Squid where to find the real web server: </para><screen><![CDATA[cache_peer backend.webserver.ip.or.dnsname parent 80 0 no-query originserver name=myAccel]]></screen><para>And finally you need to set up access controls to allow access to your site without pushing other web requests to your web server. </para><screen><![CDATA[acl our_sites dstdomain your.main.website.name
http_access allow our_sites
cache_peer_access myAccel allow our_sites
cache_peer_access myAccel deny all]]></screen><para>You should now be able to start Squid and it will serve requests as a HTTP server. </para><section><title>Testing and Live</title><para>Testing of reverse-proxies should be done with Squid configured properly as it would be used in production. But the public DNS setting not pointing at it. The /etc/hosts file of a test machine can be altered to send test requests to the squid IP instead of the live webserver. </para><para>When that testing works, public DNS can be updated to send public requests to the Squid proxy instead of the master web server and Acceleration will begin immediately. </para></section><!--rule (<hr>) is not applicable to DocBook--><para> <ulink url="https://wiki.squid-cache.org/ConfigExamples/Reverse/VirtualHosting/CategoryConfigExample#">CategoryConfigExample</ulink> </para></section></section></article>