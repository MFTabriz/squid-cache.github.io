<?xml version="1.0" encoding="utf-8"?><!DOCTYPE article  PUBLIC '-//OASIS//DTD DocBook XML V4.4//EN'  'http://www.docbook.org/xml/4.4/docbookx.dtd'><article><articleinfo><title>ConfigExamples/Reverse/HttpsVirtualHosting</title><revhistory><revision><revnumber>2</revnumber><date>2020-08-26 04:23:40</date><authorinitials>AmosJeffries</authorinitials><revremark>typo fix</revremark></revision><revision><revnumber>1</revnumber><date>2018-10-21 16:33:42</date><authorinitials>AmosJeffries</authorinitials><revremark>initial documentation - based on VirtualHosting example.</revremark></revision></revhistory></articleinfo><section><title>Reverse Proxy with HTTPS Virtual Host Support</title><para><emphasis role="strong">Warning</emphasis>: Any example presented here is provided &quot;as-is&quot; with no support or guarantee of suitability. If you have any further questions about these examples please email the squid-users mailing list. </para><section><title>Usage</title><para>This configuration example documents how to configure a Squid proxy to receive HTTPS traffic for multiple domains when it is acting as a &quot;reverse-proxy&quot; (aka CDN frontend or gateway proxy). </para><para>This configuration is for <ulink url="https://wiki.squid-cache.org/ConfigExamples/Reverse/HttpsVirtualHosting/Squid-4#">Squid-4</ulink> and newer which have been built with GnuTLS support. Older Squid versions and Squid built with OpenSSL support cannot be configured this way. </para></section><section><title>Squid Configuration</title><screen><![CDATA[https_port 443 accel defaultsite=example.net \
    tls-cert=/etc/squid/tls/example.net.pem \
    tls-cert=/etc/squid/tls/example.com.pem \
    tls-cert=/etc/squid/tls/example.org.pem]]></screen><itemizedlist><listitem><para><emphasis role="strong">accel</emphasis> tells Squid to handle requests coming in this port as if it was a Web Server. </para></listitem><listitem><para><emphasis role="strong">defaultsite=X</emphasis> tells Squid to assume the domain <emphasis>X</emphasis> is wanted if it cannot identify which domain is wanted. </para><itemizedlist><listitem override="none"><para>Squid will run fine without <emphasis role="strong">defaultsite=X</emphasis>, but there is still some software out there not sending Host headers so it's recommended to specify. </para></listitem><listitem override="none"><para>If defaultsite is not specified those clients will get an &quot;Invalid request&quot; error. </para></listitem></itemizedlist></listitem><listitem><para><emphasis role="strong">tls-cert=X</emphasis> should point to a PEM format file containing the certificate, private key, and any required intermediate CA certificate(s) for one domain. </para><itemizedlist><listitem override="none"><para>If multiple different domains details are included in one PEM file only the first will be used. </para></listitem><listitem override="none"><para>The CA certificates are expected to be in order with each CA verifying the previous cert or CA in the file. CA which do not meet this criteria are ignored. </para></listitem></itemizedlist></listitem></itemizedlist><para>Next, you need to tell Squid where to find the real web server: </para><screen><![CDATA[cache_peer backend.webserver.ip.or.dnsname parent 80 0 no-query originserver name=myAccel]]></screen><para>And finally you need to set up access controls to allow access to your site without pushing other web requests to your web server. </para><screen><![CDATA[acl our_sites dstdomain your.main.website.name
http_access allow our_sites
cache_peer_access myAccel allow our_sites
cache_peer_access myAccel deny all]]></screen><para>You should now be able to start Squid and it will serve requests as a HTTP server. </para><section><title>Testing and Live</title><para>Testing of reverse-proxies should be done with Squid configured properly as it would be used in production. But the public DNS setting not pointing at it. The /etc/hosts file of a test machine can be altered to send test requests to the squid IP instead of the live webserver. </para><para>When that testing works, public DNS can be updated to send public requests to the Squid proxy instead of the master web server and Acceleration will begin immediately. </para></section><!--rule (<hr>) is not applicable to DocBook--><para> <ulink url="https://wiki.squid-cache.org/ConfigExamples/Reverse/HttpsVirtualHosting/CategoryConfigExample#">CategoryConfigExample</ulink> </para></section></section></article>