<?xml version="1.0" encoding="utf-8"?><!DOCTYPE article  PUBLIC '-//OASIS//DTD DocBook XML V4.4//EN'  'http://www.docbook.org/xml/4.4/docbookx.dtd'><article><articleinfo><title>ConfigExamples/CoinMiners</title><revhistory><revision><revnumber>7</revnumber><date>2021-07-03 11:20:16</date><authorinitials>FrancescoChemolli</authorinitials></revision><revision><revnumber>6</revnumber><date>2018-01-02 13:30:40</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>5</revnumber><date>2018-01-02 13:26:50</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>4</revnumber><date>2018-01-02 13:22:11</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>3</revnumber><date>2018-01-02 13:18:01</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>2</revnumber><date>2018-01-02 13:17:14</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>1</revnumber><date>2018-01-02 13:06:03</date><authorinitials>YuriVoinov</authorinitials></revision></revhistory></articleinfo><para><emphasis>by <ulink url="https://wiki.squid-cache.org/ConfigExamples/CoinMiners/YuriVoinov#">YuriVoinov</ulink></emphasis> </para><section><title>Coin Miners Filtering</title><para><emphasis role="strong">Warning</emphasis>: Any example presented here is provided &quot;as-is&quot; with no support or guarantee of suitability. If you have any further questions about these examples please email the squid-users mailing list. </para><section><title>Outline</title><para>Malware coin-mining scripts is modern trend to use foreign CPU/memory resources without explicit user's permission. This is actual problem, which can be suppressed by browser's plugin. However, it is requires to install add-ons manually, and impossible in some cases. </para></section><section><title>Usage</title><para>To protect users from coin miners it is enough to set-up gateway to block communications between malware JS and mining pools. This will disable coin miners on client-side. </para></section><section><title>More</title><para>In any case, to achieve this goal, you should set up SSL Bump-aware Squid. Since over 80% of HTTP traffic, the proxy does not make sense without the inspection of encrypted traffic. Do not forget about security - such a proxy should not reduce security and its cache should be protected from unauthorized access, as well as logs. </para><para>The most convenient way to implement protection against miners is using <ulink url="https://urlfilterdb.com">ufdbguard</ulink>. But if, by any reason, you don't want to use redirector, you can simple use squid's acl (dstdomain, for example). </para></section><section><title>Squid Configuration File</title><para>Paste the configuration file like this: </para><screen><![CDATA[# ufdbGuard rewriter
url_rewrite_program /usr/local/ufdbguard/bin/ufdbgclient -m 4
url_rewrite_children 64 startup=8 idle=4 concurrency=4
url_rewrite_extras "%>a/%>A %un %>rm bump_mode=%ssl::bump_mode sni=\"%ssl::>sni\" referer=\"%{Referer}>h\""
url_rewrite_access allow all
url_rewrite_bypass off]]></screen><para>You can find updateable coin miners list <ulink url="https://raw.githubusercontent.com/Marfjeh/coinhive-block/master/domains">here</ulink>. </para><para>To automate updates with cron, you can use <ulink url="https://wiki.squid-cache.org/ConfigExamples/CoinMiners/ConfigExamples/CoinMiners?action=AttachFile&amp;do=get&amp;target=update_miners.sh">this script</ulink>: </para><screen><![CDATA[#
# Convert the miners server listing
# into an ufdbGuard domains.
# Modified by Y.Voinov (c) 2014,2018
]]><![CDATA[
# Variables
dst_dir="/usr/local/ufdbguard/blacklists/miners"
work_dir="/tmp"
filteruser="ufdb"
filtergroup="ufdb"
]]><![CDATA[
# OS commands
AWK=`which awk`
CHOWN=`which chown`
ECHO=`which echo`
GREP=`which grep`
MV=`which mv`
PRINTF=`which printf`
TOUCH=`which touch`
WGET=`which wget`
]]><![CDATA[
$ECHO "List downloading..."
$WGET -O $work_dir/miners "https://raw.githubusercontent.com/Marfjeh/coinhive-block/master/domains" && \
$ECHO "Move to blacklists directory..."
$MV $work_dir/miners $dst_dir/domains
]]><![CDATA[
# Change permission
$PRINTF "Set permissions..."
$CHOWN $filteruser:$filtergroup $dst_dir/domains
$ECHO "Done."
]]><![CDATA[
# Update date'n-time
$PRINTF "Update date and time to current..."
$TOUCH $dst_dir/*
$ECHO "Done."
#]]></screen></section><section><title>ufdbguard configuration</title><para>Add category to ufdbguard.conf: </para><screen><![CDATA[category miners {
        domainlist "miners/domains"
        redirect "http://your_proxy_FQDN:8080/cgi-bin/URLblocked.cgi?clientgroup=%s&clientaddr=%a&category=%t&url=%u"
}]]></screen><para>Then add <emphasis role="strong">!miners</emphasis> to ufdbguard ACL(s). Don't forget to compile miners database and restart ufdbguardd. </para><para>Also, don't forget to configure ufdbguard to work with bump-enabled Squid: </para><screen><![CDATA[redirect-bumped-https "https://your_proxy_FQDN:4443/cgi-bin/URLblocked.cgi?clientgroup=%s&clientaddr=%a&category=%t&url=%u"]]></screen><para>and make sure you redirection web-server has configured SSL. </para></section><section><title>Testing your setup</title><para>Just visit <ulink url="https://mineblock.org/">this site</ulink>. You should see <ulink url="https://wiki.squid-cache.org/ConfigExamples/CoinMiners/ConfigExamples/CoinMiners?action=AttachFile&amp;do=get&amp;target=C89L68e.png">this picture</ulink>. </para><!--rule (<hr>) is not applicable to DocBook--><para> <ulink url="https://wiki.squid-cache.org/ConfigExamples/CoinMiners/CategoryConfigExample#">CategoryConfigExample</ulink> </para></section></section></article>