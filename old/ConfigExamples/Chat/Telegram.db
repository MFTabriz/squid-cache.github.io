<?xml version="1.0" encoding="utf-8"?><!DOCTYPE article  PUBLIC '-//OASIS//DTD DocBook XML V4.4//EN'  'http://www.docbook.org/xml/4.4/docbookx.dtd'><article><articleinfo><title>ConfigExamples/Chat/Telegram</title><revhistory><revision><revnumber>27</revnumber><date>2021-07-03 09:50:23</date><authorinitials>FrancescoChemolli</authorinitials></revision><revision><revnumber>26</revnumber><date>2019-04-19 13:32:44</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>25</revnumber><date>2019-04-19 13:32:08</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>24</revnumber><date>2019-04-19 13:30:53</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>23</revnumber><date>2019-04-19 13:23:58</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>22</revnumber><date>2019-04-19 13:21:38</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>21</revnumber><date>2019-04-19 13:20:05</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>20</revnumber><date>2018-09-01 18:24:57</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>19</revnumber><date>2018-09-01 18:23:58</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>18</revnumber><date>2018-07-03 13:20:11</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>17</revnumber><date>2018-07-03 13:11:01</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>16</revnumber><date>2018-04-20 14:31:23</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>15</revnumber><date>2018-04-20 14:30:53</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>14</revnumber><date>2018-04-18 13:53:24</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>13</revnumber><date>2018-04-18 13:52:06</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>12</revnumber><date>2018-04-08 00:15:56</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>11</revnumber><date>2017-05-18 15:18:32</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>10</revnumber><date>2017-01-10 21:44:20</date><authorinitials>AmosJeffries</authorinitials><revremark>fix grammer and spelling. rearrange to prevent duplication of info and clarify the multiple &quot;more&quot; sections</revremark></revision><revision><revnumber>9</revnumber><date>2017-01-10 17:05:15</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>8</revnumber><date>2017-01-10 17:04:43</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>7</revnumber><date>2017-01-10 17:04:13</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>6</revnumber><date>2016-12-23 19:39:24</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>5</revnumber><date>2016-10-11 16:21:05</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>4</revnumber><date>2015-12-27 22:44:27</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>3</revnumber><date>2015-12-27 22:22:26</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>2</revnumber><date>2015-12-27 22:21:49</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>1</revnumber><date>2015-12-27 22:20:48</date><authorinitials>YuriVoinov</authorinitials></revision></revhistory></articleinfo><para><emphasis>by <ulink url="https://wiki.squid-cache.org/ConfigExamples/Chat/Telegram/YuriVoinov#">YuriVoinov</ulink></emphasis> </para><section><title>Telegram Messenger</title><para><emphasis role="strong">Warning</emphasis>: Any example presented here is provided &quot;as-is&quot; with no support or guarantee of suitability. If you have any further questions about these examples please email the squid-users mailing list. </para><section><title>How to pass Telegram</title><para>Starting from version 0.10.11 (for tdesktop) Telegram client uses TLS connection without standard TLS handshake during bootstrap connection to networks: </para><screen><![CDATA[149.154.164.0/22
149.154.172.0/22
91.108.4.0/22
91.108.56.0/24
2001:67c:4e8::/48
2001:b28:f23d::/48]]></screen><para>Also, it can use relatively large Amazon/Google/Azure networks by push notifications as web-fronting. </para><para>So <ulink url="https://wiki.squid-cache.org/ConfigExamples/Chat/Telegram/Features/SslPeekAndSplice#">SSL-Bump</ulink> proxy must be configured to splice initial connection from Telegram to server: </para><screen><![CDATA[# SSL-bump rules
acl DiscoverSNIHost at_step SslBump1
# Splice specified servers
acl NoSSLIntercept ssl::server_name_regex "/usr/local/squid/etc/acl.url.nobump"
ssl_bump peek DiscoverSNIHost
ssl_bump splice NoSSLIntercept
ssl_bump bump all]]></screen><para>Add this to <emphasis role="strong">acl.url.nobump</emphasis>: </para><screen><![CDATA[# Telegram
149\.154\.1(6[0-9]|7[0-5])\.(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9])
91\.108\.([4-7]|5[6|7])\.(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9])]]></screen><para>This is minimal access requires Telergam to connect. </para><para>This only affects Telegram clients using HTTP proxy settings. On interception proxy it will works also with Telegram clients AUTO mode (the default). </para><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> Note: Usually latest Telegram client can connect via proxy without issues. However, if your clients experiencing difficults, use configuration above. Also, if you using ufdbguard, it can be requires to add Telegram's IP's to excluding ACL for bypass ufdbguard connection probing as well (depending of ufdbguard version). </para></listitem></itemizedlist></section><section><title>How to block Telegram</title><para>To make bootstrap, Telegram uses HTTP POST by pattern <ulink url="http://A.B.C.D/api"/> on 1st stage bootstrap to networks above, and then CONNECT call to this addresses without SNI. </para><para>To block Telegram by any reason it is enough to write config snippet like this: </para><screen><![CDATA[# Block Telegram
acl Telegram url_regex ^http:\/\/149\.154\.1(6[0-9]|7[0-5])\.(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9])\/api$
acl Telegram url_regex ^http:\/\/91\.108\.([4-7]|5[6|7])\.(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9])\/api$
http_access deny Telegram
deny_info TCP_RESET Telegram
]]><![CDATA[
acl Telegram_api_terminate ssl::server_name_regex 149\.154\.1(6[0-9]|7[0-5])\.(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9])
acl Telegram_api_terminate ssl::server_name_regex 91\.108\.([4-7]|5[6|7])\.(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9])
]]><![CDATA[
# SSL bump rules
acl DiscoverSNIHost at_step SslBump1
ssl_bump peek DiscoverSNIHost
ssl_bump terminate Telegram_api_terminate
ssl_bump splice all]]></screen><para>Yon can easy to extend rules to cover IPv6 networks. </para><para>If Telegram starts hide it bootstrap behind world CDN's, just extend rules above to pattern <ulink url="http://0.0.0.0/api"/>. </para><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> Note: If you would like also to ban <emphasis role="strong">MTProto proxy</emphasis>, keep in mind it uses non-TLS handshake without presenting any legitimate certificate signed by the well-known CA (like Telegram does). So, this can be easy to ban using <ulink url="https://urlfilterdb.com">Ufdbguard</ulink> or by writing certificate testing helper for Squid. </para></listitem></itemizedlist><!--rule (<hr>) is not applicable to DocBook--><para> <ulink url="https://wiki.squid-cache.org/ConfigExamples/Chat/Telegram/CategoryConfigExample#">CategoryConfigExample</ulink> </para></section></section></article>