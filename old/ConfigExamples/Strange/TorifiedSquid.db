<?xml version="1.0" encoding="utf-8"?><!DOCTYPE article  PUBLIC '-//OASIS//DTD DocBook XML V4.4//EN'  'http://www.docbook.org/xml/4.4/docbookx.dtd'><article><articleinfo><title>ConfigExamples/Strange/TorifiedSquid</title><revhistory><revision><revnumber>26</revnumber><date>2020-03-27 01:08:53</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>25</revnumber><date>2018-05-05 23:05:41</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>24</revnumber><date>2018-05-05 23:03:04</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>23</revnumber><date>2018-05-05 23:01:14</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>22</revnumber><date>2018-05-03 23:33:16</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>21</revnumber><date>2018-05-03 22:53:11</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>20</revnumber><date>2018-05-03 22:52:09</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>19</revnumber><date>2018-05-03 22:50:10</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>18</revnumber><date>2018-05-03 22:26:35</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>17</revnumber><date>2018-05-03 22:12:04</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>16</revnumber><date>2018-05-03 22:11:06</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>15</revnumber><date>2018-05-03 22:09:39</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>14</revnumber><date>2018-04-26 20:12:12</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>13</revnumber><date>2016-12-20 20:01:43</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>12</revnumber><date>2016-09-29 14:20:29</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>11</revnumber><date>2016-08-19 12:15:47</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>10</revnumber><date>2016-08-19 12:14:50</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>9</revnumber><date>2016-08-19 01:54:52</date><authorinitials>AmosJeffries</authorinitials><revremark>add wikilinks, fix paths to match common FHS standard not Solaris proprietary format. remove some unrelated option setting.</revremark></revision><revision><revnumber>8</revnumber><date>2016-08-18 17:23:41</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>7</revnumber><date>2016-08-18 17:18:56</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>6</revnumber><date>2016-08-18 17:05:08</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>5</revnumber><date>2016-08-18 17:03:46</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>4</revnumber><date>2016-08-18 16:48:00</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>3</revnumber><date>2016-08-18 16:47:24</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>2</revnumber><date>2016-08-18 16:46:41</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>1</revnumber><date>2016-08-18 16:36:19</date><authorinitials>YuriVoinov</authorinitials></revision></revhistory></articleinfo><section><title>Torified Squid</title><itemizedlist><listitem override="none"><para><emphasis>by <ulink url="https://wiki.squid-cache.org/ConfigExamples/Strange/TorifiedSquid/YuriVoinov#">YuriVoinov</ulink></emphasis> </para></listitem></itemizedlist><para><emphasis role="strong">Warning</emphasis>: Any example presented here is provided &quot;as-is&quot; with no support or guarantee of suitability. If you have any further questions about these examples please email the squid-users mailing list. </para><section><title>Outline</title><para>This configuration passes selected by ACL HTTP/HTTPS traffic (both port 80 and 443) into cascaded Privoxy and, then, into Tor tunnel.  </para></section><section><title>Usage</title><para>This configuration useful in case ISP blocks some resources which is required to your users.  </para><section><title>LEGAL NOTICE</title><para><inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/alert.png" width="15"/></imageobject><textobject><phrase>/!\</phrase></textobject></inlinemediaobject> <inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/alert.png" width="15"/></imageobject><textobject><phrase>/!\</phrase></textobject></inlinemediaobject> <inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/alert.png" width="15"/></imageobject><textobject><phrase>/!\</phrase></textobject></inlinemediaobject> Beware, this configuration may be illegal in some countries. Doing this, you can break the law.  Remember that you are taking full responsibility by doing this. </para></section></section><section><title>Overview</title><para>The idea of this configuration firstly was described in 2011 <ulink url="https://habrahabr.ru/sandbox/38914/">here</ulink>. However, original configuration was excessive in some places, and it has a serious drawback - it worked incorrectly with HTTPS traffic. After some experiments, correct configuration has been created, which is more than two years of successfully operating in a productive server with <ulink url="https://wiki.squid-cache.org/ConfigExamples/Strange/TorifiedSquid/Squid-3.5#">Squid-3.5</ulink>. This configuration can also be used with <ulink url="https://wiki.squid-cache.org/ConfigExamples/Strange/TorifiedSquid/Squid-4#">Squid-4</ulink>. </para><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> Note: We are required to use Privoxy as intermediate proxy, because of Tor is SOCKS, not HTTP proxy, and cannot be directly chained with Squid. </para></listitem></itemizedlist><section><title>Building Tor</title><para>Download Tor from <ulink url="https://torproject.org">here</ulink>, unpack and build: </para><screen><![CDATA[# 32 bit GCC
configure --with-tor-user=tor --with-tor-group=tor --prefix=/usr/local 'CXXFLAGS=-O3 -m32 -mtune=native -pipe' 'CFLAGS=-O3 -m32 -mtune=native -pipe' --disable-asciidoc --with-libevent-dir=/usr/local
# 64 bit GCC
configure --with-tor-user=tor --with-tor-group=tor --prefix=/usr/local 'CXXFLAGS=-O3 -m64 -mtune=native -pipe' 'CFLAGS=-O3 -m64 -mtune=native -pipe' --disable-asciidoc --with-libevent-dir=/usr/local
gmake
gmake install-strip]]></screen></section><section><title>Configuring and run Tor</title><para>Edit torrc as follows: </para><screen><![CDATA[SocksPort 9050
]]><![CDATA[
## Entry policies to allow/deny SOCKS requests based on IP address.
## First entry that matches wins. If no SocksPolicy is set, we accept
## all (and only) requests that reach a SocksPort. Untrusted users who
## can access your SocksPort may be able to learn about the connections
## you make.
SocksPolicy accept 127.0.0.0/8
#SocksPolicy accept 192.168.0.0/16
SocksPolicy reject *]]></screen><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> Note: Pay attention, Tor should run from unprivileged user due to security reasons. </para></listitem></itemizedlist><para>I recommend using a configuration with obfuscated bridges (obfs3/4), the most difficult for DPI blocking. Leaving the bridges configuration of your choice. I strongly recommend to read the Tor manuals carefully before this. </para><para>Bridges can be get from <ulink url="https://bridges.torproject.org">here</ulink> or via e-mail in most hardest case. </para><para>When finished, run Tor and check tor.log for errors. </para><para><inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/alert.png" width="15"/></imageobject><textobject><phrase>/!\</phrase></textobject></inlinemediaobject> <inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/alert.png" width="15"/></imageobject><textobject><phrase>/!\</phrase></textobject></inlinemediaobject> <inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/alert.png" width="15"/></imageobject><textobject><phrase>/!\</phrase></textobject></inlinemediaobject> <emphasis role="strong">Important notice</emphasis> <inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/alert.png" width="15"/></imageobject><textobject><phrase>/!\</phrase></textobject></inlinemediaobject> <inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/alert.png" width="15"/></imageobject><textobject><phrase>/!\</phrase></textobject></inlinemediaobject> <inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/alert.png" width="15"/></imageobject><textobject><phrase>/!\</phrase></textobject></inlinemediaobject> </para><para>Starting from Tor 0.3.2 you <ulink url="https://twitter.com/torproject/status/912708766084292608">can use it directly as HTTPS tunneling proxy</ulink>. For this, you can add this to torrc: </para><screen><![CDATA[# Starting from Tor 0.3.2
HTTPTunnelPort 8118]]></screen><para>In this case Privoxy no more requires in theory. Unfortunately, this does not work for connections starts with HTTP (i.e., when user type &quot;archive.org&quot; in browser command line) and you'll get empty string with <ulink url="https://tor.stackexchange.com/questions/16095/405-method-connection-mark-unattached-ap">this error in Tor log</ulink>. </para><para>So, you still requires to build and configure Privoxy. </para></section></section><section><title>Privoxy</title><para>Configure and build Privoxy: </para><screen><![CDATA[# 32 bit GCC
./configure --prefix=/usr/local/privoxy --enable-large-file-support --with-user=privoxy --with-group=privoxy --disable-force --disable-editor --disable-toggle 'CFLAGS=-O3 -m32 -mtune=native -pipe'
]]><![CDATA[
# 64 bit GCC
./configure --prefix=/usr/local/privoxy --with-user=privoxy --with-group=privoxy --disable-force --disable-editor --disable-toggle 'CFLAGS=-O3 -m64 -mtune=native -pipe' 'LDFLAGS=-m64'
]]><![CDATA[
gmake
gmake install-strip]]></screen><para>Add this to Privoxy config: </para><screen><![CDATA[listen-address  127.0.0.1:8118
forward-socks5t         /       127.0.0.1:9050  .]]></screen><para>Check and configure Privoxy performance settings as well. </para><para>Run Privoxy from unprivileged user as follows: </para><screen><![CDATA[## To start:
privoxy --pidfile /tmp/privoxy.pid --user privoxy.privoxy /usr/local/privoxy/etc]]></screen></section><section><title>Squid Configuration File</title><para>Paste the configuration file like this: </para><screen><![CDATA[# Domains to be handled by Tor
acl tor_url url_regex "/etc/squid/url.tor"
]]><![CDATA[
# SSL bump rules
acl DiscoverSNIHost at_step SslBump1
acl NoSSLIntercept ssl::server_name_regex "/etc/squid/url.nobump"
acl NoSSLIntercept ssl::server_name_regex "/etc/squid/url.tor"
ssl_bump peek DiscoverSNIHost
ssl_bump splice NoSSLIntercept
ssl_bump bump all
]]><![CDATA[
# Tor access rules
never_direct allow tor_url
]]><![CDATA[
# Local Tor is cache parent
cache_peer 127.0.0.1 parent 8118 0 no-query no-digest default
]]><![CDATA[
cache_peer_access privoxy allow tor_url
cache_peer_access privoxy deny all
]]><![CDATA[
access_log daemon:/var/log/squid/access.log logformat=squid !tor_url]]></screen><para>Adapt config snippet to your configuration. </para><para>For squid 4.x+, adjust access_log settings as follows: </para><screen><![CDATA[acl hasRequest has request
access_log daemon:/data/cache/log/access.log buffer-size=256KB logformat=squid hasRequest !tor_url]]></screen><para>/etc/squid/url.tor contains what you need to tunnel: </para><screen><![CDATA[torproject.*
archive\.org
#livejournal\.com
#wordpress\.com
#youtube.*
#ytimg.*
#googlevideo.*
#google.*
#googleapis.*
#googleusercontent.*
#gstatic.*
#gmodules.*
#blogger.*
#blogspot.*
#facebook.*
#fb.*
telegram.*
tg\.me.*
tdesktop.*]]></screen><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> Note: In some cases it is better to not log Tor tunnel accesses. </para></listitem><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> Note: Currently you must <emphasis role="strong">splice</emphasis> Tor tunneled connections, because of Squid can't re-crypt peer connections yet. It is recommended to use this configuration in bump-enabled setups. </para></listitem><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> Note: url.tor and url.nobump are different lists. </para></listitem><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> Note: Bridges obfs3 and older is no more supported by Tor. </para></listitem></itemizedlist></section><section><title>Performance considerations</title><para>Tor-tunneled HTTP connections has better performance, because of caching. However, HTTPS connections still limited by Tor performance, because of splice required and they can't be caching in this configuration in any form. Note this. </para><!--rule (<hr>) is not applicable to DocBook--><para> <ulink url="https://wiki.squid-cache.org/ConfigExamples/Strange/TorifiedSquid/CategoryConfigExample#">CategoryConfigExample</ulink> </para></section></section></article>