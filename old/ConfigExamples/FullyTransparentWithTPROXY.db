<?xml version="1.0" encoding="utf-8"?><!DOCTYPE article  PUBLIC '-//OASIS//DTD DocBook XML V4.4//EN'  'http://www.docbook.org/xml/4.4/docbookx.dtd'><article><articleinfo><title>ConfigExamples/FullyTransparentWithTPROXY</title><revhistory><revision><revnumber>11</revnumber><date>2010-03-05 00:55:05</date><authorinitials>AmosJeffries</authorinitials><revremark>sync service 80/90 numbers with the rest of the documentation. link some config options</revremark></revision><revision><revnumber>10</revnumber><date>2010-02-27 10:25:09</date><authorinitials>Henrik Nordström</authorinitials></revision><revision><revnumber>9</revnumber><date>2009-08-15 11:26:36</date><authorinitials>AmosJeffries</authorinitials><revremark>the squid bits of this break with 3.1</revremark></revision><revision><revnumber>8</revnumber><date>2009-01-15 06:25:22</date><authorinitials>AmosJeffries</authorinitials><revremark>put warnings into the outline.</revremark></revision><revision><revnumber>7</revnumber><date>2008-11-25 20:49:12</date><authorinitials>FrancescoChemolli</authorinitials><revremark>fixed some links</revremark></revision><revision><revnumber>6</revnumber><date>2008-11-05 09:26:42</date><authorinitials>Henrik Nordström</authorinitials><revremark>Corrected accidental squid.conf linewrap</revremark></revision><revision><revnumber>5</revnumber><date>2008-07-18 10:35:06</date><authorinitials>AmosJeffries</authorinitials><revremark>mention tproxy version updates.</revremark></revision><revision><revnumber>4</revnumber><date>2008-05-18 19:38:55</date><authorinitials>localhost</authorinitials><revremark>converted to 1.6 markup</revremark></revision><revision><revnumber>3</revnumber><date>2007-05-17 07:12:24</date><authorinitials>kinkie</authorinitials><revremark>Corrected spelling error in page name</revremark></revision><revision><revnumber>2</revnumber><date>2007-05-17 03:19:59</date><authorinitials>AdrianChadd</authorinitials></revision><revision><revnumber>1</revnumber><date>2007-05-17 03:17:04</date><authorinitials>AdrianChadd</authorinitials></revision></revhistory></articleinfo><section><title>Fully Transparent Interception with Squid-2, TPROXYv2 and WCCP</title><para><emphasis role="strong">Warning</emphasis>: Any example presented here is provided &quot;as-is&quot; with no support or guarantee of suitability. If you have any further questions about these examples please email the squid-users mailing list. </para><section><title>Outline</title><para>This is a work in progress (read: a place for Adrian to jot down TPROXY documentation notes as he's coming up with the authoritative documentation.) </para><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> The following documentation applies to Squid-2 WCCPv2 support and TPROXYv2 support running on a Linux box. If you have a newer version of the exact configuration options may differ. </para></listitem></itemizedlist><informaltable><tgroup cols="2"><colspec colname="col_0"/><colspec colname="col_1"/><tbody><row rowsep="1"><entry colsep="1" rowsep="1"><para> <inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/alert.png" width="15"/></imageobject><textobject><phrase>/!\</phrase></textobject></inlinemediaobject> </para></entry><entry colsep="1" rowsep="1"><para>Balabit now only support TPROXY v4.1 which has been integrated with the 3.1 squid code (see <ulink url="https://wiki.squid-cache.org/ConfigExamples/FullyTransparentWithTPROXY/Features/Tproxy4#">Features/Tproxy4</ulink>) </para></entry></row></tbody></tgroup></informaltable><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> The configuration for Squid-3.1 is very different than the following documentation. </para></listitem></itemizedlist></section><section><title>Usage</title><para>(stuff from emails from Steve Wilton) </para><para>The kernel and iptables need to be patched with the tproxy patches (and the tproxy include file needs to be placed in /usr/include/linux/netfilter_ipv4/ip_tproxy.h or include/netfilter_ipv4/ip_tproxy.h in the squid src tree). </para><para>TThe iptables rule needs to use the TPROXY target (instead of the REDIRECT target) to redirect the port 80 traffic to the proxy.  Ie: </para><screen><![CDATA[iptables -t tproxy -A PREROUTING -i eth0 -p tcp -m tcp --dport 80 -j TPROXY --on-port 80]]></screen><para>The kernel must strip the GRE header from the incoming packets (either using the ip_wccp module, or by having a GRE tunnel set up in linux pointing at the router (no GRE setup is required on the router)). </para><screen><![CDATA[wccp2_service dynamic 80
wccp2_service_info 80 protocol=tcp flags=src_ip_hash priority=240 ports=80
wccp2_service dynamic 90
wccp2_service_info 90 protocol=tcp flags=dst_ip_hash,ports_source priority=240 ports=80]]></screen><para>It is highly recommended that the above definitions be used for the two wccp services, otherwise things will break if you have more than 1 cache (specifically, you will have problems when the a web server's name resolves to multiple ip addresses). </para><para>The <ulink url="http://www.squid-cache.org/Doc/config/http_port#">http_port</ulink> that you are redirecting to must have the transparent and tproxy options enabled as follows (modify the port as appropriate): </para><screen><![CDATA[http_port 80 transparent tproxy]]></screen><para>There _must_ be a <ulink url="http://www.squid-cache.org/Doc/config/tcp_outgoing#">tcp_outgoing</ulink> address defined.  This will need to be valid to satisfy any non-tproxied connections. </para><para>On the router, you need to make sure that all traffic going to/from the customer will be processed by _both_ wccp rules.  The way we have implemented this is to apply wccp service 80 to all traffic coming in from a customer-facing interface, and wccp service 90 applied to all traffic going out a customer-facing interface.  We have also applied the wccp &quot;exclude-in&quot; rule to all traffic coming in from the proxy-facing interface.  Ie: </para><screen><![CDATA[interface GigabitEthernet0/3.100
 description ADSL customers
 encapsulation dot1Q 502
 ip address x.x.x.x y.y.y.y
 ip wccp 80 redirect in
 ip wccp 90 redirect out
]]><![CDATA[
interface GigabitEthernet0/3.101
 description Dialup customers
 encapsulation dot1Q 502
 ip address x.x.x.x y.y.y.y
 ip wccp 80 redirect in
 ip wccp 90 redirect out
]]><![CDATA[
interface GigabitEthernet0/3.102
 description proxy servers
 encapsulation dot1Q 506
 ip address x.x.x.x y.y.y.y
 ip wccp redirect exclude in]]></screen><para>It's highly recommended to turn <ulink url="http://www.squid-cache.org/Doc/config/httpd_accel_no_pmtu_disc#">httpd_accel_no_pmtu_disc</ulink> on in the squid conf. </para><para>If you have some clients who set their proxy, it is recommended to use a separate port in squid for transparent/tproxy requests compared to clients with proxies set. </para><para>(next email) </para><para>The tproxy support in <ulink url="https://wiki.squid-cache.org/ConfigExamples/FullyTransparentWithTPROXY/Squid-2.6#">Squid-2.6</ulink> does not need to be run as root.  It maintains root capabilities for network requests at all times (allowing the tproxy patch to work), without the need to maintain all root capabilities. </para><para>(next email) </para><para>I would like to add the following to my previous list of requirements for tproxy + wccpv2: </para><itemizedlist><listitem><para>You must make sure rp_filter is disabled in the kernel </para></listitem><listitem><para>You must make sure ip_forwarding is enabled in the kernel </para></listitem></itemizedlist><para>Can you please check that you've enabled ip_forwarding in your kernel.  If that doesn't work, I don't know if the &quot;vhost vport=80&quot; is required in the <ulink url="http://www.squid-cache.org/Doc/config/http_port#">http_port</ulink> line in the squid config (we don't have these options enabled on our proxies). </para><para>I use the ip_wccp module to make the kernel handle the GRE packets correctly (which works slightly differently from the ip_gre module).  Do you have a GRE tunnel set up in linux?  If so, what command are you running to set it up?  I don't have an example to give you here, but I'm sure other people are using the ip_gre module with wccp to handle the GRE packets, and should be able to help. </para><para>(reply from the user) </para><para>Hi, Steve </para><para>finally it work.... </para><para>Here is my step : </para><para>* install squid-2.6.s1 + FD-patch_from_you  + cttproxy-patch from balabit for kernel &amp; iptables  tproxy </para><para>* create gre tunnel </para><screen><![CDATA[insmod ip_gre
ifconfig gre0 <use ip address within loopback0 router subnet> up]]></screen><itemizedlist><listitem><para>disable rp_filter &amp; enable forwarding </para></listitem></itemizedlist><screen><![CDATA[echo 0 > /proc/sys/net/ipv4/conf/lo/rp_filter
echo 1 > /proc/sys/net/ipv4/ip_forward]]></screen><itemizedlist><listitem><para>iptables  : </para></listitem></itemizedlist><screen><![CDATA[iptables -t tproxy -A PREROUTING -p tcp -m tcp  -i gre0 --dport 80 -j TPROXY --on-port 80]]></screen><itemizedlist><listitem><para>squid.conf : </para></listitem></itemizedlist><screen><![CDATA[http_port 80 transparent tproxy vhost vport=80
always_direct allow all
wccp2_router y.y.y.y
wccp2_forwarding_method 1
wccp2_return_method 1
wccp2_service dynamic 80
wccp2_service dynamic 90
wccp2_service_info 80 protocol=tcp flags=src_ip_hash priority=240 ports=80
wccp2_service_info 90 protocol=tcp flags=dst_ip_hash,ports_source priority=240 ports=80]]></screen><itemizedlist><listitem><para>router config (cisco): </para></listitem></itemizedlist><screen><![CDATA[ip wccp 80
ip wccp 90
int fasteth0 -->ip wccp 90 redirect out (gateway to internet)
int fasteth1 -->ip wccp 80 redirect out (my client gateway)
int fasteth3 -->ip wccp redirect exclude in  (squid-box attached here)]]></screen><para>check-up access.log --&gt; yes it is increments log check-up my pc by opening whatismyipaddress.com --&gt; yes it is my pc's ip </para><para>Now,  I will try tuning-up my box &amp; squid.conf tommorow </para></section><section><title>Another Example</title><itemizedlist><listitem><para>Mailing list post: <ulink url="http://www.squid-cache.org/mail-archive/squid-users/200705/0443.html"/> and <ulink url="http://www.squid-cache.org/mail-archive/squid-users/200705/0447.html"/> </para></listitem></itemizedlist></section><section><title>References</title><itemizedlist><listitem><para>Squid <ulink url="https://wiki.squid-cache.org/ConfigExamples/FullyTransparentWithTPROXY/Features/Tproxy4#">Features/Tproxy4</ulink> </para></listitem><listitem><para>TPROXY patch homepage: <ulink url="http://www.balabit.com/support/community/products/tproxy/"/> </para></listitem><listitem><para>A useful script to test: <ulink url="http://devel.squid-cache.org/cgi-bin/test"/> </para></listitem></itemizedlist><!--rule (<hr>) is not applicable to DocBook--><itemizedlist><listitem override="none"><para><ulink url="https://wiki.squid-cache.org/ConfigExamples/FullyTransparentWithTPROXY/CategoryConfigExample#">CategoryConfigExample</ulink> </para></listitem></itemizedlist></section></section></article>