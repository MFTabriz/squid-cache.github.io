<?xml version="1.0" encoding="utf-8"?><!DOCTYPE article  PUBLIC '-//OASIS//DTD DocBook XML V4.4//EN'  'http://www.docbook.org/xml/4.4/docbookx.dtd'><article><articleinfo><title>ConfigExamples/Authenticate/Ntlm</title><revhistory><revision><revnumber>6</revnumber><date>2021-07-02 14:43:59</date><authorinitials>FrancescoChemolli</authorinitials></revision><revision><revnumber>5</revnumber><date>2015-12-16 13:03:35</date><authorinitials>AmosJeffries</authorinitials></revision><revision><revnumber>4</revnumber><date>2015-11-16 21:04:16</date><authorinitials>AmosJeffries</authorinitials><revremark>update with Debian/Ubuntu winbindd_privileged bug details</revremark></revision><revision><revnumber>3</revnumber><date>2013-06-27 13:27:21</date><authorinitials>AmosJeffries</authorinitials><revremark>remove some NTLM options which do not exist in any Squid version</revremark></revision><revision><revnumber>2</revnumber><date>2009-11-13 15:30:25</date><authorinitials>FrancescoChemolli</authorinitials><revremark>fixed formatting</revremark></revision><revision><revnumber>1</revnumber><date>2009-02-11 12:46:56</date><authorinitials>AmosJeffries</authorinitials><revremark>copy out from SquidFaq. this is an auth config example.</revremark></revision></revhistory></articleinfo><section><title>Configuring Squid for NTLM with Winbind authenticators</title><para><emphasis role="strong">Warning</emphasis>: Any example presented here is provided &quot;as-is&quot; with no support or guarantee of suitability. If you have any further questions about these examples please email the squid-users mailing list. </para><para>by Jerry Murdock </para><para>Winbind is a recent addition to Samba providing some impressive capabilities for NT based user accounts.  From Squid's perspective winbind provides a robust and efficient engine for both basic and NTLM challenge/response authentication against an NT domain controller. </para><para>The winbind authenticators have been used successfully under Linux, FreeBSD, Solaris and Tru64. </para><para>Before you get started have a read and think about the issues discussed in <ulink url="http://blogs.technet.com/b/authentication/archive/2006/04/07/ntlm-s-time-has-passed.aspx"/>. </para><section><title>Supported Samba Releases</title><para>Samba-3.X is supported natively using the ntlm_auth helper shipped as part of Samba. No Squid specific winbind helpers need to be compiled (and even if compiled they won't work with Samba-3.X).  </para><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/alert.png" width="15"/></imageobject><textobject><phrase>/!\</phrase></textobject></inlinemediaobject> Samba 2.2.X reached its End-Of-Life on October 1, 2004. It was supported using the winbind helpers shipped with Squid-2.5 but is no longer supported with later versions, even if using the helper from 2.5 may still work. </para><para>{!} <inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/idea.png" width="15"/></imageobject><textobject><phrase>(!)</phrase></textobject></inlinemediaobject> For Samba-3.X the winbind helpers which was shipped with Squid <emphasis role="strong">should not</emphasis> be used (and won't work </para></listitem></itemizedlist><para>if you attempt to do so), instead the ntlm_auth helper shipped as part of the Samba-3 distribution should be used. This helper supports all versions of Squid and both the ntlm and basic authentication schemes. For details on how to use this Samba helper see the Samba documentation. For group membership lookups the wbinfo_group helper shipped with Squid can be used (this is just a wrapper around the samba wbinfo program and works with all versions of Samba) </para></section><section><title>Samba Configuration</title><para>For full details on how to configure Samba and joining a domain please see the Samba documentation. The Samba team has quite extensive documentation both on how to join a NT domain and how to join a Active Directory tree. </para><para>Samba must be built with these configure options: </para><screen><![CDATA[        --with-winbind]]></screen><para>and is normally enabled by default if you installed Samba from a prepackaged distribution. </para><para>Then follow the Samba installation instructions. But please note that neither nsswitch or the pam modules needs to be installed for Squid to function, these are only needed if you want your OS to integrate with the domain for UNIX accounts.  (Note that if PAM <emphasis role="strong">is</emphasis> configured to authenticate against Active Directory, so that AD controls access to your Unix accounts etc., it may be prudent to have Squid authenticate against PAM as well.  PAM can send Squid's authentication requests to Active Directory.  This approach keeps all authentication running through PAM, centralizing administration.) </para><section><title>Test Samba's winbindd</title><para>Edit smb.conf for winbindd functionality.  The following entries in the [global] section of smb.conf may be used as a template. </para><screen><![CDATA[workgroup = mydomain
password server = myPDC
security = domain
winbind uid = 10000-20000
winbind gid = 10000-20000
winbind use default domain = yes]]></screen><para>Join the NT domain as outlined in the winbindd man page for your version of samba. </para><para>Start nmbd (required to insure proper operation). </para><para>Start winbindd. </para><para>Test basic winbindd functionality &quot;wbinfo -t&quot;: </para><screen><![CDATA[# wbinfo -t
Secret is good]]></screen><para>Test winbindd user authentication: </para><screen><![CDATA[# wbinfo -a mydomain\\myuser%mypasswd
plaintext password authentication succeeded
error code was NT_STATUS_OK (0x0)
challenge/response password authentication succeeded
error code was NT_STATUS_OK (0x0)]]></screen><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> both plaintext and challenge/response should return </para></listitem></itemizedlist><para>&quot;succeeded.&quot; If there is no &quot;challenge/response&quot; status returned then Samba was not built with &quot;--with-winbind-auth-challenge&quot; and cannot support ntlm authentication. </para></section><section><title>SMBD and Machine Trust Accounts</title><para>The Samba team has incorporated functionality to change the machine trust account password in the new &quot;net&quot; command.  A simple daily cron job scheduling &quot;<emphasis role="strong">net rpc changetrustpw</emphasis>&quot; is all that is needed, if anything at all. </para></section><section><title>winbind privileged pipe permissions</title><para>ntlm_auth requires access to the privileged winbind pipe in order to function properly. You enable this access by adding the security user Squid runs as to the <emphasis role="strong">winbindd_priv</emphasis> group. </para><screen><![CDATA[gpasswd -a proxy winbindd_priv]]></screen><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/alert.png" width="15"/></imageobject><textobject><phrase>/!\</phrase></textobject></inlinemediaobject> Remove the cache_effective_group setting in squid.conf, if present.  This setting causes squid to ignore the auxiliary winbindd_priv group membership. </para><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> the default user Squid is bundled as <emphasis role="strong">nobody</emphasis> though some distribution packages are built with <emphasis role="strong">squid</emphasis> or <emphasis role="strong">proxy</emphasis> or other similar low-access user. </para></listitem><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-error.png" width="16"/></imageobject><textobject><phrase>{X}</phrase></textobject></inlinemediaobject> on Debian an Ubuntu systems there may also be a <emphasis>/var/lib/samba/winbindd_privileged</emphasis> directory created by the winbind and ntlm_auth tools with root ownership. The group of that folder needs to be changed to match the /var/run/samba/winbindd_privileged location. </para></listitem></itemizedlist></section></section><section><title>Squid Configuration</title><para>As Samba-3.x has it's own authentication helper there is no need to build any of the Squid authentication helpers for use with Samba-3.x (and the helpers provided by Squid won't work if you do). You do however need to enable support for the NTLM scheme if you plan on using this. Also you may want to use the wbinfo_group helper for group lookups </para><screen><![CDATA[--enable-auth="ntlm,basic"
--enable-external-acl-helpers="wbinfo_group"]]></screen><section><title>Test Squid without auth</title><para>Before going further, test basic Squid functionality.  Make sure squid is functioning without requiring authorization. </para></section><section><title>Test the helpers</title><para>Testing the winbind ntlm helper is not really possible from the command line, but the winbind basic authenticator can be tested like any other basic helper. Make sure to run the test as your cache_effective_user </para><screen><![CDATA[# /usr/local/bin/ntlm_auth --helper-protocol=squid-2.5-basic
mydomain+myuser mypasswd
OK]]></screen><para>The helper should return &quot;OK&quot; if given a valid username/password. <emphasis>+</emphasis> is the <emphasis>domain separator</emphasis> set in your smb.conf </para></section><section><title>squid.conf Settings</title><para>Add the following to enable both the winbind basic and ntlm authenticators. IE will use ntlm and everything else basic: </para><screen><![CDATA[auth_param ntlm program /usr/local/bin/ntlm_auth --helper-protocol=squid-2.5-ntlmssp
auth_param ntlm children 30
]]><![CDATA[
# warning: basic authentication sends passwords plaintext
# a network sniffer can and will discover passwords
auth_param basic program /usr/local/bin/ntlm_auth --helper-protocol=squid-2.5-basic
auth_param basic children 5
auth_param basic realm Squid proxy-caching web server
auth_param basic credentialsttl 2 hours]]></screen><para>And the following acl entries to require authentication: </para><screen><![CDATA[acl AuthorizedUsers proxy_auth REQUIRED
..
http_access allow all AuthorizedUsers]]></screen></section><section><title>Test Squid with auth</title><itemizedlist><listitem><para>Internet Explorer, Mozilla, Firefox: </para><itemizedlist><listitem override="none"><para>Test browsing through squid with a NTLM capable browser. If logged into the domain, a password prompt should NOT pop up. Confirm the traffic really is being authorized by tailing access.log. The domain\username should be present. </para></listitem></itemizedlist></listitem><listitem><para>Netscape, Mozilla ( &lt; 1.4), Opera...: </para><itemizedlist><listitem override="none"><para>Test with a NTLM non-capable browser. A standard password dialog should appear. Entering the domain should not be required if the user is in the default domain and &quot;winbind use default domain = yes&quot; is set in smb.conf.  Otherwise, the username must be entered in &quot;domain+username&quot; format. (where + is the domain separator set in smb.conf) </para></listitem></itemizedlist></listitem></itemizedlist><para>If no usernames appear in access.log and/or no password dialogs appear in either browser, then the acl/http_access portions of squid.conf are not correct. </para><para>Note that when using NTLM authentication, you will see two &quot;TCP_DENIED/407&quot; entries in access.log for every request. This is due to the challenge-response process of NTLM. </para><!--rule (<hr>) is not applicable to DocBook--><para> <ulink url="https://wiki.squid-cache.org/ConfigExamples/Authenticate/Ntlm/CategoryConfigExample#">CategoryConfigExample</ulink> </para></section></section></section></article>