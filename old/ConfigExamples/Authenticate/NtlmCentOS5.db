<?xml version="1.0" encoding="utf-8"?><!DOCTYPE article  PUBLIC '-//OASIS//DTD DocBook XML V4.4//EN'  'http://www.docbook.org/xml/4.4/docbookx.dtd'><article><articleinfo><title>ConfigExamples/Authenticate/NtlmCentOS5</title><revhistory><revision><revnumber>6</revnumber><date>2021-07-02 14:44:31</date><authorinitials>FrancescoChemolli</authorinitials></revision><revision><revnumber>5</revnumber><date>2010-06-18 20:18:37</date><authorinitials>JosephCasale</authorinitials></revision><revision><revnumber>4</revnumber><date>2010-06-16 21:14:13</date><authorinitials>JosephCasale</authorinitials></revision><revision><revnumber>3</revnumber><date>2009-05-17 07:06:28</date><authorinitials>AmosJeffries</authorinitials><revremark>update demo to let auth 407 message out.</revremark></revision><revision><revnumber>2</revnumber><date>2009-04-10 02:59:31</date><authorinitials>JosephCasale</authorinitials></revision><revision><revnumber>1</revnumber><date>2009-04-07 23:07:45</date><authorinitials>JosephCasale</authorinitials></revision></revhistory></articleinfo><section><title>Configuring Squid for NTLM with Winbind Authentication on CentOS 5</title><para>By Joseph L. Casale </para><para><emphasis role="strong">Warning</emphasis>: Any example presented here is provided &quot;as-is&quot; with no support or guarantee of suitability. If you have any further questions about these examples please email the squid-users mailing list. </para><para>This Configuration Example illustrates a simplified method to setup Squid on CentOS 5 (or any RHEL 5 flavor) using built in configuration tools while enabling only the needed services for authentication to be carried out by Winbind. </para><section><title>Prerequisites</title><section><title>Network Time Protocol (NTP)</title><para>In order for Kerberos to function, proper time synchronization between your Active Directory PDC Emulator and this server must be maintained.</para><para> Check if the ntp client is installed: </para><screen><![CDATA[# rpm -qa ntp]]></screen><para>If this query returns nothing, install it: </para><screen><![CDATA[# yum install ntp]]></screen><para>Now edit <emphasis role="strong">/etc/ntp.conf</emphasis> and comment out any lines that begin with <emphasis role="strong">server</emphasis> and create only one that points to your Active Directory PDC Emulator.</para><para> Set the daemon to start automatically at boot and start it: </para><screen><![CDATA[# vi /etc/ntp.conf
server pdce.example.local
# chkconfig ntpd on
# service ntpd start]]></screen></section><section><title>Samba and Winbind</title><para>The Samba configuration file <emphasis role="strong">/etc/samba/smb.conf</emphasis> and Squid authentication helper <emphasis role="strong">/usr/bin/ntlm_auth</emphasis> are provided by the samba-common package.</para><para> Check if the software is installed: </para><screen><![CDATA[# rpm -qa |egrep -i '(krb5-workstation|samba-common|authconfig)'
authconfig-5.3.21-5.el5
krb5-workstation-1.6.1-25.el5_2.1
samba-common-3.0.28-1.el5_2.1]]></screen><para>If not, install it with yum: </para><screen><![CDATA[# yum install authconfig krb5-workstation samba-common]]></screen></section><section><title>Squid</title><para>Squid is available in the Base repo, check if it's installed: </para><screen><![CDATA[# rpm -qa squid]]></screen><para>If this query returns nothing, install it and/or set it to start at boot: </para><screen><![CDATA[# yum install squid
# chkconfig squid on]]></screen></section></section><section><title>Configure Kerberos</title><para>To enable Active Directory Group and User enumeration by the helper, we join the CentOS server to Active Directory. You can use authconfig to configure Samba, Winbind and perform the join in one step. </para><itemizedlist><listitem><para>Replace ads.example.local with the fqdn of your Active Directory Server. </para></listitem><listitem><para>Replace EXAMPLE with the netbios name of your domain. </para></listitem><listitem><para>Replace EXAMPLE.LOCAL with the full name of your domain. </para></listitem></itemizedlist><screen><![CDATA[# authconfig --enableshadow --enablemd5 --passalgo=md5 --krb5kdc=ads.example.local \
--krb5realm=EXAMPLE.LOCAL --smbservers=ads.example.local --smbworkgroup=EXAMPLE \
--enablewinbind --enablewinbindauth --smbsecurity=ads --smbrealm=EXAMPLE.LOCAL \
--smbidmapuid="16777216-33554431" --smbidmapgid="16777216-33554431" --winbindseparator="+" \
--winbindtemplateshell="/bin/false" --enablewinbindusedefaultdomain --disablewinbindoffline \
--winbindjoin=Administrator --disablewins --disablecache --enablelocauthorize --updateall
[/usr/bin/net join -w EXAMPLE -S ads.example.local -U Administrator]
Administrator's password:
Using short domain name -- EXAMPLE
Joined 'SERVER' to realm 'EXAMPLE.LOCAL'
]]><![CDATA[
Shutting down Winbind services:                            [FAILED]
Starting Winbind services:                                 [  OK  ]]]></screen><para>If Winbind wasn't running before this it can't shutdown, but authconfig will start it and enable it to start at boot. </para><para>The default permissions for <emphasis role="strong">/var/cache/samba/winbindd_privileged</emphasis> in RHEL/CentOS 5.4 were 750 root:squid (which worked by default) but are now 750 root:wbpriv in 5.5 which doesn't allow the user Squid runs under to access the socket. Make sure squid.conf does not have a <emphasis role="strong">cache_effective_group</emphasis> defined and add wbpriv as a supplementary group to the user Squid runs under: </para><screen><![CDATA[# usermod -a -G wbpriv squid]]></screen><para>You can test Active Directory Group and User enumeration by viewing the output of wbinfo: </para><screen><![CDATA[# wbinfo -{u|g}]]></screen><para>If you are able to enumerate your Active Directory Groups and Users, everything is working. </para></section><section><title>Configuring Squid</title><para>I created an Active Directory Group to control who gets access to the proxy. Check the man pages for <ulink url="http://www.samba.org/samba/docs/man/manpages-3/ntlm_auth.1.html">ntlm_auth</ulink> for options.</para><para> Edit your <emphasis role="strong">/etc/squid/squid.conf</emphasis> to enable the helper and adjust <emphasis role="strong">our_networks</emphasis> accordingly: </para><screen><![CDATA[auth_param ntlm program /usr/bin/ntlm_auth --helper-protocol=squid-2.5-ntlmssp --require-membership-of=EXAMPLE+ADGROUP
auth_param ntlm children 5
auth_param ntlm keep_alive on
]]><![CDATA[
acl our_networks 192.168.0.0/24 192.168.1.0/24
]]><![CDATA[
acl ntlm proxy_auth REQUIRED
http_access allow our_networks ntlm]]></screen><itemizedlist><listitem><para>This is not an inclusive set of parameters for Squid to function but is what is required for the authentication portion. </para></listitem></itemizedlist></section><section><title>Notes</title><itemizedlist><listitem><para>Current versions of Firefox are capable of ntlm authentication so you need not enable basic. </para></listitem><listitem><para>You need not install the full Samba package, nor have smbd and nmbd running for authentication to take place. </para></listitem></itemizedlist><!--rule (<hr>) is not applicable to DocBook--><itemizedlist><listitem override="none"><para><ulink url="https://wiki.squid-cache.org/ConfigExamples/Authenticate/NtlmCentOS5/CategoryConfigExample#">CategoryConfigExample</ulink> </para></listitem></itemizedlist></section></section></article>