<?xml version="1.0" encoding="utf-8"?><!DOCTYPE article  PUBLIC '-//OASIS//DTD DocBook XML V4.4//EN'  'http://www.docbook.org/xml/4.4/docbookx.dtd'><article><articleinfo><title>ConfigExamples/Authenticate/MultipleSources</title><revhistory><revision><revnumber>7</revnumber><date>2021-07-02 14:43:27</date><authorinitials>FrancescoChemolli</authorinitials></revision><revision><revnumber>6</revnumber><date>2011-03-08 07:27:16</date><authorinitials>AmosJeffries</authorinitials><revremark>explain a bit more about this example.</revremark></revision><revision><revnumber>5</revnumber><date>2010-10-19 08:20:41</date><authorinitials>AmosJeffries</authorinitials><revremark>use the bundled Basic fake auth helper for demo.</revremark></revision><revision><revnumber>4</revnumber><date>2009-08-27 23:58:43</date><authorinitials>AmosJeffries</authorinitials><revremark>correct newline output on example code.</revremark></revision><revision><revnumber>3</revnumber><date>2009-02-23 23:21:55</date><authorinitials>AmosJeffries</authorinitials><revremark>typo</revremark></revision><revision><revnumber>2</revnumber><date>2009-02-23 23:21:05</date><authorinitials>AmosJeffries</authorinitials><revremark>put it in the wrong place.</revremark></revision><revision><revnumber>1</revnumber><date>2009-02-23 23:19:37</date><authorinitials>AmosJeffries</authorinitials><revremark>import from squid-users contribution.</revremark></revision></revhistory></articleinfo><section><title>Configuring Squid to authenticate against multiple services</title><para>by <emphasis>Joseph Spadavecchia</emphasis> </para><para><emphasis role="strong">Warning</emphasis>: Any example presented here is provided &quot;as-is&quot; with no support or guarantee of suitability. If you have any further questions about these examples please email the squid-users mailing list. </para><section><title>Outline</title><para>We have a requirement to use different authentication mechanisms  based on the subnet/ip-address of the client. </para><para>The use case: </para><itemizedlist><listitem><para>A client from subnet A would authenticate with Basic auth against an AD server. </para></listitem><listitem><para>A client from subnet B would authenticate with Basic auth against an LDAP server. </para></listitem></itemizedlist><para>To date this is normally done by running multiple instances of squid;  but we have the requirement to do it with a single instance.  One way  of achieving this would be to modify squid to pass the client's  ip-address along with the authentication information.  However, I'd  like to do it cleanly without modifying squid. </para><para>I created a custom authenticator that always returns &quot;OK&quot; and linked it  to the external acl. <inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> Squid-3.2 bundles one called <emphasis role="strong">basic_fake_auth</emphasis> </para></section><section><title>Squid Configuration</title><screen><![CDATA[auth_param basic program /usr/local/bin/basic_fake_auth
]]><![CDATA[
external_acl_type myAclType %SRC %LOGIN %{Proxy-Authorization} /usr/local/bin/my-acl.pl
]]><![CDATA[
acl MyAcl external myAclType
]]><![CDATA[
http_access allow MyAcl]]></screen><itemizedlist><listitem><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> myAclType's dependence on <emphasis role="strong">%LOGIN</emphasis> is required for triggering authentication and, thus, setting <emphasis role="strong">%{Proxy-Authorization}</emphasis>. </para></listitem></itemizedlist><section><title>my-acl.pl</title><screen><![CDATA[use URI::Escape;
use MIME::Base64;
]]><![CDATA[
$|=1;
]]><![CDATA[
while (<>) {
    ($ip,$user,$auth) = split();
]]><![CDATA[
    # Retrieve the password from the authentication header
    $auth = uri_unescape($auth);
    ($type,$authData) = split(/ /, $auth);
    $authString = decode_base64($authData);
    ($username,$password) = split(/:/, $authString);
]]><![CDATA[
    # do the authentication and pass results back to Squid.
    print my_awsome_auth($ip, $username, $password);
}]]></screen><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/alert.png" width="15"/></imageobject><textobject><phrase>/!\</phrase></textobject></inlinemediaobject> Add your own version of <emphasis>my_awsome_auth()</emphasis> to do the authentication actions you need. </para></listitem></itemizedlist><!--rule (<hr>) is not applicable to DocBook--><para> <ulink url="https://wiki.squid-cache.org/ConfigExamples/Authenticate/MultipleSources/CategoryConfigExample#">CategoryConfigExample</ulink> </para></section></section></section></article>