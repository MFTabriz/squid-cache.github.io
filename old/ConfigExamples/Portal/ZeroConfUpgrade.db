<?xml version="1.0" encoding="utf-8"?><!DOCTYPE article  PUBLIC '-//OASIS//DTD DocBook XML V4.4//EN'  'http://www.docbook.org/xml/4.4/docbookx.dtd'><article><articleinfo><title>ConfigExamples/Portal/ZeroConfUpgrade</title><revhistory><revision><revnumber>2</revnumber><date>2012-06-26 05:32:11</date><authorinitials>AmosJeffries</authorinitials><revremark>3.1.20 supports %b but hard-codes it to 3128.</revremark></revision><revision><revnumber>1</revnumber><date>2011-06-10 16:46:35</date><authorinitials>AmosJeffries</authorinitials><revremark>create a page specific for the WPAD/PAC splashing.</revremark></revision></revhistory></articleinfo><section><title>Portal with Browser configuration detection</title><para><emphasis role="strong">Warning</emphasis>: Any example presented here is provided &quot;as-is&quot; with no support or guarantee of suitability. If you have any further questions about these examples please email the squid-users mailing list. </para><section><title>Outline</title><para>Squid when acting as a web portal sometimes is required to perform things such as <ulink url="https://wiki.squid-cache.org/ConfigExamples/Portal/ZeroConfUpgrade/Features/Authentication#">authentication</ulink> or <ulink url="https://wiki.squid-cache.org/ConfigExamples/Portal/ZeroConfUpgrade/Features/SslBump#">ssl-bump</ulink> which are not possible on a transparent interception proxy. And Yet the portal is also required to intercept port 80 traffic. </para><para>The best solution presently is for browsers to use transparent configuration in the form of WPAD and PAC zero-conf systems which allow the portal to point them cleanly at a forward-proxy port and keep them off of port 80. </para><para>This in turn brings up the problem that a large amount of browsers have these settings are turned off. Possibly too many for the network admin to visit each problem user and fix their browser. </para><para>This example contains the configuration needed in Squid to catch browsers using port 80 and redirect them to a splash page instructing the user on how to make the browser changes themselves. </para></section><section><title>Instruction Pages</title><para>The squid <ulink url="http://www.squid-cache.org/Versions/langpack">langpack</ulink> bundle of error pages contains two template files called <emphasis>ERR_AGENT_WPAD</emphasis> and <emphasis>ERR_AGENT_CONFIGURE</emphasis> with instructions for the most popular browsers and a generic instruction for less popular ones. As with all our bundled pages these come translated in many languages for easier user reading. </para><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/alert.png" width="15"/></imageobject><textobject><phrase>/!\</phrase></textobject></inlinemediaobject> When using ERR_AGENT_CONFIGURE with Squid older than <ulink url="https://wiki.squid-cache.org/ConfigExamples/Portal/ZeroConfUpgrade/Squid-3.1#">Squid-3.1.20</ulink> you will have to edit the file and change the %b to the squid port you want the users configuring. This can be done with: </para></listitem></itemizedlist><screen><![CDATA[ sed --in-place s/%b/3128/ ERR_AGENT_CONFIGURE]]></screen><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> <ulink url="https://wiki.squid-cache.org/ConfigExamples/Portal/ZeroConfUpgrade/Squid-3.1#">3.1.20</ulink> will fill out the %b value with port 3128. Use the above replacement to use another port.</para><para> <inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> <ulink url="https://wiki.squid-cache.org/ConfigExamples/Portal/ZeroConfUpgrade/Squid-3.2#">Squid-3.2</ulink> will fill out the %b value with the proxies first <emphasis>normal</emphasis> (forward-proxy) listening port. </para></listitem></itemizedlist></section><section><title>Squid Configuration File</title><para>Setup an ACL to detect web browsers which can display the redirected page. It is not much use doing this when the program at the other end is an automated software updater for example. </para><screen><![CDATA[acl bounce browser MSIE Gecko Firefox Chrome Opera Safari]]></screen><para>We need a way to detect that the traffic came in on the intercept port. For this the myportname ACL type is used. </para><screen><![CDATA[http_port 1234 intercept name=rat-catcher
acl caught myportname rat-catcher]]></screen><para>Finally we put it all together and redirect the web browsers caught on the intercepted port. </para><screen><![CDATA[deny_info ERR_AGENT_WPAD bounce
http_access deny caught bounce]]></screen><para>These are just the snippets of config which cause the splash page and redirect to be done. Rules which permit the visitor use of the proxy are expected to be placed as appropriate below them. The basic default safety nets should as always be above them. </para><!--rule (<hr>) is not applicable to DocBook--><para> <ulink url="https://wiki.squid-cache.org/ConfigExamples/Portal/ZeroConfUpgrade/CategoryConfigExample#">CategoryConfigExample</ulink> </para></section></section></article>