<?xml version="1.0" encoding="utf-8"?><!DOCTYPE article  PUBLIC '-//OASIS//DTD DocBook XML V4.4//EN'  'http://www.docbook.org/xml/4.4/docbookx.dtd'><article><articleinfo><title>ConfigExamples/Portal/Splash</title><revhistory><revision><revnumber>14</revnumber><date>2017-10-15 13:39:59</date><authorinitials>AmosJeffries</authorinitials></revision><revision><revnumber>13</revnumber><date>2015-02-09 22:09:11</date><authorinitials>AmosJeffries</authorinitials><revremark>remove almost-duplicate helper definition from original example, missed in Henriks update from 2011.</revremark></revision><revision><revnumber>12</revnumber><date>2015-01-31 01:25:58</date><authorinitials>AmosJeffries</authorinitials></revision><revision><revnumber>11</revnumber><date>2015-01-31 01:16:58</date><authorinitials>AmosJeffries</authorinitials></revision><revision><revnumber>10</revnumber><date>2012-04-30 23:20:06</date><authorinitials>AmosJeffries</authorinitials><revremark>document use of 511 status for portals</revremark></revision><revision><revnumber>9</revnumber><date>2012-03-02 22:11:31</date><authorinitials>eu.squid-cache.org</authorinitials></revision><revision><revnumber>8</revnumber><date>2012-01-06 23:41:07</date><authorinitials>Henrik Nordstr√∂m</authorinitials><revremark>Simplified active mode description. A single helper definition is quite sufficient, driven via multiple acls.</revremark></revision><revision><revnumber>7</revnumber><date>2011-10-23 13:53:08</date><authorinitials>eu.squid-cache.org</authorinitials></revision><revision><revnumber>6</revnumber><date>2011-10-09 19:45:07</date><authorinitials>eu.squid-cache.org</authorinitials></revision><revision><revnumber>5</revnumber><date>2011-10-09 19:42:30</date><authorinitials>eu.squid-cache.org</authorinitials><revremark>Addition of active mode example</revremark></revision><revision><revnumber>4</revnumber><date>2011-09-24 13:28:34</date><authorinitials>eu.squid-cache.org</authorinitials><revremark>Added extra links to config reference</revremark></revision><revision><revnumber>3</revnumber><date>2011-09-24 13:22:36</date><authorinitials>eu.squid-cache.org</authorinitials><revremark>Updated for session helper version 1.1 and to remove some ambiguity.</revremark></revision><revision><revnumber>2</revnumber><date>2011-05-31 04:04:58</date><authorinitials>AmosJeffries</authorinitials><revremark>correct link to manual</revremark></revision><revision><revnumber>1</revnumber><date>2010-08-23 09:03:07</date><authorinitials>AmosJeffries</authorinitials><revremark>Basics on captive portal sessions.</revremark></revision></revhistory></articleinfo><section><title>Portal Splash Pages</title><para><emphasis role="strong">Warning</emphasis>: Any example presented here is provided &quot;as-is&quot; with no support or guarantee of suitability. If you have any further questions about these examples please email the squid-users mailing list. </para><section><title>Outline</title><para>Squid when acting as a web portal sometimes is required to present users with service-agreements, terms of access, advertising or other initial displays. </para></section><section><title>Browsing Sessions</title><para>This configuration redirects new visitors to an initial splash page then permits access for a configurable time before redisplaying it. Further visits during this period will extend their <emphasis>session</emphasis>. If the visitors disappears for longer than the session timeout any new request is redirected back to the splash page again and a new session started. </para><para>As of version 1.1 of the session helper, it is possible to use the &quot;-T&quot; option instead of &quot;-t&quot;. This gives a fixed timeout which will force the splash page to be displayed at regular intervals. </para></section><section><title>HTTP Status 511</title><para>Captive portal splash pages can confuse client software when it appears on intercepted traffic responses. The client software can confuse the splash page as a response from the intended origin server. </para><para>RFC <ulink url="https://tools.ietf.org/rfc/rfc6585#">6585</ulink> defines an extension HTTP status code (<emphasis role="strong">511</emphasis>) passing the information back to the client software that the response is NOT from the origin and things may change in future (ie after any splash page login has been performed). <ulink url="https://wiki.squid-cache.org/ConfigExamples/Portal/Splash/Squid-3.2#">Squid-3.2</ulink> and later can be configured to send this extension status code and a template splash page with the <ulink url="http://www.squid-cache.org/Doc/config/deny_info#">deny_info</ulink> directive. </para><itemizedlist><listitem override="none"><informaltable><tgroup cols="2"><colspec colname="col_0"/><colspec colname="col_1"/><tbody><row rowsep="1"><entry colsep="1" rowsep="1"><para> <inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> NOTE </para></entry><entry colsep="1" rowsep="1"><para> Extension status codes cannot be sent by Squid older than 3.2 series. For older Squid you should use a redirect URL in the <ulink url="http://www.squid-cache.org/Doc/config/deny_info#">deny_info</ulink> directive. </para></entry></row></tbody></tgroup></informaltable></listitem></itemizedlist></section><section><title>Squid Configuration File - Simple Example</title><para>NOTE: in the examples below: </para><itemizedlist><listitem><para>It is assumed that the Squid helpers are installed in /usr/local/sbin/squid. Change this as required for your installation. </para></listitem><listitem><para>It is assumed that the URL being redirected to is accessible without going through the proxy. A bypass allow access control may need to be added before this configuration. </para></listitem><listitem><para>The session overall timeout is 7200 seconds. Once this length of time has passed, the splash screen will be shown again to the user. If you want a fixed timeout, use the &quot;-T&quot; option instead (available in version 1.1 of the session helper). </para></listitem><listitem><para>The session is checked once every 60 seconds at most. This means that the splash screen will be shown to the user for 60 seconds, during which time they will not be able to browse any other websites. </para></listitem><listitem><para>A session database file is required. Create an empty file &quot;/var/lib/squid/session.db&quot; and ensure it is writeable to by the Squid user </para></listitem></itemizedlist><para><ulink url="https://wiki.squid-cache.org/ConfigExamples/Portal/Splash/Squid-3.1#">Squid-3.1</ulink> and older: </para><screen><![CDATA[# mind the wrap. this is one line:
external_acl_type splash_page ttl=60 concurrency=100 %SRC /usr/local/sbin/squid/squid_session -t 7200 -b /var/lib/squid/session.db
]]><![CDATA[
acl existing_users external splash_page
]]><![CDATA[
deny_info http://example.com/splash.html existing_users
]]><![CDATA[
http_access deny !existing_users]]></screen><para><ulink url="https://wiki.squid-cache.org/ConfigExamples/Portal/Splash/Squid-3.2#">Squid-3.2</ulink> and later (session helper renamed and 511 status code with splash template): </para><screen><![CDATA[# mind the wrap. this is one line:
external_acl_type splash_page ttl=60 concurrency=100 %SRC /usr/local/sbin/squid/ext_session_acl -t 7200 -b /var/lib/squid/session.db
]]><![CDATA[
acl existing_users external splash_page
]]><![CDATA[
deny_info 511:/etc/squid/splash.html existing_users
]]><![CDATA[
http_access deny !existing_users]]></screen></section><section><title>Squid Configuration File - Active Mode</title><para>You may find that when using the example above that the splash page is not always displayed to users. That is because other processes on the user's computer (such as automatic security updates) can reset the session counter, so it is that process rather than the user's browsing which receives the splash screen. </para><para>The following configuration example adds in a url_regex rule to force the  user to browse to a particular website before the session is reset. This example is for <ulink url="https://wiki.squid-cache.org/ConfigExamples/Portal/Splash/Squid-3.2#">Squid-3.2</ulink> and later, but can be adapted for earlier versions. </para><screen><![CDATA[# Set up the session helper in active mode. Mind the wrap - this is one line:
external_acl_type session concurrency=100 ttl=3 %SRC /usr/lib/squid3/ext_session_acl -a -T 10800 -b /var/lib/squid/session/
]]><![CDATA[
# Pass the LOGIN command to the session helper with this ACL
acl session_login external session LOGIN
]]><![CDATA[
# Normal session ACL as per simple example
acl session_is_active external session
]]><![CDATA[
# ACL to match URL
acl clicked_login_url url_regex -i a-url-that-must-match$
]]><![CDATA[
# First check for the login URL. If present, login session
http_access allow clicked_login_url session_login
]]><![CDATA[
# If we get here, URL not present, so renew session or deny request.
http_access deny !session_is_active
]]><![CDATA[
# Deny page to display
deny_info 511:/etc/squid/splash.html session_is_active]]></screen></section><section><title>Configuration tweaks</title><itemizedlist><listitem><para>This is just the snippet of config which causes the  splash page and session to be enacted. Rules which permit the visitor  use of the proxy are expected to be placed as appropriate below them.  The basic default safety nets should as always be above them. </para></listitem><listitem><para>As mentioned the above configuration emulated web browser sessions. This behaviour is most common for portals, but may not be exactly as desired. To perform other behaviours a custom external ACL helper is needed. </para></listitem><listitem><para>Dependency on an external web server to publish the splash page can be eliminated in some situations with the use of a <ulink url="https://wiki.squid-cache.org/ConfigExamples/Portal/Splash/Features/CustomErrors#">custom error</ulink> page template passed to <ulink url="http://www.squid-cache.org/Doc/config/deny_info#">deny_info</ulink>. However, note that is page can only be a static HTML page. </para></listitem><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> For more information please see <ulink url="http://www.squid-cache.org/Versions/v3/3.2/manuals/ext_session_acl.html">ext_session_acl</ulink>, <ulink url="http://www.squid-cache.org/Doc/config/external_acl_type/">external_acl_type</ulink>, <ulink url="http://www.squid-cache.org/Doc/config/acl/">acl</ulink>, <ulink url="http://www.squid-cache.org/Doc/config/deny_info/">deny_info</ulink>, <ulink url="http://www.squid-cache.org/Doc/config/http_access/">http_access</ulink> </para></listitem></itemizedlist><!--rule (<hr>) is not applicable to DocBook--><para> <ulink url="https://wiki.squid-cache.org/ConfigExamples/Portal/Splash/CategoryConfigExample#">CategoryConfigExample</ulink> </para></section></section></article>