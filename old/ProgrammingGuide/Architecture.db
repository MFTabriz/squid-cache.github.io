<?xml version="1.0" encoding="utf-8"?><!DOCTYPE article  PUBLIC '-//OASIS//DTD DocBook XML V4.4//EN'  'http://www.docbook.org/xml/4.4/docbookx.dtd'><article><articleinfo><title>ProgrammingGuide/Architecture</title><revhistory><revision><revnumber>8</revnumber><date>2016-08-01 14:54:55</date><authorinitials>AlexRousskov</authorinitials><revremark>Polished ICAP transaction description.</revremark></revision><revision><revnumber>7</revnumber><date>2016-08-01 14:48:08</date><authorinitials>AlexRousskov</authorinitials><revremark>We support from-client FTP.</revremark></revision><revision><revnumber>6</revnumber><date>2016-08-01 14:47:18</date><authorinitials>AlexRousskov</authorinitials><revremark>Fixed master transaction definition. M.x. is not tied to a connection. M.x. exist (or should exist) for connection-less requests. A single connection may produce many m.x.</revremark></revision><revision><revnumber>5</revnumber><date>2016-07-31 11:33:00</date><authorinitials>AmosJeffries</authorinitials><revremark>add details of the various Xaction things which can happen currently</revremark></revision><revision><revnumber>4</revnumber><date>2016-07-31 11:00:20</date><authorinitials>AmosJeffries</authorinitials><revremark>copy Alex text from OrderIsImportant</revremark></revision><revision><revnumber>3</revnumber><date>2013-02-26 10:10:33</date><authorinitials>AmosJeffries</authorinitials><revremark>ToC in template has wrong format.</revremark></revision><revision><revnumber>2</revnumber><date>2013-02-26 10:09:43</date><authorinitials>AmosJeffries</authorinitials><revremark>embed broad overview image</revremark></revision><revision><revnumber>1</revnumber><date>2013-02-26 10:06:41</date><authorinitials>AmosJeffries</authorinitials><revremark>create the architecture description page. only 20 years late.</revremark></revision></revhistory></articleinfo><section><title>Squid Architecture</title><section><title>Broad Overview</title><para>Squid is operating at layers 4-7 on the <ulink url="http://wikipedia.org/wiki/OSI_model">OSI data model</ulink>. So unlike most networking applications there is no relationship between packets (a layer 3 concept) and the traffic received by Squid. Instead of packets HTTP operates on a <emphasis role="strong">message</emphasis> basis (called segments in the OSI model definitions), where an HTTP request and response can each be loosely considered equivelent to one &quot;packet&quot; in a transport architecture. Just like IP packets HTTP messages are stateless and the delivery is entirely optional for process. See the RFC <ulink url="https://tools.ietf.org/rfc/rfc7230#">7230</ulink> texts for a better description on HTTP specifics and how it operates. </para><para>At the broad level Squid consists of four generic processing areas; </para><itemizedlist><listitem><para>a client-side which implements HTTP, HTTPS, FTP, ICP and HTCP protocols to communicate with clients, and </para></listitem><listitem><para>a server-side which implements HTTP, HTTPS, FTP, Gopher and WAIS to communicate with web servers, and </para></listitem><listitem><para>between them is the cache storage. Which in broad terms provides the buffering mechanisms for data transit, and provides switching logic to determine data source between disk, memory, and server-side. </para></listitem><listitem><para>there is also a set of components performing extra support tasks; security (authentication and access control), DNS client, IDENT client, and WHOIS client. </para><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata fileref="https://wiki.squid-cache.org/ProgrammingGuide/Architecture?action=AttachFile&amp;do=get&amp;target=BroadOverview.png"/></imageobject><textobject><phrase>BroadOverview.png</phrase></textobject></inlinemediaobject> </para></listitem></itemizedlist></listitem></itemizedlist></section><section><title>General Overview</title><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> The general design level is where Squid-2 and Squid-3 differ. With Squid-2 being composed purely of event callback chains, Squid-3 adds the model of task encapsulation within Jobs. </para></listitem></itemizedlist></section><section><title>Transaction Processing</title><para>A <emphasis role="strong">master transaction</emphasis> (class MasterXaction) manages information shared among the HTTP or FTP request and all related protocol messages (such as the corresponding HTTP/FTP/Gopher/etc. protocol response and control messages) as well as ICAP, eCAP, and helper transactions caused by protocol messages. Much of the code necessary to collect and share this information has yet to be developed. </para><para>A <emphasis role="strong">stream transaction</emphasis> is an HTTP or FTP request with the corresponding final protocol reply. It begins around the time (XXX: define precisely) when the protocol request arrives on the connection. The details from its MasterXaction are copied into a AccessLogEntry which accumulate the details about the stream and eventually winds up in access.log. </para><para>An <emphasis role="strong">ICAP transaction</emphasis> (class Adaptation::Icap::Xaction) is an ICAP request with the corresponding final ICAP response. Many ICAP transactions may occur for a single Master Transaction and, IIRC, ICAP OPTIONS revalidation transactions occur without a Master Transaction. </para><para>A <emphasis role="strong">helper transaction</emphasis> (class Helper::Xaction) may occur for each plugin helper which squid.conf settings may cause to be used by the stream transaction. </para><section><title>HTTP Request</title><para>The following sequence of checks and adjustments is applied to most HTTP requests. This sequence starts after Squid parses the request header and ends before Squid starts satisfying the request from the cache or origin server. The checks are listed here in the order of their execution: </para><orderedlist numeration="arabic"><listitem><para>Host header forgery checks </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/http_access#">http_access</ulink> directive </para></listitem><listitem><para>ICAP/eCAP <ulink url="https://wiki.squid-cache.org/ProgrammingGuide/Architecture/SquidFaq/ContentAdaptation#">adaptation</ulink> </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/url_rewrite_program#">redirector</ulink> </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/adapted_http_access#">adapted_http_access</ulink> directive </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/store_id#">store_id</ulink> directive </para></listitem><listitem><para>clientInterpretRequestHeaders() </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/cache#">cache</ulink> directive </para></listitem><listitem><para>ToS marking </para></listitem><listitem><para>nf marking </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/ssl_bump#">ssl_bump</ulink> directive </para></listitem><listitem><para>callout sequence error handling </para></listitem></orderedlist><para>A failed check may prevent subsequent checks from running. </para><para>A typical HTTP transaction (i.e., a pair of HTTP request and response messages) goes through the above sequence once. However, multiple transactions may participate in processing of a single &quot;web page download&quot;, confusing Squid admins. While all experienced Squid admins know that a single web page may contain dozens and sometimes hundreds of resources, each triggering an HTTP transaction, those multiple transactions may happen even when requesting a single resource and even when using simple command-line tools like curl or wget. </para><para>Internal Squid requests may cause even more confusion. For example, when <ulink url="https://wiki.squid-cache.org/ProgrammingGuide/Architecture/Features/HTTPS#Bumping_direct_SSL.2FTLS_connections">SslBump</ulink> is in use, Squid may create several fake CONNECT transactions for a given TLS connection, and each CONNECT may go through the above motions. If you use SslBump for intercepted port 443 traffic, then shortly after a new connection is accepted by Squid, SslBump creates a fake CONNECT request with TCP level information, and that CONNECT request goes through the above sequence (matching step SslBump1 ACL if any). If an &quot;ssl_bump peek&quot; or &quot;ssl_bump stare&quot; rule matches during that first SslBump step, then SslBump code gets SNI and creates a second fake CONNECT request that goes through the same sequence again. </para><para>Your Squid directives and helpers must be prepared to deal with multiple [CONNECT] requests per connection. </para><!--rule (<hr>) is not applicable to DocBook--><para> Discuss this page using the &quot;Discussion&quot; link in the main menu </para></section></section></section></article>