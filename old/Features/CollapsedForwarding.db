<?xml version="1.0" encoding="utf-8"?><!DOCTYPE article  PUBLIC '-//OASIS//DTD DocBook XML V4.4//EN'  'http://www.docbook.org/xml/4.4/docbookx.dtd'><article><articleinfo><title>Features/CollapsedForwarding</title><revhistory><revision><revnumber>19</revnumber><date>2014-04-30 20:44:29</date><authorinitials>AlexRousskov</authorinitials><revremark>Removed stale implemenation section per Amos request (via Bug 3495).</revremark></revision><revision><revnumber>18</revnumber><date>2014-04-30 17:42:27</date><authorinitials>AmosJeffries</authorinitials><revremark>updates for 3.5 status</revremark></revision><revision><revnumber>17</revnumber><date>2010-10-15 20:02:44</date><authorinitials>Henrik Nordström</authorinitials></revision><revision><revnumber>16</revnumber><date>2010-03-29 15:19:35</date><authorinitials>FrancescoChemolli</authorinitials><revremark>Changed text to be picked up in Features/ page</revremark></revision><revision><revnumber>15</revnumber><date>2010-03-04 11:24:30</date><authorinitials>Henrik Nordström</authorinitials><revremark>config typo</revremark></revision><revision><revnumber>14</revnumber><date>2010-02-19 13:19:59</date><authorinitials>FrancescoChemolli</authorinitials><revremark>Fixed dangling wiki-links</revremark></revision><revision><revnumber>13</revnumber><date>2009-04-10 03:28:52</date><authorinitials>AmosJeffries</authorinitials><revremark>reported as fails under RAM-only caching.</revremark></revision><revision><revnumber>12</revnumber><date>2009-03-08 10:31:29</date><authorinitials>AmosJeffries</authorinitials><revremark>bump target to 3.2</revremark></revision><revision><revnumber>11</revnumber><date>2009-03-08 10:30:03</date><authorinitials>AmosJeffries</authorinitials><revremark>.</revremark></revision><revision><revnumber>10</revnumber><date>2009-01-22 01:44:27</date><authorinitials>nat-dip6.fw.corp.yahoo.com</authorinitials></revision><revision><revnumber>9</revnumber><date>2009-01-22 01:43:46</date><authorinitials>nat-dip6.fw.corp.yahoo.com</authorinitials></revision><revision><revnumber>8</revnumber><date>2009-01-22 01:05:49</date><authorinitials>AmosJeffries</authorinitials><revremark>import feature documentation from devel.squid-cache.org</revremark></revision><revision><revnumber>7</revnumber><date>2008-08-20 02:40:18</date><authorinitials>AmosJeffries</authorinitials><revremark>set priority 1 (experiment in new roadmap ordering)</revremark></revision><revision><revnumber>6</revnumber><date>2008-08-20 02:28:38</date><authorinitials>AmosJeffries</authorinitials><revremark>drop from wishlist to 3.2 high-priority</revremark></revision><revision><revnumber>5</revnumber><date>2008-05-18 19:38:55</date><authorinitials>localhost</authorinitials><revremark>converted to 1.6 markup</revremark></revision><revision><revnumber>4</revnumber><date>2008-05-10 06:03:11</date><authorinitials>AmosJeffries</authorinitials><revremark>bump to 3.2. Important but Still needs updating and testing.</revremark></revision><revision><revnumber>3</revnumber><date>2008-03-18 16:00:43</date><authorinitials>AlexRousskov</authorinitials><revremark>This is a wish</revremark></revision><revision><revnumber>2</revnumber><date>2008-01-15 03:24:30</date><authorinitials>AmosJeffries</authorinitials></revision><revision><revnumber>1</revnumber><date>2008-01-15 03:24:12</date><authorinitials>AmosJeffries</authorinitials></revision></revhistory></articleinfo><section><title>Feature: Collapsed Forwarding</title><itemizedlist><listitem><para><emphasis role="strong">Status</emphasis>: completed in 2.6, 2.7, and ported to <ulink url="https://wiki.squid-cache.org/Features/CollapsedForwarding/Squid-3.5#">Squid-3.5</ulink> </para></listitem><listitem><para><emphasis role="strong">Version</emphasis>: 2.6+ and 3.5+ </para></listitem><listitem><para><emphasis role="strong">Developer</emphasis>: <ulink url="https://wiki.squid-cache.org/Features/CollapsedForwarding/HenrikNordstrom#">HenrikNordstrom</ulink>, <ulink url="https://wiki.squid-cache.org/Features/CollapsedForwarding/AlexRousskov#">AlexRousskov</ulink> </para></listitem><listitem><para><emphasis role="strong">More</emphasis>: Bugs <ulink url="https://bugs.squid-cache.org/show_bug.cgi?id=1614#">1614</ulink> and <ulink url="https://bugs.squid-cache.org/show_bug.cgi?id=3495#">3495</ulink> </para></listitem></itemizedlist><section><title>Details</title><para>This performance enhancement feature enables multiple client requests for the same URI to be processed as one request to the backend server. Normally disabled to avoid increased latency on dynamic content, but there can be benefit from enabling this in accelerator setups where the web servers are the bottleneck but are reliable and return mostly cacheable information. </para><para>It was left out of <ulink url="https://wiki.squid-cache.org/Features/CollapsedForwarding/Squid-3.0#">Squid-3.0</ulink> due to time and stability constraints. The <ulink url="http://www.squid-cache.org/Doc/config/max_stale#">max_stale</ulink> part of this feature was added to <ulink url="https://wiki.squid-cache.org/Features/CollapsedForwarding/Squid-3.2#">Squid-3.2</ulink>, <ulink url="http://www.squid-cache.org/Doc/config/collapsed_forwarding#">collapsed_forwarding</ulink> part to <ulink url="https://wiki.squid-cache.org/Features/CollapsedForwarding/Squid-3.5#">Squid-3.5</ulink>, <ulink url="http://www.squid-cache.org/Doc/config/refresh_stale_hit#">refresh_stale_hit</ulink> is still awaiting re-implementation. </para><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> The <emphasis>stale-while-revalidate</emphasis> part of the original <ulink url="https://wiki.squid-cache.org/Features/CollapsedForwarding/Squid-2.6#">Squid-2.6</ulink> feature has since been turned into an official HTTP/1.1 extension by RFC <ulink url="https://tools.ietf.org/rfc/rfc5861#">5861</ulink>. The protocol header should now be used instead of the squid configuration option. </para></listitem></itemizedlist></section><section><title>Documentation</title><para>In accelerator setups it is desirable if the number of connections to the backend web servers is minimized. However, Squid being designed primarily for forward proxy operation does not take this into consideration. As a result there may be storms of requests to the backend server if a very frequently accessed object expires from the cache or a new very frequently accessed object is added. </para><para>To remedy this situation this feature adds a new tuning knob (<ulink url="https://wiki.squid-cache.org/Features/CollapsedForwarding/SquidConf#">SquidConf</ulink>::collapsed_forwarding) to squid.conf, making Squid delay further requests while a cache revalidation or cache miss is being resolved. This sacrifices general proxy latency in favor for accelerator performance and thus should not be enabled unless you are running an accelerator. </para><para><ulink url="https://wiki.squid-cache.org/Features/CollapsedForwarding/Squid-2.6#">Squid-2.6</ulink> and <ulink url="https://wiki.squid-cache.org/Features/CollapsedForwarding/Squid-2.7#">Squid-2.7</ulink> in addition contain a <emphasis role="strong">stale-while-revalidate</emphasis> option on <ulink url="http://www.squid-cache.org/Doc/config/refresh_pattern#">refresh_pattern</ulink> to shortcut the cache revalidation of frequently accessed objects is added, making further requests immediately return as a cache hit while a cache revalidation is pending. This may temporarily give slightly stale information to the clients, but at the same time allows for optimal response time while a frequently accessed object is being revalidated. This too is an optimization only intended for accelerators, and only for accelerators where minimizing request latency is more important than freshness. </para></section><section><title>Configuration</title><para><ulink url="https://wiki.squid-cache.org/Features/CollapsedForwarding/Squid-2.6#">Squid-2.6</ulink>, <ulink url="https://wiki.squid-cache.org/Features/CollapsedForwarding/Squid-2.7#">Squid-2.7</ulink>, and <ulink url="https://wiki.squid-cache.org/Features/CollapsedForwarding/Squid-3.5#">Squid-3.5</ulink>+: </para><screen><![CDATA[collapsed_forwarding on]]></screen><para>This option enables collapse of multiple requests for the same URI to be processed as one request. Normally disabled to avoid corner cases with hung requests, but there can be large benefit from enabling this in accelerator setups where the web servers are reliable. </para><para><ulink url="https://wiki.squid-cache.org/Features/CollapsedForwarding/Squid-2.6#">Squid-2.6</ulink> and <ulink url="https://wiki.squid-cache.org/Features/CollapsedForwarding/Squid-2.7#">Squid-2.7</ulink> only: </para><screen><![CDATA[refresh_stale_hit interval (default 0)]]></screen><para>This option decreases latency on collapsed forwarding by initiating a revalidation request some time before the object becomes stale. This avoid having more than one client wait for the revalidation to finish. </para></section><section><title>Known issues and shortcomings</title><itemizedlist><listitem><para>The 30 second window should be tuneable; see Bug <ulink url="https://bugs.squid-cache.org/show_bug.cgi?id=2504#">2504</ulink>. </para></listitem><listitem><para>At least in the 2.6 implementation, non-successful responses are not collapsed, leading to the potential for overwhelming the back-end server; see Bug <ulink url="https://bugs.squid-cache.org/show_bug.cgi?id=1918#">1918</ulink>. </para></listitem><listitem><para>Might even be suitable for the general Internet proxy situation, not only reverse proxies. </para></listitem><listitem><para>Fails to occur when memory-only cache is used and no cache_dir are present. </para></listitem></itemizedlist><!--rule (<hr>) is not applicable to DocBook--><para> <ulink url="https://wiki.squid-cache.org/Features/CollapsedForwarding/CategoryFeature#">CategoryFeature</ulink> </para></section></section></article>