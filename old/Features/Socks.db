<?xml version="1.0" encoding="utf-8"?><!DOCTYPE article  PUBLIC '-//OASIS//DTD DocBook XML V4.4//EN'  'http://www.docbook.org/xml/4.4/docbookx.dtd'><article><articleinfo><title>Features/Socks</title><revhistory><revision><revnumber>12</revnumber><date>2015-09-21 04:59:04</date><authorinitials>AmosJeffries</authorinitials></revision><revision><revnumber>11</revnumber><date>2011-10-04 23:01:36</date><authorinitials>AmosJeffries</authorinitials><revremark>update to state the current problem.</revremark></revision><revision><revnumber>10</revnumber><date>2010-11-14 09:23:57</date><authorinitials>AmosJeffries</authorinitials><revremark>update progress.</revremark></revision><revision><revnumber>9</revnumber><date>2010-06-09 12:27:37</date><authorinitials>AmosJeffries</authorinitials><revremark>updated status</revremark></revision><revision><revnumber>8</revnumber><date>2010-04-09 08:59:15</date><authorinitials>AmosJeffries</authorinitials><revremark>some updates.</revremark></revision><revision><revnumber>7</revnumber><date>2009-08-17 11:15:21</date><authorinitials>AmosJeffries</authorinitials><revremark>more info.</revremark></revision><revision><revnumber>6</revnumber><date>2009-06-01 13:03:18</date><authorinitials>AmosJeffries</authorinitials><revremark>update status etc.</revremark></revision><revision><revnumber>5</revnumber><date>2009-06-01 13:02:29</date><authorinitials>AmosJeffries</authorinitials><revremark>very experimental branch available.</revremark></revision><revision><revnumber>4</revnumber><date>2009-05-27 12:50:21</date><authorinitials>AmosJeffries</authorinitials><revremark>threw a bit of code at it now.</revremark></revision><revision><revnumber>3</revnumber><date>2009-05-25 12:49:16</date><authorinitials>AmosJeffries</authorinitials><revremark>typo</revremark></revision><revision><revnumber>2</revnumber><date>2009-05-25 12:48:25</date><authorinitials>AmosJeffries</authorinitials><revremark>some notes on SOCKSifying Squid.</revremark></revision><revision><revnumber>1</revnumber><date>2009-03-21 03:28:23</date><authorinitials>AmosJeffries</authorinitials><revremark>another long overdue feature</revremark></revision></revhistory></articleinfo><section><title>Feature: SOCKS Support</title><itemizedlist><listitem><para><emphasis role="strong">Goal</emphasis>: To add SOCKS support to Squid. </para></listitem><listitem><para><emphasis role="strong">Status</emphasis>: Testing. Code available. </para></listitem><listitem><para><emphasis role="strong">ETA</emphasis>: unknown </para></listitem><listitem><para><emphasis role="strong">Version</emphasis>:  </para></listitem><listitem><para><emphasis role="strong">Developer</emphasis>: <ulink url="https://wiki.squid-cache.org/Features/Socks/AmosJeffries#">AmosJeffries</ulink> </para></listitem></itemizedlist></section><section><title>Details</title><para>Squid handles many HTTP related protocols. But presently is unable to natively accept or send HTTP connections over SOCKS. </para><para>The aim of this project will be to make <ulink url="http://www.squid-cache.org/Doc/config/http_port#">http_port</ulink> accept SOCKS connections and make outgoing connections to SOCKS <ulink url="http://www.squid-cache.org/Doc/config/cache_peers#">cache_peers</ulink> so that Squid can send requests easily through to SOCKS gateways or act as an HTTP SOCKS gateway itself. </para><section><title>Existing State of Squid:</title><para>A little research indicates SOCKSv5 is supposed to be as easy as a new bind() call and library linkage. <ulink url="http://www.squid-cache.org/mail-archive/squid-users/199901/0033.html"/> </para><screen><![CDATA[export CFLAGS=" -Dbind=SOCKSbind "
export CXXFLAGS=" -Dbind=SOCKSbind "
export LDADD=" -lsocks "]]></screen><para>With knowledge of how upstream peering works it follows that the connect() calls Squid may also need to be socksified to use <ulink url="http://www.squid-cache.org/Doc/config/cache_peer#">cache_peer</ulink> with a socks proxy. Which would be: </para><screen><![CDATA[export CFLAGS=" -Dbind=SOCKSbind -Dconnect=SOCKSconnect "
export CXXFLAGS=" -Dbind=SOCKSbind -Dconnect=SOCKSconnect "]]></screen><para>Doing these apparently works ad makes Squid into a SOCKS proxy. There are several users who have reported actively using Squid in this fashion. </para><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/alert.png" width="15"/></imageobject><textobject><phrase>/!\</phrase></textobject></inlinemediaobject> It has one downside in that ALL connections inbound and outbound are SOCKS connections. There is no middle ground for mixed SOCKS/non-SOCKS connections. </para></listitem></itemizedlist></section><section><title>Upgrade Plans</title><para>A new COMM_SOCKSBIND flag will be needed to the comm layer calls for the listener binding, outbound maybe a config setting for <ulink url="http://www.squid-cache.org/Doc/config/cache_peer#">cache_peer</ulink> acting on the bind() choice directly. </para><!--rule (<hr>) is not applicable to DocBook--><para>I've had a bit of time too short to do anything much and created a branch that is supposed to do listening port and SOCKS peers. It builds and listens on an <ulink url="http://www.squid-cache.org/Doc/config/http_port#">http_port</ulink> as far as I can tell now. squidclient has also been adapted to use SOCKS socket operations. Bazaar Branch available on launchpad at <ulink url="https://code.launchpad.net/~yadi/squid/socks"/> for anyone keen on testing. </para><para>Outstanding Problem: </para><itemizedlist><listitem override="none"><para>This branch seems not to perform SOCKS. Even when SOCK libraries are linked and SOCKS binding and connection calls are used. It is most likely my lack of SOCKS programming and debugging knowledge. The branch built and appeared to run fine as a regular proxy. </para></listitem><listitem><para>There seems to be no difference between traffic arriving on a SOCKS_listen() bound port and on a regular listen() bound port. Both regular and SOCKS traffic was tried. Both ports accepted both types of traffic! </para></listitem><listitem><para>There seems to be no SOCKS operations on the outbound cache_peer links, even when talking to a SOCKS server, over a SSH SOCKS tunnel and using SOCKS_connect()+SOCKS_bind() to make the outgoing connection. Possibly errors at the tunnel or server configuration, looking for someone more expert to test that properly. </para></listitem></itemizedlist><para>So currently work is blocked. Using the API via -D= compiler options still apparently works, writing the code to use an if() statement fails. Ideas? </para><para>Situations: </para><itemizedlist><listitem><para>Certain apps sending HTTP but can be configured only with SOCKS proxy (not HTTP proxy) as a relay. Weird but true. </para></listitem><listitem><para>The TOR network passes HTTP traffic but require SOCKS to interface a gateway with that network. </para></listitem><listitem><para>SSH tunnels apparently also use/require SOCKS to tunnel across to a web server at the other end. </para></listitem><listitem><para>A MMORP Game has also been reported as requiring SOCKS to gateway. I have not been able to verify at this point that their traffic is actually HTTP though. </para></listitem></itemizedlist><!--rule (<hr>) is not applicable to DocBook--><para>Extra additions: there seems to also be a system configuration setting and config file(s) for setting a parent SOCKSv5 proxy. It may be useful to pull this in as a possible automatic <ulink url="http://www.squid-cache.org/Doc/config/cache_peer#">cache_peer</ulink> entry. </para><!--rule (<hr>) is not applicable to DocBook--><para> <ulink url="https://wiki.squid-cache.org/Features/Socks/CategoryFeature#">CategoryFeature</ulink> </para></section></section></article>