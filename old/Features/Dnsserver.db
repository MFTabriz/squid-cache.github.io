<?xml version="1.0" encoding="utf-8"?><!DOCTYPE article  PUBLIC '-//OASIS//DTD DocBook XML V4.4//EN'  'http://www.docbook.org/xml/4.4/docbookx.dtd'><article><articleinfo><title>Features/Dnsserver</title><revhistory><revision><revnumber>3</revnumber><date>2010-02-19 10:35:57</date><authorinitials>FrancescoChemolli</authorinitials><revremark>Fixed dangling wiki-links</revremark></revision><revision><revnumber>2</revnumber><date>2008-11-27 21:23:20</date><authorinitials>AmosJeffries</authorinitials><revremark>import more dnsserver info from FAQ pages.</revremark></revision><revision><revnumber>1</revnumber><date>2008-11-22 13:03:32</date><authorinitials>AmosJeffries</authorinitials><revremark>added details from FAQ.</revremark></revision></revhistory></articleinfo><section><title>Feature: dnsserver helper</title><itemizedlist><listitem><para><emphasis role="strong">Status</emphasis>: Obsolete. </para></listitem><listitem><para><emphasis role="strong">Version</emphasis>: All. </para></listitem></itemizedlist></section><section><title>Details</title><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/alert.png" width="15"/></imageobject><textobject><phrase>/!\</phrase></textobject></inlinemediaobject> dnsserver helper is now replaced by a faster internal DNS client. You should NOT be running with external DNS processes. </para></listitem></itemizedlist><section><title>What is the ''dnsserver''?</title><para>The <emphasis>dnsserver</emphasis> is a process forked by <emphasis>squid</emphasis> to resolve IP addresses from domain names.  This is necessary because the <emphasis>gethostbyname(3)</emphasis> function blocks the calling process until the DNS query is completed. </para><para>Squid must use non-blocking I/O at all times, so DNS lookups are implemented external to the main process.  The <emphasis>dnsserver</emphasis> processes do not cache DNS lookups, that is implemented inside the <emphasis>squid</emphasis> process. </para><para>An internal DNS client was integrated into the main Squid binary in Squid-2.3. It is much faster and can scale to match traffic levels without needing a reconfigure. If you have reason to use the old style <emphasis>dnsserver</emphasis> process you can build it at ./configure time using <emphasis>--disable-internal-dns</emphasis>.  However we would suggest that you file a bug if you find that the internal DNS process does not work as you would expect. </para></section></section><section><title>Configuration Options</title><itemizedlist><listitem><para>cache_dns_program </para></listitem><listitem><para>dns_children </para></listitem><listitem><para>positive_dns_ttl </para></listitem><listitem><para>negative_dns_ttl </para></listitem><listitem><para>min_dns_poll_cnt </para></listitem></itemizedlist></section><section><title>Troubleshooting</title><section><title>dnsSubmit: queue overload, rejecting blah</title><para>This means that you are using external <emphasis>dnsserver</emphasis> processes for lookups, and all processes are busy, and Squid's pending queue is full.  Each <emphasis>dnsserver</emphasis> program can only handle one request at a time.  When all <emphasis>dnsserver</emphasis> processes are busy, Squid queues up requests, but only to a certain point. </para><para>To alleviate this condition, you need to either (1) increase the number of <emphasis>dnsserver</emphasis> processes by changing the value for <emphasis>dns_children</emphasis> in your config file, or (2) switch to using Squid's internal DNS client code. </para><para>Note that in some versions, Squid limits <emphasis>dns_children</emphasis> to 32.  To increase it beyond that value, you would have to edit the source code. </para></section><section><title>My ''dnsserver'' average/median service time seems high, how can I reduce it?</title><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/idea.png" width="15"/></imageobject><textobject><phrase>(!)</phrase></textobject></inlinemediaobject> Use the internal DNS resolver now built into Squid. It is not limited to single request-response blocking. </para></listitem></itemizedlist><para>First, find out if you have enough <emphasis>dnsserver</emphasis> processes running by looking at the <ulink url="https://wiki.squid-cache.org/Features/Dnsserver/SquidFaq/CacheManager#">SquidFaq/CacheManager</ulink> <emphasis>dns</emphasis> output.  Ideally, you should see that the first <emphasis>dnsserver</emphasis> handles a lot of requests, the second one less than the first, etc.  The last <emphasis>dnsserver</emphasis> should have serviced relatively few requests.  If there is not an obvious decreasing trend, then you need to increase the number of <emphasis>dns_children</emphasis> in the configuration file.  If the last <emphasis>dnsserver</emphasis> has zero requests, then you definately have enough. </para><para>Another factor which affects the DNS service time is the proximity of your DNS resolver.  Normally we do not recommend running Squid and Resolver on the same host.  Instead you should try use a DNS resolver on a different host, but on the same LAN. If your DNS traffic must pass through one or more routers, this could be causing unnecessary delays. </para></section><section><title>I have &quot;dnsserver&quot; processes that aren't being used, should I lower the number in &quot;squid.conf&quot;?</title><para>The <emphasis>dnsserver</emphasis> processes were originally used by <emphasis>squid</emphasis> because the <emphasis>gethostbyname(3)</emphasis> library routines used to convert web sites names to their internet addresses blocks until the function returns (i.e., the process that calls it has to wait for a reply). Since there is only one <emphasis>squid</emphasis> process, everyone who uses the cache would have to wait each time the routine was called.  This is why the <emphasis>dnsserver</emphasis> is a separate process, so that these processes can block, without causing blocking in <emphasis>squid</emphasis>. </para><para>It's very important that there are enough <emphasis>dnsserver</emphasis> processes to cope with every access you will need, otherwise <emphasis>squid</emphasis> will stop occasionally.  A good rule of thumb is to make sure you have at least the maximum number of dnsservers <emphasis>squid</emphasis> has <emphasis role="strong">ever</emphasis> needed on your system, and probably add two to be on the safe side. In other words, if you have only ever seen at most three <emphasis>dnsserver</emphasis> processes in use, make at least five.  Remember that a <emphasis>dnsserver</emphasis> is small and, if unused, will be swapped out. </para><!--rule (<hr>) is not applicable to DocBook--><para> <ulink url="https://wiki.squid-cache.org/Features/Dnsserver/CategoryFeature#">CategoryFeature</ulink> </para></section></section></article>