<?xml version="1.0" encoding="utf-8"?><!DOCTYPE article  PUBLIC '-//OASIS//DTD DocBook XML V4.4//EN'  'http://www.docbook.org/xml/4.4/docbookx.dtd'><article><articleinfo><title>Features/StoreUrlRewrite</title><revhistory><revision><revnumber>11</revnumber><date>2013-07-27 04:58:20</date><authorinitials>AmosJeffries</authorinitials><revremark>update version info</revremark></revision><revision><revnumber>10</revnumber><date>2012-07-13 20:12:59</date><authorinitials>Eliezer Croitoru</authorinitials><revremark>fixing jesred homepage</revremark></revision><revision><revnumber>9</revnumber><date>2012-07-13 19:53:29</date><authorinitials>Eliezer Croitoru</authorinitials></revision><revision><revnumber>8</revnumber><date>2011-03-17 08:55:19</date><authorinitials>AmosJeffries</authorinitials><revremark>polish a bit and add protocol description from addons page.</revremark></revision><revision><revnumber>7</revnumber><date>2009-07-26 07:09:14</date><authorinitials>AmosJeffries</authorinitials><revremark>fix the refresh_pattern docs</revremark></revision><revision><revnumber>6</revnumber><date>2008-09-12 03:30:13</date><authorinitials>AdrianChadd</authorinitials></revision><revision><revnumber>5</revnumber><date>2008-05-18 19:38:59</date><authorinitials>localhost</authorinitials><revremark>converted to 1.6 markup</revremark></revision><revision><revnumber>4</revnumber><date>2007-11-17 14:17:12</date><authorinitials>AdrianChadd</authorinitials></revision><revision><revnumber>3</revnumber><date>2007-11-17 14:16:00</date><authorinitials>AdrianChadd</authorinitials></revision><revision><revnumber>2</revnumber><date>2007-11-17 02:02:28</date><authorinitials>AdrianChadd</authorinitials><revremark>oops, paste+rearrange mistake!</revremark></revision><revision><revnumber>1</revnumber><date>2007-11-16 11:33:30</date><authorinitials>AdrianChadd</authorinitials></revision></revhistory></articleinfo><section><title>Feature: Store URL Rewriting?</title><itemizedlist><listitem><para><emphasis role="strong">Goal</emphasis>: Separate out the URL used for storage lookups from the URL used for forwarding. This allows for multiple destination URLs to reference the same backend content and cut back on duplicated content, both for forward proxies (think &quot;google maps&quot;) and CDN type reverse proxies. </para></listitem><listitem><para><emphasis role="strong">Status</emphasis>: deprecated. see <ulink url="https://wiki.squid-cache.org/Features/StoreUrlRewrite/Features/StoreID#">StoreID</ulink> </para></listitem><listitem><para><emphasis role="strong">Version</emphasis>: 2.7 (only) </para></listitem><listitem><para><emphasis role="strong">Developer</emphasis>: <ulink url="https://wiki.squid-cache.org/Features/StoreUrlRewrite/AdrianChadd#">AdrianChadd</ulink>. </para></listitem><listitem><para><emphasis role="strong">More</emphasis>: Background information about Google Maps content - <ulink url="http://squidproxy.wordpress.com/2007/11/16/how-cachable-is-google-part-1-google-maps/"/> (Disclaimer: No, I don't work for Google. No, never have.) </para></listitem><listitem><para><emphasis role="strong">Sponsored by</emphasis>: Xenion Communications - <ulink url="http://www.xenion.com.au/"/> </para></listitem></itemizedlist><section><title>Details</title><para>My main focus with this feature is to support caching various CDN-supplied content which maps the same resource/content to multiple locations. Initially I'm targetting Google content - Google Earth, Google Maps, Google Video, Youtube - but the same technique can be used to cache similar content from CDNs such as Akamai (think &quot;Microsoft Updates&quot;.) </para><para>The current changes to Squid-2.HEAD implement the functionality through a number of structural changes: </para><itemizedlist><listitem><para>The &quot;Rewrite&quot; code in client_side.c is broken out into client_side_rewrite.c; </para></listitem><listitem><para>This was used as a template for &quot;store URL&quot; rewriting in client_side_storeurl_rewrite.c; </para></listitem><listitem><para>An external helper (exactly the same data format is used as a redirect helper!) receives URLs and can rewrite them to a canonical form - these rewritten URLs are stored as &quot;store_url&quot; URLs, seperate from the normal URL; </para></listitem><listitem><para>The existing/normal URLs are used for ACL and forwarding </para></listitem><listitem><para>The &quot;store_url&quot; URLs are used for the store key lookup and storage </para></listitem><listitem><para>A new meta type has been added - STORE_META_STOREURL - which means the on-disk object format has slightly changed. There's no big deal here - Squid may warn about an unknown meta data type if you rollback to another squid version after trying this feature but it won't affect the operation of your cache. </para></listitem></itemizedlist></section><section><title>Squid Configuration</title><para>First, you need to determine which URLs to send to the store url rewriter. </para><screen><![CDATA[acl store_rewrite_list dstdomain mt.google.com mt0.google.com mt1.google.com mt2.google.com
acl store_rewrite_list dstdomain mt3.google.com
acl store_rewrite_list dstdomain kh.google.com kh0.google.com kh1.google.com kh2.google.com
acl store_rewrite_list dstdomain kh3.google.com
acl store_rewrite_list dstdomain kh.google.com.au kh0.google.com.au kh1.google.com.au
acl store_rewrite_list dstdomain kh2.google.com.au kh3.google.com.au
]]><![CDATA[
# This needs to be narrowed down quite a bit!
acl store_rewrite_list dstdomain .youtube.com
]]><![CDATA[
storeurl_access allow store_rewrite_list
storeurl_access deny all]]></screen><para>Then you need to configure a rewriter helper. </para><screen><![CDATA[storeurl_rewrite_program /Users/adrian/work/squid/run/local/store_url_rewrite]]></screen><para>Then, to cache the content in Google Maps/etc, you need to change the defaults so content with &quot;?&quot;'s in the URL aren't automatically made uncachable. Search your configuration and remove these two lines: </para><screen><![CDATA[#We recommend you to use the following two lines.
acl QUERY urlpath_regex cgi-bin \?
cache deny QUERY ]]></screen><para>Make sure you check your configuration file for cache and no_cache directives; you need to disable them and use refresh_patterns where applicable to tell Squid what to not cache! </para><para>Then, add these refresh patterns at the <emphasis role="strong">bottom</emphasis> of your <ulink url="http://www.squid-cache.org/Doc/config/refresh_pattern#">refresh_pattern</ulink> section. </para><screen><![CDATA[refresh_pattern -i (/cgi-bin/|\?)   0       0%      0
refresh_pattern .                   0       20%     4320]]></screen><para>These rules make sure that you don't try caching cgi-bin and ? URLs unless expiry information is explictly given. Make sure you don't add the rules after a &quot;refresh_pattern .&quot; line; refresh_pattern entries are evaluated in order and the first match is used! The last entry must be the &quot;.&quot; entry! </para></section><section><title>Storage URL re-writing Helper</title><para>Here's what I've been using: </para><programlisting format="linespecific" language="highlight" linenumbering="numbered" startinglinenumber="1"><lineannotation><![CDATA[#!/usr/local/sbin/perl]]></lineannotation>
<methodname><![CDATA[$|]]></methodname><![CDATA[ = 1;]]>
<token><![CDATA[while]]></token><![CDATA[ (<>) {]]>
<![CDATA[        ]]><token><![CDATA[chomp]]></token><![CDATA[;]]>
<![CDATA[        ]]><lineannotation><![CDATA[# print STDERR $_ . "\n";]]></lineannotation>
<![CDATA[        ]]><token><![CDATA[if]]></token><![CDATA[ (]]><phrase><![CDATA[m/kh(.*?)\.google\.com(.*?)\/(.*?) /]]></phrase><![CDATA[) {]]>
<![CDATA[                ]]><token><![CDATA[print]]></token><![CDATA[ ]]><phrase><![CDATA["http://keyhole-srv.google.com"]]></phrase><![CDATA[ . ]]><methodname><![CDATA[$]]></methodname><methodname><![CDATA[2]]></methodname><![CDATA[ . ]]><phrase><![CDATA[".SQUIDINTERNAL/"]]></phrase><![CDATA[ . ]]><methodname><![CDATA[$]]></methodname><methodname><![CDATA[3]]></methodname><![CDATA[ . ]]><phrase><![CDATA["\n"]]></phrase><![CDATA[;]]>
<![CDATA[                ]]><lineannotation><![CDATA[# print STDERR "KEYHOLE\n";]]></lineannotation>
<![CDATA[        } ]]><token><![CDATA[elsif]]></token><![CDATA[ (]]><phrase><![CDATA[m/mt(.*?)\.google\.com(.*?)\/(.*?) /]]></phrase><![CDATA[) {]]>
<![CDATA[                ]]><token><![CDATA[print]]></token><![CDATA[ ]]><phrase><![CDATA["http://map-srv.google.com"]]></phrase><![CDATA[ . ]]><methodname><![CDATA[$]]></methodname><methodname><![CDATA[2]]></methodname><![CDATA[ . ]]><phrase><![CDATA[".SQUIDINTERNAL/"]]></phrase><![CDATA[ . ]]><methodname><![CDATA[$]]></methodname><methodname><![CDATA[3]]></methodname><![CDATA[ . ]]><phrase><![CDATA["\n"]]></phrase><![CDATA[;]]>
<![CDATA[                ]]><lineannotation><![CDATA[# print STDERR "MAPSRV\n";]]></lineannotation>
<![CDATA[        } ]]><token><![CDATA[elsif]]></token><![CDATA[ (]]><phrase><![CDATA[m/^http:\/\/([A-Za-z]*?)-(.*?)\.(.*)\.youtube\.com\/get_video\?video_id=(.*) /]]></phrase><![CDATA[) {]]>
<![CDATA[                ]]><lineannotation><![CDATA[# http://lax-v290.lax.youtube.com/get_video?video_id=jqx1ZmzX0k0]]></lineannotation>
<![CDATA[                ]]><token><![CDATA[print]]></token><![CDATA[ ]]><phrase><![CDATA["http://video-srv.youtube.com.SQUIDINTERNAL/get_video?video_id="]]></phrase><![CDATA[ . ]]><methodname><![CDATA[$]]></methodname><methodname><![CDATA[4]]></methodname><![CDATA[ . ]]><phrase><![CDATA["\n"]]></phrase><![CDATA[;]]>
<![CDATA[        } ]]><token><![CDATA[else]]></token><![CDATA[ {]]>
<![CDATA[                ]]><token><![CDATA[print]]></token><![CDATA[ ]]><methodname><![CDATA[$]]></methodname><methodname><![CDATA[_]]></methodname><![CDATA[ . ]]><phrase><![CDATA["\n"]]></phrase><![CDATA[;]]>
<![CDATA[        }]]>
<![CDATA[}]]>
</programlisting><para>A simple very fast rewriter called <ulink url="http://squirm.foote.com.au/">SQUIRM</ulink> is also good to check out, it uses the regex lib to allow pattern matching. </para><para>An even faster and slightly more featured rewriter is <ulink url="http://www.linofee.org/~jel/webtools/jesred/">jesred</ulink>. </para></section><section><title>How do I make my own?</title><para>The helper program must read URLs (one per line) on standard input, and write rewritten URLs or blank lines on standard output. Squid writes additional information after the URL which a redirector can use to make a decision. </para><para>Input line received from Squid: </para><screen><![CDATA[[channel-ID] URL [key-extras]]]></screen><glosslist><glossentry><glossterm>channel-ID</glossterm><glossdef><itemizedlist><listitem override="none"><para>This is an ID for the line when concurrency is enabled. When concurrency is turned off (set to <emphasis role="strong">1</emphasis>) this field and the following space will be completely missing. </para></listitem></itemizedlist></glossdef></glossentry><glossentry><glossterm>URL</glossterm><glossdef><itemizedlist><listitem override="none"><para>The URL received from the client. In Squid with ICAP support, this is the URL after ICAP REQMOD has taken place. </para></listitem></itemizedlist></glossdef></glossentry><glossentry><glossterm>key-extras</glossterm><glossdef><itemizedlist><listitem override="none"><para>Starting with <ulink url="https://wiki.squid-cache.org/Features/StoreUrlRewrite/Squid-3.5#">Squid-3.5</ulink> additional parameters passed to the helper which may be configured with <ulink url="http://www.squid-cache.org/Doc/config/url_rewrite_extras#">url_rewrite_extras</ulink>. For backward compatibility the default key-extras for URL helpers matches the format fields sent by <ulink url="https://wiki.squid-cache.org/Features/StoreUrlRewrite/Squid-3.4#">Squid-3.4</ulink> and older in this field position: </para></listitem></itemizedlist><itemizedlist><listitem override="none"><screen><![CDATA[ ip/fqdn ident method [urlgroup] kv-pair]]></screen></listitem></itemizedlist></glossdef></glossentry><glossentry><glossterm>ip</glossterm><glossdef><itemizedlist><listitem override="none"><para>This is the IP address of the client. Followed by a slash (<emphasis role="strong">/</emphasis>) as shown above. </para></listitem></itemizedlist></glossdef></glossentry><glossentry><glossterm>fqdn</glossterm><glossdef><itemizedlist><listitem override="none"><para>The FQDN rDNS of the client, if any is known. Squid does not normally perform lookup unless needed by logging or ACLs. Squid does not wait for any results unless ACLs are configured to wait. If none is available <emphasis role="strong">-</emphasis> will be sent to the helper instead. </para></listitem></itemizedlist></glossdef></glossentry><glossentry><glossterm>ident</glossterm><glossdef><itemizedlist><listitem override="none"><para>The IDENT protocol username (if known) of the client machine. Squid will not wait for IDENT username to become known unless there are ACL which depend on it. So at the time re-writers are run the IDENT username may not yet be known. If none is available <emphasis role="strong">-</emphasis> will be sent to the helper instead. </para></listitem></itemizedlist></glossdef></glossentry><glossentry><glossterm>method</glossterm><glossdef><itemizedlist><listitem override="none"><para>The HTTP request method. URL alterations and particularly redirection are only possible on certain methods, and some such as POST and CONNECT require special care. </para></listitem></itemizedlist></glossdef></glossentry><glossentry><glossterm>urlgroup</glossterm><glossdef><itemizedlist><listitem override="none"><para>Squid-2 will send this field with the URL-grouping tag which can be configured on <ulink url="http://www.squid-cache.org/Doc/config/http_port#">http_port</ulink>. Squid-3.x will not send this field. </para></listitem></itemizedlist></glossdef></glossentry><glossentry><glossterm>kv-pair</glossterm><glossdef><itemizedlist><listitem override="none"><para>One or more key=value pairs. Only &quot;myip&quot; and &quot;myport&quot; pairs documented below were ever defined and are sent unconditionally by <ulink url="https://wiki.squid-cache.org/Features/StoreUrlRewrite/Squid-3.4#">Squid-3.4</ulink> and older: </para><informaltable><tgroup cols="2"><colspec colname="col_0"/><colspec colname="col_1"/><tbody><row rowsep="1"><entry colsep="1" rowsep="1"><para> myip=... </para></entry><entry colsep="1" rowsep="1"><para> Squid receiving address </para></entry></row><row rowsep="1"><entry colsep="1" rowsep="1"><para> myport=... </para></entry><entry colsep="1" rowsep="1"><para> Squid receiving port </para></entry></row></tbody></tgroup></informaltable></listitem></itemizedlist></glossdef></glossentry></glosslist><para>Result line sent back to Squid: </para><screen><![CDATA[[channel-ID] [result] [kv-pair] [URL]]]></screen><glosslist><glossentry><glossterm>channel-ID</glossterm><glossdef><itemizedlist><listitem override="none"><para>When a concurrency <emphasis role="strong">channel-ID</emphasis> is received it must be sent back to Squid unchanged as the first entry on the line. </para></listitem></itemizedlist></glossdef></glossentry><glossentry><glossterm>result</glossterm><glossdef><itemizedlist><listitem override="none"><para>One of the result codes: </para><informaltable><tgroup cols="2"><colspec colname="col_0"/><colspec colname="col_1"/><tbody><row rowsep="1"><entry colsep="1" rowsep="1"><para> OK </para></entry><entry colsep="1" rowsep="1"><para> Success. A new URL is presented </para></entry></row><row rowsep="1"><entry colsep="1" rowsep="1"><para> ERR </para></entry><entry colsep="1" rowsep="1"><para> Success. No change for this URL. </para></entry></row><row rowsep="1"><entry colsep="1" rowsep="1"><para> BH </para></entry><entry colsep="1" rowsep="1"><para> Failure. The helper encountered a problem. </para></entry></row></tbody></tgroup></informaltable></listitem><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> the result field is only accepted by <ulink url="https://wiki.squid-cache.org/Features/StoreUrlRewrite/Squid-3.4#">Squid-3.4</ulink> and newer. </para></listitem></itemizedlist></glossdef></glossentry><glossentry><glossterm>kv-pair</glossterm><glossdef><itemizedlist><listitem override="none"><para>One or more key=value pairs. The key names reserved on this interface for URL re-writing: </para><informaltable><tgroup cols="2"><colspec colname="col_0"/><colspec colname="col_1"/><tbody><row rowsep="1"><entry colsep="1" rowsep="1"><para> clt_conn_tag=... </para></entry><entry colsep="1" rowsep="1"><para> Tag the client TCP connection (<ulink url="https://wiki.squid-cache.org/Features/StoreUrlRewrite/Squid-3.5#">Squid-3.5</ulink>) </para></entry></row><row rowsep="1"><entry colsep="1" rowsep="1"><para> message=... </para></entry><entry colsep="1" rowsep="1"><para> reserved </para></entry></row><row rowsep="1"><entry colsep="1" rowsep="1"><para> rewrite-url=... </para></entry><entry colsep="1" rowsep="1"><para> re-write the transaction to the given URL. </para></entry></row><row rowsep="1"><entry colsep="1" rowsep="1"><para> tag=... </para></entry><entry colsep="1" rowsep="1"><para> reserved </para></entry></row><row rowsep="1"><entry colsep="1" rowsep="1"><para> ttl=... </para></entry><entry colsep="1" rowsep="1"><para> reserved </para></entry></row><row rowsep="1"><entry colsep="1" rowsep="1"><para> *_=... </para></entry><entry colsep="1" rowsep="1"><para> Key names ending in (_) are reserved for local administrators use. </para></entry></row></tbody></tgroup></informaltable></listitem><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> the kv-pair field is only accepted by <ulink url="https://wiki.squid-cache.org/Features/StoreUrlRewrite/Squid-3.4#">Squid-3.4</ulink> and newer. </para></listitem><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> the kv-pair returned by this helper can be logged by the <emphasis role="strong">%note</emphasis> <ulink url="http://www.squid-cache.org/Doc/config/logformat#">logformat</ulink> code. </para></listitem></itemizedlist></glossdef></glossentry></glosslist><glosslist><glossentry><glossterm>URL</glossterm><glossdef><itemizedlist><listitem override="none"><para>The URL to be used instead of the one sent by the client. If no action is required leave the URL field blank. The URL sent must be an absolute URL. ie starting with <ulink url="http://"/> or <ulink url="ftp://"/> etc. </para></listitem></itemizedlist></glossdef></glossentry></glosslist></section><section><title>Testing</title><para>Finally, restart Squid-2.HEAD and browse google maps; check your access.log and store.log to make sure URLs are being cached! Check store.log to make sure that the google maps/earth images are being stored in the cache (SWAPOUT) and not just RELEASEd immediately. </para><!--rule (<hr>) is not applicable to DocBook--><para> <ulink url="https://wiki.squid-cache.org/Features/StoreUrlRewrite/CategoryFeature#">CategoryFeature</ulink> </para></section></section></article>