<?xml version="1.0" encoding="utf-8"?><!DOCTYPE article  PUBLIC '-//OASIS//DTD DocBook XML V4.4//EN'  'http://www.docbook.org/xml/4.4/docbookx.dtd'><article><articleinfo><title>Features/LogDnsWait</title><revhistory><revision><revnumber>6</revnumber><date>2015-08-31 09:05:36</date><authorinitials>FrancescoChemolli</authorinitials><revremark>Fix link to bugzilla.</revremark></revision><revision><revnumber>5</revnumber><date>2010-05-25 04:02:28</date><authorinitials>AmosJeffries</authorinitials><revremark>DNs wait logging is in for 3.2</revremark></revision><revision><revnumber>4</revnumber><date>2009-04-08 17:48:22</date><authorinitials>AlexRousskov</authorinitials><revremark>Added a v3.1+ branch link</revremark></revision><revision><revnumber>3</revnumber><date>2009-04-08 17:16:41</date><authorinitials>AlexRousskov</authorinitials><revremark>Added development branch info</revremark></revision><revision><revnumber>2</revnumber><date>2009-04-08 16:52:44</date><authorinitials>AlexRousskov</authorinitials><revremark>added implementation hints</revremark></revision><revision><revnumber>1</revnumber><date>2009-04-08 16:30:07</date><authorinitials>AlexRousskov</authorinitials><revremark>initial documentation</revremark></revision></revhistory></articleinfo><section><title>Feature: DNS wait time logging for access.log</title><itemizedlist><listitem><para><emphasis role="strong">Goal</emphasis>: Provide per-transaction DNS delay information for post-mortem analysis.  </para></listitem><listitem><para><emphasis role="strong">Status</emphasis>: In progress </para></listitem><listitem><para><emphasis role="strong">Version</emphasis>: 3.2 </para></listitem><listitem><para><emphasis role="strong">Developer</emphasis>: <ulink url="https://wiki.squid-cache.org/Features/LogDnsWait/AlexRousskov#">AlexRousskov</ulink> </para></listitem></itemizedlist></section><section><title>Overview</title><para>A <emphasis>master transaction</emphasis> is all Squid activities associated with handling of a single incoming HTTP request. A master transaction may include communication with cache peers, origin servers, and ICAP servers. Master transaction details are logged to access.log. </para><para>This project adds a new access log format code to record total DNS wait time for each master transaction. This measurement accumulates time intervals when an activity directly related to a master transaction was expecting a DNS answer. The master transaction may not have been blocked while waiting for a DNS lookup as other activities within the same master transaction may not depend on the DNS lookup.  </para><para>The new access log format code name is <emphasis>dt</emphasis>. The value is logged as an integer representing total DNS wait time in milliseconds. If no DNS lookups were associated with the master transaction, a dash symbol ('­') is logged. The logged value may not cover all DNS lookups because some DNS operations happen deep in the code where it is difficult to reliably associate a lookup with a master transaction.  </para><para>As any time­-related log field, the DNS wait time precision is a few milliseconds at best, due to infrequent updates of the Squid internal clock and event processing delays. </para></section><section><title>Implementation ideas</title><para>Master transaction stats are accumulated in <emphasis>HttpRequest</emphasis> or its members. We can create a <emphasis>MasterDnsStats</emphasis> class to maintain DNS statistics for a master transaction. Cloned requests should inherit the old <emphasis>MasterDnsStats</emphasis> member value. </para><para>Keeping the total time accumulator is probably insufficient. To deal with concurrent DNS lookups for a single master transaction and to accommodate lookups that have not ended at the logging time, <emphasis>MasterDnsStats</emphasis> may use <emphasis>level</emphasis> and <emphasis>start</emphasis> members as well. The <emphasis>level</emphasis> member represents the current number of concurrent DNS lookups. The <emphasis>start</emphasis> member keeps the last time when concurrent DNS lookups started at level zero. A new DNS lookup increases the level. A finished lookup decreases the level and if it is the last lookup, adds <emphasis>current_time-start</emphasis> difference to the transaction total. Methods to encapsulate lookup start/end accounting should be added. </para><para>If the concurrency level is positive at the master transaction logging time, the logged value is increased by <emphasis>current_time-start</emphasis> difference. </para><para>It may be difficult to locate the master transaction from where DNS lookups are initiated or finished. Solving this puzzle may help properly fix Squid <ulink url="https://bugs.squid-cache.org/show_bug.cgi?id=2459#">bug #2459</ulink>. </para></section><section><title>Availability</title><para>The development is done on Squid3 trunk, targeting official v3.2 inclusion. The feature is also unofficially ported to <ulink url="https://code.launchpad.net/~rousskov/squid/3p1-plus">v3.1</ulink>. </para><!--rule (<hr>) is not applicable to DocBook--><para> <ulink url="https://wiki.squid-cache.org/Features/LogDnsWait/CategoryFeature#">CategoryFeature</ulink> </para></section></article>