<?xml version="1.0" encoding="utf-8"?><!DOCTYPE article  PUBLIC '-//OASIS//DTD DocBook XML V4.4//EN'  'http://www.docbook.org/xml/4.4/docbookx.dtd'><article><articleinfo><title>Features/DiskDaemon</title><revhistory><revision><revnumber>13</revnumber><date>2015-02-21 19:54:17</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>12</revnumber><date>2015-02-21 19:49:51</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>11</revnumber><date>2015-02-21 19:44:07</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>10</revnumber><date>2015-02-21 19:42:21</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>9</revnumber><date>2008-11-22 13:10:37</date><authorinitials>AmosJeffries</authorinitials><revremark>import from FAQ</revremark></revision><revision><revnumber>8</revnumber><date>2008-11-22 13:06:25</date><authorinitials>AmosJeffries</authorinitials><revremark>this is a feature description</revremark></revision><revision><revnumber>7</revnumber><date>2008-09-01 03:33:23</date><authorinitials>AmosJeffries</authorinitials><revremark>don't use for Linux. (preserve the info as comments anyway)</revremark></revision><revision><revnumber>6</revnumber><date>2008-07-17 03:39:48</date><authorinitials>AmosJeffries</authorinitials><revremark>side-note: Linux AUFS beats diskd now.</revremark></revision><revision><revnumber>5</revnumber><date>2008-05-18 19:38:59</date><authorinitials>localhost</authorinitials><revremark>converted to 1.6 markup</revremark></revision><revision><revnumber>4</revnumber><date>2006-03-03 09:27:23</date><authorinitials>kinkie</authorinitials></revision><revision><revnumber>3</revnumber><date>2006-02-25 00:32:26</date><authorinitials>nat.measurement-factory.com</authorinitials></revision><revision><revnumber>2</revnumber><date>2006-02-10 13:22:24</date><authorinitials>kinkie</authorinitials><revremark>Markup fix</revremark></revision><revision><revnumber>1</revnumber><date>2006-01-26 10:27:42</date><authorinitials>kinkie</authorinitials></revision></revhistory></articleinfo><section><title>Feature: Disk Daemon (diskd) helper</title><itemizedlist><listitem><para><emphasis role="strong">Status</emphasis>: Complete. </para></listitem><listitem><para><emphasis role="strong">Version</emphasis>: 2.4 </para></listitem></itemizedlist></section><section><title>Details</title><section><title>What is DISKD?</title><para>DISKD refers to some features in Squid-2.4 and later to improve Disk I/O performance.  The basic idea is that each <emphasis>cache_dir</emphasis> has its own <emphasis>diskd</emphasis> child process.  The diskd process performs all disk I/O operations (open, close, read, write, unlink) for the cache_dir. Message queues are used to send requests and responses between the Squid and diskd processes.  Shared memory is used for chunks of data to be read and written. </para></section><section><title>Does it perform better?</title><para>Yes.  We benchmarked Squid-2.4 with DISKD at the <ulink url="http://polygraph.ircache.net/Results/bakeoff-2/">Second IRCache Bake-Off</ulink>.  The results are also described <ulink url="http://www.squid-cache.org/Benchmarking/bakeoff-02/">here</ulink>.  At the bakeoff, we got 160 req/sec with diskd.  Without diskd, we'd have gotten about 40 req/sec. </para><informaltable><tgroup cols="2"><colspec colname="col_0"/><colspec colname="col_1"/><tbody><row rowsep="1"><entry colsep="1" rowsep="1"><para> <inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/alert.png" width="15"/></imageobject><textobject><phrase>/!\</phrase></textobject></inlinemediaobject> </para></entry><entry colsep="1" rowsep="1"><para> Modern <emphasis>Linux</emphasis> systems the Disk Daemon has been trumped by extremely fast AUFS. diskd is still recommended for <emphasis>BSD</emphasis> variants. However, we may have found an implementation bug in squid which was hobbling AUFS on BSD. </para></entry></row></tbody></tgroup></informaltable></section><section><title>How do I use it?</title><para>You need to run Squid version <ulink url="http://www.squid-cache.org/Versions/v2/2.4">2.4</ulink> or later. Your operating system must support message queues, and shared memory. </para><para>To configure Squid for DISKD, use the <emphasis>--enable-storeio</emphasis> option: </para><screen><![CDATA[% ./configure --enable-storeio=diskd,ufs]]></screen></section><section><title>FATAL: Unknown cache_dir type 'diskd'</title><para>You didn't put <emphasis>diskd</emphasis> in the list of storeio modules as described above.  You need to run <emphasis>configure</emphasis> and and recompile Squid. </para></section><section><title>If I use DISKD, do I have to wipe out my current cache?</title><para>No.  Diskd uses the same storage scheme as the standard &quot;UFS&quot; type.  It only changes how I/O is performed. </para></section><section><title>How do I configure message queues?</title><para>Most Unix operating systems have message queue support by default.  One way to check is to see if you have an <emphasis>ipcs</emphasis> command. </para><para>However, you will likely need to increase the message queue parameters for Squid.  Message queue implementations normally have the following parameters: </para><glosslist><glossentry><glossterm>MSGMNB</glossterm><glossdef><para>Maximum number of bytes per message queue. </para></glossdef></glossentry><glossentry><glossterm>MSGMNI</glossterm><glossdef><para>Maximum number of message queue identifiers (system wide). </para></glossdef></glossentry><glossentry><glossterm>MSGSEG</glossterm><glossdef><para>Maximum number of message segments per queue. </para></glossdef></glossentry><glossentry><glossterm>MSGSSZ</glossterm><glossdef><para>Size of a message segment. </para></glossdef></glossentry><glossentry><glossterm>MSGTQL</glossterm><glossdef><para>Maximum number of messages (system wide). </para></glossdef></glossentry><glossentry><glossterm>MSGMAX</glossterm><glossdef><para>Maximum size of a whole message.  On some systems you may need to </para></glossdef></glossentry></glosslist><para>increase this limit.  On other systems, you may not be able to change it. </para><para>The messages between Squid and diskd are 32 bytes for 32-bit CPUs and 40 bytes for 64-bit CPUs.  Thus, MSGSSZ should be 32 or greater. You may want to set it to a larger value, just to be safe. </para><para>We'll have two queues for each <emphasis>cache_dir</emphasis> -- one in each direction. So, MSGMNI needs to be at least two times the number of <emphasis>cache_dir<emphasis role="strong">s. <para>I've found that 75 messages per queue is about the limit of decent performance. If each diskd message consists of just one segment (depending on your value of MSGSSZ), then MSGSEG should be greater than 75. </para><para>MSGMNB and MSGTQL affect how many messages can be in the queues at one time.  Diskd messages shouldn't be more than 40 bytes, but let's use 64 bytes to be safe.  MSGMNB should be at least 64*75.  I recommend rounding up to the nearest power of two, or 8192. </para><para>MSGTQL should be at least 75 times the number of </para>cache_dir</emphasis>s that you'll have. </emphasis></para><section><title>FreeBSD</title><para>Your kernel must have </para><screen><![CDATA[options         SYSVMSG]]></screen><para>You can set the parameters in the kernel as follows.  This is just an example.  Make sure the values are appropriate for your system: </para><screen><![CDATA[options         MSGMNB=8192     # max # of bytes in a queue
options         MSGMNI=40       # number of message queue identifiers
options         MSGSEG=512      # number of message segments per queue
options         MSGSSZ=64       # size of a message segment
options         MSGTQL=2048     # max messages in system]]></screen></section><section><title>OpenBSD</title><para>You can set the parameters in the kernel as follows.  This is just an example.  Make sure the values are appropriate for your system: </para><screen><![CDATA[option          MSGMNB=16384    # max characters per message queue
option          MSGMNI=40       # max number of message queue identifiers
option          MSGSEG=2048     # max number of message segments in the system
option          MSGSSZ=64       # size of a message segment (Must be 2^N)
option          MSGTQL=1024     # max amount of messages in the system]]></screen></section><section><title>Digital Unix</title><para>Message queue support seems to be in the kernel by default.  Setting the options is as follows: </para><screen><![CDATA[options         MSGMNB="8192"     # max # bytes on queue
options         MSGMNI="40"       # # of message queue identifiers
options         MSGMAX="2048"     # max message size
options         MSGTQL="2048"     # # of system message headers]]></screen><para>by (B.C.Phillips at massey dot ac dot nz) Brenden Phillips </para><para>If you have a newer version (DU64), then you can probably use <emphasis>sysconfig</emphasis> instead.  To see what the current IPC settings are run </para><screen><![CDATA[# sysconfig -q ipc]]></screen><para>To change them make a file like this called ipc.stanza: </para><screen><![CDATA[ipc:
        msg-max = 2048
        msg-mni = 40
        msg-tql = 2048
        msg-mnb = 8192]]></screen><para>then run </para><screen><![CDATA[# sysconfigdb -a -f ipc.stanza]]></screen><para>You have to reboot for the change to take effect. </para></section><section><title>Solaris</title><para>Refer to <ulink url="http://www.sunworld.com/sunworldonline/swol-11-1997/swol-11-insidesolaris.html">Demangling Message Queues</ulink> in Sunworld Magazine. </para><para>I don't think the above article really tells you how to set the parameters. You do it in <emphasis>/etc/system</emphasis> with lines like this: </para><screen><![CDATA[set msgsys:msginfo_msgmax=2048
set msgsys:msginfo_msgmnb=8192
set msgsys:msginfo_msgmni=40
set msgsys:msginfo_msgssz=64
set msgsys:msginfo_msgtql=2048]]></screen><para>Of course, you must reboot whenever you modify <emphasis>/etc/system</emphasis> before changes take effect. </para><para><emphasis role="strong">Note:</emphasis> Starting with Solaris 10 8/11 release all of them parameters deprecated or remove. New Solaris IPC model is using. See <ulink url="http://docs.oracle.com/cd/E23823_01/html/817-0404/index.html">Solaris Tunable Parameters Reference</ulink> </para></section></section><section><title>How do I configure shared memory?</title><para>Shared memory uses a set of parameters similar to the ones for message queues.  The Squid DISKD implementation uses one shared memory area for each cache_dir.  Each shared memory area is about 800 kilobytes in size.  You may need to modify your system's shared memory parameters: </para><glosslist><glossentry><glossterm>SHMSEG</glossterm><glossdef><para>Maximum number of shared memory segments per process. </para></glossdef></glossentry><glossentry><glossterm>SHMMNI</glossterm><glossdef><para>Maximum number of shared memory segments for the whole system. </para></glossdef></glossentry><glossentry><glossterm>SHMMAX</glossterm><glossdef><para>Largest shared memory segment size allowed. </para></glossdef></glossentry><glossentry><glossterm>SHMALL</glossterm><glossdef><para>Total amount of shared memory that can be used. </para></glossdef></glossentry></glosslist><para>For Squid and DISKD, <emphasis>SHMSEG</emphasis> and <emphasis>SHMMNI</emphasis> must be greater than or equal to the number of cache_dir's that you have. <emphasis>SHMMAX</emphasis> must be at least 800 kilobytes. <emphasis>SHMALL</emphasis> must be at least 800 kilobytes multiplied by the number of cache_dir's. </para><para>Note that some operating systems express <emphasis>SHMALL</emphasis> in pages, rather than bytes, so be sure to divide the number of bytes by the page size if necessary. Use the <emphasis>pagesize</emphasis> command to determine your system's page size, or use 4096 as a reasonable guess. </para><section><title>FreeBSD</title><para>Your kernel must have </para><screen><![CDATA[options         SYSVSHM]]></screen><para>You can set the parameters in the kernel as follows.  This is just an example.  Make sure the values are appropriate for your system: </para><screen><![CDATA[options         SHMSEG=16       # max shared mem id's per process
options         SHMMNI=32       # max shared mem id's per system
options         SHMMAX=2097152  # max shared memory segment size (bytes)
options         SHMALL=4096     # max amount of shared memory (pages)]]></screen></section><section><title>OpenBSD</title><para>OpenBSD is similar to FreeBSD, except you must use <emphasis>option</emphasis> instead of <emphasis>options</emphasis>, and SHMMAX is in pages instead of bytes: </para><screen><![CDATA[option         SHMSEG=16        # max shared mem id's per process
option         SHMMNI=32        # max shared mem id's per system
option         SHMMAX=2048      # max shared memory segment size (pages)
option         SHMALL=4096      # max amount of shared memory (pages)]]></screen></section><section><title>Digital Unix</title><para>Message queue support seems to be in the kernel by default.  Setting the options is as follows: </para><screen><![CDATA[options         SHMSEG="16"       # max shared mem id's per process
options         SHMMNI="32"       # max shared mem id's per system
options         SHMMAX="2097152"  # max shared memory segment size (bytes)
options         SHMALL=4096       # max amount of shared memory (pages)]]></screen><para>by (B.C.Phillips at massey dot ac dot nz) Brenden Phillips </para><para>If you have a newer version (DU64), then you can probably use <emphasis>sysconfig</emphasis> instead.  To see what the current IPC settings are run </para><screen><![CDATA[# sysconfig -q ipc]]></screen><para>To change them make a file like this called ipc.stanza: </para><screen><![CDATA[ipc:
        shm-seg = 16
        shm-mni = 32
        shm-max = 2097152
        shm-all = 4096]]></screen><para>then run </para><screen><![CDATA[# sysconfigdb -a -f ipc.stanza]]></screen><para>You have to reboot for the change to take effect. </para></section><section><title>Solaris</title><para>Refer to <ulink url="http://www.sunworld.com/swol-09-1997/swol-09-insidesolaris.html">Shared memory uncovered</ulink> in Sunworld Magazine. </para><para>To set the values, you can put these lines in <emphasis>/etc/system</emphasis>: </para><screen><![CDATA[set shmsys:shminfo_shmmax=2097152
set shmsys:shminfo_shmmni=32
set shmsys:shminfo_shmseg=16]]></screen><para><emphasis role="strong">Note:</emphasis> Parameter <emphasis>shmmni</emphasis> is obsolete starting from Solaris 10 release 8/11, parameter <emphasis>shmseg</emphasis> is removed from Solaris 10 to release 8/11 and not exists now. Consult <ulink url="http://docs.oracle.com/cd/E23823_01/html/817-0404/idx-16.html">actual reference</ulink> <emphasis role="strong">before</emphasis> change system parameters! Also beware - <emphasis>shmmax</emphasis> in actual Solaris releases is 8,388,608 by default and appears good enough. You should not change it without good performance reasons. See <ulink url="http://docs.oracle.com/cd/E23823_01/html/817-0404/appendixa-6.html#indexterm-272">reference</ulink> for details. </para></section></section><section><title>Sometimes shared memory and message queues aren't released when Squid exits.</title><para>Yes, this is a little problem sometimes.  Seems like the operating system gets confused and doesn't always release shared memory and message queue resources when processes exit, especially if they exit abnormally. To fix it you can &quot;manually&quot; clear the resources with the <emphasis>ipcs</emphasis> command. Add this command into your <emphasis>RunCache</emphasis> or <emphasis>squid_start</emphasis> script: </para><screen><![CDATA[ipcs | awk '/squid/ {printf "ipcrm -%s %s\n", $1, $2}' | /bin/sh]]></screen></section><section><title>What are the Q1 and Q2 parameters?</title><para>In the source code, these are called <emphasis>magic1</emphasis> and <emphasis>magic2</emphasis>. These numbers refer to the number of oustanding requests on a message queue.  They are specified on the <emphasis>cache_dir</emphasis> option line, after the L1 and L2 directories: </para><screen><![CDATA[cache_dir diskd /cache1 1024 16 256 Q1=72 Q2=64]]></screen><para>If there are more than Q1 messages outstanding, then Squid will intentionally fail to open disk files for reading and writing. This is a load-shedding mechanism.  If your cache gets really really busy and the disks can not keep up, Squid bypasses the disks until the load goes down again. </para><para>If there are more than Q2 messages outstanding, then the main Squid process &quot;blocks&quot; for a little bit until the diskd process services some of the messages and sends back some replies. </para><para>Reasonable Q1 and Q2 values are 64 and 72. If you would rather have good hit ratio and bad response time, set Q1 &gt; Q2.  Otherwise, if you would rather have good response time and bad hit ratio, set Q1 &lt; Q2. </para><!--rule (<hr>) is not applicable to DocBook--><para> Back to the <ulink url="https://wiki.squid-cache.org/Features/DiskDaemon/SquidFaq#">SquidFaq</ulink> </para></section></section></article>