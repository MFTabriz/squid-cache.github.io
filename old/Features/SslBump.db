<?xml version="1.0" encoding="utf-8"?><!DOCTYPE article  PUBLIC '-//OASIS//DTD DocBook XML V4.4//EN'  'http://www.docbook.org/xml/4.4/docbookx.dtd'><article><articleinfo><title>Features/SslBump</title><revhistory><revision><revnumber>27</revnumber><date>2019-05-10 00:41:10</date><authorinitials>AmosJeffries</authorinitials><revremark>add helper interwiki link</revremark></revision><revision><revnumber>26</revnumber><date>2015-09-21 02:24:53</date><authorinitials>AmosJeffries</authorinitials><revremark>add reference to server-first bumping superceede for 3.3+ installs</revremark></revision><revision><revnumber>25</revnumber><date>2015-06-05 22:22:46</date><authorinitials>AmosJeffries</authorinitials></revision><revision><revnumber>24</revnumber><date>2015-02-08 12:35:17</date><authorinitials>AmosJeffries</authorinitials><revremark>highlight that this feature page is only relevant to older Squid now.</revremark></revision><revision><revnumber>23</revnumber><date>2014-06-19 11:40:21</date><authorinitials>AmosJeffries</authorinitials><revremark>fix wiki links to SquidConf and Bug items, and to v3.3 page</revremark></revision><revision><revnumber>22</revnumber><date>2014-06-17 19:05:27</date><authorinitials>AlexRousskov</authorinitials><revremark>Satarted documenting memory consumption. Having trouble finding the right locationg for this info. It may need to be moved.</revremark></revision><revision><revnumber>21</revnumber><date>2013-12-22 04:06:15</date><authorinitials>AmosJeffries</authorinitials><revremark>update with details on Squid-3.3 and later configuration improvements</revremark></revision><revision><revnumber>20</revnumber><date>2012-04-20 17:40:52</date><authorinitials>AlexRousskov</authorinitials><revremark>Polished Squid certificate name. CA certificate is less appropriate here.</revremark></revision><revision><revnumber>19</revnumber><date>2012-03-08 01:47:25</date><authorinitials>AlexRousskov</authorinitials><revremark>Added a link to certificate generation features. More work is needed to provide comprehensive SslBump overview.</revremark></revision><revision><revnumber>18</revnumber><date>2012-03-08 01:42:31</date><authorinitials>AlexRousskov</authorinitials><revremark>Polished scope description.</revremark></revision><revision><revnumber>17</revnumber><date>2012-02-15 17:51:20</date><authorinitials>AlexRousskov</authorinitials><revremark>Added the warning about bumping SSL connections (copied from the HTTPS wiki page).</revremark></revision><revision><revnumber>16</revnumber><date>2011-08-10 18:08:42</date><authorinitials>AlexRousskov</authorinitials><revremark>Added Limitation section and described problems with handing server certificate errors</revremark></revision><revision><revnumber>15</revnumber><date>2011-06-05 12:52:22</date><authorinitials>AmosJeffries</authorinitials><revremark>ass Christos as one of the dev here.</revremark></revision><revision><revnumber>14</revnumber><date>2011-06-05 12:51:01</date><authorinitials>AmosJeffries</authorinitials><revremark>fix mode flag in example</revremark></revision><revision><revnumber>13</revnumber><date>2010-06-01 02:52:35</date><authorinitials>AmosJeffries</authorinitials><revremark>link to FAQ</revremark></revision><revision><revnumber>12</revnumber><date>2009-10-28 10:17:04</date><authorinitials>FrancescoChemolli</authorinitials><revremark>fixed icon</revremark></revision><revision><revnumber>11</revnumber><date>2009-10-28 02:44:32</date><authorinitials>AmosJeffries</authorinitials><revremark>newbies do a lot of copy-n-paste. use the word example a lot more. and break the example into explained bits.</revremark></revision><revision><revnumber>10</revnumber><date>2008-09-24 17:12:14</date><authorinitials>AlexRousskov</authorinitials><revremark>Noted that &quot;always_direct allow all&quot; seems to be required.</revremark></revision><revision><revnumber>9</revnumber><date>2008-09-03 02:36:42</date><authorinitials>AmosJeffries</authorinitials><revremark>Fancy up the docs</revremark></revision><revision><revnumber>8</revnumber><date>2008-05-18 19:38:56</date><authorinitials>localhost</authorinitials><revremark>converted to 1.6 markup</revremark></revision><revision><revnumber>7</revnumber><date>2008-04-21 04:17:39</date><authorinitials>AmosJeffries</authorinitials></revision><revision><revnumber>6</revnumber><date>2008-02-12 03:39:27</date><authorinitials>AlexRousskov</authorinitials><revremark>typo</revremark></revision><revision><revnumber>5</revnumber><date>2008-02-12 03:37:09</date><authorinitials>AlexRousskov</authorinitials><revremark>Features/ page search is using &quot;completed&quot; status</revremark></revision><revision><revnumber>4</revnumber><date>2008-02-12 03:21:54</date><authorinitials>AlexRousskov</authorinitials><revremark>Marked as done. Added squid.conf sample.</revremark></revision><revision><revnumber>3</revnumber><date>2007-12-20 18:30:18</date><authorinitials>AlexRousskov</authorinitials><revremark>Updated status</revremark></revision></revhistory></articleinfo><section><title>Feature: Squid-in-the-middle SSL Bump</title><itemizedlist><listitem><para><emphasis role="strong">Goal</emphasis>: Enable ICAP inspection of SSL traffic. </para></listitem><listitem><para><emphasis role="strong">Version</emphasis>: 3.1 to 3.4. </para></listitem><listitem><para><emphasis role="strong">Developer</emphasis>: <ulink url="https://wiki.squid-cache.org/Features/SslBump/AlexRousskov#">AlexRousskov</ulink>, Christos Tsantilas </para></listitem><listitem><para><emphasis role="strong">More</emphasis>: See also <ulink url="https://wiki.squid-cache.org/Features/SslBump/Features/DynamicSslCert#">dynamic SSL certificate generation</ulink> and <ulink url="https://wiki.squid-cache.org/Features/SslBump/Features/MimicSslServerCert#">origin server certificate mimicking</ulink> features. </para></listitem></itemizedlist><section><title>Details</title><itemizedlist><listitem override="none"><informaltable><tgroup cols="1"><colspec colname="col_0"/><tbody><row rowsep="1"><entry colsep="1" rowsep="1"><para> <emphasis role="strong">This feature was replaced in Squid-3.5 by <ulink url="https://wiki.squid-cache.org/Features/SslBump/Features/SslPeekAndSplice#">peek-n-splice</ulink> </emphasis> </para></entry></row></tbody></tgroup></informaltable><informaltable><tgroup cols="1"><colspec colname="col_0"/><tbody><row rowsep="1"><entry colsep="1" rowsep="1"><para> <emphasis role="strong">This feature was replaced in Squid-3.3 by <ulink url="https://wiki.squid-cache.org/Features/SslBump/Features/BumpSslServerFirst#">server-first</ulink> </emphasis> </para></entry></row></tbody></tgroup></informaltable></listitem></itemizedlist><para>Squid-in-the-middle decryption and encryption of straight <emphasis role="strong">CONNECT</emphasis> and transparently redirected SSL traffic, using configurable CA certificates. While decrypted, the traffic can be analyzed, blocked, or adapted using regular Squid features such as <ulink url="https://wiki.squid-cache.org/Features/SslBump/Features/ICAP#">ICAP</ulink> and <ulink url="https://wiki.squid-cache.org/Features/SslBump/Features/eCAP#">eCAP</ulink>. </para><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/alert.png" width="15"/></imageobject><textobject><phrase>/!\</phrase></textobject></inlinemediaobject> By default, most user agents will warn end-users about a possible man-in-the-middle attack. </para></listitem></itemizedlist><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-error.png" width="16"/></imageobject><textobject><phrase>{X}</phrase></textobject></inlinemediaobject> WARNING: <inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-error.png" width="16"/></imageobject><textobject><phrase>{X}</phrase></textobject></inlinemediaobject> HTTPS was designed to give users an expectation of privacy and security. Decrypting HTTPS tunnels without user consent or knowledge may violate ethical norms and may be illegal in your jurisdiction. Squid decryption features described here and elsewhere are designed for deployment with user consent or, at the very least, in environments where decryption without consent is legal. These features also illustrate why users should be careful with trusting HTTPS connections and why the weakest link in the chain of HTTPS protections is rather fragile. Decrypting HTTPS tunnels constitutes a man-in-the-middle attack from the overall network security point of view. Attack tools are an equivalent of an atomic bomb in real world: Make sure you understand what you are doing and that your decision makers have enough information to make wise choices.  </para></section><section><title>Limitations</title><section><title>Squid becomes responsible for handling server certificate validation errors</title><para>When an HTTP client receives the invalid origin server certificate it can use agent features to handle validation errors. For example, many browsers warn and allow the user to examine the invalid certificate and optionally ignore the error for this or even future connections. </para><para>This powerful functionality is currently not available because Squid makes the ultimate decision on whether to ignore the validation error. The HTTP client always receives a valid certificate generated by Squid and not the invalid certificate from the origin server. We are considering adding code to mimic server certificate errors when generating a fake certificate, giving back the user an option to examine and bypass the error. Quality patches or sponsorships are welcomed. </para><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-error.png" width="16"/></imageobject><textobject><phrase>{X}</phrase></textobject></inlinemediaobject> to avoid this major limitation an upgrade to <ulink url="https://wiki.squid-cache.org/Features/SslBump/Squid-3.3#">Squid-3.3</ulink> or later and use of the <ulink url="https://wiki.squid-cache.org/Features/SslBump/Features/MimicSslServerCert#">origin server certificate mimicking</ulink> feature is strongly advised. </para></listitem></itemizedlist></section></section><section><title>Squid Configuration</title><para>Here is a sample squid.conf excerpt with SSL Bump-related options: </para><section><title>Enabling SSL Bump</title><para>Example of how to configure the HTTP port to bump CONNECT requests </para><screen><![CDATA[http_port 3128 ssl-bump cert=/usr/local/squid3/etc/site_priv+pub.pem
]]><![CDATA[
# Bumped requests have relative URLs so Squid has to use reverse proxy
# or accelerator code. By default, that code denies direct forwarding.
# The need for this option may disappear in the future.
always_direct allow all]]></screen></section><section><title>Access Controls</title><para><ulink url="http://www.squid-cache.org/Doc/config/ssl_bump#">ssl_bump</ulink> is used to prevent some requests being <emphasis>bumped</emphasis>. </para><para>Example of how to avoid bumping requests to sites that <ulink url="https://wiki.squid-cache.org/Features/SslBump/Squid-3.1#">Squid-3.1</ulink> or <ulink url="https://wiki.squid-cache.org/Features/SslBump/Squid-3.2#">Squid-3.2</ulink> cannot proxy well: </para><screen><![CDATA[acl broken_sites dstdomain .example.com
ssl_bump deny broken_sites
ssl_bump allow all]]></screen><para>The <ulink url="http://www.squid-cache.org/Doc/config/ssl_bump#">ssl_bump</ulink> directive in <ulink url="https://wiki.squid-cache.org/Features/SslBump/Squid-3.3#">Squid-3.3</ulink> has been updated to select between several bumping algorithms. The above rules are now configured like this: </para><screen><![CDATA[acl broken_sites dstdomain .example.com
ssl_bump none broken_sites
ssl_bump client-first all]]></screen><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/alert.png" width="15"/></imageobject><textobject><phrase>/!\</phrase></textobject></inlinemediaobject> However <ulink url="https://wiki.squid-cache.org/Features/SslBump/Squid-3.3#">Squid-3.3</ulink> and later provide the <emphasis>server-first</emphasis> algorithm which can be used in place of <emphasis>client-first</emphasis> in the above rules and is better for bumping HTTPS as it avoided the problems below. </para></listitem></itemizedlist></section><section><title>Other settings</title><para>Certain certificate errors may occur which are not really problems. Such as an internal site with self-signed certificates, or an internal domain name for a site differing from its public certificate name. </para><itemizedlist><listitem><para><emphasis role="strong"> <ulink url="https://wiki.squid-cache.org/Features/SslBump/Squid-3.3#">Squid-3.3</ulink> and later </emphasis> </para></listitem></itemizedlist><para>The <emphasis>server-first</emphasis> bumping algorithm with <ulink url="https://wiki.squid-cache.org/Features/SslBump/Features/MimicSslServerCert#">certificate mimicing</ulink> allows Squid to transparently pass on these flaws to the client browser for a more accurate decision about safety to be made there. </para><itemizedlist><listitem><para><emphasis role="strong"> <ulink url="https://wiki.squid-cache.org/Features/SslBump/Squid-3.1#">Squid-3.1</ulink> and <ulink url="https://wiki.squid-cache.org/Features/SslBump/Squid-3.2#">Squid-3.2</ulink> </emphasis> </para></listitem></itemizedlist><para>The <ulink url="http://www.squid-cache.org/Doc/config/sslproxy_cert_error#">sslproxy_cert_error</ulink> directive and the <emphasis>ssl_error</emphasis> ACL type allow these domains to be accepted despite the certificate problems. </para><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-error.png" width="16"/></imageobject><textobject><phrase>{X}</phrase></textobject></inlinemediaobject> SECURITY WARNING: ignoring certificate errors is a security flaw. Doing it in a shared proxy is an extremely dangerous action. It should not be done lightly or for domains which you are not the authority owner (in which case please try fixing the certificate problem before doing this). </para></listitem></itemizedlist><para>Allow access to website sending bad certificates </para><screen><![CDATA[# ignore errors with certain cites (very dangerous!)
acl TrustedName url_regex ^https://weserve.badcerts.example.com/
sslproxy_cert_error allow TrustedName
sslproxy_cert_error deny all]]></screen><para>Allow access to websites attempting to use certificates belonging to another domain. </para><screen><![CDATA[# ignore certain certificate errors (very dangerous!)
acl BadSite ssl_error SQUID_X509_V_ERR_DOMAIN_MISMATCH
sslproxy_cert_error allow BadSite
sslproxy_cert_error deny all]]></screen></section></section><section><title>Memory usage</title><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/alert.png" width="15"/></imageobject><textobject><phrase>/!\</phrase></textobject></inlinemediaobject> Warning: Unlike the rest of this page at the time of writing, this section applies to <ulink url="https://wiki.squid-cache.org/Features/SslBump/Squid-3.3#">Squid-3.3</ulink> and possibly later code capable of <ulink url="https://wiki.squid-cache.org/Features/SslBump/Features/DynamicSslCert#">dynamic SSL certificate generation</ulink> and <ulink url="https://wiki.squid-cache.org/Features/SslBump/Features/MimicSslServerCert#">origin server certificate mimicking</ulink>. The current section text is intended primarily for developers and early adopters facing excessive memory consumption in certain SslBump environments. These notes may be relocated elsewhere if a better location is found. </para></listitem></itemizedlist><para>Current documentation is specific to bump-server-first configurations. </para><section><title>Squid talking to SSL clients</title><para>If generate-host-certificates is &quot;on&quot; (which it is by default for ssl-bump http*_ports), then Squid uses one SSL context (SSL_CTX) per true SSL server certificate (see ConnStateData::getSslContextStart). That SSL context is configured with the fake certificate for the corresponding SSL server. That fake certificate comes either from the <ulink url="http://www.squid-cache.org/Versions/v5/manuals/security_file_certgen#">security_file_certgen</ulink> helper (older Squid call it ssl_crtd) or is generated ad hoc by Squid. Fake certificates (or, to be precise, their contexts) may be cached in a Squid context cache. The cache key includes subject name, common name (CN), valid after, valid before, and other true certificate properties. An SSL  context storing a full certificate chain may consume a few MBs of RAM. Since Squid usually talks to lots of servers, the total certificate cache capacity may have to exceed several GBs to avoid capacity misses. Please see <ulink url="http://www.squid-cache.org/Doc/config/dynamic_cert_mem_cache_size#">dynamic_cert_mem_cache_size</ulink> and Squid bug <ulink url="https://bugs.squid-cache.org/show_bug.cgi?id=4005#">4005</ulink> on why the configured cache limit does not currently work as intended. Squid does not empty its context cache during reconfiguration (although contexts for no-longer-used or no-longer-caching ports are deleted in recent Squids). </para><para>If generate-host-certificates is &quot;off&quot;, then Squid uses one SSL context (SSL_CTX) per <ulink url="http://www.squid-cache.org/Doc/config/http_port#">http_port</ulink> / <ulink url="http://www.squid-cache.org/Doc/config/https_port#">https_port</ulink> for all transactions on that port, regardless of their destination (see PortCfg::staticSslContext). That SSL context is configured using <ulink url="http://www.squid-cache.org/Doc/config/http_port#">http_port</ulink> options. This is done before Squid starts (or resumes) handling traffic so no server certificate mimicking is possible with this context. The context is recreated during reconfiguration. At the time of writing, there are several bugs (with pending port leak patches) that may prevent this cleanup in some Squid. </para></section><section><title>Squid talking to SSL servers</title><para>When talking to SSL origin servers, Squid uses one SSL context for all servers (or one SSL_CTX per peer if a <ulink url="http://www.squid-cache.org/Doc/config/cache_peer#">cache_peer</ulink> is used; see Config.ssl_client.sslContext and FwdState::initiateSSL()). That SSL context is configured using various sslproxy_* directives (or <ulink url="http://www.squid-cache.org/Doc/config/cache_peer#">cache_peer</ulink> ssl* options) in squid.conf. </para><para>OpenSSL will automatically load and cache (inside the SSL context) certificates and CRLs necessary to validate true server certificates received by Squid. A single CRL may consume a few MBs. Since Squid usually talks to lots of servers, the total internal OpenSSL cache size may exceed several GBs. OpenSSL does not limit its internal cache size, and there are no knobs to do so using OpenSSL API. </para><para>The SSL context used for talking directly to SSL servers is freed and recreated on reconfigure. In theory, that should clear the internal OpenSSL certificate and CRL cache when the last SSL connection using the old context is gone. At the time of writing, there are several bugs (with pending patches) that may prevent this cleanup in some Squids. </para><!--rule (<hr>) is not applicable to DocBook--><para> <ulink url="https://wiki.squid-cache.org/Features/SslBump/CategoryFeature#">CategoryFeature</ulink> </para></section></section></section></article>