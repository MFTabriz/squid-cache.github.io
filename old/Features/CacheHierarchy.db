<?xml version="1.0" encoding="utf-8"?><!DOCTYPE article  PUBLIC '-//OASIS//DTD DocBook XML V4.4//EN'  'http://www.docbook.org/xml/4.4/docbookx.dtd'><article><articleinfo><title>Features/CacheHierarchy</title><revhistory><revision><revnumber>7</revnumber><date>2018-04-07 06:37:32</date><authorinitials>AmosJeffries</authorinitials><revremark>Remove cache_peer_domain instructions. It is deprecated now.</revremark></revision><revision><revnumber>6</revnumber><date>2014-12-22 21:18:25</date><authorinitials>AmosJeffries</authorinitials><revremark>link to cache_peer</revremark></revision><revision><revnumber>5</revnumber><date>2014-07-04 13:16:56</date><authorinitials>AmosJeffries</authorinitials></revision><revision><revnumber>4</revnumber><date>2012-03-16 10:52:22</date><authorinitials>AmosJeffries</authorinitials><revremark>fix spelling mistakes and missing non-hierarchical details</revremark></revision><revision><revnumber>3</revnumber><date>2012-01-23 10:23:39</date><authorinitials>AmosJeffries</authorinitials><revremark>diagram the basic hierarchy types and a cluster example</revremark></revision><revision><revnumber>2</revnumber><date>2009-08-17 07:53:22</date><authorinitials>AmosJeffries</authorinitials><revremark>import another FAQ segment whole.</revremark></revision><revision><revnumber>1</revnumber><date>2009-08-17 07:51:30</date><authorinitials>AmosJeffries</authorinitials><revremark>import from FAQ</revremark></revision></revhistory></articleinfo><section><title>Feature: Linking Squid into a Cache Hierarchy</title><itemizedlist><listitem><para><emphasis role="strong">Goal</emphasis>: To connect multiple Squid together forming a 'mesh' or hierarchy of caches. </para></listitem><listitem><para><emphasis role="strong">Status</emphasis>: completed. </para></listitem><listitem><para><emphasis role="strong">Version</emphasis>: 1.2 </para></listitem></itemizedlist></section><section><title>Details</title><para>Proxy and Cache Hierarchies are built out of two basic peering linkages. <emphasis role="strong">parent</emphasis> links (shown as green) and <emphasis role="strong">sibling</emphasis> links (show as blue). </para><para><inlinemediaobject><imageobject><imagedata fileref="https://wiki.squid-cache.org/Features/CacheHierarchy?action=AttachFile&amp;do=get&amp;target=Peering_Basics.png"/></imageobject><textobject><phrase>Peering_Basics.png</phrase></textobject></inlinemediaobject> </para><para>These two simple connections can be combined in any number of complex <emphasis role="strong">hierarchies</emphasis>. For example this cluster of 6 sibling caches with a gateway proxy load balancing between them. </para><para><inlinemediaobject><imageobject><imagedata fileref="https://wiki.squid-cache.org/Features/CacheHierarchy?action=AttachFile&amp;do=get&amp;target=Cluster_1x6.png"/></imageobject><textobject><phrase>Cluster_1x6.png</phrase></textobject></inlinemediaobject> </para><section><title>How do I configure Squid forward all requests to another proxy?</title><para>First, you need to give Squid a parent cache with the <ulink url="http://www.squid-cache.org/Doc/config/cache_peer#">cache_peer</ulink> directive.  Second, you need to tell Squid it can not connect directly to origin servers with <ulink url="http://www.squid-cache.org/Doc/config/never_direct#">never_direct</ulink>.  This is done with these configuration file lines: </para><screen><![CDATA[cache_peer parentcache.foo.com parent 3128 0 no-query default
never_direct allow all]]></screen><para>Note, with this configuration, if the parent cache fails or becomes unreachable, then every request will result in an error message. </para><para>In case you want to be able to use direct connections when all the parents go down you should use a different approach: </para><screen><![CDATA[cache_peer parentcache.foo.com parent 3128 0 no-query
prefer_direct off
nonhierarchical_direct off]]></screen><para>The default behavior of Squid in the absence of positive ICP, HTCP, etc replies is to connect to the origin server instead of using parents. The <ulink url="http://www.squid-cache.org/Doc/config/prefer_direct#">prefer_direct</ulink> <emphasis role="strong">off</emphasis> directive tells Squid to try parents first before DNS listed servers. </para><para>Certain types of requests cannot be cached or are served faster going direct, and Squid is optimized to send them over direct connections by default. The <ulink url="http://www.squid-cache.org/Doc/config/nonhierarchical_direct#">nonhierarchical_direct</ulink> <emphasis role="strong">off</emphasis> directive tells Squid to send these requests via the parent anyway. </para><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/alert.png" width="15"/></imageobject><textobject><phrase>/!\</phrase></textobject></inlinemediaobject> The <ulink url="http://www.squid-cache.org/Doc/config/hierarchy_stoplist#">hierarchy_stoplist</ulink> directive is another which will cause traffic to go DIRECT instead of to a peer. It should be removed completely from <ulink url="https://wiki.squid-cache.org/Features/CacheHierarchy/Squid-3.2#">Squid-3.2</ulink> and later configurations if present. </para></listitem></itemizedlist></section><section><title>How do I join a cache hierarchy?</title><para>To place your cache in a hierarchy, use the <emphasis>cache_peer</emphasis> directive in <emphasis>squid.conf</emphasis> to specify the parent and sibling nodes. </para><para>For example, the following <emphasis>squid.conf</emphasis> file on <emphasis role="strong">childcache.example.com</emphasis> configures its cache to retrieve data from one parent cache and two sibling caches: </para><screen><![CDATA[#  squid.conf - On the host: childcache.example.com
#
#  Format is: hostname  type  http_port  udp_port
#
cache_peer parentcache.example.com   parent  3128 3130
cache_peer childcache2.example.com   sibling 3128 3130
cache_peer childcache3.example.com   sibling 3128 3130]]></screen><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/alert.png" width="15"/></imageobject><textobject><phrase>/!\</phrase></textobject></inlinemediaobject> cache_peer_domain is deprecated and not longer available from current Squid versions. </para></listitem></itemizedlist><para>The <ulink url="http://www.squid-cache.org/Doc/config/cache_peer_access#">cache_peer_access</ulink> directive allows you to specify that certain caches siblings or parents for certain domains: </para><screen><![CDATA[#  squid.conf - On the host: sv.cache.nlanr.net
#
#  Format is: hostname  type  http_port  udp_port
#
cache_peer electraglide.geog.unsw.edu.au parent 3128 3130
cache_peer cache1.nzgate.net.nz          parent 3128 3130
cache_peer pb.cache.nlanr.net   parent 3128 3130
cache_peer it.cache.nlanr.net   parent 3128 3130
cache_peer sd.cache.nlanr.net   parent 3128 3130
cache_peer uc.cache.nlanr.net   sibling 3128 3130
cache_peer bo.cache.nlanr.net   sibling 3128 3130
]]><![CDATA[
acl unsw dstdomain .au
cache_peer_access electraglide.geog.unsw.edu.au allow unsw
]]><![CDATA[
acl nzgate dstdomain .au .aq .fj .nz
cache_peer_domain cache1.nzgate.net.nz allow nzgate
]]><![CDATA[
acl nlanr-eu dstdomain .uk .de .fr .no .se .it
cache_peer_domain pb.cache.nlanr.net allow nlanr-eu
]]><![CDATA[
cache_peer_domain it.cache.nlanr.net allow nlanr-uk
]]><![CDATA[
acl nlanr-sa dstdomain .mx .za .mu .zm
cache_peer_domain sd.cache.nlanr.net allow nlanr-sa]]></screen><para>The configuration above indicates that the cache will use <emphasis>pb.cache.nlanr.net</emphasis> and <emphasis>it.cache.nlanr.net</emphasis> for domains uk, de, fr, no, se and it, <emphasis>sd.cache.nlanr.net</emphasis> for domains mx, za, mu and zm, and <emphasis>cache1.nzgate.net.nz</emphasis> for domains au, aq, fj, and nz. </para></section><section><title>How do I join NLANR's cache hierarchy?</title><para>We have a simple set of <ulink url="http://www.ircache.net/Cache/joining.html">guidelines for joining</ulink> the NLANR cache hierarchy. </para></section><section><title>Why should I want to join NLANR's cache hierarchy?</title><para>The NLANR hierarchy can provide you with an initial source for parent or sibling caches.  Joining the NLANR global cache system will frequently improve the performance of your caching service. </para></section><section><title>How do I register my cache with NLANR's registration service?</title><para>Just enable these options in your <emphasis>squid.conf</emphasis> and you'll be registered: </para><screen><![CDATA[cache_announce 24
announce_to sd.cache.nlanr.net:3131]]></screen><informaltable><tgroup cols="2"><colspec colname="col_0"/><colspec colname="col_1"/><tbody><row rowsep="1"><entry colsep="1" rowsep="1"><para> <inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/attention.png" width="15"/></imageobject><textobject><phrase>&lt;!&gt;</phrase></textobject></inlinemediaobject> </para></entry><entry colsep="1" rowsep="1"><para>Announcing your cache <emphasis role="strong">is not</emphasis> the same thing as joining the NLANR cache hierarchy. You can join the NLANR cache hierarchy without registering, and you can register without joining the NLANR cache hierarchy </para></entry></row></tbody></tgroup></informaltable></section><section><title>How do I find other caches close to me and arrange parent/child/sibling relationships with them?</title><para>Visit the NLANR cache <ulink url="http://www.ircache.net/Cache/Tracker/">registration database</ulink> to discover other caches near you.  Keep in mind that just because a cache is registered in the database <emphasis role="strong">does not</emphasis> mean they are willing to be your parent/sibling/child.  But it can't hurt to ask... </para></section></section><section><title>Troubleshooting</title><section><title>My cache registration is not appearing in the Tracker database.</title><itemizedlist><listitem><para>Your site will not be listed if your cache IP address does not have a DNS PTR record. If we can't map the IP address back to a domain name, it will be listed as &quot;Unknown.&quot; </para></listitem><listitem><para>The registration messages are sent with UDP. We may not be receiving your announcement message due to firewalls which block UDP, or dropped packets due to congestion. </para></listitem></itemizedlist><!--rule (<hr>) is not applicable to DocBook--><para> <ulink url="https://wiki.squid-cache.org/Features/CacheHierarchy/CategoryFeature#">CategoryFeature</ulink> </para></section></section></article>