<?xml version="1.0" encoding="utf-8"?><!DOCTYPE article  PUBLIC '-//OASIS//DTD DocBook XML V4.4//EN'  'http://www.docbook.org/xml/4.4/docbookx.dtd'><article><articleinfo><title>Features/CommCleanup</title><revhistory><revision><revnumber>7</revnumber><date>2011-06-23 03:48:00</date><authorinitials>AmosJeffries</authorinitials><revremark>now merged to trunk.</revremark></revision><revision><revnumber>6</revnumber><date>2011-04-19 09:44:51</date><authorinitials>AmosJeffries</authorinitials><revremark>mark as priority for 3.2</revremark></revision><revision><revnumber>5</revnumber><date>2010-09-29 03:07:46</date><authorinitials>AmosJeffries</authorinitials><revremark>status update. link some bugs this will solve. 2.x ones not fully checked yet.</revremark></revision><revision><revnumber>4</revnumber><date>2010-05-25 03:51:24</date><authorinitials>AmosJeffries</authorinitials><revremark>well underway now. document current state.</revremark></revision><revision><revnumber>3</revnumber><date>2010-02-10 07:15:27</date><authorinitials>AmosJeffries</authorinitials><revremark>AcceptFD has been cleaned up.</revremark></revision><revision><revnumber>2</revnumber><date>2008-05-18 19:38:59</date><authorinitials>localhost</authorinitials><revremark>converted to 1.6 markup</revremark></revision><revision><revnumber>1</revnumber><date>2008-05-10 07:46:06</date><authorinitials>AmosJeffries</authorinitials><revremark>comm is another area in need of a good design plan.</revremark></revision></revhistory></articleinfo><section><title>Feature: Comm Layer cleanup</title><itemizedlist><listitem><para><emphasis role="strong">Goal</emphasis>: Improve code quality and maintainability.  </para></listitem><listitem><para><emphasis role="strong">Status</emphasis>: completed. debugging underway. </para></listitem><listitem><para><emphasis role="strong">Version</emphasis>: Squid 3.2 </para></listitem><listitem><para><emphasis role="strong">Developer</emphasis>: <ulink url="https://wiki.squid-cache.org/Features/CommCleanup/AmosJeffries#">AmosJeffries</ulink> </para></listitem><listitem><para><emphasis role="strong">More</emphasis>: <ulink url="https://code.launchpad.net/~yadi/squid/cleanup-comm">branch</ulink> </para></listitem><listitem><para><emphasis role="strong">Bugs</emphasis>: </para></listitem></itemizedlist><itemizedlist><listitem override="none"><para><ulink url="http://bugs.squid-cache.org/show_bug.cgi?id=3070"/> </para></listitem></itemizedlist><section><title>Details</title><para>We need to cleanup and modulize the Comm Layer code. </para><para>At present its largely an undocumented collection of objects and namespaces which interact to perform Comm actions. Some of what should be comm actions are also spread amongst the other components within Squid. </para><para>We need thin and clean comm layer that makes sense to developers. Clear interaction with other component APIs. Most (perhaps all) developers cannot even grasp all the interactions and inner dependencies, which causes the snowball effect of degrading code quality. </para><para>At present the only distinction between comm and regular code is its residence in comm.cc and com.h </para><section><title>Progress</title><itemizedlist><listitem><para>The comm code handling inbound client connections (accept / listeners) has now been cleaned up and isolated in a comm library with a small, clear and documented API. </para></listitem></itemizedlist><para>Currently testing in 3.2: </para><itemizedlist><listitem><para>The outbound connection setup for server connections (socket opening / connect / bind) has now been cleaned up and isolated in the comm library with a small clear and documented API. </para></listitem><listitem><para>FD handling throughout the code has been polished up to pass Connection objects instead of raw FD fro TCP connections. </para></listitem><listitem><para>DNS lookups have been extracted from comm layer TCP setup. The components needing a new connection are responsible for generating a Comm::Connection template with at minimum the destination IP in it. </para></listitem><listitem><para>CONNECT tunnel method retries. Are possible up until some bytes get transferred. </para></listitem><listitem><para>Persistent connections pooled by destination IP:port. Retrieval out of the pool is filtered on required local endpoint IP (if any) to support transparent interception and <ulink url="http://www.squid-cache.org/Doc/config/tcp_outgoing_address#">tcp_outgoing_address</ulink> which require a fixed local address. </para></listitem></itemizedlist></section><section><title>TODO</title><itemizedlist><listitem><para>The inbound SSL layer still needs some attention to combine it behind the comm listener interface away from the higher levels of code. This can perhaps be done as part of the upgrade enabling SSL to use multiple system libraries other than OpenSSL. </para></listitem><listitem><para>The outbound SSL layer still needs some attention to combine it behind the comm connector interface away from the higher levels of code. This can perhaps be done as part of the upgrade enabling SSL to use multiple system libraries other than OpenSSL. </para></listitem><listitem><para>The socket reading operations need an API polished up. </para></listitem><listitem><para>The socket writing operations need an API polished up. </para></listitem></itemizedlist><!--rule (<hr>) is not applicable to DocBook--><para> <ulink url="https://wiki.squid-cache.org/Features/CommCleanup/CategoryFeature#">CategoryFeature</ulink> <ulink url="https://wiki.squid-cache.org/Features/CommCleanup/CategoryWish#">CategoryWish</ulink> </para></section></section></section></article>