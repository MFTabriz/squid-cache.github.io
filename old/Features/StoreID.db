<?xml version="1.0" encoding="utf-8"?><!DOCTYPE article  PUBLIC '-//OASIS//DTD DocBook XML V4.4//EN'  'http://www.docbook.org/xml/4.4/docbookx.dtd'><article><articleinfo><title>Features/StoreID</title><revhistory><revision><revnumber>23</revnumber><date>2016-01-27 16:27:00</date><authorinitials>AlexRousskov</authorinitials><revremark>Clarified that eCAP services can compute IDs that can probably be passed to and used by a storeID helper as StoreIDs.</revremark></revision><revision><revnumber>22</revnumber><date>2016-01-27 11:12:36</date><authorinitials>Eliezer Croitoru</authorinitials><revremark>Fixed typo</revremark></revision><revision><revnumber>21</revnumber><date>2016-01-27 11:09:57</date><authorinitials>Eliezer Croitoru</authorinitials><revremark>Addition of the idea &quot;ICAP + StoreID helper+redis&quot; to predict urls StoreID</revremark></revision><revision><revnumber>20</revnumber><date>2014-05-05 07:57:35</date><authorinitials>AmosJeffries</authorinitials></revision><revision><revnumber>19</revnumber><date>2013-10-11 16:26:02</date><authorinitials>AlexRousskov</authorinitials><revremark>Polished feature Goal and summary. Added info about loops.</revremark></revision><revision><revnumber>18</revnumber><date>2013-08-03 11:57:24</date><authorinitials>Eliezer Croitoru</authorinitials></revision><revision><revnumber>17</revnumber><date>2013-07-27 05:07:47</date><authorinitials>AmosJeffries</authorinitials><revremark>mention helpers for the back-compat part of the interface.</revremark></revision><revision><revnumber>16</revnumber><date>2013-07-27 03:59:40</date><authorinitials>AmosJeffries</authorinitials><revremark>update status and structure (user info before developers), and polish up the section on DB helper</revremark></revision><revision><revnumber>15</revnumber><date>2013-07-08 20:45:15</date><authorinitials>Eliezer Croitoru</authorinitials></revision><revision><revnumber>14</revnumber><date>2013-07-08 20:18:28</date><authorinitials>Eliezer Croitoru</authorinitials></revision><revision><revnumber>13</revnumber><date>2013-04-18 12:21:56</date><authorinitials>AmosJeffries</authorinitials><revremark>import the new Store-ID helpers API protocol docs instead of the URL-rewrite ones.</revremark></revision><revision><revnumber>12</revnumber><date>2013-04-13 21:28:03</date><authorinitials>Eliezer Croitoru</authorinitials></revision><revision><revnumber>11</revnumber><date>2013-02-17 15:40:52</date><authorinitials>Eliezer Croitoru</authorinitials></revision><revision><revnumber>10</revnumber><date>2013-02-17 15:37:52</date><authorinitials>Eliezer Croitoru</authorinitials></revision><revision><revnumber>9</revnumber><date>2013-02-17 15:32:28</date><authorinitials>Eliezer Croitoru</authorinitials></revision><revision><revnumber>8</revnumber><date>2013-02-17 15:28:47</date><authorinitials>Eliezer Croitoru</authorinitials></revision><revision><revnumber>7</revnumber><date>2013-02-17 15:26:44</date><authorinitials>Eliezer Croitoru</authorinitials></revision><revision><revnumber>6</revnumber><date>2012-12-04 15:31:14</date><authorinitials>Eliezer Croitoru</authorinitials></revision><revision><revnumber>5</revnumber><date>2012-12-04 15:28:25</date><authorinitials>Eliezer Croitoru</authorinitials></revision><revision><revnumber>4</revnumber><date>2012-12-03 11:43:30</date><authorinitials>Eliezer Croitoru</authorinitials></revision><revision><revnumber>3</revnumber><date>2012-12-03 11:41:16</date><authorinitials>Eliezer Croitoru</authorinitials></revision><revision><revnumber>2</revnumber><date>2012-12-03 11:39:57</date><authorinitials>Eliezer Croitoru</authorinitials></revision><revision><revnumber>1</revnumber><date>2012-12-03 11:34:59</date><authorinitials>Eliezer Croitoru</authorinitials></revision></revhistory></articleinfo><section><title>Feature: Store ID</title><itemizedlist><listitem><para><emphasis role="strong">Goal</emphasis>: Reduce cache misses when identical content is accessed using different URLs. </para></listitem><listitem><para><emphasis role="strong">Status</emphasis>: completed. </para></listitem><listitem><para><emphasis role="strong">Version</emphasis>: 3.4 </para></listitem><listitem><para><emphasis role="strong">Developer</emphasis>: <ulink url="https://wiki.squid-cache.org/Features/StoreID/Eliezer%20Croitoru#">Eliezer Croitoru</ulink> </para></listitem><listitem><para><emphasis role="strong">More</emphasis>:  </para></listitem><listitem><para><emphasis role="strong">Sponsored by</emphasis>: <ulink url="https://wiki.squid-cache.org/Features/StoreID/Eliezer%20Croitoru#">Eliezer Croitoru</ulink> - <ulink url="http://www1.ngtech.co.il/">NgTech</ulink> </para></listitem></itemizedlist><section><title>Details</title><para>&quot;Store ID&quot; is another name for the Squid cache key. By default, store IDs are computed by Squid so that different URLs are mapped to different store IDs. This feature allows the proxy admin to specify a custom store ID calculation algorithm via a helper program. It is usually used to assign the same store ID to transactions with different request URLs. Such mapping may reduce misses (i.e., increase hit ratio) when dealing with CDN URLs and similar cases where different URLs are known to point to essentially the same content. </para><para>Store ID violates HTTP and causes havoc if URLs pointing to different content are incorrectly mapped to the same Store ID. A Squid admin lacks control over URL-to-content mapping used by external CDNs and content providers. Even if the initial reverse engineering of their URL space is successful, maintaining the Store ID helper correctness is usually difficult because of sudden external mapping changes. </para><para>This feature is a port of the <ulink url="https://wiki.squid-cache.org/Features/StoreID/Squid-2.7#">Squid-2.7</ulink> Store-URL feature, however it does work in a slightly different way and will make <ulink url="https://wiki.squid-cache.org/Features/StoreID/Squid-3.4#">Squid-3.4</ulink> or later to apply all store\cache related work to be against the StoreID and not the request URL. This includes <ulink url="http://www.squid-cache.org/Doc/config/refresh_pattern#">refresh_pattern</ulink>. This allows more flexibility in the way admin will be able use the helper. </para><para>This feature will allow us later to implement <ulink url="http://www.metalinker.org/">Metalink</ulink> support into squid. </para><section><title>Known Issues</title><itemizedlist><listitem><para>Using StoreID on two URLs assumes that the resources presented by each are <emphasis role="strong">exact</emphasis> duplicates. Down to their metadata information used by HTTP conditional and revalidation requests. </para><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-error.png" width="16"/></imageobject><textobject><phrase>{X}</phrase></textobject></inlinemediaobject> care must be taken when using StoreID helper that the URLs are indeed precise duplicates or the end result may be a <emphasis>reduced</emphasis> HIT-ratio and bad proxy performance rather than improved caching. </para></listitem><listitem override="none"><para>For example; HTTP ETag header values are only guaranteed to be unique per-URL and if a CDN uses different ETag from each server then conditional requests involving ETag will MISS or REFRESH more often despite the content object/file being identical. Possibly causing a larger bandwidth consumption than if StoreID was not present at all. </para></listitem></itemizedlist></listitem><listitem><para>StoreID causes HTTP redirect loops if Squid is not configured to avoid caching redirection responses (HTTP allows caching of some redirection responses). If both the request URL and the corresponding redirect response Location URL are mapped to the same Store ID, the <emphasis>redirected</emphasis> request will hit on the cached redirection response, creating a loop. See Squid bug <ulink url="http://bugs.squid-cache.org/show_bug.cgi?id=3937">3937</ulink>. </para></listitem><listitem><para>ICP and HTCP support is missing. </para><itemizedlist><listitem override="none"><para>URL queries received from <ulink url="http://www.squid-cache.org/Doc/config/cache_peer#">cache_peer</ulink> siblings are not passed through StoreID helper. So the resulting store/cache lookup will MISS on URLs normally alterd by StoreID. </para></listitem></itemizedlist></listitem></itemizedlist></section></section><section><title>Available Helpers</title><itemizedlist><listitem><para>Eliezer Croitoru has designed several !Ruby helpers, including the <ulink url="https://wiki.squid-cache.org/Features/StoreID/Features/StoreID/Helper#">example helper</ulink> here. </para></listitem><listitem><para><emphasis role="strong">storeid_file_rewrite</emphasis> by Alan Mizrahi is a simple helper which is packaged with <ulink url="https://wiki.squid-cache.org/Features/StoreID/Squid-3.4#">Squid-3.4</ulink>. It can be used to load a <ulink url="http://wiki.squid-cache.org/Features/StoreID/DB">database of patterns</ulink> without needing to edit the code of the helper internals. </para></listitem><listitem><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> Any helper previously designed for the <ulink url="https://wiki.squid-cache.org/Features/StoreID/Squid-2.7#">Squid-2.7</ulink> StoreURL feature is expected to work with <ulink url="https://wiki.squid-cache.org/Features/StoreID/Squid-3.4#">Squid-3.4</ulink>. However upgrading the response syntax sent back to Squid is advised for better performance and forward-compatibility with future Squid versions. </para></listitem><listitem><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> Older URL-rewriter programs such as SQUIRM and Jesred will also work using the above backward-compatibility support. However newer URL-rewrite helpers designed for the <ulink url="https://wiki.squid-cache.org/Features/StoreID/Squid-3.4#">Squid-3.4</ulink> response syntax <emphasis role="strong">WILL NOT</emphasis> work on the Store-ID interface unless they have specific Store-ID interface support. </para></listitem></itemizedlist><section><title>A CDN Pattern Database</title><para>Since the feature by itself was designed and now there is only a need to allow basic and advanced usage we can move on towards a database of CDNs which can be shared by various helper designs. </para><para><ulink url="http://wiki.squid-cache.org/Features/StoreID/DB">The DB of patterns</ulink> provides de-duplication for content such as <ulink url="https://wiki.squid-cache.org/Features/StoreID/SourceForge#">SourceForge</ulink> CDN network or Linux distributions repository mirrors. Contributions are welcome. </para></section><section><title>Do we want to cache youtube videos?</title><para>Rather then a question of &quot;is is possible to be done?&quot; the real question is &quot;do we really want to cache youtube videos?&quot; </para><para>The answer to that from my point of view is: In most places YOUTUBE videos will be quite close by their CDN network. </para><para>If you are in a place that YOUTUBE cdn networks or akamai is there already the you can try to consider caching youtube videos. </para><para>It is possible to cache youtube videos and content but since youtube videos are not a &quot;small&quot; files that should be cached it can cause sometimes bad performance due to bad fine tuning of squid by targeting this sole purpose. </para><para>Since A cache proxy server admin should consider couple aspects he\she should consider the true overhead of doing it. </para></section><section><title>Url only based StoreID compared to deep inspection based StoreID</title><para>There are couple ways to determine an object StoreID. Currently squid StoreID helper interface allows only to determine the StoreID based on the request url which is very limiting since not all urls contains static identification data. </para><para>One great example would be a token based access control downloads, the user never gets a url which can be related to some unique ID of the file\object what so ever in the request but instead gets a url with a random or encrypted token which will result in the download of the file. For example: </para><itemizedlist><listitem override="none"><para>- <ulink url="http://ngtech.co.il/token-based-files/some-randomblob/xyz/yer/?couple=random&amp;request=properties"/> </para></listitem></itemizedlist><para>The above url will be unique on each download request and there for cannot be predicted using the urls only. In order to to predict this url and tie it to some StoreID there is a need for some Deep HTTP Content Inspection. </para><para>These days there are many sites that uses a POST request to fetch the unique download url\token. If we will inspect the full request and response using ICAP or eCAP we could easily know to what ID we can tie the token based urls that are embedded in the POST response. </para><para>In theory, an ID computed by an eCAP service can already be passed to Squid via eCAP annotations (a.k.a. meta headers) and then passed to the storeID helper via <ulink url="http://www.squid-cache.org/Doc/config/store_id_extras#">store_id_extras</ulink>. Currently, ICAP services do not support the option to send a StoreID as a part of the request and response processing.  </para><para>An adaptation service can use a memory only DB such as memcached or redis or others to store the StoreID for specific requests url that will later be fetched by the StoreID helper that will set them. </para><para>The above ICAP + StoreID helper idea works in production with more then one site for quite some time but it has some overheads and I would rate this kind of a setup as an Expert only. </para></section></section><section><title>Squid Configuration</title><para>A small example for StoreID refresh pattern </para><screen><![CDATA[refresh_pattern ^http://(youtube|ytimg|vimeo|[a-zA-Z0-9\-]+)\.squid\.internal/.*  10080 80%  79900 override-lastmod override-expire ignore-reload ignore-must-revalidate ignore-private
]]><![CDATA[
acl rewritedoms dstdomain .dailymotion.com .video-http.media-imdb.com .c.youtube.com av.vimeo.com .dl.sourceforge.net .ytimg.com .vid.ec.dmcdn.net .videoslasher.com
]]><![CDATA[
store_id_program /usr/local/squid/bin/new_format.rb
store_id_children 40 startup=10 idle=5 concurrency=0
store_id_access allow rewritedoms !banned_methods
store_id_access deny all]]></screen><para>An example for input and output of the helper: </para><screen><![CDATA[root# /usr/local/squid/bin/new_format.rb
]]><![CDATA[
ERR
http://i2.ytimg.com/vi/95b1zk3qhSM/hqdefault.jpg
OK store-id=http://ytimg.squid.internal/vi/95b1zk3qhSM/hqdefault.jpg]]></screen><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> from <ulink url="https://wiki.squid-cache.org/Features/StoreID/Squid-3.5#">Squid-3.5</ulink> this helper can support any value for the concurrency setting. </para></listitem></itemizedlist></section><section><title>Developers info</title><section><title>Helper Example</title><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/alert.png" width="15"/></imageobject><textobject><phrase>/!\</phrase></textobject></inlinemediaobject> This helper is an example. It is provided without any warranty or guarantees and is not recommended for production use. </para></listitem></itemizedlist><para>There is a newer <ulink url="https://wiki.squid-cache.org/Features/StoreID/Features/StoreID/Helper#">StoreID helper</ulink> which has more URL patterns in it in a way you can learn URL patterns. </para><programlisting format="linespecific" language="highlight" linenumbering="numbered" startinglinenumber="1"><lineannotation><![CDATA[#!/usr/bin/ruby]]></lineannotation>
<lineannotation><![CDATA[# encoding: utf-8]]></lineannotation>

<token><![CDATA[require]]></token><![CDATA[ ]]><phrase><![CDATA["]]></phrase><phrase><![CDATA[rubygems]]></phrase><phrase><![CDATA["]]></phrase>
<token><![CDATA[require]]></token><![CDATA[ ]]><phrase><![CDATA['syslog']]></phrase>

<token><![CDATA[class]]></token><![CDATA[ ]]><methodname><![CDATA[Cache]]></methodname>
<![CDATA[        ]]><token><![CDATA[def]]></token><![CDATA[ ]]><methodname><![CDATA[initialize]]></methodname>
<![CDATA[        ]]><token><![CDATA[end]]></token>

<![CDATA[        ]]><token><![CDATA[def]]></token><![CDATA[ ]]><methodname><![CDATA[sfdlid]]></methodname><![CDATA[(]]><methodname><![CDATA[url]]></methodname><![CDATA[)]]>
<![CDATA[                        ]]><methodname><![CDATA[m]]></methodname><![CDATA[ = ]]><methodname><![CDATA[url]]></methodname><![CDATA[.]]><methodname><![CDATA[match]]></methodname><![CDATA[(]]><phrase><![CDATA[/]]></phrase><phrase><![CDATA[^http:]]></phrase><phrase><![CDATA[\/]]></phrase><phrase><![CDATA[\/]]></phrase><phrase><![CDATA[.*]]></phrase><phrase><![CDATA[\]]></phrase><phrase><![CDATA[.dl]]></phrase><phrase><![CDATA[\]]></phrase><phrase><![CDATA[.sourceforge]]></phrase><phrase><![CDATA[\]]></phrase><phrase><![CDATA[.net]]></phrase><phrase><![CDATA[\/]]></phrase><phrase><![CDATA[(.*)]]></phrase><phrase><![CDATA[/]]></phrase><![CDATA[)]]>
<![CDATA[                        ]]><token><![CDATA[if]]></token><![CDATA[ ]]><methodname><![CDATA[m]]></methodname><![CDATA[[1]]]>
<![CDATA[                                ]]><token><![CDATA[return]]></token><![CDATA[ ]]><methodname><![CDATA[m]]></methodname><![CDATA[[1]]]>
<![CDATA[                        ]]><token><![CDATA[else]]></token>
<![CDATA[                                ]]><token><![CDATA[return]]></token><![CDATA[ ]]><token><![CDATA[nil]]></token>
<![CDATA[                        ]]><token><![CDATA[end]]></token>
<![CDATA[        ]]><token><![CDATA[end]]></token>
<token><![CDATA[end]]></token>

<token><![CDATA[def]]></token><![CDATA[ ]]><methodname><![CDATA[rewriter]]></methodname><![CDATA[(]]><methodname><![CDATA[request]]></methodname><![CDATA[)]]>
<token><![CDATA[case]]></token><![CDATA[ ]]><methodname><![CDATA[request]]></methodname>
<![CDATA[  ]]><token><![CDATA[when]]></token><![CDATA[ ]]><phrase><![CDATA[/]]></phrase><phrase><![CDATA[^http:]]></phrase><phrase><![CDATA[\/]]></phrase><phrase><![CDATA[\/]]></phrase><phrase><![CDATA[[a-zA-Z0-9]]></phrase><phrase><![CDATA[\]]></phrase><phrase><![CDATA[-]]></phrase><phrase><![CDATA[\]]></phrase><phrase><![CDATA[_]]></phrase><phrase><![CDATA[\]]></phrase><phrase><![CDATA[.]+]]></phrase><phrase><![CDATA[\]]></phrase><phrase><![CDATA[.dl]]></phrase><phrase><![CDATA[\]]></phrase><phrase><![CDATA[.sourceforge]]></phrase><phrase><![CDATA[\]]></phrase><phrase><![CDATA[.net]]></phrase><phrase><![CDATA[\/]]></phrase><phrase><![CDATA[.*]]></phrase><phrase><![CDATA[/]]></phrase>
<![CDATA[          ]]><methodname><![CDATA[vid]]></methodname><![CDATA[ = ]]><methodname><![CDATA[$cache]]></methodname><![CDATA[.]]><methodname><![CDATA[sfdlid]]></methodname><![CDATA[(]]><methodname><![CDATA[request]]></methodname><![CDATA[)]]>
<![CDATA[          ]]><methodname><![CDATA[url]]></methodname><![CDATA[ = ]]><phrase><![CDATA["]]></phrase><phrase><![CDATA[http://dl.sourceforge.net.squid.internal/]]></phrase><phrase><![CDATA["]]></phrase><![CDATA[ + ]]><methodname><![CDATA[vid]]></methodname><![CDATA[ ]]><token><![CDATA[if]]></token><![CDATA[ ]]><methodname><![CDATA[vid]]></methodname><![CDATA[ != ]]><token><![CDATA[nil]]></token>
<![CDATA[          ]]><token><![CDATA[return]]></token><![CDATA[ ]]><methodname><![CDATA[url]]></methodname><![CDATA[    ]]>
<![CDATA[  ]]><token><![CDATA[when]]></token><![CDATA[ ]]><phrase><![CDATA[/]]></phrase><phrase><![CDATA[^quit.*]]></phrase><phrase><![CDATA[/]]></phrase>
<![CDATA[          ]]><token><![CDATA[exit]]></token><![CDATA[ 0]]>
<![CDATA[  ]]><token><![CDATA[else]]></token>
<![CDATA[         ]]><token><![CDATA[return]]></token><![CDATA[ ]]><phrase><![CDATA["]]></phrase><phrase><![CDATA["]]></phrase>
<![CDATA[  ]]><token><![CDATA[end]]></token>
<token><![CDATA[end]]></token>

<token><![CDATA[def]]></token><![CDATA[ ]]><methodname><![CDATA[log]]></methodname><![CDATA[(]]><methodname><![CDATA[msg]]></methodname><![CDATA[)]]>
<![CDATA[ ]]><symbol><![CDATA[Syslog]]></symbol><![CDATA[.]]><methodname><![CDATA[log]]></methodname><![CDATA[(]]><symbol><![CDATA[Syslog]]></symbol><![CDATA[::]]><symbol><![CDATA[LOG_ERR]]></symbol><![CDATA[, ]]><phrase><![CDATA["]]></phrase><phrase><![CDATA[%s]]></phrase><phrase><![CDATA["]]></phrase><![CDATA[, ]]><methodname><![CDATA[msg]]></methodname><![CDATA[)]]>
<token><![CDATA[end]]></token>

<token><![CDATA[def]]></token><![CDATA[ ]]><methodname><![CDATA[eval]]></methodname>
<![CDATA[       ]]><methodname><![CDATA[request]]></methodname><![CDATA[ = ]]><token><![CDATA[gets]]></token>
<![CDATA[       ]]><token><![CDATA[if]]></token><![CDATA[ (]]><methodname><![CDATA[request]]></methodname><![CDATA[ && (]]><methodname><![CDATA[request]]></methodname><![CDATA[.]]><methodname><![CDATA[match]]></methodname><![CDATA[(]]><phrase><![CDATA[/]]></phrase><phrase><![CDATA[^[0-9]+]]></phrase><phrase><![CDATA[\]]></phrase><phrase><![CDATA[ ]]></phrase><phrase><![CDATA[/]]></phrase><![CDATA[)))]]>
<![CDATA[        ]]><methodname><![CDATA[conc]]></methodname><![CDATA[(]]><methodname><![CDATA[request]]></methodname><![CDATA[)]]>
<![CDATA[        ]]><token><![CDATA[return]]></token><![CDATA[ ]]><token><![CDATA[true]]></token>
<![CDATA[       ]]><token><![CDATA[else]]></token>
<![CDATA[        ]]><methodname><![CDATA[noconc]]></methodname><![CDATA[(]]><methodname><![CDATA[request]]></methodname><![CDATA[)]]>
<![CDATA[        ]]><token><![CDATA[return]]></token><![CDATA[ ]]><token><![CDATA[false]]></token>
<![CDATA[       ]]><token><![CDATA[end]]></token>

<token><![CDATA[end]]></token>


<token><![CDATA[def]]></token><![CDATA[ ]]><methodname><![CDATA[conc]]></methodname><![CDATA[(]]><methodname><![CDATA[request]]></methodname><![CDATA[)]]>
<![CDATA[        ]]><token><![CDATA[return]]></token><![CDATA[ ]]><token><![CDATA[if]]></token><![CDATA[ !]]><methodname><![CDATA[request]]></methodname>
<![CDATA[        ]]><methodname><![CDATA[request]]></methodname><![CDATA[ = ]]><methodname><![CDATA[request]]></methodname><![CDATA[.]]><methodname><![CDATA[split]]></methodname>
<![CDATA[                ]]><token><![CDATA[if]]></token><![CDATA[ ]]><methodname><![CDATA[request]]></methodname><![CDATA[[0] && ]]><methodname><![CDATA[request]]></methodname><![CDATA[[1]]]>
<![CDATA[                        ]]><methodname><![CDATA[log]]></methodname><![CDATA[(]]><phrase><![CDATA["]]></phrase><phrase><![CDATA[original request []]></phrase><phrase><![CDATA[#{]]></phrase><methodname><![CDATA[request]]></methodname><![CDATA[.]]><methodname><![CDATA[join]]></methodname><![CDATA[(]]><phrase><![CDATA["]]></phrase><phrase><![CDATA[ ]]></phrase><phrase><![CDATA["]]></phrase><![CDATA[)]]><phrase><![CDATA[}]]></phrase><phrase><![CDATA[].]]></phrase><phrase><![CDATA["]]></phrase><![CDATA[) ]]><token><![CDATA[if]]></token><![CDATA[ ]]><methodname><![CDATA[$debug]]></methodname>
<![CDATA[                        ]]><methodname><![CDATA[result]]></methodname><![CDATA[ = ]]><methodname><![CDATA[rewriter]]></methodname><![CDATA[(]]><methodname><![CDATA[request]]></methodname><![CDATA[[1])]]>
<![CDATA[                ]]><token><![CDATA[if]]></token><![CDATA[ ]]><methodname><![CDATA[result]]></methodname>
<![CDATA[                  ]]><methodname><![CDATA[url]]></methodname><![CDATA[ = ]]><methodname><![CDATA[request]]></methodname><![CDATA[[0] +]]><phrase><![CDATA["]]></phrase><phrase><![CDATA[ OK store-id=]]></phrase><phrase><![CDATA["]]></phrase><![CDATA[ + ]]><methodname><![CDATA[result]]></methodname>
<![CDATA[                        ]]><token><![CDATA[else]]></token>
<![CDATA[                  ]]><methodname><![CDATA[url]]></methodname><![CDATA[ = ]]><methodname><![CDATA[request]]></methodname><![CDATA[[0] +]]><phrase><![CDATA["]]></phrase><phrase><![CDATA[ ERR]]></phrase><phrase><![CDATA["]]></phrase>
<![CDATA[                ]]><token><![CDATA[end]]></token>
<![CDATA[                ]]><methodname><![CDATA[log]]></methodname><![CDATA[(]]><phrase><![CDATA["]]></phrase><phrase><![CDATA[modified response []]></phrase><phrase><![CDATA[#{]]></phrase><methodname><![CDATA[url]]></methodname><phrase><![CDATA[}]]></phrase><phrase><![CDATA[].]]></phrase><phrase><![CDATA["]]></phrase><![CDATA[) ]]><token><![CDATA[if]]></token><![CDATA[ ]]><methodname><![CDATA[$debug]]></methodname>
<![CDATA[                        ]]><token><![CDATA[puts]]></token><![CDATA[ ]]><methodname><![CDATA[url]]></methodname>
<![CDATA[                ]]><token><![CDATA[else]]></token>
<![CDATA[                ]]><methodname><![CDATA[log]]></methodname><![CDATA[(]]><phrase><![CDATA["]]></phrase><phrase><![CDATA[original request [had a problem].]]></phrase><phrase><![CDATA["]]></phrase><![CDATA[) ]]><token><![CDATA[if]]></token><![CDATA[ ]]><methodname><![CDATA[$debug]]></methodname>
<![CDATA[                ]]><methodname><![CDATA[url]]></methodname><![CDATA[ = ]]><methodname><![CDATA[request]]></methodname><![CDATA[[0] + ]]><phrase><![CDATA["]]></phrase><phrase><![CDATA[ERR]]></phrase><phrase><![CDATA["]]></phrase>
<![CDATA[                ]]><methodname><![CDATA[log]]></methodname><![CDATA[(]]><phrase><![CDATA["]]></phrase><phrase><![CDATA[modified response []]></phrase><phrase><![CDATA[#{]]></phrase><methodname><![CDATA[url]]></methodname><phrase><![CDATA[}]]></phrase><phrase><![CDATA[].]]></phrase><phrase><![CDATA["]]></phrase><![CDATA[) ]]><token><![CDATA[if]]></token><![CDATA[ ]]><methodname><![CDATA[$debug]]></methodname>
<![CDATA[                ]]><token><![CDATA[puts]]></token><![CDATA[ ]]><methodname><![CDATA[url]]></methodname>
<![CDATA[                ]]><token><![CDATA[end]]></token>

<token><![CDATA[end]]></token>

<token><![CDATA[def]]></token><![CDATA[ ]]><methodname><![CDATA[noconc]]></methodname><![CDATA[(]]><methodname><![CDATA[request]]></methodname><![CDATA[)]]>
<![CDATA[        ]]><token><![CDATA[return]]></token><![CDATA[ ]]><token><![CDATA[if]]></token><![CDATA[ !]]><methodname><![CDATA[request]]></methodname>
<![CDATA[        ]]><methodname><![CDATA[request]]></methodname><![CDATA[ = ]]><methodname><![CDATA[request]]></methodname><![CDATA[.]]><methodname><![CDATA[split]]></methodname>
<![CDATA[                ]]><token><![CDATA[if]]></token><![CDATA[ ]]><methodname><![CDATA[request]]></methodname><![CDATA[[0]]]>
<![CDATA[                        ]]><methodname><![CDATA[log]]></methodname><![CDATA[(]]><phrase><![CDATA["]]></phrase><phrase><![CDATA[Original request []]></phrase><phrase><![CDATA[#{]]></phrase><methodname><![CDATA[request]]></methodname><![CDATA[.]]><methodname><![CDATA[join]]></methodname><![CDATA[(]]><phrase><![CDATA["]]></phrase><phrase><![CDATA[ ]]></phrase><phrase><![CDATA["]]></phrase><![CDATA[)]]><phrase><![CDATA[}]]></phrase><phrase><![CDATA[].]]></phrase><phrase><![CDATA["]]></phrase><![CDATA[) ]]><token><![CDATA[if]]></token><![CDATA[ ]]><methodname><![CDATA[$debug]]></methodname>
<![CDATA[                        ]]><methodname><![CDATA[result]]></methodname><![CDATA[ = ]]><methodname><![CDATA[rewriter]]></methodname><![CDATA[(]]><methodname><![CDATA[request]]></methodname><![CDATA[[0])]]>
<![CDATA[                ]]><token><![CDATA[if]]></token><![CDATA[ ]]><methodname><![CDATA[result]]></methodname><![CDATA[ && (]]><methodname><![CDATA[result]]></methodname><![CDATA[.]]><methodname><![CDATA[size]]></methodname><![CDATA[ > 10)]]>
<![CDATA[                       ]]><methodname><![CDATA[url]]></methodname><![CDATA[ = ]]><phrase><![CDATA["]]></phrase><phrase><![CDATA[OK store-id=]]></phrase><phrase><![CDATA["]]></phrase><![CDATA[ + ]]><methodname><![CDATA[rewriter]]></methodname><![CDATA[(]]><methodname><![CDATA[request]]></methodname><![CDATA[[0])]]>
<![CDATA[                       ]]><lineannotation><![CDATA[#url = "OK store-id=" + request[0] if ( ($empty % 2) == 0 )]]></lineannotation>
<![CDATA[                ]]><token><![CDATA[else]]></token>
<![CDATA[                       ]]><methodname><![CDATA[url]]></methodname><![CDATA[ = ]]><phrase><![CDATA["]]></phrase><phrase><![CDATA[ERR]]></phrase><phrase><![CDATA["]]></phrase>
<![CDATA[                ]]><token><![CDATA[end]]></token>
<![CDATA[                        ]]><methodname><![CDATA[log]]></methodname><![CDATA[(]]><phrase><![CDATA["]]></phrase><phrase><![CDATA[modified response []]></phrase><phrase><![CDATA[#{]]></phrase><methodname><![CDATA[url]]></methodname><phrase><![CDATA[}]]></phrase><phrase><![CDATA[].]]></phrase><phrase><![CDATA["]]></phrase><![CDATA[) ]]><token><![CDATA[if]]></token><![CDATA[ ]]><methodname><![CDATA[$debug]]></methodname>
<![CDATA[                        ]]><token><![CDATA[puts]]></token><![CDATA[ ]]><methodname><![CDATA[url]]></methodname>
<![CDATA[                ]]><token><![CDATA[else]]></token>
<![CDATA[                ]]><methodname><![CDATA[log]]></methodname><![CDATA[(]]><phrase><![CDATA["]]></phrase><phrase><![CDATA[Original request [had a problem].]]></phrase><phrase><![CDATA["]]></phrase><![CDATA[) ]]><token><![CDATA[if]]></token><![CDATA[ ]]><methodname><![CDATA[$debug]]></methodname>
<![CDATA[                        ]]><methodname><![CDATA[url]]></methodname><![CDATA[ = ]]><phrase><![CDATA["]]></phrase><phrase><![CDATA[ERR]]></phrase><phrase><![CDATA["]]></phrase>
<![CDATA[                ]]><methodname><![CDATA[log]]></methodname><![CDATA[(]]><phrase><![CDATA["]]></phrase><phrase><![CDATA[modified response []]></phrase><phrase><![CDATA[#{]]></phrase><methodname><![CDATA[url]]></methodname><phrase><![CDATA[}]]></phrase><phrase><![CDATA[].]]></phrase><phrase><![CDATA["]]></phrase><![CDATA[) ]]><token><![CDATA[if]]></token><![CDATA[ ]]><methodname><![CDATA[$debug]]></methodname>
<![CDATA[                ]]><token><![CDATA[puts]]></token><![CDATA[ ]]><methodname><![CDATA[url]]></methodname>
<![CDATA[                ]]><token><![CDATA[end]]></token>
<token><![CDATA[end]]></token>

<token><![CDATA[def]]></token><![CDATA[ ]]><methodname><![CDATA[validr?]]></methodname><![CDATA[(]]><methodname><![CDATA[request]]></methodname><![CDATA[)]]>
<![CDATA[  ]]><token><![CDATA[if]]></token><![CDATA[ (]]><methodname><![CDATA[request]]></methodname><![CDATA[.]]><methodname><![CDATA[ascii_only?]]></methodname><![CDATA[ && ]]><methodname><![CDATA[request]]></methodname><![CDATA[.]]><methodname><![CDATA[valid_encoding?]]></methodname><![CDATA[)]]>
<![CDATA[    ]]><token><![CDATA[return]]></token><![CDATA[ ]]><token><![CDATA[true]]></token>
<![CDATA[  ]]><token><![CDATA[else]]></token>
<![CDATA[    ]]><symbol><![CDATA[STDERR]]></symbol><![CDATA[.]]><methodname><![CDATA[puts]]></methodname><![CDATA[(]]><phrase><![CDATA["]]></phrase><phrase><![CDATA[errorness line]]></phrase><phrase><![CDATA[#{]]></phrase><methodname><![CDATA[request]]></methodname><phrase><![CDATA[}]]></phrase><phrase><![CDATA["]]></phrase><![CDATA[)]]>
<![CDATA[    ]]><token><![CDATA[return]]></token><![CDATA[ ]]><token><![CDATA[false]]></token>
<![CDATA[  ]]><token><![CDATA[end]]></token>


<token><![CDATA[end]]></token>

<token><![CDATA[def]]></token><![CDATA[ ]]><methodname><![CDATA[main]]></methodname>
<![CDATA[  ]]><symbol><![CDATA[Syslog]]></symbol><![CDATA[.]]><methodname><![CDATA[open]]></methodname><![CDATA[(]]><phrase><![CDATA['new_helper.rb']]></phrase><![CDATA[, ]]><symbol><![CDATA[Syslog]]></symbol><![CDATA[::]]><symbol><![CDATA[LOG_PID]]></symbol><![CDATA[)]]>
<![CDATA[  ]]><methodname><![CDATA[log]]></methodname><![CDATA[(]]><phrase><![CDATA["]]></phrase><phrase><![CDATA[Started]]></phrase><phrase><![CDATA["]]></phrase><![CDATA[)]]>
<![CDATA[  ]]>
<![CDATA[  ]]><methodname><![CDATA[c]]></methodname><![CDATA[ = ]]><token><![CDATA[eval]]></token>

<![CDATA[        ]]><token><![CDATA[if]]></token><![CDATA[ ]]><methodname><![CDATA[c]]></methodname>
<![CDATA[         ]]><token><![CDATA[while]]></token><![CDATA[ ]]><methodname><![CDATA[request]]></methodname><![CDATA[ = ]]><token><![CDATA[gets]]></token>
<![CDATA[                ]]><methodname><![CDATA[conc]]></methodname><![CDATA[(]]><methodname><![CDATA[request]]></methodname><![CDATA[) ]]><token><![CDATA[if]]></token><![CDATA[ ]]><methodname><![CDATA[validr?]]></methodname><![CDATA[(]]><methodname><![CDATA[request]]></methodname><![CDATA[)]]>
<![CDATA[         ]]><token><![CDATA[end]]></token>
<![CDATA[        ]]><token><![CDATA[else]]></token>
<![CDATA[         ]]><token><![CDATA[while]]></token><![CDATA[ ]]><methodname><![CDATA[request]]></methodname><![CDATA[ = ]]><token><![CDATA[gets]]></token>
<![CDATA[                ]]><methodname><![CDATA[noconc]]></methodname><![CDATA[(]]><methodname><![CDATA[request]]></methodname><![CDATA[) ]]><token><![CDATA[if]]></token><![CDATA[ ]]><methodname><![CDATA[validr?]]></methodname><![CDATA[(]]><methodname><![CDATA[request]]></methodname><![CDATA[)]]>
<![CDATA[         ]]><token><![CDATA[end]]></token>
<![CDATA[        ]]><token><![CDATA[end]]></token>
<token><![CDATA[end]]></token>

<methodname><![CDATA[$debug]]></methodname><![CDATA[ = ]]><token><![CDATA[true]]></token>
<methodname><![CDATA[$cache]]></methodname><![CDATA[ = ]]><symbol><![CDATA[Cache]]></symbol><![CDATA[.]]><methodname><![CDATA[new]]></methodname>
<symbol><![CDATA[STDOUT]]></symbol><![CDATA[.]]><methodname><![CDATA[sync]]></methodname><![CDATA[ = ]]><token><![CDATA[true]]></token>
<methodname><![CDATA[main]]></methodname>
</programlisting></section><section><title>Helper Input\Output Example</title><screen><![CDATA[#./new_helper.rb
http://freefr.dl.sourceforge.net/project/vlc/2.0.5/win32/vlc-2.0.5-win32.exe
OK store-id=http://dl.sourceforge.net.squid.internal/project/vlc/2.0.5/win32/vlc-2.0.5-win32.exe
http://www.google.com/
ERR
quit
#tail /var/log/messages
Feb 17 17:32:07 www1 new_helper.rb[21352]: Started
Feb 17 17:32:08 www1 new_helper.rb[21352]: Original request [http://freefr.dl.sourceforge.net/project/vlc/2.0.5/win32/vlc-2.0.5-win32.exe].
Feb 17 17:32:08 www1 new_helper.rb[21352]: modified response [OK store-id=http://dl.sourceforge.net.squid.internal/project/vlc/2.0.5/win32/vlc-2.0.5-win32.exe].
Feb 17 17:32:39 www1 new_helper.rb[21352]: Original request [http://www.google.com/].
Feb 17 17:32:39 www1 new_helper.rb[21352]: modified response [ERR].
Feb 17 17:32:51 www1 new_helper.rb[21352]: Original request [quit].]]></screen></section></section><section><title>How do I make my own helper?</title><para>The helper program must read URLs (one per line) on standard input, and write OK with a unique identifier (ID) or ERR/BH lines on standard output. Squid writes additional information after the URL which a helper can use to make a decision. </para><para>Input line received from Squid: </para><screen><![CDATA[[channel-ID] URL [key-extras]]]></screen><glosslist><glossentry><glossterm>channel-ID</glossterm><glossdef><itemizedlist><listitem override="none"><para>This is an ID for the line when concurrency is enabled. When concurrency is turned off (set to <emphasis role="strong">1</emphasis>) this field and the following space will be completely missing. </para></listitem></itemizedlist></glossdef></glossentry><glossentry><glossterm>URL</glossterm><glossdef><itemizedlist><listitem override="none"><para>The URL received from the client. In Squid with ICAP support, this is the URL after ICAP REQMOD has taken place. </para></listitem></itemizedlist></glossdef></glossentry><glossentry><glossterm>key-extras</glossterm><glossdef><itemizedlist><listitem override="none"><para>Starting with <ulink url="https://wiki.squid-cache.org/Features/StoreID/Squid-3.5#">Squid-3.5</ulink> additional parameters passed to the helper which may be configured with <ulink url="http://www.squid-cache.org/Doc/config/url_rewrite_extras#">url_rewrite_extras</ulink>. For backward compatibility the default key-extras for URL helpers matches the format fields sent by <ulink url="https://wiki.squid-cache.org/Features/StoreID/Squid-3.4#">Squid-3.4</ulink> and older in this field position: </para></listitem></itemizedlist><itemizedlist><listitem override="none"><screen><![CDATA[ ip/fqdn ident method [urlgroup] kv-pair]]></screen></listitem></itemizedlist></glossdef></glossentry><glossentry><glossterm>ip</glossterm><glossdef><itemizedlist><listitem override="none"><para>This is the IP address of the client. Followed by a slash (<emphasis role="strong">/</emphasis>) as shown above. </para></listitem></itemizedlist></glossdef></glossentry><glossentry><glossterm>fqdn</glossterm><glossdef><itemizedlist><listitem override="none"><para>The FQDN rDNS of the client, if any is known. Squid does not normally perform lookup unless needed by logging or ACLs. Squid does not wait for any results unless ACLs are configured to wait. If none is available <emphasis role="strong">-</emphasis> will be sent to the helper instead. </para></listitem></itemizedlist></glossdef></glossentry><glossentry><glossterm>ident</glossterm><glossdef><itemizedlist><listitem override="none"><para>The IDENT protocol username (if known) of the client machine. Squid will not wait for IDENT username to become known unless there are ACL which depend on it. So at the time re-writers are run the IDENT username may not yet be known. If none is available <emphasis role="strong">-</emphasis> will be sent to the helper instead. </para></listitem></itemizedlist></glossdef></glossentry><glossentry><glossterm>method</glossterm><glossdef><itemizedlist><listitem override="none"><para>The HTTP request method. URL alterations and particularly redirection are only possible on certain methods, and some such as POST and CONNECT require special care. </para></listitem></itemizedlist></glossdef></glossentry><glossentry><glossterm>urlgroup</glossterm><glossdef><itemizedlist><listitem override="none"><para>Squid-2 will send this field with the URL-grouping tag which can be configured on <ulink url="http://www.squid-cache.org/Doc/config/http_port#">http_port</ulink>. Squid-3.x will not send this field. </para></listitem></itemizedlist></glossdef></glossentry><glossentry><glossterm>kv-pair</glossterm><glossdef><itemizedlist><listitem override="none"><para>One or more key=value pairs. Only &quot;myip&quot; and &quot;myport&quot; pairs documented below were ever defined and are sent unconditionally by <ulink url="https://wiki.squid-cache.org/Features/StoreID/Squid-3.4#">Squid-3.4</ulink> and older: </para><informaltable><tgroup cols="2"><colspec colname="col_0"/><colspec colname="col_1"/><tbody><row rowsep="1"><entry colsep="1" rowsep="1"><para> myip=... </para></entry><entry colsep="1" rowsep="1"><para> Squid receiving address </para></entry></row><row rowsep="1"><entry colsep="1" rowsep="1"><para> myport=... </para></entry><entry colsep="1" rowsep="1"><para> Squid receiving port </para></entry></row></tbody></tgroup></informaltable></listitem></itemizedlist></glossdef></glossentry></glosslist><para>Result line sent back to Squid: </para><screen><![CDATA[[channel-ID] result kv-pair]]></screen><glosslist><glossentry><glossterm>channel-ID</glossterm><glossdef><itemizedlist><listitem override="none"><para>When a concurrency <emphasis role="strong">channel-ID</emphasis> is received it must be sent back to Squid unchanged as the first entry on the line. </para></listitem></itemizedlist></glossdef></glossentry><glossentry><glossterm>result</glossterm><glossdef><itemizedlist><listitem override="none"><para>One of the result codes: </para><informaltable><tgroup cols="2"><colspec colname="col_0"/><colspec colname="col_1"/><tbody><row rowsep="1"><entry colsep="1" rowsep="1"><para> OK </para></entry><entry colsep="1" rowsep="1"><para> Success. A new storage ID is presented for this URL. </para></entry></row><row rowsep="1"><entry colsep="1" rowsep="1"><para> ERR </para></entry><entry colsep="1" rowsep="1"><para> Success. No change for this URL. </para></entry></row><row rowsep="1"><entry colsep="1" rowsep="1"><para> BH </para></entry><entry colsep="1" rowsep="1"><para> Failure. The helper encountered a problem. </para></entry></row></tbody></tgroup></informaltable></listitem></itemizedlist></glossdef></glossentry><glossentry><glossterm>kv-pair</glossterm><glossdef><itemizedlist><listitem override="none"><para>One or more key=value pairs. The key names reserved on this interface for URL re-writing: </para><informaltable><tgroup cols="2"><colspec colname="col_0"/><colspec colname="col_1"/><tbody><row rowsep="1"><entry colsep="1" rowsep="1"><para> clt_conn_tag=... </para></entry><entry colsep="1" rowsep="1"><para> Tag the client TCP connection (<ulink url="https://wiki.squid-cache.org/Features/StoreID/Squid-3.5#">Squid-3.5</ulink>) </para></entry></row><row rowsep="1"><entry colsep="1" rowsep="1"><para> message=... </para></entry><entry colsep="1" rowsep="1"><para> reserved </para></entry></row><row rowsep="1"><entry colsep="1" rowsep="1"><para> store-id=... </para></entry><entry colsep="1" rowsep="1"><para> set the cache storage ID for this URL. </para></entry></row><row rowsep="1"><entry colsep="1" rowsep="1"><para> tag=... </para></entry><entry colsep="1" rowsep="1"><para> reserved </para></entry></row><row rowsep="1"><entry colsep="1" rowsep="1"><para> ttl=... </para></entry><entry colsep="1" rowsep="1"><para> reserved </para></entry></row><row rowsep="1"><entry colsep="1" rowsep="1"><para> *_=... </para></entry><entry colsep="1" rowsep="1"><para> Key names ending in (_) are reserved for local administrators use. </para></entry></row></tbody></tgroup></informaltable></listitem><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> the kv-pair returned by this helper can be logged by the <emphasis role="strong">%note</emphasis> <ulink url="http://www.squid-cache.org/Doc/config/logformat#">logformat</ulink> code. </para></listitem></itemizedlist><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> This interface will also accept responses in the syntax delivered by <ulink url="https://wiki.squid-cache.org/Features/StoreID/Features/StoreUrlRewrite#">Store URL-rewrite</ulink> feature helpers written for <ulink url="https://wiki.squid-cache.org/Features/StoreID/Squid-2.7#">Squid-2.7</ulink>. However thst syntax is deprecated and such helpers should be upgraded as soon as possible to use this Store-ID syntax. </para></glossdef></glossentry></glosslist><!--rule (<hr>) is not applicable to DocBook--><para> <ulink url="https://wiki.squid-cache.org/Features/StoreID/CategoryFeature#">CategoryFeature</ulink> </para></section></section></article>