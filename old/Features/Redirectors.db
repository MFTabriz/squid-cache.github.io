<?xml version="1.0" encoding="utf-8"?><!DOCTYPE article  PUBLIC '-//OASIS//DTD DocBook XML V4.4//EN'  'http://www.docbook.org/xml/4.4/docbookx.dtd'><article><articleinfo><title>Features/Redirectors</title><revhistory><revision><revnumber>18</revnumber><date>2011-11-10 22:58:43</date><authorinitials>AmosJeffries</authorinitials><revremark>alter the redirector example script not to return URL on no change cases</revremark></revision><revision><revnumber>17</revnumber><date>2011-03-17 10:13:16</date><authorinitials>AmosJeffries</authorinitials><revremark>even more polish to correct the terminology initial descriptions.</revremark></revision><revision><revnumber>16</revnumber><date>2011-03-17 08:30:36</date><authorinitials>AmosJeffries</authorinitials><revremark>revamp and import protocol details from the addons page</revremark></revision><revision><revnumber>15</revnumber><date>2010-10-28 10:35:11</date><authorinitials>FrancescoChemolli</authorinitials><revremark>Moved to auto-magic Status label</revremark></revision><revision><revnumber>14</revnumber><date>2009-10-14 05:14:03</date><authorinitials>AmosJeffries</authorinitials><revremark>tweaks</revremark></revision><revision><revnumber>13</revnumber><date>2009-03-08 09:53:43</date><authorinitials>AmosJeffries</authorinitials><revremark>add text in developer field to keep off wishlist of things yet to do.</revremark></revision><revision><revnumber>12</revnumber><date>2009-02-27 12:53:01</date><authorinitials>AmosJeffries</authorinitials><revremark>add docs for concurrency</revremark></revision><revision><revnumber>11</revnumber><date>2009-02-04 09:13:34</date><authorinitials>AmosJeffries</authorinitials><revremark>add feature template bits</revremark></revision><revision><revnumber>10</revnumber><date>2009-02-04 08:10:27</date><authorinitials>AmosJeffries</authorinitials><revremark>this is a feature</revremark></revision><revision><revnumber>9</revnumber><date>2008-10-27 01:34:16</date><authorinitials>AmosJeffries</authorinitials><revremark>fix confusing phrasing.</revremark></revision><revision><revnumber>8</revnumber><date>2008-05-18 19:38:57</date><authorinitials>localhost</authorinitials><revremark>converted to 1.6 markup</revremark></revision><revision><revnumber>7</revnumber><date>2008-04-10 10:36:40</date><authorinitials>FrancescoChemolli</authorinitials><revremark>Changed link to PhpRedirectors to match wiki-links</revremark></revision><revision><revnumber>6</revnumber><date>2008-04-09 16:38:36</date><authorinitials>The_Spider</authorinitials></revision><revision><revnumber>5</revnumber><date>2008-03-09 17:55:26</date><authorinitials>kinkie</authorinitials><revremark>Added note on location_rewrite</revremark></revision><revision><revnumber>4</revnumber><date>2006-08-29 12:36:03</date><authorinitials>kinkie</authorinitials></revision><revision><revnumber>3</revnumber><date>2006-06-04 06:20:08</date><authorinitials>ReubenFarrelly</authorinitials><revremark>Remove reference to squid-1.1.19</revremark></revision><revision><revnumber>2</revnumber><date>2006-03-03 09:24:54</date><authorinitials>kinkie</authorinitials></revision><revision><revnumber>1</revnumber><date>2006-01-25 21:48:47</date><authorinitials>kinkie</authorinitials></revision></revhistory></articleinfo><section><title>Feature: Redirection Helpers</title><itemizedlist><listitem><para><emphasis role="strong">Goal</emphasis>: Allow Squid to use custom helpers to redirect and/or hijack web requests on demand to another location. </para></listitem><listitem><para><emphasis role="strong">Status</emphasis>: completed </para></listitem><listitem><para><emphasis role="strong">Version</emphasis>: 2.5+ </para></listitem></itemizedlist><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/alert.png" width="15"/></imageobject><textobject><phrase>/!\</phrase></textobject></inlinemediaobject> Some <emphasis>redirectors</emphasis> are properly called URL re-writers to reflect what they actually do. Which is to alter the URL being handled. Thanks to a long legacy in both Squid and other software (looking at Apache) there are many re-writers and few real redirectors. </para></listitem></itemizedlist><section><title>What is a redirector? or re-writer?</title><para>Squid has the ability to alter requested URLs.  Implemented as an external process, Squid can be configured to pass every incoming URL through a helper process that returns either a new URL, or a blank line to indicate no change. </para><para><emphasis role="strong">Redirection</emphasis> is a defined feature of HTTP where a status code between 300 and 399 is sent to the requesting client along with an alternative URL. A <emphasis role="strong">redirector</emphasis> helper in Squid uses this feature of HTTP to <emphasis>bounce</emphasis> or re-direct the client browsers to alternative URLs. You may be familiar with <emphasis role="strong">302</emphasis> responses to POST requests or between domains such as www.example.com and example.com. </para><para>A <emphasis role="strong">re-writer</emphasis> does not use this feature of HTTP, but merely mangles the URL into a new form. Sometimes this is needed, usually not. HTTP defines many features which this breaks. </para><para>The helper program is <emphasis role="strong"><emphasis role="underline">NOT</emphasis></emphasis> a standard part of the Squid package.  However, some examples are provided below, and in the &quot;helpers/url_rewrite/&quot; directory of the source distribution.  Since everyone has different needs, it is up to the individual administrators to write their own implementation. </para></section><section><title>Why use a redirector?</title><para>A redirector allows the administrator to control the locations to which his users go.  Using this in conjunction with interception proxies allows simple but effective control. </para></section><section><title>How does it work?</title><para>The helper program must read URLs (one per line) on standard input, and write rewritten URLs or blank lines on standard output. Squid writes additional information after the URL which a redirector can use to make a decision. </para><para>Input line received from Squid: </para><screen><![CDATA[[channel-ID] URL [key-extras]]]></screen><glosslist><glossentry><glossterm>channel-ID</glossterm><glossdef><itemizedlist><listitem override="none"><para>This is an ID for the line when concurrency is enabled. When concurrency is turned off (set to <emphasis role="strong">1</emphasis>) this field and the following space will be completely missing. </para></listitem></itemizedlist></glossdef></glossentry><glossentry><glossterm>URL</glossterm><glossdef><itemizedlist><listitem override="none"><para>The URL received from the client. In Squid with ICAP support, this is the URL after ICAP REQMOD has taken place. </para></listitem></itemizedlist></glossdef></glossentry><glossentry><glossterm>key-extras</glossterm><glossdef><itemizedlist><listitem override="none"><para>Starting with <ulink url="https://wiki.squid-cache.org/Features/Redirectors/Squid-3.5#">Squid-3.5</ulink> additional parameters passed to the helper which may be configured with <ulink url="http://www.squid-cache.org/Doc/config/url_rewrite_extras#">url_rewrite_extras</ulink>. For backward compatibility the default key-extras for URL helpers matches the format fields sent by <ulink url="https://wiki.squid-cache.org/Features/Redirectors/Squid-3.4#">Squid-3.4</ulink> and older in this field position: </para></listitem></itemizedlist><itemizedlist><listitem override="none"><screen><![CDATA[ ip/fqdn ident method [urlgroup] kv-pair]]></screen></listitem></itemizedlist></glossdef></glossentry><glossentry><glossterm>ip</glossterm><glossdef><itemizedlist><listitem override="none"><para>This is the IP address of the client. Followed by a slash (<emphasis role="strong">/</emphasis>) as shown above. </para></listitem></itemizedlist></glossdef></glossentry><glossentry><glossterm>fqdn</glossterm><glossdef><itemizedlist><listitem override="none"><para>The FQDN rDNS of the client, if any is known. Squid does not normally perform lookup unless needed by logging or ACLs. Squid does not wait for any results unless ACLs are configured to wait. If none is available <emphasis role="strong">-</emphasis> will be sent to the helper instead. </para></listitem></itemizedlist></glossdef></glossentry><glossentry><glossterm>ident</glossterm><glossdef><itemizedlist><listitem override="none"><para>The IDENT protocol username (if known) of the client machine. Squid will not wait for IDENT username to become known unless there are ACL which depend on it. So at the time re-writers are run the IDENT username may not yet be known. If none is available <emphasis role="strong">-</emphasis> will be sent to the helper instead. </para></listitem></itemizedlist></glossdef></glossentry><glossentry><glossterm>method</glossterm><glossdef><itemizedlist><listitem override="none"><para>The HTTP request method. URL alterations and particularly redirection are only possible on certain methods, and some such as POST and CONNECT require special care. </para></listitem></itemizedlist></glossdef></glossentry><glossentry><glossterm>urlgroup</glossterm><glossdef><itemizedlist><listitem override="none"><para>Squid-2 will send this field with the URL-grouping tag which can be configured on <ulink url="http://www.squid-cache.org/Doc/config/http_port#">http_port</ulink>. Squid-3.x will not send this field. </para></listitem></itemizedlist></glossdef></glossentry><glossentry><glossterm>kv-pair</glossterm><glossdef><itemizedlist><listitem override="none"><para>One or more key=value pairs. Only &quot;myip&quot; and &quot;myport&quot; pairs documented below were ever defined and are sent unconditionally by <ulink url="https://wiki.squid-cache.org/Features/Redirectors/Squid-3.4#">Squid-3.4</ulink> and older: </para><informaltable><tgroup cols="2"><colspec colname="col_0"/><colspec colname="col_1"/><tbody><row rowsep="1"><entry colsep="1" rowsep="1"><para> myip=... </para></entry><entry colsep="1" rowsep="1"><para> Squid receiving address </para></entry></row><row rowsep="1"><entry colsep="1" rowsep="1"><para> myport=... </para></entry><entry colsep="1" rowsep="1"><para> Squid receiving port </para></entry></row></tbody></tgroup></informaltable></listitem></itemizedlist></glossdef></glossentry></glosslist><section><title>Using an HTTP redirector</title><para>The <emphasis>redirector</emphasis> feature of HTTP is a &quot;301&quot;, &quot;307&quot; or &quot;302&quot; redirect message to the client specifying an alternative URL to work with. </para><para>For example; the following script might be used to redirect external clients to a secure Web server for internal documents: </para><screen><![CDATA[$|=1;
while (<>) {
    chomp;
    @X = split;
    $url = $X[1];
    if ($url =~ /^http:\/\/internal\.example\.com/) {
        $url =~ s/^http/https/;
        $url =~ s/internal/secure/;
        print $X[0]." 302:$url\n";
    } else {
        print $X[0]." \n";
    }
}]]></screen><para>Redirection can be performed by helpers on the <ulink url="http://www.squid-cache.org/Doc/config/url_rewrite_program#">url_rewrite_program</ulink> interface. Lines performing either redirect or re-write can be produced by the same helpers on a per-request basis. Redirect is preferred since re-writing URLs introduces a large number of problems into the client HTTP experience. </para><para>The input line received from Squid is detailed by the section above. </para><para>Redirectors send a slightly different format of line back to Squid.  </para><para>Result line sent back to Squid: </para><screen><![CDATA[[channel-ID] [result] [kv-pairs] [status:URL]]]></screen><glosslist><glossentry><glossterm>channel-ID</glossterm><glossdef><itemizedlist><listitem override="none"><para>When a concurrency <emphasis role="strong">channel-ID</emphasis> is received it must be sent back to Squid unchanged as the first entry on the line. </para></listitem></itemizedlist></glossdef></glossentry><glossentry><glossterm>result</glossterm><glossdef><itemizedlist><listitem override="none"><para>One of the result codes: </para><informaltable><tgroup cols="2"><colspec colname="col_0"/><colspec colname="col_1"/><tbody><row rowsep="1"><entry colsep="1" rowsep="1"><para> OK </para></entry><entry colsep="1" rowsep="1"><para> Success. A new URL is presented. </para></entry></row><row rowsep="1"><entry colsep="1" rowsep="1"><para> ERR </para></entry><entry colsep="1" rowsep="1"><para> Success. No action for this URL. </para></entry></row><row rowsep="1"><entry colsep="1" rowsep="1"><para> BH </para></entry><entry colsep="1" rowsep="1"><para> Failure. The helper encountered a problem. </para></entry></row></tbody></tgroup></informaltable></listitem><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> the result field is only accepted by <ulink url="https://wiki.squid-cache.org/Features/Redirectors/Squid-3.4#">Squid-3.4</ulink> and newer. </para></listitem></itemizedlist></glossdef></glossentry><glossentry><glossterm>kv-pair</glossterm><glossdef><itemizedlist><listitem override="none"><para>One or more key=value pairs. The key names reserved on this interface for HTTP redirection: </para><informaltable><tgroup cols="2"><colspec colname="col_0"/><colspec colname="col_1"/><tbody><row rowsep="1"><entry colsep="1" rowsep="1"><para> clt_conn_tag=... </para></entry><entry colsep="1" rowsep="1"><para> Tag the client TCP connection (<ulink url="https://wiki.squid-cache.org/Features/Redirectors/Squid-3.5#">Squid-3.5</ulink>) </para></entry></row><row rowsep="1"><entry colsep="1" rowsep="1"><para> message=... </para></entry><entry colsep="1" rowsep="1"><para> reserved </para></entry></row><row rowsep="1"><entry colsep="1" rowsep="1"><para> status=... </para></entry><entry colsep="1" rowsep="1"><para> HTTP status code to use on the redirect. Must be one of: 301, 302, 303, 307, 308 </para></entry></row><row rowsep="1"><entry colsep="1" rowsep="1"><para> tag=... </para></entry><entry colsep="1" rowsep="1"><para> reserved </para></entry></row><row rowsep="1"><entry colsep="1" rowsep="1"><para> ttl=... </para></entry><entry colsep="1" rowsep="1"><para> reserved </para></entry></row><row rowsep="1"><entry colsep="1" rowsep="1"><para> url=... </para></entry><entry colsep="1" rowsep="1"><para> redirect the client to given URL </para></entry></row><row rowsep="1"><entry colsep="1" rowsep="1"><para> *_=... </para></entry><entry colsep="1" rowsep="1"><para> Key names ending in (_) are reserved for local administrators use. </para></entry></row></tbody></tgroup></informaltable></listitem><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> the kv-pair field is only accepted by <ulink url="https://wiki.squid-cache.org/Features/Redirectors/Squid-3.4#">Squid-3.4</ulink> and newer. </para></listitem><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> the kv-pair returned by this helper can be logged by the <emphasis role="strong">%note</emphasis> <ulink url="http://www.squid-cache.org/Doc/config/logformat#">logformat</ulink> code. </para></listitem></itemizedlist></glossdef></glossentry><glossentry><glossterm>status</glossterm><glossdef><itemizedlist><listitem override="none"><para>The HTTP 301, 302 or 307 status code. Please see section 10.3 of RFC <ulink url="https://tools.ietf.org/rfc/rfc2616#">2616</ulink> for an explanation of the HTTP redirect codes and which request methods they may be sent on. </para></listitem></itemizedlist></glossdef></glossentry><glossentry><glossterm>URL</glossterm><glossdef><itemizedlist><listitem override="none"><para>The URL to be used instead of the one sent by the client. This must be an absolute URL. ie starting with <ulink url="http://"/> or <ulink url="ftp://"/> etc. </para></listitem></itemizedlist></glossdef><glossdef><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> If no action is required leave status:URL area blank. </para></glossdef><glossdef><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> The <emphasis role="strong">status</emphasis> and <emphasis role="strong">URL</emphasis> are separated by a colon (<emphasis role="strong">:</emphasis>) as shown above instead of whitespace. </para></glossdef></glossentry></glosslist></section><section><title>Using a re-writer to mangle the URL as it passes</title><para>Normally, the <emphasis>redirector</emphasis> feature is used to inform the client of alternate URLs. However, in some situations, it may be required to rewrite requested URLs. Squid then transparently requesting the new URL from the web server. This can cause many problems at both the client and server ends so should be avoided in favor of true redirection whenever possible. </para><para>A simple very fast rewriter called  <ulink url="http://squirm.foote.com.au/">SQUIRM</ulink> is a good place to start, it uses the regex lib to allow pattern matching. </para><para>An even faster and slightly more featured rewriter based on SQUIRM is <ulink url="http://ivs.cs.uni-magdeburg.de/~elkner/webtools/jesred/">jesred</ulink>. </para><para>The following Perl script may also be used as a template for writing your own URL re-writer: </para><screen><![CDATA[$|=1;
while (<>) {
    chomp;
    @X = split;
    $url = $X[1];
    if ($url =~ /^http:\/\/internal\.example\.com/) {
        print $X[0]." http://www.example.com/\n";
    } else {
        print $X[0]." \n";
    }
}]]></screen><para>URL re-writing can be performed by helpers on the <ulink url="http://www.squid-cache.org/Doc/config/url_rewrite_program#">url_rewrite_program</ulink>, <ulink url="http://www.squid-cache.org/Doc/config/storeurl_rewrite_program#">storeurl_rewrite_program</ulink> and <ulink url="http://www.squid-cache.org/Doc/config/location_rewrite_program#">location_rewrite_program</ulink> interfaces. </para><para>WARNING: when used on the url_rewrite_program interface re-writing URLs introduces a large number of problems into the client HTTP experience. Some of these problems can be mitigated with a paired helper running on the <ulink url="http://www.squid-cache.org/Doc/config/location_rewrite_program#">location_rewrite_program</ulink> interface de-mangling the server redirection URLs. </para><para>Result line sent back to Squid: </para><screen><![CDATA[[channel-ID] [result] [kv-pair] [URL]]]></screen><glosslist><glossentry><glossterm>channel-ID</glossterm><glossdef><itemizedlist><listitem override="none"><para>When a concurrency <emphasis role="strong">channel-ID</emphasis> is received it must be sent back to Squid unchanged as the first entry on the line. </para></listitem></itemizedlist></glossdef></glossentry><glossentry><glossterm>result</glossterm><glossdef><itemizedlist><listitem override="none"><para>One of the result codes: </para><informaltable><tgroup cols="2"><colspec colname="col_0"/><colspec colname="col_1"/><tbody><row rowsep="1"><entry colsep="1" rowsep="1"><para> OK </para></entry><entry colsep="1" rowsep="1"><para> Success. A new URL is presented </para></entry></row><row rowsep="1"><entry colsep="1" rowsep="1"><para> ERR </para></entry><entry colsep="1" rowsep="1"><para> Success. No change for this URL. </para></entry></row><row rowsep="1"><entry colsep="1" rowsep="1"><para> BH </para></entry><entry colsep="1" rowsep="1"><para> Failure. The helper encountered a problem. </para></entry></row></tbody></tgroup></informaltable></listitem><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> the result field is only accepted by <ulink url="https://wiki.squid-cache.org/Features/Redirectors/Squid-3.4#">Squid-3.4</ulink> and newer. </para></listitem></itemizedlist></glossdef></glossentry><glossentry><glossterm>kv-pair</glossterm><glossdef><itemizedlist><listitem override="none"><para>One or more key=value pairs. The key names reserved on this interface for URL re-writing: </para><informaltable><tgroup cols="2"><colspec colname="col_0"/><colspec colname="col_1"/><tbody><row rowsep="1"><entry colsep="1" rowsep="1"><para> clt_conn_tag=... </para></entry><entry colsep="1" rowsep="1"><para> Tag the client TCP connection (<ulink url="https://wiki.squid-cache.org/Features/Redirectors/Squid-3.5#">Squid-3.5</ulink>) </para></entry></row><row rowsep="1"><entry colsep="1" rowsep="1"><para> message=... </para></entry><entry colsep="1" rowsep="1"><para> reserved </para></entry></row><row rowsep="1"><entry colsep="1" rowsep="1"><para> rewrite-url=... </para></entry><entry colsep="1" rowsep="1"><para> re-write the transaction to the given URL. </para></entry></row><row rowsep="1"><entry colsep="1" rowsep="1"><para> tag=... </para></entry><entry colsep="1" rowsep="1"><para> reserved </para></entry></row><row rowsep="1"><entry colsep="1" rowsep="1"><para> ttl=... </para></entry><entry colsep="1" rowsep="1"><para> reserved </para></entry></row><row rowsep="1"><entry colsep="1" rowsep="1"><para> *_=... </para></entry><entry colsep="1" rowsep="1"><para> Key names ending in (_) are reserved for local administrators use. </para></entry></row></tbody></tgroup></informaltable></listitem><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> the kv-pair field is only accepted by <ulink url="https://wiki.squid-cache.org/Features/Redirectors/Squid-3.4#">Squid-3.4</ulink> and newer. </para></listitem><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> the kv-pair returned by this helper can be logged by the <emphasis role="strong">%note</emphasis> <ulink url="http://www.squid-cache.org/Doc/config/logformat#">logformat</ulink> code. </para></listitem></itemizedlist></glossdef></glossentry></glosslist><glosslist><glossentry><glossterm>URL</glossterm><glossdef><itemizedlist><listitem override="none"><para>The URL to be used instead of the one sent by the client. If no action is required leave the URL field blank. The URL sent must be an absolute URL. ie starting with <ulink url="http://"/> or <ulink url="ftp://"/> etc. </para></listitem></itemizedlist></glossdef></glossentry></glosslist></section></section><section><title>Redirections by origin servers</title><para>Problem: </para><itemizedlist><listitem override="none"><para>You are using a re-writer to mangle the URL seen by the internal web service. These are not to be shown publicly. But the web server keeps redirecting clients to these internal URLs anyway. </para></listitem></itemizedlist><para>The usual URL re-writer interface only acts on <emphasis>client requests</emphasis>. If you wish to modify server-generated redirections (the HTTP <emphasis>Location</emphasis> header) you have to use a <ulink url="http://www.squid-cache.org/Doc/config/location_rewrite#">location_rewrite</ulink> helper. </para><para>The server doing this is very likely also to be using these private URLs in things like cookies or embeded page content. There is nothing Squid can do about those. And worse they may not be reported by your visitors in any way indicating it is the re-writer. A browser-specific <emphasis role="strong">my login won't work</emphasis> is just one popular example of the cookie side-effect. </para><section><title>Can I use something other than perl?</title><para>Almost any external script can be used to perform a redirect. See <ulink url="https://wiki.squid-cache.org/Features/Redirectors/ConfigExamples/PhpRedirectors#">ConfigExamples/PhpRedirectors</ulink> for hints on writing complex redirectors using PHP. </para></section></section><section><title>Troubleshooting</title><section><title>FATAL: All redirectors have exited!</title><para>A redirector process must exit (stop running) only when its <emphasis>stdin</emphasis> is closed.  If you see the &quot;All redirectors have exited&quot; message, it probably means your redirector program has a bug.  Maybe it runs out of memory or has memory access errors.  You may want to test your redirector program outside of squid with a big input list, taken from your <emphasis>access.log</emphasis> perhaps. Also, check for coredump files from the redirector program (see <ulink url="https://wiki.squid-cache.org/Features/Redirectors/SquidFaq/TroubleShooting#">SquidFaq/TroubleShooting</ulink> to define where). </para></section><section><title>unexpected reply on channel ...</title><para>Your Squid is configured to use concurrency but the helper is either no supporting it or sending back broken replies. </para><para>If the channel mentioned contains <emphasis role="strong">-1</emphasis> the helper does not support concurrency. </para><para>If the channel mentioned is from a redirector and has a large number ending in 301, 302 etc. The helper does not support concurrency. </para><para>NP: URL re-writers that do not support concurrency simply fail to do any re-writing. </para><para>SOLUTION: Configure concurrency to <emphasis role="strong">1</emphasis> for that helper. </para></section><section><title>Redirector interface is broken re IDENT values</title><para><emphasis>I added a redirector consisting of</emphasis> </para><screen><![CDATA[/usr/bin/tee /tmp/squid.log]]></screen><para><emphasis>and many of the redirector requests don't have a username in the ident field.</emphasis> </para><para>Squid does not delay a request to wait for an ident lookup, unless you use the ident ACLs.  Thus, it is very likely that the ident was not available at the time of calling the redirector, but became available by the time the request is complete and logged to access.log. </para><para>If you want to pause requests until ident lookup is completed, try something like this: </para><screen><![CDATA[acl foo ident REQUIRED
http_access allow foo]]></screen><!--rule (<hr>) is not applicable to DocBook--></section></section></section></article>