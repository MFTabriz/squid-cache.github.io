<?xml version="1.0" encoding="utf-8"?><!DOCTYPE article  PUBLIC '-//OASIS//DTD DocBook XML V4.4//EN'  'http://www.docbook.org/xml/4.4/docbookx.dtd'><article><articleinfo><title>MultipleInstances</title><revhistory><revision><revnumber>12</revnumber><date>2017-12-04 20:04:44</date><authorinitials>AlexRousskov</authorinitials><revremark>Added a warning to a semi-outdated Tips section.</revremark></revision><revision><revnumber>11</revnumber><date>2015-10-31 04:32:44</date><authorinitials>AmosJeffries</authorinitials></revision><revision><revnumber>10</revnumber><date>2015-10-31 04:24:34</date><authorinitials>AmosJeffries</authorinitials><revremark>update config info for squid-4 changes</revremark></revision><revision><revnumber>9</revnumber><date>2014-05-03 16:05:15</date><authorinitials>AmosJeffries</authorinitials></revision><revision><revnumber>8</revnumber><date>2014-05-03 16:04:46</date><authorinitials>AmosJeffries</authorinitials><revremark>update with details of named services</revremark></revision><revision><revnumber>7</revnumber><date>2011-03-20 23:26:03</date><authorinitials>AmosJeffries</authorinitials><revremark>references SMP support in 3.2</revremark></revision><revision><revnumber>6</revnumber><date>2010-05-28 05:50:09</date><authorinitials>AmosJeffries</authorinitials><revremark>wiki-link the config options referenced here</revremark></revision><revision><revnumber>5</revnumber><date>2010-05-28 05:46:06</date><authorinitials>AmosJeffries</authorinitials><revremark>how to balance multiple listeners behind a single inbound port with iptables.</revremark></revision><revision><revnumber>4</revnumber><date>2009-02-13 03:11:53</date><authorinitials>AmosJeffries</authorinitials><revremark>add include directive.  cache_acess_log is changed.</revremark></revision><revision><revnumber>3</revnumber><date>2008-05-18 19:38:56</date><authorinitials>localhost</authorinitials><revremark>converted to 1.6 markup</revremark></revision><revision><revnumber>2</revnumber><date>2005-07-01 12:38:45</date><authorinitials>kinkie</authorinitials><revremark>added samples, unique_hostname</revremark></revision><revision><revnumber>1</revnumber><date>2005-07-01 10:53:42</date><authorinitials>kinkie</authorinitials><revremark>First Draft</revremark></revision></revhistory></articleinfo><section><title>Running multiple instances of Squid on a system</title><para>Running multiple instances of Squid on a system is not hard, but it requires the administrator to make sure they don't stomp on each other's feet, and know how to recognize each other to avoid forwarding loops (or misdetected forwarding loops). </para><section><title>SMP enabled Squid</title><para><inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/alert.png" width="15"/></imageobject><textobject><phrase>/!\</phrase></textobject></inlinemediaobject> <ulink url="https://wiki.squid-cache.org/MultipleInstances/Squid-3.2#">Squid-3.2</ulink> to <ulink url="https://wiki.squid-cache.org/MultipleInstances/Squid-3.4#">Squid-3.4</ulink> contain <ulink url="https://wiki.squid-cache.org/MultipleInstances/Features/SmpScale#">SMP scaling support</ulink> implemented in such a way that only one squid instance could be run on a single machine when SMP was enabled. Multiple instances can <emphasis role="strong">only</emphasis> be run without SMP support. </para><para><ulink url="https://wiki.squid-cache.org/MultipleInstances/Squid-3.5#">Squid-3.5</ulink> provides the <emphasis role="strong">-n</emphasis> command line option to configure a unique service name for each Squid instance started. Each set of SMP-aware processes will interact only with other processes using the same service name. A service name is always present, the default service name is <emphasis>squid</emphasis> is used when the <emphasis role="strong">-n</emphasis> option is absent from the command line. </para><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> A service name may only contain ASCI alphanumeric values (a-z, A-Z, 0-9). </para></listitem></itemizedlist><para>When using a non-default service name to run squid all other command line options require use of the <emphasis role="strong">-n</emphasis> service name to target the service being controlled. This includes the <emphasis role="strong">-z</emphasis> option as some cache types require SMP-aware processing. </para><para>The configuration directives outlined below still require unique values to be configured even when service name is being used. </para><para>The macro <emphasis role="strong">${service_name}</emphasis> is added to squid.conf processing. It expands to the service name of the process parsing the config file. </para></section><section><title>Relevant squid.conf directives</title><itemizedlist><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/visible_hostname#">visible_hostname</ulink> </para><itemizedlist><listitem override="none"><para>you may want to keep this unique for troubleshooting purposes. </para></listitem></itemizedlist></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/unique_hostname#">unique_hostname</ulink> </para><itemizedlist><listitem override="none"><para>if you don't change the <ulink url="http://www.squid-cache.org/Doc/config/visible_hostname#">visible_hostname</ulink> and want your caches to cooperate, at least change this setting to properly detect forwarding loops </para></listitem></itemizedlist></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/http_port#">http_port</ulink> </para><itemizedlist><listitem override="none"><para>either the various squids run on different ports, or on different IP addresses. In the latter case the syntax to be used is <code>192.0.2.1:3128</code> and <code>192.0.2.2:3128</code>. A domain name can be used instead of IP address, but take care that the domain(s) used by each instance resolve to different IPs. </para></listitem></itemizedlist></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/icp_port#">icp_port</ulink>, <ulink url="http://www.squid-cache.org/Doc/config/snmp_port#">snmp_port</ulink> </para><itemizedlist><listitem override="none"><para>same as with http_port. If you do not need ICP and SNMP, remove from the config file. </para></listitem></itemizedlist></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/access_log#">access_log</ulink>, <ulink url="http://www.squid-cache.org/Doc/config/cache_log#">cache_log</ulink> </para><itemizedlist><listitem override="none"><para>you want to have different logfiles for you different squid instances. Squid <emphasis role="strong">might</emphasis> even work when all log to the same files, but the result would probably be a garbled mess. </para></listitem></itemizedlist></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/pid_filename#">pid_filename</ulink> </para><itemizedlist><listitem override="none"><para>this file <emphasis role="strong">must</emphasis> be different for each instance. It is used by squid to detect a running instance and to send various internal messages (i.e. <code>squid -k reconfigure</code>). </para><itemizedlist><listitem override="none"><para><ulink url="https://wiki.squid-cache.org/MultipleInstances/Squid-4#">Squid-4</ulink> and later the default uses <emphasis role="strong">${service_name}</emphasis> making it no longer necessary to configure. </para></listitem><listitem override="none"><para><ulink url="https://wiki.squid-cache.org/MultipleInstances/Squid-3.5#">Squid-3.5</ulink> and older must explicitly set this option to a unique file per instance. </para></listitem></itemizedlist></listitem></itemizedlist></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/cache_dir#">cache_dir</ulink> </para><itemizedlist><listitem override="none"><para>make sure that no overlapping directories exist. Squids do not coordinate when accessing them, and shuffling stuff around each others' playground is a <emphasis role="strong">bad thing <superscript>TM</superscript></emphasis> </para></listitem></itemizedlist></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/include#">include</ulink> </para><itemizedlist><listitem override="none"><para>to reduce duplication mistakes break shared pieces of config (ACL definitions etc) out into separate files which <ulink url="http://www.squid-cache.org/Doc/config/include#">include</ulink> pulls into each of the multiple squid.conf at the right places. </para></listitem></itemizedlist></listitem></itemizedlist></section><section><title>Tips</title><para><inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/alert.png" width="15"/></imageobject><textobject><phrase>/!\</phrase></textobject></inlinemediaobject> This section does not apply to SMP Squids. </para><para>The easiest way I found to manage multiple squids running on one single box was to: </para><itemizedlist><listitem><para>create a configuration file per instance  </para></listitem><listitem><para>write a small shell script (named <code>squid-</code><emphasis>something</emphasis>) per instance, containing: </para></listitem></itemizedlist><screen><![CDATA[exec /usr/local/sbin/squid -f /usr/local/etc/squid-something.conf $@]]></screen><para>(of course, relevant path changes may have to be applied). </para><para>And then just run them as you would with a single-install squid setup. </para></section><section><title>Load Balancing behind a single port with iptables</title><para><emphasis>by Felipe Damasio, Eric Dumazet, Jan Engelhardt</emphasis> </para><para>The theory of operation is: It puts the new HTTP connection on the extrachain chain. There, it marks each connection with a sequential number. This marking is latter checked by the PREROUTING chain and forwards it a squid port depending on the mark. </para><para>So, the first connection will be sent to port 3127, the second to 3128, the third to 3129, and the fourth back to 3127 (cycling through the ports on an even distribution). </para><para>The full thread on netfilter-devel where this was developed is here: <ulink url="http://marc.info/?l=netfilter-devel&amp;m=127483388828088&amp;w=2"/> </para><para>(watch the wrap, iptables rules are single lines) </para><screen><![CDATA[N=3
first_squid_port=3127
]]><![CDATA[
iptables -t mangle -F
iptables -t mangle -X
iptables -t mangle -N DIVERT
iptables -t mangle -A DIVERT -j MARK --set-mark 1
iptables -t mangle -A DIVERT -j ACCEPT
iptables -t mangle -A PREROUTING -p tcp -m socket -j DIVERT
]]><![CDATA[
iptables -t mangle -N extrachain
iptables -t mangle -A PREROUTING -p tcp --dport 80 -m conntrack --ctstate NEW -j extrachain
]]><![CDATA[
for i in `seq 0 $((N-1))`; do
  iptables -t mangle -A extrachain -m statistic --mode nth --every $N --packet $i -j CONNMARK --set-mark $i
done
]]><![CDATA[
for i in `seq 0 $((N-1))`; do
  iptables -t mangle  -A PREROUTING -i eth0 -p tcp --dport 80 -m connmark --mark $i -j TPROXY --tproxy-mark 0x1/0x1  --on-port $((i+first_squid_port))
done]]></screen></section></section></article>