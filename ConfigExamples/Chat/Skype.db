<?xml version="1.0" encoding="utf-8"?><!DOCTYPE article  PUBLIC '-//OASIS//DTD DocBook XML V4.4//EN'  'http://www.docbook.org/xml/4.4/docbookx.dtd'><article><articleinfo><title>ConfigExamples/Chat/Skype</title><revhistory><revision><revnumber>14</revnumber><date>2021-07-03 09:50:12</date><authorinitials>FrancescoChemolli</authorinitials></revision><revision><revnumber>13</revnumber><date>2017-12-16 08:20:51</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>12</revnumber><date>2017-03-06 20:55:34</date><authorinitials>Eliezer Croitoru</authorinitials></revision><revision><revnumber>11</revnumber><date>2015-12-06 23:19:52</date><authorinitials>AmosJeffries</authorinitials></revision><revision><revnumber>10</revnumber><date>2015-12-06 23:19:24</date><authorinitials>AmosJeffries</authorinitials><revremark>hex should be the range not just a and f, and IPv4-mapped address is possible</revremark></revision><revision><revnumber>9</revnumber><date>2012-03-15 13:09:37</date><authorinitials>AmosJeffries</authorinitials><revremark>agent pattern fix</revremark></revision><revision><revnumber>8</revnumber><date>2010-08-14 05:49:14</date><authorinitials>AmosJeffries</authorinitials><revremark>typo.</revremark></revision><revision><revnumber>7</revnumber><date>2010-08-11 00:04:19</date><authorinitials>AmosJeffries</authorinitials><revremark>use dstdom_regex instead of url_regex</revremark></revision><revision><revnumber>6</revnumber><date>2010-06-23 00:18:49</date><authorinitials>AmosJeffries</authorinitials><revremark>how to catch skype 4.x which dont have a UA.</revremark></revision><revision><revnumber>5</revnumber><date>2010-01-16 01:18:44</date><authorinitials>AmosJeffries</authorinitials><revremark>typo</revremark></revision><revision><revnumber>4</revnumber><date>2009-08-25 00:30:34</date><authorinitials>AmosJeffries</authorinitials><revremark>get the title right :)</revremark></revision><revision><revnumber>3</revnumber><date>2009-08-25 00:23:21</date><authorinitials>AmosJeffries</authorinitials><revremark>Add almost-inversion for permitting Skype through.</revremark></revision><revision><revnumber>2</revnumber><date>2009-08-25 00:14:50</date><authorinitials>AmosJeffries</authorinitials><revremark>skype can do IPv6 too...</revremark></revision><revision><revnumber>1</revnumber><date>2008-10-04 02:18:01</date><authorinitials>AmosJeffries</authorinitials><revremark>import from knowledge base general article.</revremark></revision></revhistory></articleinfo><section><title>Important update (06/03/2017)</title><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/alert.png" width="15"/></imageobject><textobject><phrase>/!\</phrase></textobject></inlinemediaobject> Important update (06/03/2017) to prevent this article misleading you to the assumption that you indded got to the right place. </para></listitem></itemizedlist><para>Notice that the methods that are mentioned in the next article are not up-to-date(06/03/2017) and are expected to work only for specific setups. Setups which uses ssl-bump needs a much more complicated concept then the mentioned in the article to make it so skype clients will be able to run smooth with squid in the picture. Else then that skype in many cases will require direct access to the Internet and will not work in a very restricted networks with allow access only using a proxy. I belive that NTOP have some more details on how to somehow make skype work or be blocked in some cases. I recommend peeking at theri at: <ulink url="https://github.com/ntop/nDPI/search?utf8=âœ“&amp;q=skype"/> </para></section><section><title>Skype Access Controls</title><para><emphasis role="strong">Warning</emphasis>: Any example presented here is provided &quot;as-is&quot; with no support or guarantee of suitability. If you have any further questions about these examples please email the squid-users mailing list. </para><section><title>Squid Configuration File</title><para>Configuration file to include. </para><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/alert.png" width="15"/></imageobject><textobject><phrase>/!\</phrase></textobject></inlinemediaobject> Since FTP uses numeric IPs the Skype ACL must be exact including the port. </para></listitem></itemizedlist><section><title>Blocking</title><screen><![CDATA[# Skype
]]><![CDATA[
acl numeric_IPs dstdom_regex ^(([0-9]+\.[0-9]+\.[0-9]+\.[0-9]+)|(\[([0-9a-f]+)?:([0-9a-f:]+)?:([0-9a-f]+|0-9\.]+)?\])):443
acl Skype_UA browser ^skype
]]><![CDATA[
http_access deny numeric_IPS
http_access deny Skype_UA]]></screen><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/alert.png" width="15"/></imageobject><textobject><phrase>/!\</phrase></textobject></inlinemediaobject> Recent releases of Skype have been evading the above restriction by not sending their User-Agent headers and using domain names. The following can be used to catch those installs, but be aware it will likely also catch other agents. </para></listitem></itemizedlist><screen><![CDATA[acl validUserAgent browser \S+
http_access deny !validUserAgent]]></screen></section><section><title>Permitting</title><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/alert.png" width="15"/></imageobject><textobject><phrase>/!\</phrase></textobject></inlinemediaobject> This needs to be done before any restrictive CONNECT http_access controls. </para></listitem></itemizedlist><screen><![CDATA[acl numeric_IPs dstdom_regex ^(([0-9]+\.[0-9]+\.[0-9]+\.[0-9]+)|(\[([0-9a-f]+)?:([0-9a-f:]+)?:([0-9a-f]+|0-9\.]+)?\])):443
acl Skype_UA browser ^skype
]]><![CDATA[
http_access allow CONNECT localnet numeric_IPS Skype_UA]]></screen><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> Note that Skype prefers the <emphasis role="strong">port 443</emphasis> which is by default enabled in Squid anyway so this configuration is only needed when you block HTTPS access through the proxy. </para></listitem></itemizedlist><para>If you limit HTTPS access to known sites only, then permitting Skype will break that policy. </para></section><section><title>Metro Skype WIndows 10</title><para><inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/alert.png" width="15"/></imageobject><textobject><phrase>/!\</phrase></textobject></inlinemediaobject> This is required to Skype work if Squid SSL-Bump aware. </para><para>Add this domains to splice ACL then reconfigure Squid: </para><screen><![CDATA[## Trusted SKYPE addresses
# api.aps|skypegraph|edge Metro Skype requires
(a\.config|pipe|api\.aps|skypegraph|edge)\.skype\.com
# Metro Skype requires
ocsp\.omniroot\.com
trouter\.io
msedge\.net
]]><![CDATA[
# messenger.live.com requires for Metro Skype
mobile\.pipe\.aria\.microsoft\.com
messenger\.live\.com]]></screen><para>squid.conf part should looks like this: </para><screen><![CDATA[acl NoSSLIntercept ssl::server_name_regex "/usr/local/squid/etc/acl.url.nobump"
ssl_bump splice NoSSLIntercept]]></screen><!--rule (<hr>) is not applicable to DocBook--><para> <ulink url="https://wiki.squid-cache.org/ConfigExamples/Chat/Skype/CategoryConfigExample#">CategoryConfigExample</ulink> </para></section></section></section></article>