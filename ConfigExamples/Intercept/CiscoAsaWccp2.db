<?xml version="1.0" encoding="utf-8"?><!DOCTYPE article  PUBLIC '-//OASIS//DTD DocBook XML V4.4//EN'  'http://www.docbook.org/xml/4.4/docbookx.dtd'><article><articleinfo><title>ConfigExamples/Intercept/CiscoAsaWccp2</title><revhistory><revision><revnumber>14</revnumber><date>2010-09-08 00:20:27</date><authorinitials>AmosJeffries</authorinitials><revremark>more polish</revremark></revision><revision><revnumber>13</revnumber><date>2010-09-08 00:16:25</date><authorinitials>AmosJeffries</authorinitials><revremark>polish: move it to the bottom after the csco details.</revremark></revision><revision><revnumber>12</revnumber><date>2010-09-08 00:13:09</date><authorinitials>AmosJeffries</authorinitials><revremark>pull in the squid details from WCCP2 feature page.</revremark></revision><revision><revnumber>11</revnumber><date>2010-08-27 18:15:07</date><authorinitials>Henrik Nordstr√∂m</authorinitials></revision><revision><revnumber>10</revnumber><date>2009-11-24 21:40:24</date><authorinitials>eu.squid-cache.org</authorinitials></revision><revision><revnumber>9</revnumber><date>2009-10-26 23:13:07</date><authorinitials>AmosJeffries</authorinitials><revremark>add explanations for config lines</revremark></revision><revision><revnumber>8</revnumber><date>2009-10-26 22:56:54</date><authorinitials>AmosJeffries</authorinitials><revremark>correct wrapping on config. thanks to Ross Kovelman</revremark></revision><revision><revnumber>7</revnumber><date>2009-10-19 23:20:10</date><authorinitials>AmosJeffries</authorinitials><revremark>typo in meta tag</revremark></revision><revision><revnumber>6</revnumber><date>2009-10-19 23:13:40</date><authorinitials>AmosJeffries</authorinitials><revremark>add section for troubleshooting. empty so far</revremark></revision><revision><revnumber>5</revnumber><date>2009-10-19 22:47:37</date><authorinitials>AmosJeffries</authorinitials><revremark>meta tags for feature page include</revremark></revision><revision><revnumber>4</revnumber><date>2009-06-18 13:04:17</date><authorinitials>port-87-234-42-202.static.qsc.de</authorinitials></revision><revision><revnumber>3</revnumber><date>2009-06-18 13:03:37</date><authorinitials>port-87-234-42-202.static.qsc.de</authorinitials></revision><revision><revnumber>2</revnumber><date>2009-06-18 13:02:51</date><authorinitials>port-87-234-42-202.static.qsc.de</authorinitials></revision><revision><revnumber>1</revnumber><date>2009-06-18 12:59:58</date><authorinitials>port-87-234-42-202.static.qsc.de</authorinitials></revision></revhistory></articleinfo><section><title>Cisco ASA and Squid with WCCP2</title><para><emphasis role="strong">Warning</emphasis>: Any example presented here is provided &quot;as-is&quot; with no support or guarantee of suitability. If you have any further questions about these examples please email the squid-users mailing list. </para><section><title>Very important passage from the Cisco-Manual</title><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-error.png" width="16"/></imageobject><textobject><phrase>{X}</phrase></textobject></inlinemediaobject> &quot;The only topology that the security appliance supports is when client and cache engine are behind the same interface of the security appliance and the cache engine can directly  communicate with the client without going through the security appliance.&quot; </para></listitem></itemizedlist></section><section><title>Cisco ASA</title><para>Bypass the Squid box from re-capture </para><screen><![CDATA[ access-list wccp_redirect extended deny ip host $SQUID-IP any]]></screen><para>Note: This shouldn't be required, because the asa would build this rule itself, when adding the squid box. </para><para>... while capturing the local /24 network defined by &quot;workstations&quot;. </para><screen><![CDATA[ access-list wccp_redirect extended permit tcp workstations 255.255.255.0 any eq www]]></screen><para>Intercept everything not prevented by the bypass list: </para><screen><![CDATA[ wccp web-cache redirect-list wccp_redirect password foo
]]><![CDATA[
 wccp interface internal web-cache redirect in]]></screen><para>p.s.: you should deny other forwardings with iptables </para><section><title>Squid configuration for WCCP version 2</title><para>All the squid.conf options beginning with wccp2_* apply to <emphasis role="strong">WCCPv2 only</emphasis> </para><itemizedlist><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/wccp2_router#">wccp2_router</ulink> </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/wccp2_address#">wccp2_address</ulink> </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/wccp2_forwarding_method#">wccp2_forwarding_method</ulink> </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/wccp2_return_method#">wccp2_return_method</ulink> </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/wccp2_assignment_method#">wccp2_assignment_method</ulink> </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/wccp2_service#">wccp2_service</ulink> </para></listitem></itemizedlist><section><title>Squid configuration</title><itemizedlist><listitem override="none"><para><emphasis role="strong">$IP-OF-ROUTER</emphasis> is used below to represent the IP address of the router sending the WCCP traffic to Squid. </para></listitem></itemizedlist><para><ulink url="https://wiki.squid-cache.org/ConfigExamples/Intercept/CiscoAsaWccp2/Squid-2.6#">Squid-2.6</ulink> to <ulink url="https://wiki.squid-cache.org/ConfigExamples/Intercept/CiscoAsaWccp2/Squid-3.0#">Squid-3.0</ulink> require magic numbers... </para><screen><![CDATA[http_port 3129 transparent
wccp2_router $IP-OF-ROUTER
wccp2_forwarding_method 1
wccp2_return_method 1
wccp2_service standard 0 password=foo]]></screen><itemizedlist><listitem><para><ulink url="https://wiki.squid-cache.org/ConfigExamples/Intercept/CiscoAsaWccp2/Squid-3.1#">Squid-3.1</ulink> and later accept text names for the tunneling methods </para></listitem></itemizedlist><screen><![CDATA[http_port 3129 intercept
wccp2_router $IP-OF-ROUTER
wccp2_forwarding_method gre
wccp2_return_method gre
wccp2_service standard 0 password=foo]]></screen></section><section><title>Squid box OS configuration</title><screen><![CDATA[modprobe ip_gre
ip tunnel add wccp0 mode gre remote $ASA-EXT-IP local $SQUID-IP dev eth0
]]><![CDATA[
ifconfig wccp0 $SQUID-IP netmask 255.255.255.255 up]]></screen><itemizedlist><listitem><para>disable rp_filter, or the packets will be silently discarded </para></listitem></itemizedlist><screen><![CDATA[echo 0 >/proc/sys/net/ipv4/conf/wccp0/rp_filter
echo 0 >/proc/sys/net/ipv4/conf/eth0/rp_filter]]></screen><itemizedlist><listitem><para>enable ip-forwarding and redirect packets to squid </para></listitem></itemizedlist><screen><![CDATA[echo 1 >/proc/sys/net/ipv4/ip_forward
iptables -t nat -A PREROUTING -i wccp0 -p tcp --dport 80 -j REDIRECT --to-port 3129
iptables -t nat -A POSTROUTING -j MASQUERADE]]></screen></section></section></section></section></article>