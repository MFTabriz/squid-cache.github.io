<?xml version="1.0" encoding="utf-8"?><!DOCTYPE article  PUBLIC '-//OASIS//DTD DocBook XML V4.4//EN'  'http://www.docbook.org/xml/4.4/docbookx.dtd'><article><articleinfo><title>ConfigExamples/Intercept/CentOsTproxy4</title><revhistory><revision><revnumber>15</revnumber><date>2009-10-27 21:58:42</date><authorinitials>AmosJeffries</authorinitials><revremark>routing rules omitted. Add them back. Reference the tproxy4 main page</revremark></revision><revision><revnumber>14</revnumber><date>2009-07-07 14:37:25</date><authorinitials>AmosJeffries</authorinitials><revremark>patching not relevant</revremark></revision><revision><revnumber>13</revnumber><date>2009-07-07 14:35:11</date><authorinitials>AmosJeffries</authorinitials><revremark>drop a last mention of patching and correct titles</revremark></revision><revision><revnumber>12</revnumber><date>2009-06-30 17:20:04</date><authorinitials>NicholasRitter</authorinitials></revision><revision><revnumber>11</revnumber><date>2009-06-21 10:10:43</date><authorinitials>AmosJeffries</authorinitials><revremark>... and another typo.</revremark></revision><revision><revnumber>10</revnumber><date>2009-06-21 09:51:32</date><authorinitials>AmosJeffries</authorinitials><revremark>another typo</revremark></revision><revision><revnumber>9</revnumber><date>2009-06-21 09:37:45</date><authorinitials>AmosJeffries</authorinitials><revremark>iptables is out too. one of the rules was a typo that causes bad port destination on tproxy captures. TPROXY==ACCEPT for iptables</revremark></revision><revision><revnumber>8</revnumber><date>2009-02-05 11:24:12</date><authorinitials>AmosJeffries</authorinitials><revremark>bad config detail wrap</revremark></revision><revision><revnumber>7</revnumber><date>2009-02-05 11:20:08</date><authorinitials>AmosJeffries</authorinitials><revremark>sync ports in iptables and squid config info</revremark></revision><revision><revnumber>6</revnumber><date>2009-02-05 07:42:29</date><authorinitials>AmosJeffries</authorinitials><revremark>kernel 2.6.28 and iptable 1.4.3 are confirmed integrated too.</revremark></revision><revision><revnumber>5</revnumber><date>2009-02-05 06:40:07</date><authorinitials>AmosJeffries</authorinitials><revremark>mention 2.6.28</revremark></revision><revision><revnumber>4</revnumber><date>2009-01-26 13:04:21</date><authorinitials>AmosJeffries</authorinitials><revremark>fix wrap error in example.</revremark></revision><revision><revnumber>3</revnumber><date>2009-01-15 06:32:14</date><authorinitials>AmosJeffries</authorinitials><revremark>3.1 is out now.</revremark></revision><revision><revnumber>2</revnumber><date>2008-09-23 11:53:17</date><authorinitials>AmosJeffries</authorinitials><revremark>warning about mixing modes.</revremark></revision><revision><revnumber>1</revnumber><date>2008-08-08 02:47:53</date><authorinitials>AmosJeffries</authorinitials><revremark>Draft #1</revremark></revision></revhistory></articleinfo><section><title>TPROXY v4 with CentOS 5.3</title><para>by <emphasis>Nicholas Ritter</emphasis> </para><para><emphasis role="strong">Warning</emphasis>: Any example presented here is provided &quot;as-is&quot; with no support or guarantee of suitability. If you have any further questions about these examples please email the squid-users mailing list. </para><section><title>Outline</title><para>Listed below are the beginnings of steps I have. They are not complete, I left out some steps which I will add and repost. Please let me know if you have questions/troubles with the steps. I have not fully checked the steps for clarity and accuracy...but I eventually will. </para><para>These steps are for setting <ulink url="https://wiki.squid-cache.org/ConfigExamples/Intercept/CentOsTproxy4/Squid-3.1#">Squid-3.1</ulink> with <ulink url="https://wiki.squid-cache.org/ConfigExamples/Intercept/CentOsTproxy4/Features/Tproxy4#">TPROXYv4</ulink>, IP spoofing and Cisco WCCP. This is not a bridging setup. It is also important to note that these steps are specific to the x86_64 version of CentOS 5.3, although very minor changes would make this solution work on any version of CentOS 5 (I try to make notes where there are differences.) </para></section><section><title>Steps</title><section><title>Preparation</title><orderedlist numeration="arabic"><listitem><para>Install CentOS 5.3 </para><orderedlist numeration="loweralpha"><listitem><para>be sure <emphasis role="strong">NOT</emphasis> to install squid via the OS installer b. install the development libraries and tools, as well as the legacy software development </para></listitem></orderedlist></listitem><listitem><para>Once the install completes and you have booted into the OS, run: <emphasis role="strong">yum update</emphasis> (and apply all updates.) </para></listitem><listitem><para>Once the yum command completes, <emphasis role="strong">reboot</emphasis> </para></listitem><listitem><para>Download iptables-1.4.3.2 from netfilter.org. </para></listitem><listitem><para>Download kernel 2.6.30 from kernel.org. </para></listitem><listitem><para>Download (squid 3.1.0.8 or higher) <ulink url="http://www.squid-cache.org/Versions/v3/3.1/">Squid v3.1 source code</ulink> </para></listitem><listitem><para>decompress the kernel source to /usr/src/linux-2.6.30. (I have read all over the place that kernel source should not reside in /usr/src, I use the path here as an example, you can put the source anywhere.) Make a symbolic link to /usr/src/linux when done: </para></listitem></orderedlist><screen><![CDATA[ln -s /usr/src/linux-2.6.25 /usr/src/linux
cd /usr/src/linux]]></screen></section><section><title>Routing Configuration</title><para>As per the <ulink url="https://wiki.squid-cache.org/ConfigExamples/Intercept/CentOsTproxy4/Features/Tproxy4#">TPROXYv4</ulink> regular configuration: </para><screen><![CDATA[ip rule add fwmark 1 lookup 100
]]><![CDATA[
ip route add local 0.0.0.0/0 dev lo table 100]]></screen></section><section><title>Building iptables</title><informaltable><tgroup cols="2"><colspec colname="col_0"/><colspec colname="col_1"/><tbody><row rowsep="1"><entry colsep="1" rowsep="1"><para> <inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> </para></entry><entry colsep="1" rowsep="1"><para> iptables 1.4.3 is now released and has support integrated. <ulink url="http://www.netfilter.org/projects/iptables/index.html"/> </para></entry></row></tbody></tgroup></informaltable><itemizedlist><listitem><para>configure the Makefile for iptables: </para></listitem></itemizedlist><screen><![CDATA[make BINDDIR=/sbin LIBDIR=/lib64 KERNEL_DIR=/usr/src/linux]]></screen><itemizedlist><listitem><para>check that TPROXY was built: </para></listitem></itemizedlist><screen><![CDATA[ls extensions/libxt_TPROXY*]]></screen><itemizedlist><listitem><para>then install: </para></listitem></itemizedlist><screen><![CDATA[make BINDDIR=/sbin LIBDIR=/lib64 KERNEL_DIR=/usr/src/linux install]]></screen><itemizedlist><listitem><para>Next check iptables versioning to make sure it installed properly in the right path: </para><orderedlist numeration="loweralpha"><listitem><para>&quot;iptables -v&quot; should show: b. iptables v1.4.0: no command specified Try `iptables -h' or 'iptables --help' for more information. </para></listitem></orderedlist></listitem></itemizedlist><informaltable><tgroup cols="2"><colspec colname="col_0"/><colspec colname="col_1"/><tbody><row rowsep="1"><entry colsep="1" rowsep="1"><para> <inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> </para></entry><entry colsep="1" rowsep="1"><para> If it doesn't show this, but v1.3.5 instead, then I wrote the step 15 above from memory incorrectly, and the paths need to be adjusted. </para></entry></row></tbody></tgroup></informaltable><itemizedlist><listitem><para>Do a &quot;service iptables status&quot; and see if iptables is running, stopped, or has a  &quot;RH-Firewall-1-INPUT&quot; chain. If it stopped altogether, do a &quot;service iptables start&quot; and make sure that it starts and stays running. </para></listitem><listitem><para>Is the following iptables commands to enable TPROXY functionality in the running iptables instance: </para></listitem></itemizedlist><screen><![CDATA[iptables -t mangle -N DIVERT
iptables -t mangle -A PREROUTING -p tcp -m socket -j DIVERT
]]><![CDATA[
iptables -t mangle -A DIVERT -j MARK --set-mark 1
iptables -t mangle -A DIVERT -j ACCEPT
]]><![CDATA[
iptables -t mangle -A PREROUTING -p tcp --dport 80 -j TPROXY --tproxy-mark 0x1/0x1 --on-port 3129]]></screen><informaltable><tgroup cols="2"><colspec colname="col_0"/><colspec colname="col_1"/><tbody><row rowsep="1"><entry colsep="1" rowsep="1"><para> <inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> <emphasis role="strong">Note:</emphasis> </para></entry><entry colsep="1" rowsep="1"><para> If any of the above commands fails, there is something wrong with iptables update to 1.4.0 and/or tproxy module status in iptables 1.4.0. Keep in mind that the commands are sensitive to case, spacing, and hyphenation. </para></entry></row></tbody></tgroup></informaltable></section><section><title>WCCP Configuration</title><itemizedlist><listitem><para>WCCP related iptables rules need to be created next...this and further steps are only needed if L4 WCCPv2 is used with a router, and not L2 WCCP with a switch. </para></listitem></itemizedlist><screen><![CDATA[iptables -A INPUT -i gre0 -j ACCEPT
]]><![CDATA[
iptables -A INPUT -p gre -j ACCEPT]]></screen><itemizedlist><listitem><para>For the WCCP udp traffic that is not in a gre tunnel: </para></listitem></itemizedlist><screen><![CDATA[iptables -A RH-Firewall-1-INPUT -s 10.48.33.2/32 -p udp -m udp --dport 2048 -j ACCEPT]]></screen><informaltable><tgroup cols="2"><colspec colname="col_0"/><colspec colname="col_1"/><tbody><row rowsep="1"><entry colsep="1" rowsep="1"><para> <inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> <emphasis role="strong">note:</emphasis> </para></entry><entry colsep="1" rowsep="1"><para> When running <emphasis role="strong">iptables</emphasis> commands, you my find that you have no firewall rules at all. In this case you will need to create an input chain to add some of the rules to. I created a chain called <emphasis role="strong">LocalFW</emphasis> instead (see below) and added the final WCCP rule to that chain. The other rules stay as they are. To do this, learn iptables...or something *LIKE* what is listed below: </para></entry></row></tbody></tgroup></informaltable><screen><![CDATA[iptables -t filter -NLocalFW
iptables -A FORWARD -j LocalFW
iptables -A INPUT -j LocalFW
iptables -A LocalFW -i lo -j ACCEPT
iptables -A LocalFW -p icmp -m icmp --icmp-type any -j ACCEPT]]></screen></section><section><title>Building Squid</title><para>After preparing the kernel and iptables as above. </para><itemizedlist><listitem><para>Build <ulink url="http://www.squid-cache.org/Versions/v3/3.1/">Squid 3.1 source</ulink> as noted in the Squid readme and tproxy readme, enabling netfilter with: </para></listitem></itemizedlist><screen><![CDATA[--enable-linux-netfilter]]></screen><informaltable><tgroup cols="2"><colspec colname="col_0"/><colspec colname="col_1"/><tbody><row rowsep="1"><entry colsep="1" rowsep="1"><para> <inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/alert.png" width="15"/></imageobject><textobject><phrase>/!\</phrase></textobject></inlinemediaobject> </para></entry><entry colsep="1" rowsep="1"><para> --enable-linux-tproxy was phased out because tproxy has been more tightly integrated with iptables/netfilter and Squid. </para></entry></row></tbody></tgroup></informaltable><itemizedlist><listitem><para>Configure squid as noted in the squid and tproxy readmes. </para></listitem></itemizedlist><screen><![CDATA[http_port 3129 tproxy]]></screen><informaltable><tgroup cols="2"><colspec colname="col_0"/><colspec colname="col_1"/><tbody><row rowsep="1"><entry colsep="1" rowsep="1"><para> <inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/alert.png" width="15"/></imageobject><textobject><phrase>/!\</phrase></textobject></inlinemediaobject> </para></entry><entry colsep="1" rowsep="1"><para> A special http_port line is recommended since tproxy mode for Squid can interfere with non-tproxy requests on the same port. </para></entry></row></tbody></tgroup></informaltable><!--rule (<hr>) is not applicable to DocBook--><itemizedlist><listitem override="none"><para><ulink url="https://wiki.squid-cache.org/ConfigExamples/Intercept/CentOsTproxy4/CategoryConfigExample#">CategoryConfigExample</ulink> </para></listitem></itemizedlist></section></section></section></article>