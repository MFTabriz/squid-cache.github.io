<?xml version="1.0" encoding="utf-8"?><!DOCTYPE article  PUBLIC '-//OASIS//DTD DocBook XML V4.4//EN'  'http://www.docbook.org/xml/4.4/docbookx.dtd'><article><articleinfo><title>ConfigExamples/Intercept/LinuxLocalhost</title><revhistory><revision><revnumber>1</revnumber><date>2009-04-03 07:15:48</date><authorinitials>AmosJeffries</authorinitials><revremark>import from FAQ page</revremark></revision></revhistory></articleinfo><section><title>Linux traffic Interception with Squid and the Browser on the same box</title><itemizedlist><listitem override="none"><para><emphasis>by Joshua N Pritikin</emphasis> </para></listitem></itemizedlist><para><emphasis role="strong">Warning</emphasis>: Any example presented here is provided &quot;as-is&quot; with no support or guarantee of suitability. If you have any further questions about these examples please email the squid-users mailing list. </para><section><title>Outline</title><para>To Intercept web requests transparently without any kind of client configuration. When web traffic is rgenerated by the machine squid is run on. </para><para><emphasis role="strong">NP:</emphasis> for most non-Windows boxes setting the <emphasis role="strong">http_proxy</emphasis> environment variable (http_proxy=&quot;<ulink url="http://SQUIDIP:3128/"/>&quot;) is a preferred alternative to the below interception. </para><para><emphasis role="strong">NP:</emphasis> other users have reported setting outgoing TOS and filtering on it instead of process gid to also be effective. </para></section><section><title>iptables configuration</title><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/alert.png" width="15"/></imageobject><textobject><phrase>/!\</phrase></textobject></inlinemediaobject> Replace <emphasis role="strong">SQUIDIP</emphasis> with the public IP(s) which squid may use for its listening port and outbound connections. Repeat each iptables line one per squid outbound IP. </para></listitem></itemizedlist><screen><![CDATA[iptables -t nat -F  # clear table
]]><![CDATA[
# normal transparent proxy
iptables -t nat -A PREROUTING -p tcp -i eth0 --dport 80 -j REDIRECT --to-port 3127
]]><![CDATA[
# handle connections on the same box (SQUIDIP is a loopback instance)
gid=`id -g proxy`
iptables -t nat -A OUTPUT -p tcp --dport 80 -m owner --gid-owner $gid -j ACCEPT
iptables -t nat -A OUTPUT -p tcp --dport 80 -j DNAT --to-destination SQUIDIP:3127]]></screen></section><section><title>Squid Configuration File</title><para>You will need to configure squid to know the IP is being intercepted like so: </para><screen><![CDATA[http_port 3127 transparent]]></screen><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="15" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/alert.png" width="15"/></imageobject><textobject><phrase>/!\</phrase></textobject></inlinemediaobject> In Squid 3.1+ the <emphasis>transparent</emphasis> option has been split. Use <emphasis role="strong">'intercept</emphasis> to catch DNAT packets. </para></listitem></itemizedlist><screen><![CDATA[http_port 3127 intercept]]></screen><!--rule (<hr>) is not applicable to DocBook--><para> <ulink url="https://wiki.squid-cache.org/ConfigExamples/Intercept/LinuxLocalhost/CategoryConfigExample#">CategoryConfigExample</ulink> </para></section></section></article>