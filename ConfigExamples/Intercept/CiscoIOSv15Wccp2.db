<?xml version="1.0" encoding="utf-8"?><!DOCTYPE article  PUBLIC '-//OASIS//DTD DocBook XML V4.4//EN'  'http://www.docbook.org/xml/4.4/docbookx.dtd'><article><articleinfo><title>ConfigExamples/Intercept/CiscoIOSv15Wccp2</title><revhistory><revision><revnumber>119</revnumber><date>2016-08-19 12:05:56</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>118</revnumber><date>2016-07-02 19:37:10</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>117</revnumber><date>2016-07-02 19:35:11</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>116</revnumber><date>2016-07-02 19:33:38</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>115</revnumber><date>2016-07-02 19:32:22</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>114</revnumber><date>2016-07-02 19:31:08</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>113</revnumber><date>2016-07-02 19:30:48</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>112</revnumber><date>2016-07-02 19:28:14</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>111</revnumber><date>2016-07-02 19:14:59</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>110</revnumber><date>2016-07-02 19:13:55</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>109</revnumber><date>2016-07-02 19:11:42</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>108</revnumber><date>2016-07-02 19:10:39</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>107</revnumber><date>2016-07-02 19:09:54</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>106</revnumber><date>2016-07-02 19:08:13</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>105</revnumber><date>2016-07-02 19:07:56</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>104</revnumber><date>2016-07-02 17:58:10</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>103</revnumber><date>2016-07-02 12:57:56</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>102</revnumber><date>2016-07-02 12:56:43</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>101</revnumber><date>2016-07-02 12:49:05</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>100</revnumber><date>2016-07-02 12:48:17</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>99</revnumber><date>2016-07-02 12:40:01</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>98</revnumber><date>2016-07-02 12:38:23</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>97</revnumber><date>2016-07-02 12:34:39</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>96</revnumber><date>2016-07-02 12:25:36</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>95</revnumber><date>2016-07-02 12:24:43</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>94</revnumber><date>2016-07-02 12:23:47</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>93</revnumber><date>2016-06-27 16:50:01</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>92</revnumber><date>2016-06-27 16:47:51</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>91</revnumber><date>2016-06-27 16:46:35</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>90</revnumber><date>2016-06-24 18:30:46</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>89</revnumber><date>2016-06-24 18:30:00</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>88</revnumber><date>2016-06-24 18:27:46</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>87</revnumber><date>2016-06-24 18:25:26</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>86</revnumber><date>2016-06-24 18:24:44</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>85</revnumber><date>2016-06-24 18:23:44</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>84</revnumber><date>2016-06-24 18:22:55</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>83</revnumber><date>2016-06-24 18:21:07</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>82</revnumber><date>2016-06-24 18:18:27</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>81</revnumber><date>2016-06-24 18:15:17</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>80</revnumber><date>2016-06-24 18:14:22</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>79</revnumber><date>2016-06-24 18:11:41</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>78</revnumber><date>2016-06-16 20:51:05</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>77</revnumber><date>2016-06-16 20:49:39</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>76</revnumber><date>2016-06-15 17:49:10</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>75</revnumber><date>2016-06-15 17:48:01</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>74</revnumber><date>2016-06-15 17:47:26</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>73</revnumber><date>2016-06-15 17:35:27</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>72</revnumber><date>2016-06-15 17:28:26</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>71</revnumber><date>2016-06-15 17:27:42</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>70</revnumber><date>2016-06-15 17:25:29</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>69</revnumber><date>2016-06-15 16:55:06</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>68</revnumber><date>2016-06-15 16:53:17</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>67</revnumber><date>2016-06-15 16:43:58</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>66</revnumber><date>2016-06-15 16:42:53</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>65</revnumber><date>2016-06-15 16:41:41</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>64</revnumber><date>2016-06-05 20:33:53</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>63</revnumber><date>2016-06-05 20:31:34</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>62</revnumber><date>2016-05-30 18:36:07</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>61</revnumber><date>2016-05-30 18:34:41</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>60</revnumber><date>2016-05-28 16:14:36</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>59</revnumber><date>2016-05-28 16:09:36</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>58</revnumber><date>2016-05-28 16:09:21</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>57</revnumber><date>2016-05-28 16:07:30</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>56</revnumber><date>2016-05-28 16:04:17</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>55</revnumber><date>2016-05-28 16:03:23</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>54</revnumber><date>2016-05-20 20:16:44</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>53</revnumber><date>2016-04-29 20:32:27</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>52</revnumber><date>2016-04-29 20:31:43</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>51</revnumber><date>2016-04-29 20:28:59</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>50</revnumber><date>2016-04-29 19:26:04</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>49</revnumber><date>2016-04-29 13:46:35</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>48</revnumber><date>2016-04-28 21:27:53</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>47</revnumber><date>2016-04-28 21:23:07</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>46</revnumber><date>2016-04-28 21:21:05</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>45</revnumber><date>2016-04-27 18:41:45</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>44</revnumber><date>2016-04-27 18:38:41</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>43</revnumber><date>2016-04-27 18:37:00</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>42</revnumber><date>2016-04-27 18:35:03</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>41</revnumber><date>2016-04-25 21:45:36</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>40</revnumber><date>2016-04-13 22:21:26</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>39</revnumber><date>2016-04-12 19:43:48</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>38</revnumber><date>2016-04-12 19:42:33</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>37</revnumber><date>2016-01-08 20:21:10</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>36</revnumber><date>2015-10-14 20:35:25</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>35</revnumber><date>2015-10-14 19:10:11</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>34</revnumber><date>2015-07-13 12:22:46</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>33</revnumber><date>2015-07-13 12:22:05</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>32</revnumber><date>2015-07-13 12:20:32</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>31</revnumber><date>2015-07-13 12:20:06</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>30</revnumber><date>2015-05-05 16:45:17</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>29</revnumber><date>2015-04-14 15:11:53</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>28</revnumber><date>2015-04-14 15:10:05</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>27</revnumber><date>2015-03-16 19:58:08</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>26</revnumber><date>2015-03-16 19:57:10</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>25</revnumber><date>2015-03-16 19:56:01</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>24</revnumber><date>2015-03-16 19:52:58</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>23</revnumber><date>2015-03-16 19:51:06</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>22</revnumber><date>2015-03-16 19:50:04</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>21</revnumber><date>2015-02-08 19:22:33</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>20</revnumber><date>2015-02-08 19:18:07</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>19</revnumber><date>2015-01-27 21:18:28</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>18</revnumber><date>2015-01-11 16:52:35</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>17</revnumber><date>2015-01-10 13:37:36</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>16</revnumber><date>2015-01-10 13:36:35</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>15</revnumber><date>2015-01-10 13:35:27</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>14</revnumber><date>2015-01-10 13:34:52</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>13</revnumber><date>2015-01-10 13:33:08</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>12</revnumber><date>2015-01-10 12:39:24</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>11</revnumber><date>2015-01-10 10:55:00</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>10</revnumber><date>2015-01-10 10:54:42</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>9</revnumber><date>2015-01-10 10:52:03</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>8</revnumber><date>2015-01-10 10:48:08</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>7</revnumber><date>2015-01-09 21:14:36</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>6</revnumber><date>2015-01-09 20:52:55</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>5</revnumber><date>2015-01-09 20:51:15</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>4</revnumber><date>2015-01-09 20:42:31</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>3</revnumber><date>2015-01-09 20:31:13</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>2</revnumber><date>2015-01-09 20:25:24</date><authorinitials>YuriVoinov</authorinitials></revision><revision><revnumber>1</revnumber><date>2015-01-09 20:20:33</date><authorinitials>YuriVoinov</authorinitials></revision></revhistory></articleinfo><section><title>Variant I: Routed DMZ witch WCCPv2</title><itemizedlist><listitem override="none"><para><emphasis>by <ulink url="https://wiki.squid-cache.org/ConfigExamples/Intercept/CiscoIOSv15Wccp2/YuriVoinov#">YuriVoinov</ulink></emphasis> </para></listitem></itemizedlist><section><title>Configuring a Cisco IOS 15.5(3)M2 with WCCPv2 using ISR G2 router</title><para><emphasis role="strong">Warning</emphasis>: Any example presented here is provided &quot;as-is&quot; with no support or guarantee of suitability. If you have any further questions about these examples please email the squid-users mailing list. </para><section><title>Outline</title><para>This configuration passes HTTP/HTTPS traffic (both port 80 and 443) over <ulink url="https://en.wikipedia.org/wiki/Web_Cache_Communication_Protocol">WCCPv2</ulink> to proxy box for handling. It is expected the that the box will contain squid 3.x/4.x for processing the traffic. </para><para>The routers runs Cisco IOS Software, Version 15.5(3)M2, with SECURITYK9 and DATAK9 technology packs activated and have two physical interfaces - GigabitEthernet0/0 which connected to LAN switch, and GigabitEthernet0/1 (IP 192.168.200.2) connected to DMZ with proxy. Proxy has IP 192.168.200.3 in this example. WCCPv2 configured on router 2911. </para><para><inlinemediaobject><imageobject><imagedata fileref="https://wiki.squid-cache.org/ConfigExamples/Intercept/CiscoIOSv15Wccp2?action=AttachFile&amp;do=get&amp;target=Network_scheme.png"/></imageobject><textobject><phrase>Network scheme</phrase></textobject></inlinemediaobject> </para><para>Router has both router/switch functionality, so we can use both GRE/L2 redirection methods. </para><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> Note: Beware - you must have NAT configuted on your squid's box, and you must have squid built with OS-specific NAT support. </para></listitem><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> Note: When using managed switch in DMZ, be sure proxy box port in the same VLAN/has the same encapsulation as router port with WCCP activated. Otherwise router can't do WCCP handshake with proxy. </para></listitem></itemizedlist></section><section><title>Cisco IOS 15.5(3)M2 router</title><screen><![CDATA[!
ip cef
ip wccp web-cache redirect-list WCCP_ACCESS
ip wccp 70 redirect-list WCCP_ACCESS
no ipv6 cef
!
!
!
interface GigabitEthernet0/1
 ip address 192.168.200.2 255.255.255.0
 ip wccp web-cache redirect out
 ip wccp 70 redirect out
!
!
ip route 0.0.0.0 0.0.0.0 192.168.200.1
!
ip access-list extended WCCP_ACCESS
 remark ACL for HTTP/HTTPS
 remark Squid proxies bypass WCCP
 deny   ip host 192.168.200.3 any
 remark LAN clients proxy port 80/443
 permit tcp 192.168.0.0 0.0.255.255 any eq www 443
 remark all others bypass WCCP
 deny   ip any any
!
!]]></screen><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> Note: ip wccp web-cache can redirect only HTTP (port 80), so to redirect HTTPS we create another dynamic wccp-service 70 (in Cisco WCCP documentation this number dedicated to HTTPS. In general, number in range 1-254, it does not matter, but remember it to specify in squid config). Also remember, SECURITYK9/DATAK9 technology packs need to be activated only in case HTTPS interception. They are not used for only HTTP redirection. </para></listitem></itemizedlist><para>Also beware, when proxy is stopped - all HTTP/HTTPS traffic bypass it and passthrough default route to next hop (or last resort gateway). </para></section><section><title>Squid HTTP/HTTPS WCCPv2 configuration</title><screen><![CDATA[# WCCPv2 parameters
wccp2_router 192.168.200.2
wccp2_forwarding_method l2
wccp2_return_method l2
wccp2_rebuild_wait off
wccp2_service standard 0
wccp2_service dynamic 70
wccp2_service_info 70 protocol=tcp flags=dst_ip_hash,src_ip_alt_hash,src_port_alt_hash priority=231 ports=443]]></screen><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> Note: Squid must be built with WCCPv2 support. </para></listitem><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> Note: Squid box has configured default router pointed to 192.168.200.1 (Ge0/1 on 2901) - last resort gateway. </para></listitem><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> Note: This example uses L2 redirecting (for OSes without native GRE support). Beware, wccp2_rebuild_wait sends &quot;Here I am&quot; message to router when proxy is ready to serve requests, without cache rebuilding complere. Also, both - router and proxy - uses port 2048/udp to communicate with WCCP. So, this port must be open in firewalls. The most important: When using l2 redirection, both - WCCP-enabled router port and proxy - must share the same L2 network segment. </para></listitem><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> Note: If your choose GRE for communication with router and proxy, remember: you must have configured GRE on your proxy box! </para></listitem></itemizedlist><section><title>Security</title><para>To avoid denial-of-service attacks, you can enforce authentification between proxy(proxies) and router. To do that you need to setup WCCP services on router using passwords: </para><screen><![CDATA[ip wccp web-cache redirect-list WCCP_ACCESS password 0 foo123
ip wccp 70 redirect-list WCCP_ACCESS password 0 bar456]]></screen><para>If your router has service password-encryption enabled (to do that you need to apply next command in router global configuration): </para><screen><![CDATA[service password-encryption]]></screen><para>after defining your WCCP services on router, passwords will be encrypted: </para><screen><![CDATA[ip wccp web-cache redirect-list WCCP_ACCESS password 7 0600002E1D1C5A
ip wccp 70 redirect-list WCCP_ACCESS password 7 121B0405465E5A]]></screen><para>Then change WCCP service definitions in squid.conf: </para><screen><![CDATA[#       MD5 service authentication can be enabled by adding
#       "password=<password>" to the end of this service declaration.
wccp2_service standard 0 password=foo123
wccp2_service dynamic 70 password=bar456]]></screen><para>Then restart squid and check redirection is working. </para><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> Note: Beware your squid.conf contains <emphasis role="strong">any</emphasis> passwords in plain-text! Protect it as by as protect proxy box from unauthorized access! </para></listitem></itemizedlist></section></section><section><title>Setup verification</title><para>To verify setup up and running execute next commands on WCCP-enabled router: </para><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata fileref="https://wiki.squid-cache.org/ConfigExamples/Intercept/CiscoIOSv15Wccp2?action=AttachFile&amp;do=get&amp;target=Check_WCCP_1.png"/></imageobject><textobject><phrase>Check WCCP HTTP/HTTPS</phrase></textobject></inlinemediaobject> <inlinemediaobject><imageobject><imagedata fileref="https://wiki.squid-cache.org/ConfigExamples/Intercept/CiscoIOSv15Wccp2?action=AttachFile&amp;do=get&amp;target=Check_WCCP_2.png"/></imageobject><textobject><phrase>Check WCCP HTTP/HTTPS</phrase></textobject></inlinemediaobject> <inlinemediaobject><imageobject><imagedata fileref="https://wiki.squid-cache.org/ConfigExamples/Intercept/CiscoIOSv15Wccp2?action=AttachFile&amp;do=get&amp;target=Check_WCCP_3.png"/></imageobject><textobject><phrase>Check WCCP Interfaces/summary</phrase></textobject></inlinemediaobject> <inlinemediaobject><imageobject><imagedata fileref="https://wiki.squid-cache.org/ConfigExamples/Intercept/CiscoIOSv15Wccp2?action=AttachFile&amp;do=get&amp;target=Check_WCCP_up_and_running.png"/></imageobject><textobject><phrase>Check WCCP up and running</phrase></textobject></inlinemediaobject> </para></listitem></itemizedlist></section><section><title>QUIC/SPDY protocol blocking</title><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> Note: In most modern installations you may want (and you must) to block alternate protocols: SPDY and/or QUIC. To do that, please use <emphasis role="strong"><ulink url="http://wiki.squid-cache.org/KnowledgeBase/Block%20QUIC%20protocol">this instructions</ulink></emphasis>. </para></listitem></itemizedlist></section><section><title>Conclusion</title><para>This configuration example used on Cisco 2911 with Squid 3.x/4.x. As you can see, you can configure your environment for different ports interception. </para><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> Note: <emphasis role="strong">Performance</emphasis> is more better against PBR (route-map), WCCP uses less CPU on Cisco's devices. So, WCCP is preferrable against route-map. Also note, l2 redirection has hardware support and less overhead, than gre, which has only software processing (on CPU). </para></listitem><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> Note: This configuration was tested and fully operated on Cisco iOS versions 15.4(1)T, 15.4(3)M, 15.5(1)T, 15.5(2)T1, 15.5(3)M, 15.5(3)M2, 15.6(2)T, 15.6(2)T1, 15.6(3)M. <inlinemediaobject><imageobject><imagedata depth="12" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/thumbs-up.png" width="14"/></imageobject><textobject><phrase>{OK}</phrase></textobject></inlinemediaobject> <inlinemediaobject><imageobject><imagedata depth="12" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/thumbs-up.png" width="14"/></imageobject><textobject><phrase>{OK}</phrase></textobject></inlinemediaobject> <inlinemediaobject><imageobject><imagedata depth="12" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/thumbs-up.png" width="14"/></imageobject><textobject><phrase>{OK}</phrase></textobject></inlinemediaobject> </para></listitem></itemizedlist></section></section></section><section><title>Variant II: Switch L3 as WCCPv2 router</title><itemizedlist><listitem override="none"><para><emphasis>by <ulink url="https://wiki.squid-cache.org/ConfigExamples/Intercept/CiscoIOSv15Wccp2/YuriVoinov#">YuriVoinov</ulink></emphasis> and Svyatoslav Voinov </para></listitem></itemizedlist><section><title>Configuring a Cisco IOS 15.0(2)SE9 with WCCPv2 using aggregation switch</title><section><title>Outline</title><para>This configuration passes HTTP/HTTPS traffic (both port 80 and 443) from switch L3 over <ulink url="https://en.wikipedia.org/wiki/Web_Cache_Communication_Protocol">WCCPv2</ulink> to proxy box for handling. It is expected the that the box will contain squid 3.x/4.x for processing the traffic. </para><para>In this example uses Cisco 3750 aggregation switch in L3 mode as WCCPv2 router. The switch runs Cisco IOS Software, with appropriate version, in this example Version 15.0(2)SE9, with IPSERVICEK9 technology pack and has physical 1 Gbps interfaces. Proxy has two aggregated ports, IP's 192.168.201.10 (2 Gbps aggregate, aggr1) and 192.168.201.11 (4 Gbps aggregate, aggr2) in this example. WCCPv2 uses L2 redirection with assignment method <emphasis role="strong">mask</emphasis>. Switch only support WCCP &quot;IN&quot; redirection. </para><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata fileref="https://wiki.squid-cache.org/ConfigExamples/Intercept/CiscoIOSv15Wccp2?action=AttachFile&amp;do=get&amp;target=Network_scheme2.png"/></imageobject><textobject><phrase>Network scheme 2</phrase></textobject></inlinemediaobject> </para></listitem></itemizedlist></section><section><title>Cisco IOS 15.0(2)SE9 switch</title><screen><![CDATA[ip routing
 
ip wccp source-interface Vlan201
ip wccp web-cache redirect-list WCCP_ACCESS
ip wccp 70 redirect-list WCCP_ACCESS
]]><![CDATA[
interface GigabitEthernet1/0/15
 no switchport
 ip address 192.168.200.4 255.255.255.0
]]><![CDATA[
interface Vlan201
 ip address 192.168.201.1 255.255.255.0
 ip wccp web-cache redirect in
 ip wccp 70 redirect in
]]><![CDATA[
ip route 0.0.0.0 0.0.0.0 192.168.200.1
]]><![CDATA[
ip access-list extended WCCP_ACCESS
 remark ACL for HTTP/HTTPS
 remark Squid proxies bypass WCCP
 deny   ip host 192.168.201.10 any
 deny   ip host 192.168.201.11 any
 remark LAN clients proxy port 80/443
 permit tcp 192.168.0.0 0.0.255.255 any eq www 443
 remark all others bypass WCCP
 deny   ip any any]]></screen><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> Note: &quot;WCCP is supported only on the SDM templates that support PBR: access, routing, and dual IPv4/v6 routing.&quot; (from Cisco documentation) </para></listitem></itemizedlist></section><section><title>Squid HTTP/HTTPS WCCPv2 configuration</title><screen><![CDATA[# -------------------------------------
# WCCPv2 parameters
# -------------------------------------
wccp2_router 192.168.201.1
wccp2_forwarding_method l2
wccp2_return_method l2
wccp2_rebuild_wait off
wccp2_service standard 0
wccp2_service dynamic 70
wccp2_service_info 70 protocol=tcp flags=dst_ip_hash,src_ip_alt_hash,src_port_alt_hash priority=231 ports=443
# Cisco Routers uses hash (default), switches - mask
wccp2_assignment_method mask
]]><![CDATA[
balance_on_multiple_ip on]]></screen><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> Note: As usual, it's expected your Squid already configured with HTTP and HTTPS ports. </para></listitem></itemizedlist><section><title>Security</title><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> Note: When using authenticated WCCP, like previous example, please note, Cisco equipement has passwork length limit (no more than 8 symbols on routers and most switches) and password strength limit - you can use only letters and numbers. Also was discovered additional password length limit on switches like 3750 with some old iOS, in this cases you'll be forced to reduce password length to 6-7 symbols. </para></listitem></itemizedlist></section></section><section><title>Conclusion</title><para>This configuration example used on Cisco 3750 aggregation switch with Squid 3.x/4.x. As you can see, you can configure your environment for different ports interception. </para><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> Note: Initial setup was created, tested and fully operated on switch WS-C3750G-16TD-S with iOS 12.2(55)SE10 IPSERVICEK9 with Squid 3.5.19. <inlinemediaobject><imageobject><imagedata depth="12" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/thumbs-up.png" width="14"/></imageobject><textobject><phrase>{OK}</phrase></textobject></inlinemediaobject> </para></listitem><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> Note: This configuration was tested and fully operated on Cisco iOS version 15.0(2)SE9 on appropriate switch (see next note). <inlinemediaobject><imageobject><imagedata depth="12" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/thumbs-up.png" width="14"/></imageobject><textobject><phrase>{OK}</phrase></textobject></inlinemediaobject> <inlinemediaobject><imageobject><imagedata depth="12" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/thumbs-up.png" width="14"/></imageobject><textobject><phrase>{OK}</phrase></textobject></inlinemediaobject> <inlinemediaobject><imageobject><imagedata depth="12" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/thumbs-up.png" width="14"/></imageobject><textobject><phrase>{OK}</phrase></textobject></inlinemediaobject> </para></listitem><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> Note: Be <emphasis role="strong">VERY CAREFUL</emphasis>: Cisco 3750 series has much submodels, not at all compatible with iOS 15.x. Partially, C3750G-16TD-S can run iOS 12.2(55)SE series only. Read <ulink url="http://www.cisco.com/c/en/us/td/docs/switches/lan/catalyst3750/software/release/15-0_2_se/release/notes/OL25301.html">Cisco Release Notes</ulink> first when choose iOS release. Quote from: &quot; Not all Catalyst 3750 and 3560 switches can run this release. These models are not supported in Cisco IOS Release 12.2(58)SE1 and later: WS-C3560-24TS, WS-C3560-24PS. WS-C3560-48PS, WS-C3560-48TS, WS-C3750-24PS, WS-C3750-24TS, WS-C3750-48PS, WS-C3750-48TS, WS-3750G-24T, WS-C3750G-12S, WS-C3750G-24TS, WS-C3750G-16TD. For ongoing maintenance rebuilds for these models, use Cisco IOS Release 12.2(55)SE and later (SE1, SE2, and so on).&quot; Also note, WCCP on this series of switches are supported starting from 12.2(37)SE iOS. </para></listitem><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> Note: Against Variant I, switches hardware accelerated redirections don't shown in <emphasis role="strong">sho ip wccp</emphasis> command output. Check redirection work via Squid's access.log. </para></listitem></itemizedlist></section></section></section><section><title>Variant III: Switched ISR G2 router with WCCPv2</title><itemizedlist><listitem override="none"><para><emphasis>by <ulink url="https://wiki.squid-cache.org/ConfigExamples/Intercept/CiscoIOSv15Wccp2/YuriVoinov#">YuriVoinov</ulink></emphasis> and Svyatoslav Voinov </para></listitem></itemizedlist><section><title>Configuring a Cisco IOS 15.5(3)M2 with WCCPv2 using switched ISR G2 router with convergent switch board</title><section><title>Outline</title><para>This configuration passes HTTP/HTTPS traffic (both port 80 and 443) over <ulink url="https://en.wikipedia.org/wiki/Web_Cache_Communication_Protocol">WCCPv2</ulink> to proxy box for handling. It is expected the that the box will contain squid 3.x/4.x for processing the traffic. </para><para>The routers runs Cisco IOS Software, Version 15.5(3)M2, with SECURITYK9 and DATAK9 technology packs activated. Router contains convergent switch board with four 100 Mbps or 1 Gbps ports. WCCPv2 configured on router 2911. </para><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata fileref="https://wiki.squid-cache.org/ConfigExamples/Intercept/CiscoIOSv15Wccp2?action=AttachFile&amp;do=get&amp;target=Network_scheme3.png"/></imageobject><textobject><phrase>Network scheme 3</phrase></textobject></inlinemediaobject> </para></listitem></itemizedlist></section><section><title>Cisco IOS 15.5(3)M2 router</title><screen><![CDATA[!
ip dhcp pool 100
 network 192.168.100.0 255.255.255.0
 default-router 192.168.100.1 
 dns-server 192.168.100.1 
 lease 30
!
ip dhcp pool 101
 network 192.168.101.0 255.255.255.0
 default-router 192.168.101.1 
 dns-server 192.168.101.1 
 lease 30
!
!
ip cef
ip wccp source-interface Vlan201
no ipv6 cef
!
!
interface FastEthernet0/0/0
 switchport access vlan 201
 no ip address
!
interface FastEthernet0/0/1
 switchport access vlan 201
 no ip address
!
interface FastEthernet0/0/2
 switchport mode trunk
 no ip address
!         
interface FastEthernet0/0/3
 switchport access vlan 100
 no ip address
!
!
interface Vlan100
 ip address 192.168.100.1 255.255.255.0
 ip wccp web-cache redirect in
 ip wccp 70 redirect in
 ip nat inside
 ip virtual-reassembly in
!
interface Vlan101
 ip address 192.168.101.1 255.255.255.0
 ip wccp web-cache redirect in
 ip wccp 70 redirect in
 ip nat inside
 ip virtual-reassembly in
!         
interface Vlan201
 ip address 192.168.201.1 255.255.255.0
 ip wccp web-cache redirect in
 ip wccp 70 redirect in
 ip nat inside
 ip virtual-reassembly in
!
ip nat inside source list NAT interface GigabitEthernet0/1 overload
ip route 0.0.0.0 0.0.0.0 GigabitEthernet0/1 EXTERNAL_ISP_IP
!
ip access-list extended WCCP_ACCESS
 remark ACL for HTTP/HTTPS
 remark Squid proxies bypass WCCP
 deny   ip host 192.168.201.10 any
 remark LAN clients proxy port 80/443
 permit tcp 192.168.0.0 0.0.255.255 any eq www 443
!]]></screen><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> Note: Whenever clients and proxy connected via switch module, router uses <emphasis role="strong">hash</emphasis> assignment method itself. </para></listitem></itemizedlist></section><section><title>Squid HTTP/HTTPS WCCPv2 configuration</title><screen><![CDATA[# -------------------------------------
# WCCPv2 parameters
# -------------------------------------
wccp2_router 192.168.201.1
wccp2_forwarding_method l2
wccp2_return_method l2
wccp2_rebuild_wait off
wccp2_service standard 0
wccp2_service dynamic 70
wccp2_service_info 70 protocol=tcp flags=dst_ip_hash,src_ip_alt_hash,src_port_alt_hash priority=231 ports=443
# Cisco Routers uses hash (default), switches - mask
wccp2_assignment_method hash]]></screen><section><title>Security</title><itemizedlist><listitem override="none"><para><inlinemediaobject><imageobject><imagedata depth="16" fileref="https://wiki.squid-cache.org/wiki/squidtheme/img/icon-info.png" width="16"/></imageobject><textobject><phrase>{i}</phrase></textobject></inlinemediaobject> Note: You can use authenticated WCCP like first example. </para></listitem></itemizedlist></section></section><section><title>Conclusion</title><para>This configuration example uses switched ISR-G2 2911 router as central insfrastructure device. You can define as many client vlans as you required using access switches downstream infrastructure, and: on port Gi0/1 need to configure closed firewall with NAT due to security reasons. </para></section></section></section><section><title>Variant IV: VRF with WCCPv2</title><itemizedlist><listitem override="none"><para><emphasis>by <ulink url="https://wiki.squid-cache.org/ConfigExamples/Intercept/CiscoIOSv15Wccp2/YuriVoinov#">YuriVoinov</ulink></emphasis> and Svyatoslav Voinov </para></listitem></itemizedlist><section><title>Outline</title><para>This configuration passes HTTP/HTTPS traffic (both port 80 and 443) from <ulink url="https://en.wikipedia.org/wiki/Virtual_routing_and_forwarding">VRF</ulink>-enabled router over <ulink url="https://en.wikipedia.org/wiki/Web_Cache_Communication_Protocol">WCCPv2</ulink> to proxy box for handling. It is expected the that the box will contain squid 3.x/4.x for processing the traffic. You can have many VRF routers (on <ulink url="https://en.wikipedia.org/wiki/Multiprotocol_Label_Switching">MPLS</ulink> router box) with the as many proxy boxes as you wish, for example, in ISP. </para><!--rule (<hr>) is not applicable to DocBook--><para> <ulink url="https://wiki.squid-cache.org/ConfigExamples/Intercept/CiscoIOSv15Wccp2/CategoryConfigExample#">CategoryConfigExample</ulink> </para></section></section></article>