<?xml version="1.0" encoding="utf-8"?><!DOCTYPE article  PUBLIC '-//OASIS//DTD DocBook XML V4.4//EN'  'http://www.docbook.org/xml/4.4/docbookx.dtd'><article><articleinfo><title>ConfigExamples/Intercept/Cisco3640Wccp2</title><revhistory><revision><revnumber>4</revnumber><date>2010-09-08 00:22:25</date><authorinitials>AmosJeffries</authorinitials><revremark>link squid config details.</revremark></revision><revision><revnumber>3</revnumber><date>2009-10-19 23:11:40</date><authorinitials>AmosJeffries</authorinitials><revremark>update meta tags for feature include, add section for troubleshoot. empty so far</revremark></revision><revision><revnumber>2</revnumber><date>2009-10-19 22:31:27</date><authorinitials>AmosJeffries</authorinitials><revremark>test meta tags for feature page inclusion</revremark></revision><revision><revnumber>1</revnumber><date>2008-09-01 04:16:59</date><authorinitials>AmosJeffries</authorinitials><revremark>Import from FreeBSD + WCCPv2 example</revremark></revision></revhistory></articleinfo><section><title>Configuring a Cisco 3640 with WCCPv2 Interception</title><para><emphasis role="strong">Warning</emphasis>: Any example presented here is provided &quot;as-is&quot; with no support or guarantee of suitability. If you have any further questions about these examples please email the squid-users mailing list. </para><section><title>Outline</title><para>This was done on a Cisco 3640 running c3640-is-mz.122-23f.bin; its acting as a NAT gateway and home router. </para><para>This configuration passes web traffic (port 80 only) over WCCPv2 to another box for handling. It is expected the that the box will contain squid or other proxy for processing the traffic. </para></section><section><title>Cisco 3640 router</title><screen><![CDATA[!
ip wccp web-cache
!
interface Ethernet1/0
 description Public interface
 ip address X.X.X.X 255.255.255.248
 no ip redirects
 no ip unreachables
 ip nat outside
 full-duplex
!
interface FastEthernet2/0
 no ip address
 duplex auto
 speed auto
!
interface FastEthernet2/0.1
 encapsulation dot1Q 1 native
 ip address 192.168.1.1 255.255.255.0
 no ip redirects
 no ip unreachables
 ip wccp web-cache redirect in
 ip nat inside]]></screen><section><title>Squid configuration for WCCP version 2</title><para>All the squid.conf options beginning with wccp2_* apply to <emphasis role="strong">WCCPv2 only</emphasis> </para><itemizedlist><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/wccp2_router#">wccp2_router</ulink> </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/wccp2_address#">wccp2_address</ulink> </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/wccp2_forwarding_method#">wccp2_forwarding_method</ulink> </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/wccp2_return_method#">wccp2_return_method</ulink> </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/wccp2_assignment_method#">wccp2_assignment_method</ulink> </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/wccp2_service#">wccp2_service</ulink> </para></listitem></itemizedlist><section><title>Squid configuration</title><itemizedlist><listitem override="none"><para><emphasis role="strong">$IP-OF-ROUTER</emphasis> is used below to represent the IP address of the router sending the WCCP traffic to Squid. </para></listitem></itemizedlist><para><ulink url="https://wiki.squid-cache.org/ConfigExamples/Intercept/Cisco3640Wccp2/Squid-2.6#">Squid-2.6</ulink> to <ulink url="https://wiki.squid-cache.org/ConfigExamples/Intercept/Cisco3640Wccp2/Squid-3.0#">Squid-3.0</ulink> require magic numbers... </para><screen><![CDATA[http_port 3129 transparent
wccp2_router $IP-OF-ROUTER
wccp2_forwarding_method 1
wccp2_return_method 1
wccp2_service standard 0 password=foo]]></screen><itemizedlist><listitem><para><ulink url="https://wiki.squid-cache.org/ConfigExamples/Intercept/Cisco3640Wccp2/Squid-3.1#">Squid-3.1</ulink> and later accept text names for the tunneling methods </para></listitem></itemizedlist><screen><![CDATA[http_port 3129 intercept
wccp2_router $IP-OF-ROUTER
wccp2_forwarding_method gre
wccp2_return_method gre
wccp2_service standard 0 password=foo]]></screen></section><section><title>Squid box OS configuration</title><screen><![CDATA[modprobe ip_gre
ip tunnel add wccp0 mode gre remote $ASA-EXT-IP local $SQUID-IP dev eth0
]]><![CDATA[
ifconfig wccp0 $SQUID-IP netmask 255.255.255.255 up]]></screen><itemizedlist><listitem><para>disable rp_filter, or the packets will be silently discarded </para></listitem></itemizedlist><screen><![CDATA[echo 0 >/proc/sys/net/ipv4/conf/wccp0/rp_filter
echo 0 >/proc/sys/net/ipv4/conf/eth0/rp_filter]]></screen><itemizedlist><listitem><para>enable ip-forwarding and redirect packets to squid </para></listitem></itemizedlist><screen><![CDATA[echo 1 >/proc/sys/net/ipv4/ip_forward
iptables -t nat -A PREROUTING -i wccp0 -p tcp --dport 80 -j REDIRECT --to-port 3129
iptables -t nat -A POSTROUTING -j MASQUERADE]]></screen></section></section></section></section><section><title>Troubleshooting</title><!--rule (<hr>) is not applicable to DocBook--><para> <ulink url="https://wiki.squid-cache.org/ConfigExamples/Intercept/Cisco3640Wccp2/CategoryConfigExample#">CategoryConfigExample</ulink> </para></section></article>