<?xml version="1.0" encoding="utf-8"?><!DOCTYPE article  PUBLIC '-//OASIS//DTD DocBook XML V4.4//EN'  'http://www.docbook.org/xml/4.4/docbookx.dtd'><article><articleinfo><title>ConfigExamples/Intercept/CiscoIos1246T2Wccp2</title><revhistory><revision><revnumber>6</revnumber><date>2010-09-08 00:21:00</date><authorinitials>AmosJeffries</authorinitials><revremark>link squid config details.</revremark></revision><revision><revnumber>5</revnumber><date>2009-10-19 23:17:44</date><authorinitials>AmosJeffries</authorinitials><revremark>typo in meta tag</revremark></revision><revision><revnumber>4</revnumber><date>2009-10-19 23:16:23</date><authorinitials>AmosJeffries</authorinitials><revremark>typo</revremark></revision><revision><revnumber>3</revnumber><date>2009-10-19 23:16:06</date><authorinitials>AmosJeffries</authorinitials><revremark>add section for troubleshooting</revremark></revision><revision><revnumber>2</revnumber><date>2009-10-19 22:51:00</date><authorinitials>AmosJeffries</authorinitials><revremark>meta tags for feature page include</revremark></revision><revision><revnumber>1</revnumber><date>2009-04-03 07:01:24</date><authorinitials>AmosJeffries</authorinitials><revremark>import from FAQ page</revremark></revision></revhistory></articleinfo><section><title>Configuring a Cisco IOS 12.4(6) T2 with WCCPv2 Interception</title><itemizedlist><listitem override="none"><para><emphasis>by <ulink url="https://wiki.squid-cache.org/ConfigExamples/Intercept/CiscoIos1246T2Wccp2/ReubenFarrelly#">ReubenFarrelly</ulink></emphasis> </para></listitem></itemizedlist><para><emphasis role="strong">Warning</emphasis>: Any example presented here is provided &quot;as-is&quot; with no support or guarantee of suitability. If you have any further questions about these examples please email the squid-users mailing list. </para><section><title>Outline</title><para>This configuration passes web traffic (port 80 only) over WCCPv2 to another box for handling. It is expected the that the box will contain squid or other proxy for processing the traffic. </para><para>The router runs cisco IOS 12.4(6)T2 ADVSECURITY, and I have a sub-interface on my FastEthernet port as the switch-router link is a trunk </para></section><section><title>Cisco IOS 12.4(6) T2 router</title><screen><![CDATA[!
ip wccp web-cache
ip cef
!
interface FastEthernet0/0.2
 description Link to internal LAN
 encapsulation dot1Q 2
 ip address 192.168.0.1 255.255.255.0
 ip access-group outboundfilters in
 no ip proxy-arp
 ip wccp web-cache redirect in
 ip inspect fw-rules in
 ip nat inside
 ip virtual-reassembly
 no snmp trap link-status
!]]></screen><section><title>Squid configuration for WCCP version 2</title><para>All the squid.conf options beginning with wccp2_* apply to <emphasis role="strong">WCCPv2 only</emphasis> </para><itemizedlist><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/wccp2_router#">wccp2_router</ulink> </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/wccp2_address#">wccp2_address</ulink> </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/wccp2_forwarding_method#">wccp2_forwarding_method</ulink> </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/wccp2_return_method#">wccp2_return_method</ulink> </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/wccp2_assignment_method#">wccp2_assignment_method</ulink> </para></listitem><listitem><para><ulink url="http://www.squid-cache.org/Doc/config/wccp2_service#">wccp2_service</ulink> </para></listitem></itemizedlist><section><title>Squid configuration</title><itemizedlist><listitem override="none"><para><emphasis role="strong">$IP-OF-ROUTER</emphasis> is used below to represent the IP address of the router sending the WCCP traffic to Squid. </para></listitem></itemizedlist><para><ulink url="https://wiki.squid-cache.org/ConfigExamples/Intercept/CiscoIos1246T2Wccp2/Squid-2.6#">Squid-2.6</ulink> to <ulink url="https://wiki.squid-cache.org/ConfigExamples/Intercept/CiscoIos1246T2Wccp2/Squid-3.0#">Squid-3.0</ulink> require magic numbers... </para><screen><![CDATA[http_port 3129 transparent
wccp2_router $IP-OF-ROUTER
wccp2_forwarding_method 1
wccp2_return_method 1
wccp2_service standard 0 password=foo]]></screen><itemizedlist><listitem><para><ulink url="https://wiki.squid-cache.org/ConfigExamples/Intercept/CiscoIos1246T2Wccp2/Squid-3.1#">Squid-3.1</ulink> and later accept text names for the tunneling methods </para></listitem></itemizedlist><screen><![CDATA[http_port 3129 intercept
wccp2_router $IP-OF-ROUTER
wccp2_forwarding_method gre
wccp2_return_method gre
wccp2_service standard 0 password=foo]]></screen></section><section><title>Squid box OS configuration</title><screen><![CDATA[modprobe ip_gre
ip tunnel add wccp0 mode gre remote $ASA-EXT-IP local $SQUID-IP dev eth0
]]><![CDATA[
ifconfig wccp0 $SQUID-IP netmask 255.255.255.255 up]]></screen><itemizedlist><listitem><para>disable rp_filter, or the packets will be silently discarded </para></listitem></itemizedlist><screen><![CDATA[echo 0 >/proc/sys/net/ipv4/conf/wccp0/rp_filter
echo 0 >/proc/sys/net/ipv4/conf/eth0/rp_filter]]></screen><itemizedlist><listitem><para>enable ip-forwarding and redirect packets to squid </para></listitem></itemizedlist><screen><![CDATA[echo 1 >/proc/sys/net/ipv4/ip_forward
iptables -t nat -A PREROUTING -i wccp0 -p tcp --dport 80 -j REDIRECT --to-port 3129
iptables -t nat -A POSTROUTING -j MASQUERADE]]></screen></section></section></section></section><section><title>Troubleshooting</title><section><title>IOS 12.4 (6)-(9) T dropping packets</title><itemizedlist><listitem override="none"><para>In this release of IOS software that I am running (12.4(6)T2 and 12.4(9)T) you MUST NOT have <emphasis role="strong">ip inspect fw-rules</emphasis> in on the same interface as your <emphasis role="strong">ip wccp web-cache redirect</emphasis> statement. </para></listitem></itemizedlist><para>I opened a TAC case on this as it is clearly a bug and regression from past behaviour where WCCP did work fine with IP inspection configured on the same interface.  This turned out to be confirmed as a bug in IOS, which is documented as <ulink url="http://www.cisco.com/cgi-bin/Support/Bugtool/onebug.pl?bugid=CSCse55959">CSCse55959</ulink>. </para><para>The cause of this is TCP fragments of traffic being dropped by the ip inspection process - fragments which should not even be inspected in the first place. This bug does not occur on the PIX which works fine with the same network design and configuration.  If you would like this bug fixed, please open a cisco TAC case referencing this bug report and encourage cisco to fix it. </para><!--rule (<hr>) is not applicable to DocBook--><para> <ulink url="https://wiki.squid-cache.org/ConfigExamples/Intercept/CiscoIos1246T2Wccp2/CategoryConfigExample#">CategoryConfigExample</ulink> </para></section></section></article>